name: Release All Services

# ç»Ÿä¸€å‘å¸ƒæ‰€æœ‰VGOå¾®æœåŠ¡
# è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»¥'release/'å¼€å¤´çš„åˆ†æ”¯æˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches:
      - 'release/*'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      services:
        description: 'Services to release (comma-separated: vgo-kit,vgo-iam,vgo-gateway or "all")'
        required: true
        default: 'all'
        type: string
      skip_tests:
        description: 'Skip tests (for emergency releases)'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'Dry run (simulate release without actual deployment)'
        required: false
        default: false
        type: boolean

env:
  GO_VERSION: '1.24.1'
  REGISTRY: ghcr.io
  ORG_NAME: vera-byte

jobs:
  # é¢„æ£€æŸ¥ä½œä¸š
  pre-check:
    name: Pre-release Checks
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      services: ${{ steps.services.outputs.services }}
      release-order: ${{ steps.services.outputs.release-order }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git for submodules
        run: |
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git submodule update --init --recursive

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # ä»åˆ†æ”¯åæå–ç‰ˆæœ¬ (release/v1.0.0 -> v1.0.0)
            VERSION="${GITHUB_REF#refs/heads/release/}"
          fi
          
          # éªŒè¯ç‰ˆæœ¬æ ¼å¼
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "âŒ ç‰ˆæœ¬æ ¼å¼æ— æ•ˆ: $VERSION"
            echo "âœ… æ­£ç¡®æ ¼å¼: v1.0.0 æˆ– v1.0.0-beta"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ å‘å¸ƒç‰ˆæœ¬: $VERSION"

      - name: Determine services to release
        id: services
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SERVICES_INPUT="${{ github.event.inputs.services }}"
          else
            SERVICES_INPUT="all"
          fi
          
          if [ "$SERVICES_INPUT" = "all" ]; then
            SERVICES="vgo-kit,vgo-iam,vgo-gateway"
            RELEASE_ORDER="vgo-kit vgo-iam vgo-gateway"
          else
            SERVICES="$SERVICES_INPUT"
            # ç¡®ä¿vgo-kitä¼˜å…ˆå‘å¸ƒï¼ˆå¦‚æœåŒ…å«åœ¨åˆ—è¡¨ä¸­ï¼‰
            if [[ "$SERVICES" == *"vgo-kit"* ]]; then
              RELEASE_ORDER="vgo-kit"
              if [[ "$SERVICES" == *"vgo-iam"* ]]; then
                RELEASE_ORDER="$RELEASE_ORDER vgo-iam"
              fi
              if [[ "$SERVICES" == *"vgo-gateway"* ]]; then
                RELEASE_ORDER="$RELEASE_ORDER vgo-gateway"
              fi
            else
              RELEASE_ORDER=$(echo "$SERVICES" | tr ',' ' ')
            fi
          fi
          
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "release-order=$RELEASE_ORDER" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ å‘å¸ƒæœåŠ¡: $SERVICES"
          echo "ğŸ“‹ å‘å¸ƒé¡ºåº: $RELEASE_ORDER"

      - name: Check workspace structure
        run: |
          echo "ğŸ“‹ æ£€æŸ¥å·¥ä½œåŒºç»“æ„..."
          if [ ! -f "go.work" ]; then
            echo "âŒ go.work æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          for service in $(echo "${{ steps.services.outputs.services }}" | tr ',' ' '); do
            if [ ! -d "$service" ]; then
              echo "âŒ æœåŠ¡ç›®å½•ä¸å­˜åœ¨: $service"
              exit 1
            fi
            if [ ! -f "$service/go.mod" ]; then
              echo "âŒ go.mod æ–‡ä»¶ä¸å­˜åœ¨: $service/go.mod"
              exit 1
            fi
          done
          
          echo "âœ… å·¥ä½œåŒºç»“æ„æ£€æŸ¥é€šè¿‡"

      - name: Check for existing tags
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "ğŸ“‹ æ£€æŸ¥æ ‡ç­¾å†²çª..."
          
          for service in $(echo "${{ steps.services.outputs.services }}" | tr ',' ' '); do
            cd "$service"
            if git tag -l | grep -q "^$VERSION$"; then
              echo "âŒ æ ‡ç­¾ $VERSION åœ¨ $service ä¸­å·²å­˜åœ¨"
              cd ..
              exit 1
            fi
            cd ..
          done
          
          echo "âœ… æ ‡ç­¾æ£€æŸ¥é€šè¿‡"

  # è¿è¡Œæµ‹è¯•ï¼ˆé™¤éè·³è¿‡ï¼‰
  test-all:
    name: Test All Services
    runs-on: ubuntu-latest
    needs: [pre-check]
    if: github.event.inputs.skip_tests != 'true'
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: vgo_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install migrate tool
        run: |
          go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

      - name: Test all services
        run: |
          for service in $(echo "${{ needs.pre-check.outputs.services }}" | tr ',' ' '); do
            echo "ğŸ§ª æµ‹è¯• $service..."
            cd "$service"
            
            # ä¸‹è½½ä¾èµ–
            go mod download
            
            # è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -d "migrations" ] && [ "$(ls -A migrations)" ]; then
              migrate -path migrations -database "postgres://postgres:postgres@localhost:5432/vgo_test?sslmode=disable" up || true
            fi
            
            # è¿è¡Œæµ‹è¯•
            go test -v -race -coverprofile=coverage.out ./...
            
            cd ..
          done
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/vgo_test?sslmode=disable
          REDIS_URL: redis://localhost:6379

  # å‘å¸ƒvgo-kitï¼ˆåŸºç¡€åº“ï¼Œå¿…é¡»é¦–å…ˆå‘å¸ƒï¼‰
  release-vgo-kit:
    name: Release vgo-kit
    runs-on: ubuntu-latest
    needs: [pre-check, test-all]
    if: always() && (needs.test-all.result == 'success' || needs.test-all.result == 'skipped') && contains(needs.pre-check.outputs.services, 'vgo-kit')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git for submodules
        run: |
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git submodule update --init --recursive

      - name: Create and push tag
        if: github.event.inputs.dry_run != 'true'
        run: |
          cd vgo-kit
          git tag -a "${{ needs.pre-check.outputs.version }}" -m "Release ${{ needs.pre-check.outputs.version }}"
          git push origin "${{ needs.pre-check.outputs.version }}"
          echo "âœ… vgo-kit ${{ needs.pre-check.outputs.version }} æ ‡ç­¾å·²åˆ›å»º"

      - name: Simulate tag creation (dry run)
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ğŸ” [DRY RUN] å°†ä¸º vgo-kit åˆ›å»ºæ ‡ç­¾: ${{ needs.pre-check.outputs.version }}"

  # å‘å¸ƒvgo-iamï¼ˆä¾èµ–vgo-kitï¼‰
  release-vgo-iam:
    name: Release vgo-iam
    runs-on: ubuntu-latest
    needs: [pre-check, test-all, release-vgo-kit]
    if: always() && (needs.test-all.result == 'success' || needs.test-all.result == 'skipped') && (needs.release-vgo-kit.result == 'success' || needs.release-vgo-kit.result == 'skipped') && contains(needs.pre-check.outputs.services, 'vgo-iam')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git for submodules
        run: |
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git submodule update --init --recursive

      - name: Wait for vgo-kit release to complete
        if: contains(needs.pre-check.outputs.services, 'vgo-kit')
        run: |
          echo "â³ ç­‰å¾… vgo-kit å‘å¸ƒå®Œæˆ..."
          sleep 30  # ç»™vgo-kitçš„GitHub Actionsä¸€äº›æ—¶é—´å¯åŠ¨

      - name: Create and push tag
        if: github.event.inputs.dry_run != 'true'
        run: |
          cd vgo-iam
          git tag -a "${{ needs.pre-check.outputs.version }}" -m "Release ${{ needs.pre-check.outputs.version }}"
          git push origin "${{ needs.pre-check.outputs.version }}"
          echo "âœ… vgo-iam ${{ needs.pre-check.outputs.version }} æ ‡ç­¾å·²åˆ›å»º"

      - name: Simulate tag creation (dry run)
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ğŸ” [DRY RUN] å°†ä¸º vgo-iam åˆ›å»ºæ ‡ç­¾: ${{ needs.pre-check.outputs.version }}"

  # å‘å¸ƒvgo-gatewayï¼ˆä¾èµ–vgo-kitï¼‰
  release-vgo-gateway:
    name: Release vgo-gateway
    runs-on: ubuntu-latest
    needs: [pre-check, test-all, release-vgo-kit]
    if: always() && (needs.test-all.result == 'success' || needs.test-all.result == 'skipped') && (needs.release-vgo-kit.result == 'success' || needs.release-vgo-kit.result == 'skipped') && contains(needs.pre-check.outputs.services, 'vgo-gateway')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git for submodules
        run: |
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git submodule update --init --recursive

      - name: Wait for vgo-kit release to complete
        if: contains(needs.pre-check.outputs.services, 'vgo-kit')
        run: |
          echo "â³ ç­‰å¾… vgo-kit å‘å¸ƒå®Œæˆ..."
          sleep 30  # ç»™vgo-kitçš„GitHub Actionsä¸€äº›æ—¶é—´å¯åŠ¨

      - name: Create and push tag
        if: github.event.inputs.dry_run != 'true'
        run: |
          cd vgo-gateway
          git tag -a "${{ needs.pre-check.outputs.version }}" -m "Release ${{ needs.pre-check.outputs.version }}"
          git push origin "${{ needs.pre-check.outputs.version }}"
          echo "âœ… vgo-gateway ${{ needs.pre-check.outputs.version }} æ ‡ç­¾å·²åˆ›å»º"

      - name: Simulate tag creation (dry run)
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ğŸ” [DRY RUN] å°†ä¸º vgo-gateway åˆ›å»ºæ ‡ç­¾: ${{ needs.pre-check.outputs.version }}"

  # å‘å¸ƒåæ€»ç»“
  post-release:
    name: Post Release Summary
    runs-on: ubuntu-latest
    needs: [pre-check, test-all, release-vgo-kit, release-vgo-iam, release-vgo-gateway]
    if: always()
    steps:
      - name: Generate release summary
        run: |
          echo "## ğŸš€ VGOå¾®æœåŠ¡å‘å¸ƒæ€»ç»“"
          echo
          echo "**ç‰ˆæœ¬:** ${{ needs.pre-check.outputs.version }}"
          echo "**å‘å¸ƒæ—¶é—´:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "**è§¦å‘æ–¹å¼:** ${{ github.event_name }}"
          echo "**æ˜¯å¦ä¸ºæ¨¡æ‹Ÿå‘å¸ƒ:** ${{ github.event.inputs.dry_run || 'false' }}"
          echo
          echo "### ğŸ“‹ å‘å¸ƒçŠ¶æ€"
          echo
          
          # æ£€æŸ¥å„ä¸ªæœåŠ¡çš„å‘å¸ƒçŠ¶æ€
          if [[ "${{ contains(needs.pre-check.outputs.services, 'vgo-kit') }}" == "true" ]]; then
            if [[ "${{ needs.release-vgo-kit.result }}" == "success" ]]; then
              echo "âœ… **vgo-kit**: å‘å¸ƒæˆåŠŸ"
            else
              echo "âŒ **vgo-kit**: å‘å¸ƒå¤±è´¥"
            fi
          fi
          
          if [[ "${{ contains(needs.pre-check.outputs.services, 'vgo-iam') }}" == "true" ]]; then
            if [[ "${{ needs.release-vgo-iam.result }}" == "success" ]]; then
              echo "âœ… **vgo-iam**: å‘å¸ƒæˆåŠŸ"
            else
              echo "âŒ **vgo-iam**: å‘å¸ƒå¤±è´¥"
            fi
          fi
          
          if [[ "${{ contains(needs.pre-check.outputs.services, 'vgo-gateway') }}" == "true" ]]; then
            if [[ "${{ needs.release-vgo-gateway.result }}" == "success" ]]; then
              echo "âœ… **vgo-gateway**: å‘å¸ƒæˆåŠŸ"
            else
              echo "âŒ **vgo-gateway**: å‘å¸ƒå¤±è´¥"
            fi
          fi
          
          echo
          echo "### ğŸ³ Dockeré•œåƒ"
          echo
          
          for service in $(echo "${{ needs.pre-check.outputs.services }}" | tr ',' ' '); do
            if [[ "$service" != "vgo-kit" ]]; then  # vgo-kitä¸æ„å»ºDockeré•œåƒ
              echo "- \`${{ env.REGISTRY }}/${{ env.ORG_NAME }}/$service:${{ needs.pre-check.outputs.version }}\`"
            fi
          done
          
          echo
          echo "### ğŸ“š åç»­æ­¥éª¤"
          echo
          echo "1. æ£€æŸ¥å„æœåŠ¡çš„GitHub Actionså·¥ä½œæµçŠ¶æ€"
          echo "2. éªŒè¯Dockeré•œåƒæ˜¯å¦æˆåŠŸæ„å»ºå’Œæ¨é€"
          echo "3. æ›´æ–°éƒ¨ç½²ç¯å¢ƒä¸­çš„é•œåƒç‰ˆæœ¬"
          echo "4. æ‰§è¡Œéƒ¨ç½²åæµ‹è¯•"
          echo "5. æ›´æ–°æ–‡æ¡£å’Œå˜æ›´æ—¥å¿—"
          
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo
            echo "### âš ï¸ æ³¨æ„"
            echo
            echo "è¿™æ˜¯ä¸€æ¬¡æ¨¡æ‹Ÿå‘å¸ƒï¼Œæ²¡æœ‰å®é™…åˆ›å»ºæ ‡ç­¾æˆ–è§¦å‘æ„å»ºã€‚"
          fi

      - name: Check overall success
        run: |
          FAILED_SERVICES=()
          
          if [[ "${{ contains(needs.pre-check.outputs.services, 'vgo-kit') }}" == "true" && "${{ needs.release-vgo-kit.result }}" != "success" ]]; then
            FAILED_SERVICES+=("vgo-kit")
          fi
          
          if [[ "${{ contains(needs.pre-check.outputs.services, 'vgo-iam') }}" == "true" && "${{ needs.release-vgo-iam.result }}" != "success" ]]; then
            FAILED_SERVICES+=("vgo-iam")
          fi
          
          if [[ "${{ contains(needs.pre-check.outputs.services, 'vgo-gateway') }}" == "true" && "${{ needs.release-vgo-gateway.result }}" != "success" ]]; then
            FAILED_SERVICES+=("vgo-gateway")
          fi
          
          if [[ ${#FAILED_SERVICES[@]} -gt 0 ]]; then
            echo "âŒ ä»¥ä¸‹æœåŠ¡å‘å¸ƒå¤±è´¥: ${FAILED_SERVICES[*]}"
            exit 1
          else
            echo "âœ… æ‰€æœ‰æœåŠ¡å‘å¸ƒæˆåŠŸï¼"
          fi