<template><div><h1 id="æ¶æ„è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#æ¶æ„è®¾è®¡">#</a> æ¶æ„è®¾è®¡</h1>
<p>VGOå¾®æœåŠ¡é‡‡ç”¨ç°ä»£åŒ–çš„å¾®æœåŠ¡æ¶æ„è®¾è®¡ï¼Œæœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†ç³»ç»Ÿçš„æ•´ä½“æ¶æ„ã€è®¾è®¡åŸåˆ™ã€æŠ€æœ¯é€‰å‹å’Œå„ä¸ªç»„ä»¶çš„èŒè´£ã€‚</p>
<h2 id="ğŸ—ï¸-æ•´ä½“æ¶æ„" tabindex="-1"><a class="header-anchor" href="#ğŸ—ï¸-æ•´ä½“æ¶æ„">#</a> ğŸ—ï¸ æ•´ä½“æ¶æ„</h2>
<h3 id="ç³»ç»Ÿæ¶æ„å›¾" tabindex="-1"><a class="header-anchor" href="#ç³»ç»Ÿæ¶æ„å›¾">#</a> ç³»ç»Ÿæ¶æ„å›¾</h3>
<div class="language-mermaid line-numbers-mode" data-highlighter="prismjs" data-ext="mermaid"><pre v-pre><code class="language-mermaid"><span class="line"><span class="token keyword">graph</span> TB</span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"å®¢æˆ·ç«¯å±‚ (Client Layer)"</span></span>
<span class="line">        A<span class="token text string">[Webåº”ç”¨]</span></span>
<span class="line">        B<span class="token text string">[ç§»åŠ¨åº”ç”¨]</span></span>
<span class="line">        C<span class="token text string">[ç¬¬ä¸‰æ–¹åº”ç”¨]</span></span>
<span class="line">        D<span class="token text string">[CLIå·¥å…·]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"æ¥å…¥å±‚ (Gateway Layer)"</span></span>
<span class="line">        E<span class="token text string">[APIç½‘å…³]</span></span>
<span class="line">        F<span class="token text string">[è´Ÿè½½å‡è¡¡å™¨]</span></span>
<span class="line">        G<span class="token text string">[é˜²ç«å¢™/WAF]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"æœåŠ¡å±‚ (Service Layer)"</span></span>
<span class="line">        H<span class="token text string">[è®¤è¯æœåŠ¡]</span></span>
<span class="line">        I<span class="token text string">[ç”¨æˆ·ç®¡ç†æœåŠ¡]</span></span>
<span class="line">        J<span class="token text string">[ç­–ç•¥ç®¡ç†æœåŠ¡]</span></span>
<span class="line">        K<span class="token text string">[æƒé™éªŒè¯æœåŠ¡]</span></span>
<span class="line">        L<span class="token text string">[è®¿é—®å¯†é’¥æœåŠ¡]</span></span>
<span class="line">        M<span class="token text string">[åº”ç”¨ç®¡ç†æœåŠ¡]</span></span>
<span class="line">        N<span class="token text string">[å®¡è®¡æ—¥å¿—æœåŠ¡]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"æ•°æ®å±‚ (Data Layer)"</span></span>
<span class="line">        O<span class="token text string">[PostgreSQLä¸»åº“]</span></span>
<span class="line">        P<span class="token text string">[PostgreSQLä»åº“]</span></span>
<span class="line">        Q<span class="token text string">[Redisç¼“å­˜]</span></span>
<span class="line">        R<span class="token text string">[NATSæ¶ˆæ¯é˜Ÿåˆ—]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)"</span></span>
<span class="line">        S<span class="token text string">[ç›‘æ§ç³»ç»Ÿ]</span></span>
<span class="line">        T<span class="token text string">[æ—¥å¿—ç³»ç»Ÿ]</span></span>
<span class="line">        U<span class="token text string">[é…ç½®ä¸­å¿ƒ]</span></span>
<span class="line">        V<span class="token text string">[æœåŠ¡å‘ç°]</span></span>
<span class="line">        W<span class="token text string">[å®¹å™¨ç¼–æ’]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    A <span class="token arrow operator">--></span> E</span>
<span class="line">    B <span class="token arrow operator">--></span> E</span>
<span class="line">    C <span class="token arrow operator">--></span> E</span>
<span class="line">    D <span class="token arrow operator">--></span> E</span>
<span class="line">    E <span class="token arrow operator">--></span> F</span>
<span class="line">    F <span class="token arrow operator">--></span> G</span>
<span class="line">    G <span class="token arrow operator">--></span> H</span>
<span class="line">    G <span class="token arrow operator">--></span> I</span>
<span class="line">    G <span class="token arrow operator">--></span> J</span>
<span class="line">    G <span class="token arrow operator">--></span> K</span>
<span class="line">    G <span class="token arrow operator">--></span> L</span>
<span class="line">    G <span class="token arrow operator">--></span> M</span>
<span class="line">    G <span class="token arrow operator">--></span> N</span>
<span class="line">    </span>
<span class="line">    H <span class="token arrow operator">--></span> O</span>
<span class="line">    I <span class="token arrow operator">--></span> O</span>
<span class="line">    J <span class="token arrow operator">--></span> O</span>
<span class="line">    K <span class="token arrow operator">--></span> Q</span>
<span class="line">    L <span class="token arrow operator">--></span> O</span>
<span class="line">    M <span class="token arrow operator">--></span> O</span>
<span class="line">    N <span class="token arrow operator">--></span> O</span>
<span class="line">    </span>
<span class="line">    H <span class="token arrow operator">--></span> P</span>
<span class="line">    I <span class="token arrow operator">--></span> P</span>
<span class="line">    J <span class="token arrow operator">--></span> P</span>
<span class="line">    L <span class="token arrow operator">--></span> P</span>
<span class="line">    M <span class="token arrow operator">--></span> P</span>
<span class="line">    N <span class="token arrow operator">--></span> P</span>
<span class="line">    </span>
<span class="line">    H <span class="token arrow operator">--></span> R</span>
<span class="line">    I <span class="token arrow operator">--></span> R</span>
<span class="line">    J <span class="token arrow operator">--></span> R</span>
<span class="line">    K <span class="token arrow operator">--></span> R</span>
<span class="line">    L <span class="token arrow operator">--></span> R</span>
<span class="line">    M <span class="token arrow operator">--></span> R</span>
<span class="line">    N <span class="token arrow operator">--></span> R</span>
<span class="line">    </span>
<span class="line">    H <span class="token arrow operator">--></span> S</span>
<span class="line">    I <span class="token arrow operator">--></span> S</span>
<span class="line">    J <span class="token arrow operator">--></span> S</span>
<span class="line">    K <span class="token arrow operator">--></span> S</span>
<span class="line">    L <span class="token arrow operator">--></span> S</span>
<span class="line">    M <span class="token arrow operator">--></span> S</span>
<span class="line">    N <span class="token arrow operator">--></span> S</span>
<span class="line">    </span>
<span class="line">    H <span class="token arrow operator">--></span> T</span>
<span class="line">    I <span class="token arrow operator">--></span> T</span>
<span class="line">    J <span class="token arrow operator">--></span> T</span>
<span class="line">    K <span class="token arrow operator">--></span> T</span>
<span class="line">    L <span class="token arrow operator">--></span> T</span>
<span class="line">    M <span class="token arrow operator">--></span> T</span>
<span class="line">    N <span class="token arrow operator">--></span> T</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ¶æ„åˆ†å±‚" tabindex="-1"><a class="header-anchor" href="#æ¶æ„åˆ†å±‚">#</a> æ¶æ„åˆ†å±‚</h3>
<table>
<thead>
<tr>
<th>å±‚çº§</th>
<th>èŒè´£</th>
<th>æŠ€æœ¯æ ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td>å®¢æˆ·ç«¯å±‚</td>
<td>ç”¨æˆ·äº¤äº’ç•Œé¢</td>
<td>Web/Mobile/CLI</td>
</tr>
<tr>
<td>æ¥å…¥å±‚</td>
<td>æµé‡æ¥å…¥ã€è·¯ç”±ã€å®‰å…¨</td>
<td>Nginx, Envoy, Istio</td>
</tr>
<tr>
<td>æœåŠ¡å±‚</td>
<td>ä¸šåŠ¡é€»è¾‘å¤„ç†</td>
<td>Go, gRPC, HTTP</td>
</tr>
<tr>
<td>æ•°æ®å±‚</td>
<td>æ•°æ®å­˜å‚¨å’Œæ¶ˆæ¯ä¼ é€’</td>
<td>PostgreSQL, Redis, NATS</td>
</tr>
<tr>
<td>åŸºç¡€è®¾æ–½å±‚</td>
<td>è¿ç»´æ”¯æ’‘æœåŠ¡</td>
<td>Kubernetes, Prometheus, ELK</td>
</tr>
</tbody>
</table>
<h2 id="ğŸ¯-è®¾è®¡åŸåˆ™" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-è®¾è®¡åŸåˆ™">#</a> ğŸ¯ è®¾è®¡åŸåˆ™</h2>
<h3 id="_1-å•ä¸€èŒè´£åŸåˆ™-srp" tabindex="-1"><a class="header-anchor" href="#_1-å•ä¸€èŒè´£åŸåˆ™-srp">#</a> 1. å•ä¸€èŒè´£åŸåˆ™ (SRP)</h3>
<p>æ¯ä¸ªå¾®æœåŠ¡åªè´Ÿè´£ä¸€ä¸ªä¸šåŠ¡é¢†åŸŸï¼š</p>
<ul>
<li><strong>ç”¨æˆ·ç®¡ç†æœåŠ¡</strong>: ç”¨æˆ·çš„CRUDæ“ä½œ</li>
<li><strong>ç­–ç•¥ç®¡ç†æœåŠ¡</strong>: æƒé™ç­–ç•¥çš„ç®¡ç†</li>
<li><strong>æƒé™éªŒè¯æœåŠ¡</strong>: æƒé™æ£€æŸ¥å’Œå†³ç­–</li>
<li><strong>è®¿é—®å¯†é’¥æœåŠ¡</strong>: APIå¯†é’¥çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</li>
<li><strong>åº”ç”¨ç®¡ç†æœåŠ¡</strong>: åº”ç”¨æ³¨å†Œå’Œé…ç½®</li>
</ul>
<h3 id="_2-å¼€é—­åŸåˆ™-ocp" tabindex="-1"><a class="header-anchor" href="#_2-å¼€é—­åŸåˆ™-ocp">#</a> 2. å¼€é—­åŸåˆ™ (OCP)</h3>
<p>ç³»ç»Ÿå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼š</p>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// æƒé™éªŒè¯æ¥å£ï¼Œæ”¯æŒå¤šç§éªŒè¯ç­–ç•¥</span></span>
<span class="line"><span class="token keyword">type</span> PermissionChecker <span class="token keyword">interface</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">CheckPermission</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>CheckPermissionRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>CheckPermissionResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// RBACæƒé™æ£€æŸ¥å™¨</span></span>
<span class="line"><span class="token keyword">type</span> RBACChecker <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    policyRepo PolicyRepository</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ABACæƒé™æ£€æŸ¥å™¨</span></span>
<span class="line"><span class="token keyword">type</span> ABACChecker <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    ruleEngine RuleEngine</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„æƒé™æ£€æŸ¥ç­–ç•¥</span></span>
<span class="line"><span class="token keyword">type</span> CustomChecker <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    customLogic CustomLogic</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-ä¾èµ–å€’ç½®åŸåˆ™-dip" tabindex="-1"><a class="header-anchor" href="#_3-ä¾èµ–å€’ç½®åŸåˆ™-dip">#</a> 3. ä¾èµ–å€’ç½®åŸåˆ™ (DIP)</h3>
<p>é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—ï¼Œéƒ½ä¾èµ–æŠ½è±¡ï¼š</p>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// æœåŠ¡å±‚ä¾èµ–æŠ½è±¡æ¥å£</span></span>
<span class="line"><span class="token keyword">type</span> UserService <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    repo   UserRepository    <span class="token comment">// æŠ½è±¡æ¥å£</span></span>
<span class="line">    cache  CacheService     <span class="token comment">// æŠ½è±¡æ¥å£</span></span>
<span class="line">    logger Logger           <span class="token comment">// æŠ½è±¡æ¥å£</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å…·ä½“å®ç°åœ¨åŸºç¡€è®¾æ–½å±‚</span></span>
<span class="line"><span class="token keyword">type</span> PostgreSQLUserRepository <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    db <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> RedisCache <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    client <span class="token operator">*</span>redis<span class="token punctuation">.</span>Client</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-æ¥å£éš”ç¦»åŸåˆ™-isp" tabindex="-1"><a class="header-anchor" href="#_4-æ¥å£éš”ç¦»åŸåˆ™-isp">#</a> 4. æ¥å£éš”ç¦»åŸåˆ™ (ISP)</h3>
<p>å®¢æˆ·ç«¯ä¸åº”è¯¥ä¾èµ–å®ƒä¸éœ€è¦çš„æ¥å£ï¼š</p>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// ç»†ç²’åº¦æ¥å£è®¾è®¡</span></span>
<span class="line"><span class="token keyword">type</span> UserReader <span class="token keyword">interface</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">GetUser</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">ListUsers</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> opts ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> UserWriter <span class="token keyword">interface</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">CreateUser</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> user <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token builtin">error</span></span>
<span class="line">    <span class="token function">UpdateUser</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> user <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token builtin">error</span></span>
<span class="line">    <span class="token function">DeleteUser</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç»„åˆæ¥å£</span></span>
<span class="line"><span class="token keyword">type</span> UserRepository <span class="token keyword">interface</span> <span class="token punctuation">{</span></span>
<span class="line">    UserReader</span>
<span class="line">    UserWriter</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”§-æŠ€æœ¯é€‰å‹" tabindex="-1"><a class="header-anchor" href="#ğŸ”§-æŠ€æœ¯é€‰å‹">#</a> ğŸ”§ æŠ€æœ¯é€‰å‹</h2>
<h3 id="ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶" tabindex="-1"><a class="header-anchor" href="#ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶">#</a> ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶</h3>
<table>
<thead>
<tr>
<th>æŠ€æœ¯</th>
<th>ç‰ˆæœ¬</th>
<th>é€‰æ‹©ç†ç”±</th>
</tr>
</thead>
<tbody>
<tr>
<td>Go</td>
<td>1.21+</td>
<td>é«˜æ€§èƒ½ã€å¹¶å‘å‹å¥½ã€ç”Ÿæ€ä¸°å¯Œ</td>
</tr>
<tr>
<td>gRPC</td>
<td>1.58+</td>
<td>é«˜æ•ˆçš„RPCæ¡†æ¶ï¼Œæ”¯æŒå¤šè¯­è¨€</td>
</tr>
<tr>
<td>Protocol Buffers</td>
<td>3.21+</td>
<td>é«˜æ•ˆçš„åºåˆ—åŒ–åè®®</td>
</tr>
<tr>
<td>Gin</td>
<td>1.9+</td>
<td>è½»é‡çº§HTTPæ¡†æ¶</td>
</tr>
<tr>
<td>Zap</td>
<td>1.25+</td>
<td>é«˜æ€§èƒ½ç»“æ„åŒ–æ—¥å¿—</td>
</tr>
</tbody>
</table>
<h3 id="æ•°æ®å­˜å‚¨" tabindex="-1"><a class="header-anchor" href="#æ•°æ®å­˜å‚¨">#</a> æ•°æ®å­˜å‚¨</h3>
<table>
<thead>
<tr>
<th>æŠ€æœ¯</th>
<th>ç‰ˆæœ¬</th>
<th>ç”¨é€”</th>
<th>é€‰æ‹©ç†ç”±</th>
</tr>
</thead>
<tbody>
<tr>
<td>PostgreSQL</td>
<td>15+</td>
<td>ä¸»æ•°æ®åº“</td>
<td>ACIDç‰¹æ€§ã€JSONæ”¯æŒã€æ‰©å±•æ€§å¥½</td>
</tr>
<tr>
<td>Redis</td>
<td>7+</td>
<td>ç¼“å­˜ã€ä¼šè¯</td>
<td>é«˜æ€§èƒ½ã€ä¸°å¯Œçš„æ•°æ®ç»“æ„</td>
</tr>
<tr>
<td>NATS</td>
<td>2.9+</td>
<td>æ¶ˆæ¯é˜Ÿåˆ—</td>
<td>è½»é‡çº§ã€é«˜æ€§èƒ½ã€äº‘åŸç”Ÿ</td>
</tr>
</tbody>
</table>
<h3 id="åŸºç¡€è®¾æ–½" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€è®¾æ–½">#</a> åŸºç¡€è®¾æ–½</h3>
<table>
<thead>
<tr>
<th>æŠ€æœ¯</th>
<th>ç‰ˆæœ¬</th>
<th>ç”¨é€”</th>
<th>é€‰æ‹©ç†ç”±</th>
</tr>
</thead>
<tbody>
<tr>
<td>Docker</td>
<td>24+</td>
<td>å®¹å™¨åŒ–</td>
<td>æ ‡å‡†åŒ–éƒ¨ç½²ã€ç¯å¢ƒä¸€è‡´æ€§</td>
</tr>
<tr>
<td>Kubernetes</td>
<td>1.28+</td>
<td>å®¹å™¨ç¼–æ’</td>
<td>è‡ªåŠ¨åŒ–è¿ç»´ã€å¼¹æ€§ä¼¸ç¼©</td>
</tr>
<tr>
<td>Prometheus</td>
<td>2.45+</td>
<td>ç›‘æ§</td>
<td>äº‘åŸç”Ÿç›‘æ§æ ‡å‡†</td>
</tr>
<tr>
<td>Grafana</td>
<td>10+</td>
<td>å¯è§†åŒ–</td>
<td>ä¸°å¯Œçš„å›¾è¡¨å’Œä»ªè¡¨æ¿</td>
</tr>
<tr>
<td>Jaeger</td>
<td>1.49+</td>
<td>é“¾è·¯è¿½è¸ª</td>
<td>åˆ†å¸ƒå¼è¿½è¸ªæ ‡å‡†</td>
</tr>
</tbody>
</table>
<h2 id="ğŸ›ï¸-æœåŠ¡æ¶æ„" tabindex="-1"><a class="header-anchor" href="#ğŸ›ï¸-æœåŠ¡æ¶æ„">#</a> ğŸ›ï¸ æœåŠ¡æ¶æ„</h2>
<h3 id="æœåŠ¡æ‹†åˆ†ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#æœåŠ¡æ‹†åˆ†ç­–ç•¥">#</a> æœåŠ¡æ‹†åˆ†ç­–ç•¥</h3>
<h4 id="æŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†" tabindex="-1"><a class="header-anchor" href="#æŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†">#</a> æŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†</h4>
<div class="language-mermaid line-numbers-mode" data-highlighter="prismjs" data-ext="mermaid"><pre v-pre><code class="language-mermaid"><span class="line"><span class="token keyword">graph</span> LR</span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"èº«ä»½è®¤è¯åŸŸ"</span></span>
<span class="line">        A<span class="token text string">[è®¤è¯æœåŠ¡]</span></span>
<span class="line">        B<span class="token text string">[ç”¨æˆ·ç®¡ç†æœåŠ¡]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"æƒé™ç®¡ç†åŸŸ"</span></span>
<span class="line">        C<span class="token text string">[ç­–ç•¥ç®¡ç†æœåŠ¡]</span></span>
<span class="line">        D<span class="token text string">[æƒé™éªŒè¯æœåŠ¡]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"åº”ç”¨ç®¡ç†åŸŸ"</span></span>
<span class="line">        E<span class="token text string">[åº”ç”¨ç®¡ç†æœåŠ¡]</span></span>
<span class="line">        F<span class="token text string">[è®¿é—®å¯†é’¥æœåŠ¡]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"å®¡è®¡åŸŸ"</span></span>
<span class="line">        G<span class="token text string">[å®¡è®¡æ—¥å¿—æœåŠ¡]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æœåŠ¡èŒè´£çŸ©é˜µ" tabindex="-1"><a class="header-anchor" href="#æœåŠ¡èŒè´£çŸ©é˜µ">#</a> æœåŠ¡èŒè´£çŸ©é˜µ</h4>
<table>
<thead>
<tr>
<th>æœåŠ¡</th>
<th>æ ¸å¿ƒèŒè´£</th>
<th>æ•°æ®æ¨¡å‹</th>
<th>ä¾èµ–æœåŠ¡</th>
</tr>
</thead>
<tbody>
<tr>
<td>è®¤è¯æœåŠ¡</td>
<td>ç”¨æˆ·ç™»å½•ã€Tokenç®¡ç†</td>
<td>Session, Token</td>
<td>ç”¨æˆ·ç®¡ç†æœåŠ¡</td>
</tr>
<tr>
<td>ç”¨æˆ·ç®¡ç†æœåŠ¡</td>
<td>ç”¨æˆ·CRUDã€ç”¨æˆ·ä¿¡æ¯</td>
<td>User, Profile</td>
<td>-</td>
</tr>
<tr>
<td>ç­–ç•¥ç®¡ç†æœåŠ¡</td>
<td>ç­–ç•¥CRUDã€ç­–ç•¥è§£æ</td>
<td>Policy, Rule</td>
<td>-</td>
</tr>
<tr>
<td>æƒé™éªŒè¯æœåŠ¡</td>
<td>æƒé™æ£€æŸ¥ã€å†³ç­–å¼•æ“</td>
<td>Permission, Decision</td>
<td>ç­–ç•¥ç®¡ç†æœåŠ¡</td>
</tr>
<tr>
<td>åº”ç”¨ç®¡ç†æœåŠ¡</td>
<td>åº”ç”¨æ³¨å†Œã€é…ç½®ç®¡ç†</td>
<td>Application, Config</td>
<td>-</td>
</tr>
<tr>
<td>è®¿é—®å¯†é’¥æœåŠ¡</td>
<td>å¯†é’¥ç”Ÿæˆã€ç”Ÿå‘½å‘¨æœŸ</td>
<td>AccessKey, Secret</td>
<td>ç”¨æˆ·ç®¡ç†æœåŠ¡</td>
</tr>
<tr>
<td>å®¡è®¡æ—¥å¿—æœåŠ¡</td>
<td>æ“ä½œè®°å½•ã€åˆè§„å®¡è®¡</td>
<td>AuditLog, Event</td>
<td>æ‰€æœ‰æœåŠ¡</td>
</tr>
</tbody>
</table>
<h3 id="æ•°æ®ä¸€è‡´æ€§ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#æ•°æ®ä¸€è‡´æ€§ç­–ç•¥">#</a> æ•°æ®ä¸€è‡´æ€§ç­–ç•¥</h3>
<h4 id="_1-å¼ºä¸€è‡´æ€§åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#_1-å¼ºä¸€è‡´æ€§åœºæ™¯">#</a> 1. å¼ºä¸€è‡´æ€§åœºæ™¯</h4>
<p>ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ä¿è¯ACIDç‰¹æ€§ï¼š</p>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// ç”¨æˆ·åˆ›å»ºæ—¶åŒæ—¶åˆ›å»ºé»˜è®¤ç­–ç•¥</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>UserService<span class="token punctuation">)</span> <span class="token function">CreateUserWithDefaultPolicy</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>CreateUserRequest<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> s<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">WithTransaction</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>tx <span class="token operator">*</span>sql<span class="token punctuation">.</span>Tx<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// åˆ›å»ºç”¨æˆ·</span></span>
<span class="line">        user<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>userRepo<span class="token punctuation">.</span><span class="token function">CreateWithTx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> tx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>User<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// åˆ›å»ºé»˜è®¤ç­–ç•¥</span></span>
<span class="line">        policy <span class="token operator">:=</span> <span class="token operator">&amp;</span>Policy<span class="token punctuation">{</span></span>
<span class="line">            UserID<span class="token punctuation">:</span> user<span class="token punctuation">.</span>ID<span class="token punctuation">,</span></span>
<span class="line">            Name<span class="token punctuation">:</span>   <span class="token string">"default"</span><span class="token punctuation">,</span></span>
<span class="line">            Rules<span class="token punctuation">:</span>  defaultRules<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> s<span class="token punctuation">.</span>policyRepo<span class="token punctuation">.</span><span class="token function">CreateWithTx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> tx<span class="token punctuation">,</span> policy<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-æœ€ç»ˆä¸€è‡´æ€§åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#_2-æœ€ç»ˆä¸€è‡´æ€§åœºæ™¯">#</a> 2. æœ€ç»ˆä¸€è‡´æ€§åœºæ™¯</h4>
<p>ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¶æ„ï¼š</p>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// ç”¨æˆ·çŠ¶æ€å˜æ›´äº‹ä»¶</span></span>
<span class="line"><span class="token keyword">type</span> UserStatusChangedEvent <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    UserID    <span class="token builtin">string</span>    <span class="token string">`json:"user_id"`</span></span>
<span class="line">    OldStatus <span class="token builtin">string</span>    <span class="token string">`json:"old_status"`</span></span>
<span class="line">    NewStatus <span class="token builtin">string</span>    <span class="token string">`json:"new_status"`</span></span>
<span class="line">    Timestamp time<span class="token punctuation">.</span>Time <span class="token string">`json:"timestamp"`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å‘å¸ƒäº‹ä»¶</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>UserService<span class="token punctuation">)</span> <span class="token function">UpdateUserStatus</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> userID<span class="token punctuation">,</span> status <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ›´æ–°ç”¨æˆ·çŠ¶æ€</span></span>
<span class="line">    err <span class="token operator">:=</span> s<span class="token punctuation">.</span>repo<span class="token punctuation">.</span><span class="token function">UpdateStatus</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> userID<span class="token punctuation">,</span> status<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å‘å¸ƒçŠ¶æ€å˜æ›´äº‹ä»¶</span></span>
<span class="line">    event <span class="token operator">:=</span> UserStatusChangedEvent<span class="token punctuation">{</span></span>
<span class="line">        UserID<span class="token punctuation">:</span>    userID<span class="token punctuation">,</span></span>
<span class="line">        NewStatus<span class="token punctuation">:</span> status<span class="token punctuation">,</span></span>
<span class="line">        Timestamp<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> s<span class="token punctuation">.</span>eventBus<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"user.status.changed"</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å…¶ä»–æœåŠ¡è®¢é˜…äº‹ä»¶</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>PolicyService<span class="token punctuation">)</span> <span class="token function">HandleUserStatusChanged</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> event UserStatusChangedEvent<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> event<span class="token punctuation">.</span>NewStatus <span class="token operator">==</span> <span class="token string">"disabled"</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ç¦ç”¨ç”¨æˆ·çš„æ‰€æœ‰ç­–ç•¥</span></span>
<span class="line">        <span class="token keyword">return</span> s<span class="token punctuation">.</span>repo<span class="token punctuation">.</span><span class="token function">DisableUserPolicies</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> event<span class="token punctuation">.</span>UserID<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”„-é€šä¿¡æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#ğŸ”„-é€šä¿¡æ¨¡å¼">#</a> ğŸ”„ é€šä¿¡æ¨¡å¼</h2>
<h3 id="_1-åŒæ­¥é€šä¿¡-grpc" tabindex="-1"><a class="header-anchor" href="#_1-åŒæ­¥é€šä¿¡-grpc">#</a> 1. åŒæ­¥é€šä¿¡ (gRPC)</h3>
<p>ç”¨äºéœ€è¦ç«‹å³å“åº”çš„åœºæ™¯ï¼š</p>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// æƒé™æ£€æŸ¥ - åŒæ­¥è°ƒç”¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>AuthMiddleware<span class="token punctuation">)</span> <span class="token function">CheckPermission</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> userID<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> action <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    req <span class="token operator">:=</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>CheckPermissionRequest<span class="token punctuation">{</span></span>
<span class="line">        UserId<span class="token punctuation">:</span>   userID<span class="token punctuation">,</span></span>
<span class="line">        Resource<span class="token punctuation">:</span> resource<span class="token punctuation">,</span></span>
<span class="line">        Action<span class="token punctuation">:</span>   action<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>permissionClient<span class="token punctuation">.</span><span class="token function">CheckPermission</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>resp<span class="token punctuation">.</span>Allowed <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"permission denied"</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-å¼‚æ­¥é€šä¿¡-æ¶ˆæ¯é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#_2-å¼‚æ­¥é€šä¿¡-æ¶ˆæ¯é˜Ÿåˆ—">#</a> 2. å¼‚æ­¥é€šä¿¡ (æ¶ˆæ¯é˜Ÿåˆ—)</h3>
<p>ç”¨äºäº‹ä»¶é€šçŸ¥å’Œåå°å¤„ç†ï¼š</p>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// å®¡è®¡æ—¥å¿— - å¼‚æ­¥å¤„ç†</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>AuditService<span class="token punctuation">)</span> <span class="token function">LogUserAction</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> action UserAction<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    event <span class="token operator">:=</span> AuditEvent<span class="token punctuation">{</span></span>
<span class="line">        UserID<span class="token punctuation">:</span>    action<span class="token punctuation">.</span>UserID<span class="token punctuation">,</span></span>
<span class="line">        Action<span class="token punctuation">:</span>    action<span class="token punctuation">.</span>Type<span class="token punctuation">,</span></span>
<span class="line">        Resource<span class="token punctuation">:</span>  action<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span></span>
<span class="line">        Timestamp<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        Metadata<span class="token punctuation">:</span>  action<span class="token punctuation">.</span>Metadata<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å¼‚æ­¥å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—</span></span>
<span class="line">    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>messageQueue<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><span class="token string">"audit.user.action"</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            s<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Failed to publish audit event"</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-è¯·æ±‚-å“åº”æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_3-è¯·æ±‚-å“åº”æ¨¡å¼">#</a> 3. è¯·æ±‚-å“åº”æ¨¡å¼</h3>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>UserService<span class="token punctuation">)</span> <span class="token function">GetUser</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>pb<span class="token punctuation">.</span>GetUserRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>pb<span class="token punctuation">.</span>GetUserResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å‚æ•°éªŒè¯</span></span>
<span class="line">    <span class="token keyword">if</span> req<span class="token punctuation">.</span>UserId <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>InvalidArgument<span class="token punctuation">,</span> <span class="token string">"user_id is required"</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ä»ç¼“å­˜è·å–</span></span>
<span class="line">    <span class="token keyword">if</span> user<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">GetUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>UserId<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>GetUserResponse<span class="token punctuation">{</span>User<span class="token punctuation">:</span> user<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ä»æ•°æ®åº“è·å–</span></span>
<span class="line">    user<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>repo<span class="token punctuation">.</span><span class="token function">GetByID</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>UserId<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> repository<span class="token punctuation">.</span>ErrNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>NotFound<span class="token punctuation">,</span> <span class="token string">"user not found"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Internal<span class="token punctuation">,</span> <span class="token string">"failed to get user: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ›´æ–°ç¼“å­˜</span></span>
<span class="line">    <span class="token keyword">go</span> s<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">SetUser</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>GetUserResponse<span class="token punctuation">{</span>User<span class="token punctuation">:</span> user<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ—„ï¸-æ•°æ®æ¶æ„" tabindex="-1"><a class="header-anchor" href="#ğŸ—„ï¸-æ•°æ®æ¶æ„">#</a> ğŸ—„ï¸ æ•°æ®æ¶æ„</h2>
<h3 id="æ•°æ®åº“è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#æ•°æ®åº“è®¾è®¡">#</a> æ•°æ®åº“è®¾è®¡</h3>
<h4 id="_1-ç”¨æˆ·ç®¡ç†æ•°æ®æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#_1-ç”¨æˆ·ç®¡ç†æ•°æ®æ¨¡å‹">#</a> 1. ç”¨æˆ·ç®¡ç†æ•°æ®æ¨¡å‹</h4>
<div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre v-pre><code class="language-sql"><span class="line"><span class="token comment">-- ç”¨æˆ·è¡¨</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> users <span class="token punctuation">(</span></span>
<span class="line">    id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    username <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    password_hash <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">status</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'active'</span><span class="token punctuation">,</span></span>
<span class="line">    profile JSONB<span class="token punctuation">,</span></span>
<span class="line">    created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    deleted_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE</span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- ç”¨æˆ·è§’è‰²å…³è”è¡¨</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_roles <span class="token punctuation">(</span></span>
<span class="line">    id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    user_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    role_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> roles<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    granted_by UUID <span class="token keyword">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    granted_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    expires_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE<span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> role_id<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-ç­–ç•¥ç®¡ç†æ•°æ®æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#_2-ç­–ç•¥ç®¡ç†æ•°æ®æ¨¡å‹">#</a> 2. ç­–ç•¥ç®¡ç†æ•°æ®æ¨¡å‹</h4>
<div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre v-pre><code class="language-sql"><span class="line"><span class="token comment">-- ç­–ç•¥è¡¨</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> policies <span class="token punctuation">(</span></span>
<span class="line">    id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    description <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">    document JSONB <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    version <span class="token keyword">INTEGER</span> <span class="token keyword">DEFAULT</span> <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">status</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'active'</span><span class="token punctuation">,</span></span>
<span class="line">    created_by UUID <span class="token keyword">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- ç­–ç•¥é™„åŠ è¡¨</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> policy_attachments <span class="token punctuation">(</span></span>
<span class="line">    id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    policy_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> policies<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    principal_type <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token comment">-- 'user', 'role', 'group'</span></span>
<span class="line">    principal_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    attached_by UUID <span class="token keyword">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    attached_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>policy_id<span class="token punctuation">,</span> principal_type<span class="token punctuation">,</span> principal_id<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-è®¿é—®å¯†é’¥æ•°æ®æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#_3-è®¿é—®å¯†é’¥æ•°æ®æ¨¡å‹">#</a> 3. è®¿é—®å¯†é’¥æ•°æ®æ¨¡å‹</h4>
<div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre v-pre><code class="language-sql"><span class="line"><span class="token comment">-- è®¿é—®å¯†é’¥è¡¨</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> access_keys <span class="token punctuation">(</span></span>
<span class="line">    id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    access_key_id <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    secret_access_key_hash <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    user_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">status</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'active'</span><span class="token punctuation">,</span></span>
<span class="line">    description <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">    last_used_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE<span class="token punctuation">,</span></span>
<span class="line">    expires_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE<span class="token punctuation">,</span></span>
<span class="line">    created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- è®¿é—®å¯†é’¥ä½¿ç”¨è®°å½•è¡¨</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> access_key_usage <span class="token punctuation">(</span></span>
<span class="line">    id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    access_key_id <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> access_keys<span class="token punctuation">(</span>access_key_id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    service <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">action</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    resource <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    client_ip INET<span class="token punctuation">,</span></span>
<span class="line">    user_agent <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">    success <span class="token keyword">BOOLEAN</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    error_message <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">    created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ç¼“å­˜ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜ç­–ç•¥">#</a> ç¼“å­˜ç­–ç•¥</h3>
<h4 id="_1-å¤šçº§ç¼“å­˜æ¶æ„" tabindex="-1"><a class="header-anchor" href="#_1-å¤šçº§ç¼“å­˜æ¶æ„">#</a> 1. å¤šçº§ç¼“å­˜æ¶æ„</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// ç¼“å­˜æ¥å£</span></span>
<span class="line"><span class="token keyword">type</span> CacheService <span class="token keyword">interface</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">Set</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> ttl time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token builtin">error</span></span>
<span class="line">    <span class="token function">Delete</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span></span>
<span class="line">    <span class="token function">Exists</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å¤šçº§ç¼“å­˜å®ç°</span></span>
<span class="line"><span class="token keyword">type</span> MultiLevelCache <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    l1Cache <span class="token operator">*</span>sync<span class="token punctuation">.</span>Map        <span class="token comment">// å†…å­˜ç¼“å­˜</span></span>
<span class="line">    l2Cache <span class="token operator">*</span>redis<span class="token punctuation">.</span>Client    <span class="token comment">// Redisç¼“å­˜</span></span>
<span class="line">    l3Cache Database         <span class="token comment">// æ•°æ®åº“</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>MultiLevelCache<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// L1: å†…å­˜ç¼“å­˜</span></span>
<span class="line">    <span class="token keyword">if</span> value<span class="token punctuation">,</span> ok <span class="token operator">:=</span> c<span class="token punctuation">.</span>l1Cache<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// L2: Redisç¼“å­˜</span></span>
<span class="line">    value<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>l2Cache<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// å›å¡«L1ç¼“å­˜</span></span>
<span class="line">        c<span class="token punctuation">.</span>l1Cache<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> value<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// L3: æ•°æ®åº“</span></span>
<span class="line">    value<span class="token punctuation">,</span> err <span class="token operator">=</span> c<span class="token punctuation">.</span>l3Cache<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å›å¡«ç¼“å­˜</span></span>
<span class="line">    c<span class="token punctuation">.</span>l1Cache<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span>
<span class="line">    c<span class="token punctuation">.</span>l2Cache<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> value<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-ç¼“å­˜æ›´æ–°ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#_2-ç¼“å­˜æ›´æ–°ç­–ç•¥">#</a> 2. ç¼“å­˜æ›´æ–°ç­–ç•¥</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// å†™å…¥æ—¶æ›´æ–°ç¼“å­˜</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>UserService<span class="token punctuation">)</span> <span class="token function">UpdateUser</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> user <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ›´æ–°æ•°æ®åº“</span></span>
<span class="line">    err <span class="token operator">:=</span> s<span class="token punctuation">.</span>repo<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ›´æ–°ç¼“å­˜</span></span>
<span class="line">    cacheKey <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"user:%s"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span></span>
<span class="line">    userData<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å¼‚æ­¥æ›´æ–°ç¼“å­˜ï¼Œé¿å…å½±å“ä¸»æµç¨‹</span></span>
<span class="line">    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cacheKey<span class="token punctuation">,</span> userData<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            s<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Failed to update cache"</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç¼“å­˜å¤±æ•ˆç­–ç•¥</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>UserService<span class="token punctuation">)</span> <span class="token function">InvalidateUserCache</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> userID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    keys <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"user:%s"</span><span class="token punctuation">,</span> userID<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"user:profile:%s"</span><span class="token punctuation">,</span> userID<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"user:permissions:%s"</span><span class="token punctuation">,</span> userID<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> key <span class="token operator">:=</span> <span class="token keyword">range</span> keys <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            s<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Failed to delete cache key"</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”’-å®‰å…¨æ¶æ„" tabindex="-1"><a class="header-anchor" href="#ğŸ”’-å®‰å…¨æ¶æ„">#</a> ğŸ”’ å®‰å…¨æ¶æ„</h2>
<h3 id="è®¤è¯æµç¨‹" tabindex="-1"><a class="header-anchor" href="#è®¤è¯æµç¨‹">#</a> è®¤è¯æµç¨‹</h3>
<div class="language-mermaid line-numbers-mode" data-highlighter="prismjs" data-ext="mermaid"><pre v-pre><code class="language-mermaid"><span class="line"><span class="token keyword">sequenceDiagram</span></span>
<span class="line">    <span class="token keyword">participant</span> C as å®¢æˆ·ç«¯</span>
<span class="line">    <span class="token keyword">participant</span> G as APIç½‘å…³</span>
<span class="line">    <span class="token keyword">participant</span> A as è®¤è¯æœåŠ¡</span>
<span class="line">    <span class="token keyword">participant</span> U as ç”¨æˆ·æœåŠ¡</span>
<span class="line">    <span class="token keyword">participant</span> R as Redis</span>
<span class="line">    </span>
<span class="line">    C<span class="token arrow operator">->></span>G<span class="token operator">:</span> ç™»å½•è¯·æ±‚ <span class="token text string">(username/password)</span></span>
<span class="line">    G<span class="token arrow operator">->></span>A<span class="token operator">:</span> è½¬å‘è®¤è¯è¯·æ±‚</span>
<span class="line">    A<span class="token arrow operator">->></span>U<span class="token operator">:</span> éªŒè¯ç”¨æˆ·å‡­æ®</span>
<span class="line">    U<span class="token arrow operator">-->></span>A<span class="token operator">:</span> è¿”å›ç”¨æˆ·ä¿¡æ¯</span>
<span class="line">    A<span class="token arrow operator">->></span>R<span class="token operator">:</span> åˆ›å»ºä¼šè¯</span>
<span class="line">    A<span class="token arrow operator">->></span>A<span class="token operator">:</span> ç”ŸæˆJWT Token</span>
<span class="line">    A<span class="token arrow operator">-->></span>G<span class="token operator">:</span> è¿”å›Token</span>
<span class="line">    G<span class="token arrow operator">-->></span>C<span class="token operator">:</span> è¿”å›è®¤è¯ç»“æœ</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">Note over</span> C,R<span class="token operator">:</span> åç»­APIè°ƒç”¨</span>
<span class="line">    C<span class="token arrow operator">->></span>G<span class="token operator">:</span> APIè¯·æ±‚ <span class="token text string">(Bearer Token)</span></span>
<span class="line">    G<span class="token arrow operator">->></span>G<span class="token operator">:</span> éªŒè¯JWT Token</span>
<span class="line">    G<span class="token arrow operator">->></span>A<span class="token operator">:</span> æ£€æŸ¥ä¼šè¯çŠ¶æ€</span>
<span class="line">    A<span class="token arrow operator">->></span>R<span class="token operator">:</span> æŸ¥è¯¢ä¼šè¯</span>
<span class="line">    R<span class="token arrow operator">-->></span>A<span class="token operator">:</span> è¿”å›ä¼šè¯ä¿¡æ¯</span>
<span class="line">    A<span class="token arrow operator">-->></span>G<span class="token operator">:</span> ä¼šè¯æœ‰æ•ˆ</span>
<span class="line">    G<span class="token arrow operator">->></span>G<span class="token operator">:</span> æå–ç”¨æˆ·ä¿¡æ¯</span>
<span class="line">    G<span class="token arrow operator">->></span>+<span class="token operator">:</span> è½¬å‘åˆ°ç›®æ ‡æœåŠ¡</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æˆæƒæµç¨‹" tabindex="-1"><a class="header-anchor" href="#æˆæƒæµç¨‹">#</a> æˆæƒæµç¨‹</h3>
<div class="language-mermaid line-numbers-mode" data-highlighter="prismjs" data-ext="mermaid"><pre v-pre><code class="language-mermaid"><span class="line"><span class="token keyword">sequenceDiagram</span></span>
<span class="line">    <span class="token keyword">participant</span> C as å®¢æˆ·ç«¯</span>
<span class="line">    <span class="token keyword">participant</span> G as APIç½‘å…³</span>
<span class="line">    <span class="token keyword">participant</span> P as æƒé™æœåŠ¡</span>
<span class="line">    <span class="token keyword">participant</span> S as ç­–ç•¥æœåŠ¡</span>
<span class="line">    <span class="token keyword">participant</span> Cache as Redisç¼“å­˜</span>
<span class="line">    </span>
<span class="line">    C<span class="token arrow operator">->></span>G<span class="token operator">:</span> APIè¯·æ±‚ <span class="token text string">(å·²è®¤è¯)</span></span>
<span class="line">    G<span class="token arrow operator">->></span>P<span class="token operator">:</span> æƒé™æ£€æŸ¥è¯·æ±‚</span>
<span class="line">    P<span class="token arrow operator">->></span>Cache<span class="token operator">:</span> æŸ¥è¯¢æƒé™ç¼“å­˜</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">alt</span> ç¼“å­˜å‘½ä¸­</span>
<span class="line">        Cache<span class="token arrow operator">-->></span>P<span class="token operator">:</span> è¿”å›æƒé™ç»“æœ</span>
<span class="line">    <span class="token keyword">else</span> ç¼“å­˜æœªå‘½ä¸­</span>
<span class="line">        P<span class="token arrow operator">->></span>S<span class="token operator">:</span> è·å–ç”¨æˆ·ç­–ç•¥</span>
<span class="line">        S<span class="token arrow operator">-->></span>P<span class="token operator">:</span> è¿”å›ç­–ç•¥åˆ—è¡¨</span>
<span class="line">        P<span class="token arrow operator">->></span>P<span class="token operator">:</span> æ‰§è¡Œæƒé™å†³ç­–</span>
<span class="line">        P<span class="token arrow operator">->></span>Cache<span class="token operator">:</span> ç¼“å­˜æƒé™ç»“æœ</span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    P<span class="token arrow operator">-->></span>G<span class="token operator">:</span> è¿”å›æƒé™å†³ç­–</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">alt</span> æƒé™å…è®¸</span>
<span class="line">        G<span class="token arrow operator">->></span>+<span class="token operator">:</span> è½¬å‘åˆ°ç›®æ ‡æœåŠ¡</span>
<span class="line">    <span class="token keyword">else</span> æƒé™æ‹’ç»</span>
<span class="line">        G<span class="token arrow operator">-->></span>C<span class="token operator">:</span> è¿”å›403é”™è¯¯</span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“Š-ç›‘æ§æ¶æ„" tabindex="-1"><a class="header-anchor" href="#ğŸ“Š-ç›‘æ§æ¶æ„">#</a> ğŸ“Š ç›‘æ§æ¶æ„</h2>
<h3 id="ç›‘æ§ä½“ç³»" tabindex="-1"><a class="header-anchor" href="#ç›‘æ§ä½“ç³»">#</a> ç›‘æ§ä½“ç³»</h3>
<div class="language-mermaid line-numbers-mode" data-highlighter="prismjs" data-ext="mermaid"><pre v-pre><code class="language-mermaid"><span class="line"><span class="token keyword">graph</span> TB</span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"åº”ç”¨å±‚ç›‘æ§"</span></span>
<span class="line">        A<span class="token text string">[ä¸šåŠ¡æŒ‡æ ‡]</span></span>
<span class="line">        B<span class="token text string">[æ€§èƒ½æŒ‡æ ‡]</span></span>
<span class="line">        C<span class="token text string">[é”™è¯¯æŒ‡æ ‡]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"åŸºç¡€è®¾æ–½ç›‘æ§"</span></span>
<span class="line">        D<span class="token text string">[ç³»ç»ŸæŒ‡æ ‡]</span></span>
<span class="line">        E<span class="token text string">[ç½‘ç»œæŒ‡æ ‡]</span></span>
<span class="line">        F<span class="token text string">[å­˜å‚¨æŒ‡æ ‡]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"æ—¥å¿—ç›‘æ§"</span></span>
<span class="line">        G<span class="token text string">[åº”ç”¨æ—¥å¿—]</span></span>
<span class="line">        H<span class="token text string">[è®¿é—®æ—¥å¿—]</span></span>
<span class="line">        I<span class="token text string">[é”™è¯¯æ—¥å¿—]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"é“¾è·¯è¿½è¸ª"</span></span>
<span class="line">        J<span class="token text string">[è¯·æ±‚è¿½è¸ª]</span></span>
<span class="line">        K<span class="token text string">[æœåŠ¡ä¾èµ–]</span></span>
<span class="line">        L<span class="token text string">[æ€§èƒ½åˆ†æ]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"æ•°æ®æ”¶é›†"</span></span>
<span class="line">        M<span class="token text string">[Prometheus]</span></span>
<span class="line">        N<span class="token text string">[Jaeger]</span></span>
<span class="line">        O<span class="token text string">[Fluentd]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"æ•°æ®å­˜å‚¨"</span></span>
<span class="line">        P<span class="token text string">[æ—¶åºæ•°æ®åº“]</span></span>
<span class="line">        Q<span class="token text string">[é“¾è·¯æ•°æ®åº“]</span></span>
<span class="line">        R<span class="token text string">[æ—¥å¿—å­˜å‚¨]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"å¯è§†åŒ–"</span></span>
<span class="line">        S<span class="token text string">[Grafana]</span></span>
<span class="line">        T<span class="token text string">[Jaeger UI]</span></span>
<span class="line">        U<span class="token text string">[Kibana]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    A <span class="token arrow operator">--></span> M</span>
<span class="line">    B <span class="token arrow operator">--></span> M</span>
<span class="line">    C <span class="token arrow operator">--></span> M</span>
<span class="line">    D <span class="token arrow operator">--></span> M</span>
<span class="line">    E <span class="token arrow operator">--></span> M</span>
<span class="line">    F <span class="token arrow operator">--></span> M</span>
<span class="line">    </span>
<span class="line">    G <span class="token arrow operator">--></span> O</span>
<span class="line">    H <span class="token arrow operator">--></span> O</span>
<span class="line">    I <span class="token arrow operator">--></span> O</span>
<span class="line">    </span>
<span class="line">    J <span class="token arrow operator">--></span> N</span>
<span class="line">    K <span class="token arrow operator">--></span> N</span>
<span class="line">    L <span class="token arrow operator">--></span> N</span>
<span class="line">    </span>
<span class="line">    M <span class="token arrow operator">--></span> P</span>
<span class="line">    N <span class="token arrow operator">--></span> Q</span>
<span class="line">    O <span class="token arrow operator">--></span> R</span>
<span class="line">    </span>
<span class="line">    P <span class="token arrow operator">--></span> S</span>
<span class="line">    Q <span class="token arrow operator">--></span> T</span>
<span class="line">    R <span class="token arrow operator">--></span> U</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æŒ‡æ ‡ä½“ç³»" tabindex="-1"><a class="header-anchor" href="#æŒ‡æ ‡ä½“ç³»">#</a> æŒ‡æ ‡ä½“ç³»</h3>
<h4 id="_1-ä¸šåŠ¡æŒ‡æ ‡" tabindex="-1"><a class="header-anchor" href="#_1-ä¸šåŠ¡æŒ‡æ ‡">#</a> 1. ä¸šåŠ¡æŒ‡æ ‡</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// ä¸šåŠ¡æŒ‡æ ‡å®šä¹‰</span></span>
<span class="line"><span class="token keyword">var</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token comment">// ç”¨æˆ·ç›¸å…³æŒ‡æ ‡</span></span>
<span class="line">    userRegistrations <span class="token operator">=</span> prometheus<span class="token punctuation">.</span><span class="token function">NewCounterVec</span><span class="token punctuation">(</span></span>
<span class="line">        prometheus<span class="token punctuation">.</span>CounterOpts<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span> <span class="token string">"vgo_user_registrations_total"</span><span class="token punctuation">,</span></span>
<span class="line">            Help<span class="token punctuation">:</span> <span class="token string">"Total number of user registrations"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¤è¯ç›¸å…³æŒ‡æ ‡</span></span>
<span class="line">    authenticationAttempts <span class="token operator">=</span> prometheus<span class="token punctuation">.</span><span class="token function">NewCounterVec</span><span class="token punctuation">(</span></span>
<span class="line">        prometheus<span class="token punctuation">.</span>CounterOpts<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span> <span class="token string">"vgo_authentication_attempts_total"</span><span class="token punctuation">,</span></span>
<span class="line">            Help<span class="token punctuation">:</span> <span class="token string">"Total number of authentication attempts"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"method"</span><span class="token punctuation">,</span> <span class="token string">"status"</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æƒé™æ£€æŸ¥æŒ‡æ ‡</span></span>
<span class="line">    permissionChecks <span class="token operator">=</span> prometheus<span class="token punctuation">.</span><span class="token function">NewCounterVec</span><span class="token punctuation">(</span></span>
<span class="line">        prometheus<span class="token punctuation">.</span>CounterOpts<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span> <span class="token string">"vgo_permission_checks_total"</span><span class="token punctuation">,</span></span>
<span class="line">            Help<span class="token punctuation">:</span> <span class="token string">"Total number of permission checks"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"resource"</span><span class="token punctuation">,</span> <span class="token string">"action"</span><span class="token punctuation">,</span> <span class="token string">"result"</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// APIè°ƒç”¨æŒ‡æ ‡</span></span>
<span class="line">    apiRequests <span class="token operator">=</span> prometheus<span class="token punctuation">.</span><span class="token function">NewCounterVec</span><span class="token punctuation">(</span></span>
<span class="line">        prometheus<span class="token punctuation">.</span>CounterOpts<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span> <span class="token string">"vgo_api_requests_total"</span><span class="token punctuation">,</span></span>
<span class="line">            Help<span class="token punctuation">:</span> <span class="token string">"Total number of API requests"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"method"</span><span class="token punctuation">,</span> <span class="token string">"endpoint"</span><span class="token punctuation">,</span> <span class="token string">"status"</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å“åº”æ—¶é—´æŒ‡æ ‡</span></span>
<span class="line">    apiDuration <span class="token operator">=</span> prometheus<span class="token punctuation">.</span><span class="token function">NewHistogramVec</span><span class="token punctuation">(</span></span>
<span class="line">        prometheus<span class="token punctuation">.</span>HistogramOpts<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span>    <span class="token string">"vgo_api_duration_seconds"</span><span class="token punctuation">,</span></span>
<span class="line">            Help<span class="token punctuation">:</span>    <span class="token string">"API request duration in seconds"</span><span class="token punctuation">,</span></span>
<span class="line">            Buckets<span class="token punctuation">:</span> prometheus<span class="token punctuation">.</span>DefBuckets<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"method"</span><span class="token punctuation">,</span> <span class="token string">"endpoint"</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-ç³»ç»ŸæŒ‡æ ‡" tabindex="-1"><a class="header-anchor" href="#_2-ç³»ç»ŸæŒ‡æ ‡">#</a> 2. ç³»ç»ŸæŒ‡æ ‡</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// ç³»ç»ŸæŒ‡æ ‡æ”¶é›†</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>MetricsCollector<span class="token punctuation">)</span> <span class="token function">CollectSystemMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// CPUä½¿ç”¨ç‡</span></span>
<span class="line">    cpuUsage<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> cpu<span class="token punctuation">.</span><span class="token function">Percent</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span></span>
<span class="line">    cpuUsageGauge<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>cpuUsage<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å†…å­˜ä½¿ç”¨ç‡</span></span>
<span class="line">    memInfo<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> mem<span class="token punctuation">.</span><span class="token function">VirtualMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    memoryUsageGauge<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>memInfo<span class="token punctuation">.</span>UsedPercent<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç£ç›˜ä½¿ç”¨ç‡</span></span>
<span class="line">    diskInfo<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> disk<span class="token punctuation">.</span><span class="token function">Usage</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span></span>
<span class="line">    diskUsageGauge<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>diskInfo<span class="token punctuation">.</span>UsedPercent<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç½‘ç»œæµé‡</span></span>
<span class="line">    netInfo<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">IOCounters</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>netInfo<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        networkBytesReceivedCounter<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>netInfo<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>BytesRecv<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        networkBytesSentCounter<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>netInfo<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>BytesSent<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// Goroutineæ•°é‡</span></span>
<span class="line">    goroutineGauge<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>runtime<span class="token punctuation">.</span><span class="token function">NumGoroutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// GCç»Ÿè®¡</span></span>
<span class="line">    <span class="token keyword">var</span> gcStats runtime<span class="token punctuation">.</span>MemStats</span>
<span class="line">    runtime<span class="token punctuation">.</span><span class="token function">ReadMemStats</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcStats<span class="token punctuation">)</span></span>
<span class="line">    gcDurationGauge<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>gcStats<span class="token punctuation">.</span>PauseTotalNs<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1e9</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“š-ç›¸å…³æ–‡æ¡£" tabindex="-1"><a class="header-anchor" href="#ğŸ“š-ç›¸å…³æ–‡æ¡£">#</a> ğŸ“š ç›¸å…³æ–‡æ¡£</h2>
<ul>
<li><RouteLink to="/development/">å¼€å‘æŒ‡å—</RouteLink></li>
<li><RouteLink to="/development/testing.html">æµ‹è¯•æŒ‡å—</RouteLink></li>
<li><RouteLink to="/development/debugging.html">è°ƒè¯•æŒ‡å—</RouteLink></li>
<li><RouteLink to="/development/performance.html">æ€§èƒ½ä¼˜åŒ–</RouteLink></li>
<li><RouteLink to="/api/">APIæ–‡æ¡£</RouteLink></li>
<li><RouteLink to="/deployment/">éƒ¨ç½²æŒ‡å—</RouteLink></li>
</ul>
</div></template>


