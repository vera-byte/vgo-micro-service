<template><div><h1 id="è°ƒè¯•æŒ‡å—" tabindex="-1"><a class="header-anchor" href="#è°ƒè¯•æŒ‡å—">#</a> è°ƒè¯•æŒ‡å—</h1>
<p>æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†VGOå¾®æœåŠ¡çš„è°ƒè¯•æŠ€å·§ã€å·¥å…·ä½¿ç”¨å’Œé—®é¢˜æ’æŸ¥æ–¹æ³•ã€‚</p>
<h2 id="ğŸ”-è°ƒè¯•ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#ğŸ”-è°ƒè¯•ç­–ç•¥">#</a> ğŸ” è°ƒè¯•ç­–ç•¥</h2>
<h3 id="è°ƒè¯•å±‚æ¬¡" tabindex="-1"><a class="header-anchor" href="#è°ƒè¯•å±‚æ¬¡">#</a> è°ƒè¯•å±‚æ¬¡</h3>
<div class="language-mermaid line-numbers-mode" data-highlighter="prismjs" data-ext="mermaid"><pre v-pre><code class="language-mermaid"><span class="line"><span class="token keyword">graph</span> TB</span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"è°ƒè¯•å±‚æ¬¡"</span></span>
<span class="line">        A<span class="token text string">["åº”ç”¨å±‚è°ƒè¯•&lt;br/>ä¸šåŠ¡é€»è¾‘ã€APIæ¥å£"]</span></span>
<span class="line">        B<span class="token text string">["æœåŠ¡å±‚è°ƒè¯•&lt;br/>æœåŠ¡é—´é€šä¿¡ã€æ•°æ®æµ"]</span></span>
<span class="line">        C<span class="token text string">["åŸºç¡€è®¾æ–½å±‚è°ƒè¯•&lt;br/>æ•°æ®åº“ã€ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—"]</span></span>
<span class="line">        D<span class="token text string">["ç³»ç»Ÿå±‚è°ƒè¯•&lt;br/>ç½‘ç»œã€å­˜å‚¨ã€æ€§èƒ½"]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    A <span class="token arrow operator">--></span> B</span>
<span class="line">    B <span class="token arrow operator">--></span> C</span>
<span class="line">    C <span class="token arrow operator">--></span> D</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">style</span> A <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#e1f5fe</span></span>
<span class="line">    <span class="token keyword">style</span> B <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#f3e5f5</span></span>
<span class="line">    <span class="token keyword">style</span> C <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#fff3e0</span></span>
<span class="line">    <span class="token keyword">style</span> D <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#f1f8e9</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è°ƒè¯•æµç¨‹" tabindex="-1"><a class="header-anchor" href="#è°ƒè¯•æµç¨‹">#</a> è°ƒè¯•æµç¨‹</h3>
<ol>
<li><strong>é—®é¢˜è¯†åˆ«</strong> - ç¡®å®šé—®é¢˜çš„ç—‡çŠ¶å’Œå½±å“èŒƒå›´</li>
<li><strong>ä¿¡æ¯æ”¶é›†</strong> - æ”¶é›†æ—¥å¿—ã€æŒ‡æ ‡å’Œè¿½è¸ªä¿¡æ¯</li>
<li><strong>å‡è®¾å½¢æˆ</strong> - åŸºäºä¿¡æ¯åˆ†æå¯èƒ½çš„åŸå› </li>
<li><strong>éªŒè¯æµ‹è¯•</strong> - é€šè¿‡å®éªŒéªŒè¯å‡è®¾</li>
<li><strong>é—®é¢˜ä¿®å¤</strong> - å®æ–½è§£å†³æ–¹æ¡ˆ</li>
<li><strong>éªŒè¯ä¿®å¤</strong> - ç¡®è®¤é—®é¢˜å·²è§£å†³</li>
</ol>
<h2 id="ğŸ› ï¸-è°ƒè¯•å·¥å…·" tabindex="-1"><a class="header-anchor" href="#ğŸ› ï¸-è°ƒè¯•å·¥å…·">#</a> ğŸ› ï¸ è°ƒè¯•å·¥å…·</h2>
<h3 id="_1-æ—¥å¿—è°ƒè¯•" tabindex="-1"><a class="header-anchor" href="#_1-æ—¥å¿—è°ƒè¯•">#</a> 1. æ—¥å¿—è°ƒè¯•</h3>
<h4 id="ç»“æ„åŒ–æ—¥å¿—" tabindex="-1"><a class="header-anchor" href="#ç»“æ„åŒ–æ—¥å¿—">#</a> ç»“æ„åŒ–æ—¥å¿—</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> logger</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"context"</span></span>
<span class="line">    <span class="token string">"os"</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">"go.uber.org/zap"</span></span>
<span class="line">    <span class="token string">"go.uber.org/zap/zapcore"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ—¥å¿—é…ç½®</span></span>
<span class="line"><span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Level      <span class="token builtin">string</span> <span class="token string">`json:"level"`</span></span>
<span class="line">    Format     <span class="token builtin">string</span> <span class="token string">`json:"format"`</span> <span class="token comment">// json, console</span></span>
<span class="line">    Output     <span class="token builtin">string</span> <span class="token string">`json:"output"`</span> <span class="token comment">// stdout, file</span></span>
<span class="line">    Filename   <span class="token builtin">string</span> <span class="token string">`json:"filename"`</span></span>
<span class="line">    MaxSize    <span class="token builtin">int</span>    <span class="token string">`json:"max_size"`</span>    <span class="token comment">// MB</span></span>
<span class="line">    MaxBackups <span class="token builtin">int</span>    <span class="token string">`json:"max_backups"`</span></span>
<span class="line">    MaxAge     <span class="token builtin">int</span>    <span class="token string">`json:"max_age"`</span>     <span class="token comment">// days</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// åˆ›å»ºæ—¥å¿—å™¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewLogger</span><span class="token punctuation">(</span>cfg Config<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>zap<span class="token punctuation">.</span>Logger<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// è®¾ç½®æ—¥å¿—çº§åˆ«</span></span>
<span class="line">    level<span class="token punctuation">,</span> err <span class="token operator">:=</span> zapcore<span class="token punctuation">.</span><span class="token function">ParseLevel</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>Level<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// é…ç½®ç¼–ç å™¨</span></span>
<span class="line">    <span class="token keyword">var</span> encoderConfig zapcore<span class="token punctuation">.</span>EncoderConfig</span>
<span class="line">    <span class="token keyword">if</span> cfg<span class="token punctuation">.</span>Format <span class="token operator">==</span> <span class="token string">"json"</span> <span class="token punctuation">{</span></span>
<span class="line">        encoderConfig <span class="token operator">=</span> zap<span class="token punctuation">.</span><span class="token function">NewProductionEncoderConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        encoderConfig <span class="token operator">=</span> zap<span class="token punctuation">.</span><span class="token function">NewDevelopmentEncoderConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        encoderConfig<span class="token punctuation">.</span>EncodeLevel <span class="token operator">=</span> zapcore<span class="token punctuation">.</span>CapitalColorLevelEncoder</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    encoderConfig<span class="token punctuation">.</span>TimeKey <span class="token operator">=</span> <span class="token string">"timestamp"</span></span>
<span class="line">    encoderConfig<span class="token punctuation">.</span>EncodeTime <span class="token operator">=</span> zapcore<span class="token punctuation">.</span>ISO8601TimeEncoder</span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// é…ç½®è¾“å‡º</span></span>
<span class="line">    <span class="token keyword">var</span> writeSyncer zapcore<span class="token punctuation">.</span>WriteSyncer</span>
<span class="line">    <span class="token keyword">if</span> cfg<span class="token punctuation">.</span>Output <span class="token operator">==</span> <span class="token string">"file"</span> <span class="token punctuation">{</span></span>
<span class="line">        writeSyncer <span class="token operator">=</span> <span class="token function">getLogWriter</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        writeSyncer <span class="token operator">=</span> zapcore<span class="token punctuation">.</span><span class="token function">AddSync</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆ›å»ºæ ¸å¿ƒ</span></span>
<span class="line">    <span class="token keyword">var</span> encoder zapcore<span class="token punctuation">.</span>Encoder</span>
<span class="line">    <span class="token keyword">if</span> cfg<span class="token punctuation">.</span>Format <span class="token operator">==</span> <span class="token string">"json"</span> <span class="token punctuation">{</span></span>
<span class="line">        encoder <span class="token operator">=</span> zapcore<span class="token punctuation">.</span><span class="token function">NewJSONEncoder</span><span class="token punctuation">(</span>encoderConfig<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        encoder <span class="token operator">=</span> zapcore<span class="token punctuation">.</span><span class="token function">NewConsoleEncoder</span><span class="token punctuation">(</span>encoderConfig<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    core <span class="token operator">:=</span> zapcore<span class="token punctuation">.</span><span class="token function">NewCore</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> writeSyncer<span class="token punctuation">,</span> level<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆ›å»ºæ—¥å¿—å™¨</span></span>
<span class="line">    logger <span class="token operator">:=</span> zap<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>core<span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">AddCaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">AddStacktrace</span><span class="token punctuation">(</span>zapcore<span class="token punctuation">.</span>ErrorLevel<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> logger<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å¸¦ä¸Šä¸‹æ–‡çš„æ—¥å¿—</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">WithContext</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> logger <span class="token operator">*</span>zap<span class="token punctuation">.</span>Logger<span class="token punctuation">)</span> <span class="token operator">*</span>zap<span class="token punctuation">.</span>Logger <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> requestID <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"request_id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> requestID <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        logger <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span>zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"request_id"</span><span class="token punctuation">,</span> requestID<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> userID <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> userID <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        logger <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span>zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> userID<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> traceID <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"trace_id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> traceID <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        logger <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span>zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"trace_id"</span><span class="token punctuation">,</span> traceID<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> logger</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>UserService<span class="token punctuation">)</span> <span class="token function">CreateUser</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>CreateUserRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    logger <span class="token operator">:=</span> <span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> s<span class="token punctuation">.</span>logger<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Creating user"</span><span class="token punctuation">,</span></span>
<span class="line">        zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>Username<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"email"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>Email<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// éªŒè¯è¾“å…¥</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">validateCreateUserRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Invalid create user request"</span><span class="token punctuation">,</span></span>
<span class="line">            zap<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            zap<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token string">"request"</span><span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆ›å»ºç”¨æˆ·</span></span>
<span class="line">    user<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>repo<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span></span>
<span class="line">        Username<span class="token punctuation">:</span> req<span class="token punctuation">.</span>Username<span class="token punctuation">,</span></span>
<span class="line">        Email<span class="token punctuation">:</span>    req<span class="token punctuation">.</span>Email<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Failed to create user"</span><span class="token punctuation">,</span></span>
<span class="line">            zap<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>Username<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"User created successfully"</span><span class="token punctuation">,</span></span>
<span class="line">        zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>Username<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> user<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ—¥å¿—æŸ¥è¯¢å’Œåˆ†æ" tabindex="-1"><a class="header-anchor" href="#æ—¥å¿—æŸ¥è¯¢å’Œåˆ†æ">#</a> æ—¥å¿—æŸ¥è¯¢å’Œåˆ†æ</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># scripts/log-analysis.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯æ—¥å¿—</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Recent errors:"</span></span>
<span class="line">jq <span class="token string">'select(.level == "error")'</span> logs/app.log <span class="token operator">|</span> <span class="token function">tail</span> <span class="token parameter variable">-10</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŒ‰ç”¨æˆ·IDæŸ¥è¯¢æ—¥å¿—</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Logs for user <span class="token variable">$1</span>:"</span></span>
<span class="line">jq <span class="token string">"select(.user_id == <span class="token entity" title="\&quot;">\"</span><span class="token variable">$1</span><span class="token entity" title="\&quot;">\"</span>)"</span> logs/app.log</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹APIå“åº”æ—¶é—´ç»Ÿè®¡</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"API response time statistics:"</span></span>
<span class="line">jq <span class="token string">'select(.msg == "HTTP request completed") | .duration'</span> logs/app.log <span class="token operator">|</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token function">awk</span> <span class="token string">'{sum+=$1; count++} END {print "Avg:", sum/count, "Count:", count}'</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹é”™è¯¯ç‡</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Error rate in last hour:"</span></span>
<span class="line"><span class="token assign-left variable">total</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>jq 'select<span class="token punctuation">(</span>.timestamp <span class="token operator">></span> <span class="token punctuation">(</span>now - <span class="token number">3600</span><span class="token punctuation">)</span><span class="token variable">)</span></span>' logs/app.log <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token punctuation">)</span></span>
<span class="line"><span class="token assign-left variable">errors</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>jq 'select<span class="token punctuation">(</span>.timestamp <span class="token operator">></span> <span class="token punctuation">(</span>now - <span class="token number">3600</span><span class="token punctuation">)</span> and .level <span class="token operator">==</span> <span class="token string">"error"</span><span class="token variable">)</span></span>' logs/app.log <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token punctuation">)</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Errors: <span class="token variable">$errors</span> / <span class="token variable">$total</span> (<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">"scale=2; <span class="token variable">$errors</span> * 100 / <span class="token variable">$total</span>"</span> <span class="token operator">|</span> <span class="token function">bc</span><span class="token variable">)</span></span>%)"</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-æ€§èƒ½åˆ†æ" tabindex="-1"><a class="header-anchor" href="#_2-æ€§èƒ½åˆ†æ">#</a> 2. æ€§èƒ½åˆ†æ</h3>
<h4 id="go-pprofé›†æˆ" tabindex="-1"><a class="header-anchor" href="#go-pprofé›†æˆ">#</a> Go pprofé›†æˆ</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> debug</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"context"</span></span>
<span class="line">    <span class="token string">"net/http"</span></span>
<span class="line">    <span class="token boolean">_</span> <span class="token string">"net/http/pprof"</span></span>
<span class="line">    <span class="token string">"runtime"</span></span>
<span class="line">    <span class="token string">"time"</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">"go.uber.org/zap"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ€§èƒ½åˆ†ææœåŠ¡</span></span>
<span class="line"><span class="token keyword">type</span> ProfilerService <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    logger <span class="token operator">*</span>zap<span class="token punctuation">.</span>Logger</span>
<span class="line">    server <span class="token operator">*</span>http<span class="token punctuation">.</span>Server</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewProfilerService</span><span class="token punctuation">(</span>addr <span class="token builtin">string</span><span class="token punctuation">,</span> logger <span class="token operator">*</span>zap<span class="token punctuation">.</span>Logger<span class="token punctuation">)</span> <span class="token operator">*</span>ProfilerService <span class="token punctuation">{</span></span>
<span class="line">    mux <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ³¨å†Œpprofå¤„ç†å™¨</span></span>
<span class="line">    mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/debug/pprof/"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        http<span class="token punctuation">.</span>DefaultServeMux<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è‡ªå®šä¹‰æ€§èƒ½æŒ‡æ ‡</span></span>
<span class="line">    mux<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/debug/stats"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">var</span> m runtime<span class="token punctuation">.</span>MemStats</span>
<span class="line">        runtime<span class="token punctuation">.</span><span class="token function">ReadMemStats</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        stats <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">"goroutines"</span><span class="token punctuation">:</span>     runtime<span class="token punctuation">.</span><span class="token function">NumGoroutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">"memory_alloc"</span><span class="token punctuation">:</span>   m<span class="token punctuation">.</span>Alloc<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">"memory_total"</span><span class="token punctuation">:</span>   m<span class="token punctuation">.</span>TotalAlloc<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">"memory_sys"</span><span class="token punctuation">:</span>     m<span class="token punctuation">.</span>Sys<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">"gc_runs"</span><span class="token punctuation">:</span>        m<span class="token punctuation">.</span>NumGC<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">"gc_pause_total"</span><span class="token punctuation">:</span> m<span class="token punctuation">.</span>PauseTotalNs<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span></span>
<span class="line">        json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    server <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span></span>
<span class="line">        Addr<span class="token punctuation">:</span>    addr<span class="token punctuation">,</span></span>
<span class="line">        Handler<span class="token punctuation">:</span> mux<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>ProfilerService<span class="token punctuation">{</span></span>
<span class="line">        logger<span class="token punctuation">:</span> logger<span class="token punctuation">,</span></span>
<span class="line">        server<span class="token punctuation">:</span> server<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>ProfilerService<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    p<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Starting profiler server"</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"addr"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>server<span class="token punctuation">.</span>Addr<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> p<span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>ProfilerService<span class="token punctuation">)</span> <span class="token function">Stop</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    p<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Stopping profiler server"</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> p<span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">Shutdown</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">PerformanceMiddleware</span><span class="token punctuation">(</span>logger <span class="token operator">*</span>zap<span class="token punctuation">.</span>Logger<span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// è®°å½•è¯·æ±‚å¼€å§‹æ—¶çš„å†…å­˜çŠ¶æ€</span></span>
<span class="line">            <span class="token keyword">var</span> startMem runtime<span class="token punctuation">.</span>MemStats</span>
<span class="line">            runtime<span class="token punctuation">.</span><span class="token function">ReadMemStats</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>startMem<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// æ‰§è¡Œè¯·æ±‚</span></span>
<span class="line">            next<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// è®°å½•è¯·æ±‚ç»“æŸæ—¶çš„å†…å­˜çŠ¶æ€</span></span>
<span class="line">            <span class="token keyword">var</span> endMem runtime<span class="token punctuation">.</span>MemStats</span>
<span class="line">            runtime<span class="token punctuation">.</span><span class="token function">ReadMemStats</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>endMem<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            duration <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span></span>
<span class="line">            memoryUsed <span class="token operator">:=</span> endMem<span class="token punctuation">.</span>Alloc <span class="token operator">-</span> startMem<span class="token punctuation">.</span>Alloc</span>
<span class="line">            </span>
<span class="line">            logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"HTTP request completed"</span><span class="token punctuation">,</span></span>
<span class="line">                zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"method"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Method<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                zap<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token string">"duration"</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                zap<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token string">"memory_used"</span><span class="token punctuation">,</span> memoryUsed<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                zap<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"goroutines"</span><span class="token punctuation">,</span> runtime<span class="token punctuation">.</span><span class="token function">NumGoroutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// å¦‚æœè¯·æ±‚æ—¶é—´è¿‡é•¿ï¼Œè®°å½•è­¦å‘Š</span></span>
<span class="line">            <span class="token keyword">if</span> duration <span class="token operator">></span> <span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second <span class="token punctuation">{</span></span>
<span class="line">                logger<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Slow request detected"</span><span class="token punctuation">,</span></span>
<span class="line">                    zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"method"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Method<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                    zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                    zap<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token string">"duration"</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ€§èƒ½åˆ†æè„šæœ¬" tabindex="-1"><a class="header-anchor" href="#æ€§èƒ½åˆ†æè„šæœ¬">#</a> æ€§èƒ½åˆ†æè„šæœ¬</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># scripts/profile.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">SERVICE_URL</span><span class="token operator">=</span><span class="token string">"http://localhost:8080"</span></span>
<span class="line"><span class="token assign-left variable">PROFILE_DURATION</span><span class="token operator">=</span><span class="token string">"30s"</span></span>
<span class="line"><span class="token assign-left variable">OUTPUT_DIR</span><span class="token operator">=</span><span class="token string">"./profiles"</span></span>
<span class="line"></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$OUTPUT_DIR</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Collecting CPU profile for <span class="token variable">$PROFILE_DURATION</span>..."</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">"<span class="token variable">$SERVICE_URL</span>/debug/pprof/profile?seconds=30"</span> <span class="token operator">></span> <span class="token string">"<span class="token variable">$OUTPUT_DIR</span>/cpu.prof"</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Collecting memory profile..."</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">"<span class="token variable">$SERVICE_URL</span>/debug/pprof/heap"</span> <span class="token operator">></span> <span class="token string">"<span class="token variable">$OUTPUT_DIR</span>/heap.prof"</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Collecting goroutine profile..."</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">"<span class="token variable">$SERVICE_URL</span>/debug/pprof/goroutine"</span> <span class="token operator">></span> <span class="token string">"<span class="token variable">$OUTPUT_DIR</span>/goroutine.prof"</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Collecting mutex profile..."</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">"<span class="token variable">$SERVICE_URL</span>/debug/pprof/mutex"</span> <span class="token operator">></span> <span class="token string">"<span class="token variable">$OUTPUT_DIR</span>/mutex.prof"</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Collecting block profile..."</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">"<span class="token variable">$SERVICE_URL</span>/debug/pprof/block"</span> <span class="token operator">></span> <span class="token string">"<span class="token variable">$OUTPUT_DIR</span>/block.prof"</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Profiles saved to <span class="token variable">$OUTPUT_DIR</span>"</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Analyze with: go tool pprof <span class="token variable">$OUTPUT_DIR</span>/cpu.prof"</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-åˆ†å¸ƒå¼è¿½è¸ª" tabindex="-1"><a class="header-anchor" href="#_3-åˆ†å¸ƒå¼è¿½è¸ª">#</a> 3. åˆ†å¸ƒå¼è¿½è¸ª</h3>
<h4 id="jaegeré›†æˆ" tabindex="-1"><a class="header-anchor" href="#jaegeré›†æˆ">#</a> Jaegeré›†æˆ</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> tracing</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"context"</span></span>
<span class="line">    <span class="token string">"io"</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">"github.com/opentracing/opentracing-go"</span></span>
<span class="line">    <span class="token string">"github.com/opentracing/opentracing-go/ext"</span></span>
<span class="line">    <span class="token string">"github.com/uber/jaeger-client-go"</span></span>
<span class="line">    <span class="token string">"github.com/uber/jaeger-client-go/config"</span></span>
<span class="line">    <span class="token string">"go.uber.org/zap"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è¿½è¸ªé…ç½®</span></span>
<span class="line"><span class="token keyword">type</span> TracingConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    ServiceName <span class="token builtin">string</span>  <span class="token string">`json:"service_name"`</span></span>
<span class="line">    AgentHost   <span class="token builtin">string</span>  <span class="token string">`json:"agent_host"`</span></span>
<span class="line">    AgentPort   <span class="token builtin">int</span>     <span class="token string">`json:"agent_port"`</span></span>
<span class="line">    SampleRate  <span class="token builtin">float64</span> <span class="token string">`json:"sample_rate"`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// åˆå§‹åŒ–è¿½è¸ª</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">InitTracing</span><span class="token punctuation">(</span>cfg TracingConfig<span class="token punctuation">,</span> logger <span class="token operator">*</span>zap<span class="token punctuation">.</span>Logger<span class="token punctuation">)</span> <span class="token punctuation">(</span>opentracing<span class="token punctuation">.</span>Tracer<span class="token punctuation">,</span> io<span class="token punctuation">.</span>Closer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    config <span class="token operator">:=</span> config<span class="token punctuation">.</span>Configuration<span class="token punctuation">{</span></span>
<span class="line">        ServiceName<span class="token punctuation">:</span> cfg<span class="token punctuation">.</span>ServiceName<span class="token punctuation">,</span></span>
<span class="line">        Sampler<span class="token punctuation">:</span> <span class="token operator">&amp;</span>config<span class="token punctuation">.</span>SamplerConfig<span class="token punctuation">{</span></span>
<span class="line">            Type<span class="token punctuation">:</span>  jaeger<span class="token punctuation">.</span>SamplerTypeConst<span class="token punctuation">,</span></span>
<span class="line">            Param<span class="token punctuation">:</span> cfg<span class="token punctuation">.</span>SampleRate<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        Reporter<span class="token punctuation">:</span> <span class="token operator">&amp;</span>config<span class="token punctuation">.</span>ReporterConfig<span class="token punctuation">{</span></span>
<span class="line">            LogSpans<span class="token punctuation">:</span>           <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            LocalAgentHostPort<span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s:%d"</span><span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>AgentHost<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>AgentPort<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    tracer<span class="token punctuation">,</span> closer<span class="token punctuation">,</span> err <span class="token operator">:=</span> config<span class="token punctuation">.</span><span class="token function">NewTracer</span><span class="token punctuation">(</span></span>
<span class="line">        config<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span>jaeger<span class="token punctuation">.</span>StdLogger<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    opentracing<span class="token punctuation">.</span><span class="token function">SetGlobalTracer</span><span class="token punctuation">(</span>tracer<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Tracing initialized"</span><span class="token punctuation">,</span></span>
<span class="line">        zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"service"</span><span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>ServiceName<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"agent"</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s:%d"</span><span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>AgentHost<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>AgentPort<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> tracer<span class="token punctuation">,</span> closer<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// HTTPè¿½è¸ªä¸­é—´ä»¶</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TracingMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// ä»è¯·æ±‚å¤´ä¸­æå–spanä¸Šä¸‹æ–‡</span></span>
<span class="line">            spanCtx<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> opentracing<span class="token punctuation">.</span><span class="token function">GlobalTracer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Extract</span><span class="token punctuation">(</span></span>
<span class="line">                opentracing<span class="token punctuation">.</span>HTTPHeaders<span class="token punctuation">,</span></span>
<span class="line">                opentracing<span class="token punctuation">.</span><span class="token function">HTTPHeadersCarrier</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Header<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// åˆ›å»ºæ–°çš„span</span></span>
<span class="line">            span <span class="token operator">:=</span> opentracing<span class="token punctuation">.</span><span class="token function">GlobalTracer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StartSpan</span><span class="token punctuation">(</span></span>
<span class="line">                fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s %s"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Method<span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                ext<span class="token punctuation">.</span><span class="token function">RPCServerOption</span><span class="token punctuation">(</span>spanCtx<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">defer</span> span<span class="token punctuation">.</span><span class="token function">Finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// è®¾ç½®spanæ ‡ç­¾</span></span>
<span class="line">            ext<span class="token punctuation">.</span>HTTPMethod<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>span<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Method<span class="token punctuation">)</span></span>
<span class="line">            ext<span class="token punctuation">.</span>HTTPUrl<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>span<span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            ext<span class="token punctuation">.</span>Component<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>span<span class="token punctuation">,</span> <span class="token string">"http-server"</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// å°†spanæ·»åŠ åˆ°ä¸Šä¸‹æ–‡</span></span>
<span class="line">            ctx <span class="token operator">:=</span> opentracing<span class="token punctuation">.</span><span class="token function">ContextWithSpan</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> span<span class="token punctuation">)</span></span>
<span class="line">            r <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// åˆ›å»ºå“åº”å†™å…¥å™¨åŒ…è£…å™¨</span></span>
<span class="line">            rw <span class="token operator">:=</span> <span class="token operator">&amp;</span>responseWriter<span class="token punctuation">{</span>ResponseWriter<span class="token punctuation">:</span> w<span class="token punctuation">,</span> statusCode<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// æ‰§è¡Œè¯·æ±‚</span></span>
<span class="line">            next<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>rw<span class="token punctuation">,</span> r<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// è®¾ç½®å“åº”çŠ¶æ€</span></span>
<span class="line">            ext<span class="token punctuation">.</span>HTTPStatusCode<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>span<span class="token punctuation">,</span> <span class="token function">uint16</span><span class="token punctuation">(</span>rw<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> rw<span class="token punctuation">.</span>statusCode <span class="token operator">>=</span> <span class="token number">400</span> <span class="token punctuation">{</span></span>
<span class="line">                ext<span class="token punctuation">.</span>Error<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>span<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å“åº”å†™å…¥å™¨åŒ…è£…å™¨</span></span>
<span class="line"><span class="token keyword">type</span> responseWriter <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    http<span class="token punctuation">.</span>ResponseWriter</span>
<span class="line">    statusCode <span class="token builtin">int</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>responseWriter<span class="token punctuation">)</span> <span class="token function">WriteHeader</span><span class="token punctuation">(</span>code <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    rw<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> code</span>
<span class="line">    rw<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æœåŠ¡è°ƒç”¨è¿½è¸ª</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TraceServiceCall</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> operation <span class="token builtin">string</span><span class="token punctuation">,</span> fn <span class="token keyword">func</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    span<span class="token punctuation">,</span> ctx <span class="token operator">:=</span> opentracing<span class="token punctuation">.</span><span class="token function">StartSpanFromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> operation<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> span<span class="token punctuation">.</span><span class="token function">Finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾ç½®spanæ ‡ç­¾</span></span>
<span class="line">    span<span class="token punctuation">.</span><span class="token function">SetTag</span><span class="token punctuation">(</span><span class="token string">"service.name"</span><span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span></span>
<span class="line">    span<span class="token punctuation">.</span><span class="token function">SetTag</span><span class="token punctuation">(</span><span class="token string">"operation"</span><span class="token punctuation">,</span> operation<span class="token punctuation">)</span></span>
<span class="line">    ext<span class="token punctuation">.</span>Component<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>span<span class="token punctuation">,</span> <span class="token string">"service-client"</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ‰§è¡Œæ“ä½œ</span></span>
<span class="line">    err <span class="token operator">:=</span> <span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        ext<span class="token punctuation">.</span>Error<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>span<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">        span<span class="token punctuation">.</span><span class="token function">SetTag</span><span class="token punctuation">(</span><span class="token string">"error.message"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> err</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ•°æ®åº“æ“ä½œè¿½è¸ª</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TraceDBOperation</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> query <span class="token builtin">string</span><span class="token punctuation">,</span> fn <span class="token keyword">func</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    span<span class="token punctuation">,</span> ctx <span class="token operator">:=</span> opentracing<span class="token punctuation">.</span><span class="token function">StartSpanFromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"db.query"</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> span<span class="token punctuation">.</span><span class="token function">Finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¾ç½®spanæ ‡ç­¾</span></span>
<span class="line">    ext<span class="token punctuation">.</span>DBType<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>span<span class="token punctuation">,</span> <span class="token string">"postgresql"</span><span class="token punctuation">)</span></span>
<span class="line">    ext<span class="token punctuation">.</span>DBStatement<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>span<span class="token punctuation">,</span> query<span class="token punctuation">)</span></span>
<span class="line">    ext<span class="token punctuation">.</span>Component<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>span<span class="token punctuation">,</span> <span class="token string">"database"</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ‰§è¡ŒæŸ¥è¯¢</span></span>
<span class="line">    err <span class="token operator">:=</span> <span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        ext<span class="token punctuation">.</span>Error<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>span<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">        span<span class="token punctuation">.</span><span class="token function">SetTag</span><span class="token punctuation">(</span><span class="token string">"error.message"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> err</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-å®æ—¶è°ƒè¯•" tabindex="-1"><a class="header-anchor" href="#_4-å®æ—¶è°ƒè¯•">#</a> 4. å®æ—¶è°ƒè¯•</h3>
<h4 id="delveè°ƒè¯•å™¨" tabindex="-1"><a class="header-anchor" href="#delveè°ƒè¯•å™¨">#</a> Delveè°ƒè¯•å™¨</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># å®‰è£…Delve</span></span>
<span class="line">go <span class="token function">install</span> github.com/go-delve/delve/cmd/dlv@latest</span>
<span class="line"></span>
<span class="line"><span class="token comment"># è°ƒè¯•è¿è¡Œä¸­çš„ç¨‹åº</span></span>
<span class="line">dlv attach <span class="token operator">&lt;</span>pid<span class="token operator">></span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># è°ƒè¯•æµ‹è¯•</span></span>
<span class="line">dlv <span class="token builtin class-name">test</span> ./pkg/user</span>
<span class="line"></span>
<span class="line"><span class="token comment"># è¿œç¨‹è°ƒè¯•</span></span>
<span class="line">dlv debug <span class="token parameter variable">--headless</span> <span class="token parameter variable">--listen</span><span class="token operator">=</span>:2345 --api-version<span class="token operator">=</span><span class="token number">2</span> --accept-multiclient</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="è°ƒè¯•é…ç½®" tabindex="-1"><a class="header-anchor" href="#è°ƒè¯•é…ç½®">#</a> è°ƒè¯•é…ç½®</h4>
<div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre v-pre><code class="language-json"><span class="line"><span class="token comment">// .vscode/launch.json</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.2.0"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">"configurations"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Debug VGO Service"</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"go"</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">"request"</span><span class="token operator">:</span> <span class="token string">"launch"</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">"mode"</span><span class="token operator">:</span> <span class="token string">"debug"</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">"program"</span><span class="token operator">:</span> <span class="token string">"${workspaceFolder}/cmd/server"</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">"env"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">"GO_ENV"</span><span class="token operator">:</span> <span class="token string">"development"</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">"DATABASE_URL"</span><span class="token operator">:</span> <span class="token string">"postgres://localhost:5432/vgo_dev"</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token property">"REDIS_URL"</span><span class="token operator">:</span> <span class="token string">"redis://localhost:6379"</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token string">"--config"</span><span class="token punctuation">,</span> <span class="token string">"configs/development.yaml"</span></span>
<span class="line">            <span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Debug Test"</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"go"</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">"request"</span><span class="token operator">:</span> <span class="token string">"launch"</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">"mode"</span><span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">"program"</span><span class="token operator">:</span> <span class="token string">"${workspaceFolder}/pkg/user"</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">"env"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token property">"GO_ENV"</span><span class="token operator">:</span> <span class="token string">"test"</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Attach to Process"</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"go"</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">"request"</span><span class="token operator">:</span> <span class="token string">"attach"</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">"mode"</span><span class="token operator">:</span> <span class="token string">"local"</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token property">"processId"</span><span class="token operator">:</span> <span class="token number">0</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”§-é—®é¢˜æ’æŸ¥" tabindex="-1"><a class="header-anchor" href="#ğŸ”§-é—®é¢˜æ’æŸ¥">#</a> ğŸ”§ é—®é¢˜æ’æŸ¥</h2>
<h3 id="_1-å¸¸è§é—®é¢˜è¯Šæ–­" tabindex="-1"><a class="header-anchor" href="#_1-å¸¸è§é—®é¢˜è¯Šæ–­">#</a> 1. å¸¸è§é—®é¢˜è¯Šæ–­</h3>
<h4 id="æœåŠ¡å¯åŠ¨é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#æœåŠ¡å¯åŠ¨é—®é¢˜">#</a> æœåŠ¡å¯åŠ¨é—®é¢˜</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># scripts/diagnose-startup.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"=== VGO Service Startup Diagnosis ==="</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥ç«¯å£å ç”¨</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Checking port usage:"</span></span>
<span class="line"><span class="token function">netstat</span> <span class="token parameter variable">-tulpn</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">':(8080|5432|6379|4222)'</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥æœåŠ¡çŠ¶æ€</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Checking service status:"</span></span>
<span class="line">systemctl status vgo-service <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">"Service not managed by systemd"</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥æ—¥å¿—</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Recent logs:"</span></span>
<span class="line"><span class="token function">tail</span> <span class="token parameter variable">-50</span> /var/log/vgo/service.log <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">"Log file not found"</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥é…ç½®æ–‡ä»¶</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Checking configuration:"</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">"/etc/vgo/config.yaml"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"Config file exists"</span></span>
<span class="line">    yaml-lint /etc/vgo/config.yaml <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">"Config file has syntax errors"</span></span>
<span class="line"><span class="token keyword">else</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"Config file not found"</span></span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥æ•°æ®åº“è¿æ¥</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Testing database connection:"</span></span>
<span class="line">psql <span class="token parameter variable">-h</span> localhost <span class="token parameter variable">-U</span> vgo <span class="token parameter variable">-d</span> vgo <span class="token parameter variable">-c</span> <span class="token string">"SELECT 1;"</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">"Database connection failed"</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥Redisè¿æ¥</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Testing Redis connection:"</span></span>
<span class="line">redis-cli <span class="token function">ping</span> <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">"Redis connection failed"</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥ç£ç›˜ç©ºé—´</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Disk usage:"</span></span>
<span class="line"><span class="token function">df</span> <span class="token parameter variable">-h</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥å†…å­˜ä½¿ç”¨</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Memory usage:"</span></span>
<span class="line"><span class="token function">free</span> <span class="token parameter variable">-h</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ€§èƒ½é—®é¢˜è¯Šæ–­" tabindex="-1"><a class="header-anchor" href="#æ€§èƒ½é—®é¢˜è¯Šæ–­">#</a> æ€§èƒ½é—®é¢˜è¯Šæ–­</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># scripts/diagnose-performance.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">SERVICE_PID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>pgrep vgo-service<span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">"<span class="token variable">$SERVICE_PID</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"VGO service is not running"</span></span>
<span class="line">    <span class="token builtin class-name">exit</span> <span class="token number">1</span></span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"=== VGO Service Performance Diagnosis ==="</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Service PID: <span class="token variable">$SERVICE_PID</span>"</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># CPUä½¿ç”¨ç‡</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>CPU usage:"</span></span>
<span class="line"><span class="token function">top</span> <span class="token parameter variable">-p</span> <span class="token variable">$SERVICE_PID</span> <span class="token parameter variable">-n</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token function">grep</span> vgo-service</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å†…å­˜ä½¿ç”¨</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Memory usage:"</span></span>
<span class="line"><span class="token function">ps</span> <span class="token parameter variable">-p</span> <span class="token variable">$SERVICE_PID</span> <span class="token parameter variable">-o</span> pid,ppid,cmd,%mem,%cpu <span class="token parameter variable">--sort</span><span class="token operator">=</span>-%mem</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ–‡ä»¶æè¿°ç¬¦</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>File descriptors:"</span></span>
<span class="line"><span class="token function">ls</span> /proc/<span class="token variable">$SERVICE_PID</span>/fd <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Limit: <span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">ulimit</span> <span class="token parameter variable">-n</span><span class="token variable">)</span></span>"</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç½‘ç»œè¿æ¥</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Network connections:"</span></span>
<span class="line"><span class="token function">netstat</span> <span class="token parameter variable">-anp</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token variable">$SERVICE_PID</span> <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Goroutineæ•°é‡</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Goroutines:"</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-s</span> http://localhost:8080/debug/stats <span class="token operator">|</span> jq <span class="token string">'.goroutines'</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å†…å­˜ç»Ÿè®¡</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Memory stats:"</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-s</span> http://localhost:8080/debug/stats <span class="token operator">|</span> jq <span class="token string">'{</span>
<span class="line">    memory_alloc: .memory_alloc,</span>
<span class="line">    memory_sys: .memory_sys,</span>
<span class="line">    gc_runs: .gc_runs</span>
<span class="line">}'</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æœ€è¿‘çš„æ…¢æŸ¥è¯¢</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Slow requests (>1s):"</span></span>
<span class="line"><span class="token function">grep</span> <span class="token string">"duration.*[0-9]\+s"</span> /var/log/vgo/service.log <span class="token operator">|</span> <span class="token function">tail</span> <span class="token parameter variable">-10</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-æ•°æ®åº“é—®é¢˜æ’æŸ¥" tabindex="-1"><a class="header-anchor" href="#_2-æ•°æ®åº“é—®é¢˜æ’æŸ¥">#</a> 2. æ•°æ®åº“é—®é¢˜æ’æŸ¥</h3>
<h4 id="postgresqlè¯Šæ–­" tabindex="-1"><a class="header-anchor" href="#postgresqlè¯Šæ–­">#</a> PostgreSQLè¯Šæ–­</h4>
<div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre v-pre><code class="language-sql"><span class="line"><span class="token comment">-- æ£€æŸ¥æ´»è·ƒè¿æ¥</span></span>
<span class="line"><span class="token keyword">SELECT</span> </span>
<span class="line">    pid<span class="token punctuation">,</span></span>
<span class="line">    usename<span class="token punctuation">,</span></span>
<span class="line">    application_name<span class="token punctuation">,</span></span>
<span class="line">    client_addr<span class="token punctuation">,</span></span>
<span class="line">    state<span class="token punctuation">,</span></span>
<span class="line">    query_start<span class="token punctuation">,</span></span>
<span class="line">    query</span>
<span class="line"><span class="token keyword">FROM</span> pg_stat_activity </span>
<span class="line"><span class="token keyword">WHERE</span> state <span class="token operator">=</span> <span class="token string">'active'</span></span>
<span class="line"><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> query_start<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- æ£€æŸ¥é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢</span></span>
<span class="line"><span class="token keyword">SELECT</span> </span>
<span class="line">    pid<span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> pg_stat_activity<span class="token punctuation">.</span>query_start <span class="token keyword">AS</span> duration<span class="token punctuation">,</span></span>
<span class="line">    query<span class="token punctuation">,</span></span>
<span class="line">    state</span>
<span class="line"><span class="token keyword">FROM</span> pg_stat_activity </span>
<span class="line"><span class="token keyword">WHERE</span> <span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> pg_stat_activity<span class="token punctuation">.</span>query_start<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">interval</span> <span class="token string">'5 minutes'</span></span>
<span class="line"><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> duration <span class="token keyword">DESC</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- æ£€æŸ¥é”ç­‰å¾…</span></span>
<span class="line"><span class="token keyword">SELECT</span> </span>
<span class="line">    blocked_locks<span class="token punctuation">.</span>pid <span class="token keyword">AS</span> blocked_pid<span class="token punctuation">,</span></span>
<span class="line">    blocked_activity<span class="token punctuation">.</span>usename <span class="token keyword">AS</span> blocked_user<span class="token punctuation">,</span></span>
<span class="line">    blocking_locks<span class="token punctuation">.</span>pid <span class="token keyword">AS</span> blocking_pid<span class="token punctuation">,</span></span>
<span class="line">    blocking_activity<span class="token punctuation">.</span>usename <span class="token keyword">AS</span> blocking_user<span class="token punctuation">,</span></span>
<span class="line">    blocked_activity<span class="token punctuation">.</span>query <span class="token keyword">AS</span> blocked_statement<span class="token punctuation">,</span></span>
<span class="line">    blocking_activity<span class="token punctuation">.</span>query <span class="token keyword">AS</span> current_statement_in_blocking_process</span>
<span class="line"><span class="token keyword">FROM</span> pg_catalog<span class="token punctuation">.</span>pg_locks blocked_locks</span>
<span class="line"><span class="token keyword">JOIN</span> pg_catalog<span class="token punctuation">.</span>pg_stat_activity blocked_activity <span class="token keyword">ON</span> blocked_activity<span class="token punctuation">.</span>pid <span class="token operator">=</span> blocked_locks<span class="token punctuation">.</span>pid</span>
<span class="line"><span class="token keyword">JOIN</span> pg_catalog<span class="token punctuation">.</span>pg_locks blocking_locks </span>
<span class="line">    <span class="token keyword">ON</span> blocking_locks<span class="token punctuation">.</span>locktype <span class="token operator">=</span> blocked_locks<span class="token punctuation">.</span>locktype</span>
<span class="line">    <span class="token operator">AND</span> blocking_locks<span class="token punctuation">.</span><span class="token keyword">database</span> <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">FROM</span> blocked_locks<span class="token punctuation">.</span><span class="token keyword">database</span></span>
<span class="line">    <span class="token operator">AND</span> blocking_locks<span class="token punctuation">.</span>relation <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">FROM</span> blocked_locks<span class="token punctuation">.</span>relation</span>
<span class="line">    <span class="token operator">AND</span> blocking_locks<span class="token punctuation">.</span>page <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">FROM</span> blocked_locks<span class="token punctuation">.</span>page</span>
<span class="line">    <span class="token operator">AND</span> blocking_locks<span class="token punctuation">.</span>tuple <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">FROM</span> blocked_locks<span class="token punctuation">.</span>tuple</span>
<span class="line">    <span class="token operator">AND</span> blocking_locks<span class="token punctuation">.</span>virtualxid <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">FROM</span> blocked_locks<span class="token punctuation">.</span>virtualxid</span>
<span class="line">    <span class="token operator">AND</span> blocking_locks<span class="token punctuation">.</span>transactionid <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">FROM</span> blocked_locks<span class="token punctuation">.</span>transactionid</span>
<span class="line">    <span class="token operator">AND</span> blocking_locks<span class="token punctuation">.</span>classid <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">FROM</span> blocked_locks<span class="token punctuation">.</span>classid</span>
<span class="line">    <span class="token operator">AND</span> blocking_locks<span class="token punctuation">.</span>objid <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">FROM</span> blocked_locks<span class="token punctuation">.</span>objid</span>
<span class="line">    <span class="token operator">AND</span> blocking_locks<span class="token punctuation">.</span>objsubid <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token keyword">DISTINCT</span> <span class="token keyword">FROM</span> blocked_locks<span class="token punctuation">.</span>objsubid</span>
<span class="line">    <span class="token operator">AND</span> blocking_locks<span class="token punctuation">.</span>pid <span class="token operator">!=</span> blocked_locks<span class="token punctuation">.</span>pid</span>
<span class="line"><span class="token keyword">JOIN</span> pg_catalog<span class="token punctuation">.</span>pg_stat_activity blocking_activity <span class="token keyword">ON</span> blocking_activity<span class="token punctuation">.</span>pid <span class="token operator">=</span> blocking_locks<span class="token punctuation">.</span>pid</span>
<span class="line"><span class="token keyword">WHERE</span> <span class="token operator">NOT</span> blocked_locks<span class="token punctuation">.</span>granted<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- æ£€æŸ¥è¡¨å¤§å°</span></span>
<span class="line"><span class="token keyword">SELECT</span> </span>
<span class="line">    schemaname<span class="token punctuation">,</span></span>
<span class="line">    tablename<span class="token punctuation">,</span></span>
<span class="line">    pg_size_pretty<span class="token punctuation">(</span>pg_total_relation_size<span class="token punctuation">(</span>schemaname<span class="token operator">||</span><span class="token string">'.'</span><span class="token operator">||</span>tablename<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> size</span>
<span class="line"><span class="token keyword">FROM</span> pg_tables </span>
<span class="line"><span class="token keyword">WHERE</span> schemaname <span class="token operator">=</span> <span class="token string">'public'</span></span>
<span class="line"><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> pg_total_relation_size<span class="token punctuation">(</span>schemaname<span class="token operator">||</span><span class="token string">'.'</span><span class="token operator">||</span>tablename<span class="token punctuation">)</span> <span class="token keyword">DESC</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ</span></span>
<span class="line"><span class="token keyword">SELECT</span> </span>
<span class="line">    schemaname<span class="token punctuation">,</span></span>
<span class="line">    tablename<span class="token punctuation">,</span></span>
<span class="line">    indexname<span class="token punctuation">,</span></span>
<span class="line">    idx_scan<span class="token punctuation">,</span></span>
<span class="line">    idx_tup_read<span class="token punctuation">,</span></span>
<span class="line">    idx_tup_fetch</span>
<span class="line"><span class="token keyword">FROM</span> pg_stat_user_indexes</span>
<span class="line"><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> idx_scan <span class="token keyword">DESC</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="redisè¯Šæ–­" tabindex="-1"><a class="header-anchor" href="#redisè¯Šæ–­">#</a> Redisè¯Šæ–­</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># scripts/diagnose-redis.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"=== Redis Diagnosis ==="</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Redisä¿¡æ¯</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Redis info:"</span></span>
<span class="line">redis-cli info server <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">"redis_version|uptime_in_seconds|connected_clients"</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å†…å­˜ä½¿ç”¨</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Memory usage:"</span></span>
<span class="line">redis-cli info memory <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">"used_memory_human|used_memory_peak_human|maxmemory_human"</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># é”®ç©ºé—´ä¿¡æ¯</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Keyspace info:"</span></span>
<span class="line">redis-cli info keyspace</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ…¢æŸ¥è¯¢</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Slow queries:"</span></span>
<span class="line">redis-cli slowlog get <span class="token number">10</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å®¢æˆ·ç«¯è¿æ¥</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Client connections:"</span></span>
<span class="line">redis-cli client list <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-10</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># é”®åˆ†æ</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Top keys by memory usage:"</span></span>
<span class="line">redis-cli <span class="token parameter variable">--bigkeys</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-ç½‘ç»œé—®é¢˜æ’æŸ¥" tabindex="-1"><a class="header-anchor" href="#_3-ç½‘ç»œé—®é¢˜æ’æŸ¥">#</a> 3. ç½‘ç»œé—®é¢˜æ’æŸ¥</h3>
<h4 id="ç½‘ç»œè¿é€šæ€§æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#ç½‘ç»œè¿é€šæ€§æµ‹è¯•">#</a> ç½‘ç»œè¿é€šæ€§æµ‹è¯•</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># scripts/diagnose-network.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"=== Network Diagnosis ==="</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥æœåŠ¡ç«¯å£</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Service ports:"</span></span>
<span class="line"><span class="token function">netstat</span> <span class="token parameter variable">-tulpn</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">':(8080|8081|8082)'</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥DNSè§£æ</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>DNS resolution:"</span></span>
<span class="line"><span class="token function">nslookup</span> postgres.local</span>
<span class="line"><span class="token function">nslookup</span> redis.local</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥æœåŠ¡é—´è¿é€šæ€§</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Service connectivity:"</span></span>
<span class="line">telnet postgres.local <span class="token number">5432</span> <span class="token operator">&lt;</span> /dev/null</span>
<span class="line">telnet redis.local <span class="token number">6379</span> <span class="token operator">&lt;</span> /dev/null</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥å¤–éƒ¨APIè¿é€šæ€§</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>External API connectivity:"</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-I</span> https://api.example.com/health</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Network latency:"</span></span>
<span class="line"><span class="token function">ping</span> <span class="token parameter variable">-c</span> <span class="token number">3</span> postgres.local</span>
<span class="line"><span class="token function">ping</span> <span class="token parameter variable">-c</span> <span class="token number">3</span> redis.local</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥é˜²ç«å¢™è§„åˆ™</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token entity" title="\n">\n</span>Firewall rules:"</span></span>
<span class="line"><span class="token function">sudo</span> iptables <span class="token parameter variable">-L</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">'(8080|5432|6379)'</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸš¨-æ•…éšœå¤„ç†" tabindex="-1"><a class="header-anchor" href="#ğŸš¨-æ•…éšœå¤„ç†">#</a> ğŸš¨ æ•…éšœå¤„ç†</h2>
<h3 id="_1-ç´§æ€¥æ•…éšœå“åº”" tabindex="-1"><a class="header-anchor" href="#_1-ç´§æ€¥æ•…éšœå“åº”">#</a> 1. ç´§æ€¥æ•…éšœå“åº”</h3>
<h4 id="æ•…éšœå“åº”æµç¨‹" tabindex="-1"><a class="header-anchor" href="#æ•…éšœå“åº”æµç¨‹">#</a> æ•…éšœå“åº”æµç¨‹</h4>
<div class="language-mermaid line-numbers-mode" data-highlighter="prismjs" data-ext="mermaid"><pre v-pre><code class="language-mermaid"><span class="line"><span class="token keyword">flowchart</span> TD</span>
<span class="line">    A<span class="token text string">[æ•…éšœæ£€æµ‹]</span> <span class="token arrow operator">--></span> B<span class="token text string">[æ•…éšœç¡®è®¤]</span></span>
<span class="line">    B <span class="token arrow operator">--></span> C<span class="token text string">[å½±å“è¯„ä¼°]</span></span>
<span class="line">    C <span class="token arrow operator">--></span> D<span class="token text string">[ç´§æ€¥å¤„ç†]</span></span>
<span class="line">    D <span class="token arrow operator">--></span> E<span class="token text string">[æ ¹å› åˆ†æ]</span></span>
<span class="line">    E <span class="token arrow operator">--></span> F<span class="token text string">[æ°¸ä¹…ä¿®å¤]</span></span>
<span class="line">    F <span class="token arrow operator">--></span> G<span class="token text string">[æ•…éšœæ€»ç»“]</span></span>
<span class="line">    </span>
<span class="line">    D <span class="token arrow operator">--></span> H<span class="token text string">[å›æ»šéƒ¨ç½²]</span></span>
<span class="line">    D <span class="token arrow operator">--></span> I<span class="token text string">[æ‰©å®¹èµ„æº]</span></span>
<span class="line">    D <span class="token arrow operator">--></span> J<span class="token text string">[åˆ‡æ¢æµé‡]</span></span>
<span class="line">    D <span class="token arrow operator">--></span> K<span class="token text string">[é‡å¯æœåŠ¡]</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ•…éšœå¤„ç†è„šæœ¬" tabindex="-1"><a class="header-anchor" href="#æ•…éšœå¤„ç†è„šæœ¬">#</a> æ•…éšœå¤„ç†è„šæœ¬</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># scripts/emergency-response.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">set</span> <span class="token parameter variable">-e</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">ACTION</span><span class="token operator">=</span><span class="token variable">$1</span></span>
<span class="line"><span class="token assign-left variable">SERVICE</span><span class="token operator">=</span><span class="token variable">${2<span class="token operator">:-</span>"all"}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">case</span> <span class="token variable">$ACTION</span> <span class="token keyword">in</span></span>
<span class="line">    <span class="token string">"rollback"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">"Rolling back deployment..."</span></span>
<span class="line">        kubectl rollout undo deployment/vgo-service</span>
<span class="line">        kubectl rollout status deployment/vgo-service</span>
<span class="line">        <span class="token punctuation">;</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">"scale-up"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">"Scaling up service..."</span></span>
<span class="line">        kubectl scale deployment/vgo-service <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">10</span></span>
<span class="line">        kubectl rollout status deployment/vgo-service</span>
<span class="line">        <span class="token punctuation">;</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">"restart"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">"Restarting service..."</span></span>
<span class="line">        kubectl rollout restart deployment/vgo-service</span>
<span class="line">        kubectl rollout status deployment/vgo-service</span>
<span class="line">        <span class="token punctuation">;</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">"drain-traffic"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">"Draining traffic from service..."</span></span>
<span class="line">        kubectl patch <span class="token function">service</span> vgo-service <span class="token parameter variable">-p</span> <span class="token string">'{"spec":{"selector":{"app":"maintenance"}}}'</span></span>
<span class="line">        <span class="token punctuation">;</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">"restore-traffic"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">"Restoring traffic to service..."</span></span>
<span class="line">        kubectl patch <span class="token function">service</span> vgo-service <span class="token parameter variable">-p</span> <span class="token string">'{"spec":{"selector":{"app":"vgo-service"}}}'</span></span>
<span class="line">        <span class="token punctuation">;</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">"health-check"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">"Performing health check..."</span></span>
<span class="line">        <span class="token function">curl</span> <span class="token parameter variable">-f</span> http://localhost:8080/health <span class="token operator">||</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">"Service is healthy"</span></span>
<span class="line">        <span class="token punctuation">;</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    *<span class="token punctuation">)</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">"Usage: <span class="token variable">$0</span> {rollback|scale-up|restart|drain-traffic|restore-traffic|health-check} [service]"</span></span>
<span class="line">        <span class="token builtin class-name">exit</span> <span class="token number">1</span></span>
<span class="line">        <span class="token punctuation">;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">esac</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-ç›‘æ§å‘Šè­¦" tabindex="-1"><a class="header-anchor" href="#_2-ç›‘æ§å‘Šè­¦">#</a> 2. ç›‘æ§å‘Šè­¦</h3>
<h4 id="å‘Šè­¦è§„åˆ™" tabindex="-1"><a class="header-anchor" href="#å‘Šè­¦è§„åˆ™">#</a> å‘Šè­¦è§„åˆ™</h4>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># monitoring/alerts.yml</span></span>
<span class="line"><span class="token key atrule">groups</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>service</span>
<span class="line">  <span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> ServiceDown</span>
<span class="line">    <span class="token key atrule">expr</span><span class="token punctuation">:</span> up<span class="token punctuation">{</span>job="vgo<span class="token punctuation">-</span>service"<span class="token punctuation">}</span> == 0</span>
<span class="line">    <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m</span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical</span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"VGO service is down"</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"VGO service has been down for more than 1 minute"</span></span>
<span class="line">  </span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> HighErrorRate</span>
<span class="line">    <span class="token key atrule">expr</span><span class="token punctuation">:</span> rate(http_requests_total<span class="token punctuation">{</span>status=~"5.."<span class="token punctuation">}</span><span class="token punctuation">[</span>5m<span class="token punctuation">]</span>) <span class="token punctuation">></span> 0.1</span>
<span class="line">    <span class="token key atrule">for</span><span class="token punctuation">:</span> 2m</span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning</span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"High error rate detected"</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"Error rate is {{ $value }} errors per second"</span></span>
<span class="line">  </span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> HighResponseTime</span>
<span class="line">    <span class="token key atrule">expr</span><span class="token punctuation">:</span> histogram_quantile(0.95<span class="token punctuation">,</span> rate(http_request_duration_seconds_bucket<span class="token punctuation">[</span>5m<span class="token punctuation">]</span>)) <span class="token punctuation">></span> 1</span>
<span class="line">    <span class="token key atrule">for</span><span class="token punctuation">:</span> 5m</span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning</span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"High response time detected"</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"95th percentile response time is {{ $value }} seconds"</span></span>
<span class="line">  </span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> DatabaseConnectionFailure</span>
<span class="line">    <span class="token key atrule">expr</span><span class="token punctuation">:</span> database_connections_failed_total <span class="token punctuation">></span> 0</span>
<span class="line">    <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m</span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical</span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"Database connection failure"</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"Failed to connect to database"</span></span>
<span class="line">  </span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> HighMemoryUsage</span>
<span class="line">    <span class="token key atrule">expr</span><span class="token punctuation">:</span> process_resident_memory_bytes / 1024 / 1024 <span class="token punctuation">></span> 1000</span>
<span class="line">    <span class="token key atrule">for</span><span class="token punctuation">:</span> 5m</span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning</span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"High memory usage"</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"Memory usage is {{ $value }}MB"</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“Š-è°ƒè¯•æœ€ä½³å®è·µ" tabindex="-1"><a class="header-anchor" href="#ğŸ“Š-è°ƒè¯•æœ€ä½³å®è·µ">#</a> ğŸ“Š è°ƒè¯•æœ€ä½³å®è·µ</h2>
<h3 id="_1-æ—¥å¿—æœ€ä½³å®è·µ" tabindex="-1"><a class="header-anchor" href="#_1-æ—¥å¿—æœ€ä½³å®è·µ">#</a> 1. æ—¥å¿—æœ€ä½³å®è·µ</h3>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// å¥½çš„æ—¥å¿—å®è·µ</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>UserService<span class="token punctuation">)</span> <span class="token function">CreateUser</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>CreateUserRequest<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    logger <span class="token operator">:=</span> s<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span></span>
<span class="line">        zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"operation"</span><span class="token punctuation">,</span> <span class="token string">"CreateUser"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>UserID<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Starting user creation"</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®°å½•å…³é”®æ­¥éª¤</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Validating user input"</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">validateUser</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"User validation failed"</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Checking user existence"</span><span class="token punctuation">)</span></span>
<span class="line">    exists<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>repo<span class="token punctuation">.</span><span class="token function">UserExists</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">.</span>Username<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Failed to check user existence"</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> exists <span class="token punctuation">{</span></span>
<span class="line">        logger<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"User already exists"</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>Username<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> ErrUserExists</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Creating user in database"</span><span class="token punctuation">)</span></span>
<span class="line">    user<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>repo<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Failed to create user"</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"User created successfully"</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-é”™è¯¯å¤„ç†æœ€ä½³å®è·µ" tabindex="-1"><a class="header-anchor" href="#_2-é”™è¯¯å¤„ç†æœ€ä½³å®è·µ">#</a> 2. é”™è¯¯å¤„ç†æœ€ä½³å®è·µ</h3>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// é”™è¯¯åŒ…è£…å’Œä¸Šä¸‹æ–‡</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>UserRepository<span class="token punctuation">)</span> <span class="token function">GetByID</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> op <span class="token operator">=</span> <span class="token string">"UserRepository.GetByID"</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> id <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"%s: %w"</span><span class="token punctuation">,</span> op<span class="token punctuation">,</span> ErrInvalidUserID<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    query <span class="token operator">:=</span> <span class="token string">`SELECT id, username, email, created_at FROM users WHERE id = $1 AND deleted_at IS NULL`</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">var</span> user User</span>
<span class="line">    err <span class="token operator">:=</span> r<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">QueryRowContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> query<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token operator">&amp;</span>user<span class="token punctuation">.</span>ID<span class="token punctuation">,</span></span>
<span class="line">        <span class="token operator">&amp;</span>user<span class="token punctuation">.</span>Username<span class="token punctuation">,</span></span>
<span class="line">        <span class="token operator">&amp;</span>user<span class="token punctuation">.</span>Email<span class="token punctuation">,</span></span>
<span class="line">        <span class="token operator">&amp;</span>user<span class="token punctuation">.</span>CreatedAt<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> sql<span class="token punctuation">.</span>ErrNoRows<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"%s: user %s: %w"</span><span class="token punctuation">,</span> op<span class="token punctuation">,</span> id<span class="token punctuation">,</span> ErrUserNotFound<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"%s: failed to query user %s: %w"</span><span class="token punctuation">,</span> op<span class="token punctuation">,</span> id<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>user<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// é”™è¯¯åˆ†ç±»</span></span>
<span class="line"><span class="token keyword">var</span> <span class="token punctuation">(</span></span>
<span class="line">    ErrUserNotFound   <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"user not found"</span><span class="token punctuation">)</span></span>
<span class="line">    ErrInvalidUserID  <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"invalid user ID"</span><span class="token punctuation">)</span></span>
<span class="line">    ErrUserExists     <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"user already exists"</span><span class="token punctuation">)</span></span>
<span class="line">    ErrDatabaseError  <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"database error"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// é”™è¯¯å¤„ç†ä¸­é—´ä»¶</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">ErrorHandlingMiddleware</span><span class="token punctuation">(</span>logger <span class="token operator">*</span>zap<span class="token punctuation">.</span>Logger<span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                    logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Panic recovered"</span><span class="token punctuation">,</span></span>
<span class="line">                        zap<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                        zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                        zap<span class="token punctuation">.</span><span class="token function">Stack</span><span class="token punctuation">(</span><span class="token string">"stack"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token punctuation">)</span></span>
<span class="line">                    </span>
<span class="line">                    http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"Internal Server Error"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            next<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-æ€§èƒ½è°ƒè¯•æŠ€å·§" tabindex="-1"><a class="header-anchor" href="#_3-æ€§èƒ½è°ƒè¯•æŠ€å·§">#</a> 3. æ€§èƒ½è°ƒè¯•æŠ€å·§</h3>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// æ€§èƒ½æµ‹é‡</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>UserService<span class="token punctuation">)</span> <span class="token function">GetUser</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        duration <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span></span>
<span class="line">        s<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span><span class="token function">RecordDuration</span><span class="token punctuation">(</span><span class="token string">"get_user"</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> duration <span class="token operator">></span> <span class="token number">100</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Millisecond <span class="token punctuation">{</span></span>
<span class="line">            s<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"Slow operation detected"</span><span class="token punctuation">,</span></span>
<span class="line">                zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"operation"</span><span class="token punctuation">,</span> <span class="token string">"GetUser"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                zap<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token string">"duration"</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> s<span class="token punctuation">.</span>repo<span class="token punctuation">.</span><span class="token function">GetByID</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å†…å­˜ä½¿ç”¨ç›‘æ§</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>Service<span class="token punctuation">)</span> <span class="token function">monitorMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">select</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">var</span> m runtime<span class="token punctuation">.</span>MemStats</span>
<span class="line">            runtime<span class="token punctuation">.</span><span class="token function">ReadMemStats</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            s<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Memory stats"</span><span class="token punctuation">,</span></span>
<span class="line">                zap<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token string">"alloc"</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Alloc<span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                zap<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token string">"sys"</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Sys<span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                zap<span class="token punctuation">.</span><span class="token function">Uint32</span><span class="token punctuation">(</span><span class="token string">"gc_runs"</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>NumGC<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                zap<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">"goroutines"</span><span class="token punctuation">,</span> runtime<span class="token punctuation">.</span><span class="token function">NumGoroutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// å†…å­˜ä½¿ç”¨è¿‡é«˜æ—¶è§¦å‘GC</span></span>
<span class="line">            <span class="token keyword">if</span> m<span class="token punctuation">.</span>Alloc <span class="token operator">></span> <span class="token number">500</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span> <span class="token punctuation">{</span> <span class="token comment">// 500MB</span></span>
<span class="line">                s<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"High memory usage, forcing GC"</span><span class="token punctuation">)</span></span>
<span class="line">                runtime<span class="token punctuation">.</span><span class="token function">GC</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>s<span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“š-ç›¸å…³æ–‡æ¡£" tabindex="-1"><a class="header-anchor" href="#ğŸ“š-ç›¸å…³æ–‡æ¡£">#</a> ğŸ“š ç›¸å…³æ–‡æ¡£</h2>
<ul>
<li><RouteLink to="/development/">å¼€å‘æŒ‡å—</RouteLink></li>
<li><RouteLink to="/development/architecture.html">æ¶æ„è®¾è®¡</RouteLink></li>
<li><RouteLink to="/development/testing.html">æµ‹è¯•æŒ‡å—</RouteLink></li>
<li><RouteLink to="/development/performance.html">æ€§èƒ½ä¼˜åŒ–</RouteLink></li>
<li><RouteLink to="/api/">APIæ–‡æ¡£</RouteLink></li>
<li><RouteLink to="/deployment/">éƒ¨ç½²æŒ‡å—</RouteLink></li>
</ul>
</div></template>


