<template><div><h1 id="æµ‹è¯•æŒ‡å—" tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•æŒ‡å—">#</a> æµ‹è¯•æŒ‡å—</h1>
<p>æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†VGOå¾®æœåŠ¡çš„æµ‹è¯•ç­–ç•¥ã€æµ‹è¯•æ¡†æ¶ã€æµ‹è¯•å®è·µå’Œæµ‹è¯•å·¥å…·çš„ä½¿ç”¨æ–¹æ³•ã€‚</p>
<h2 id="ğŸ¯-æµ‹è¯•ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-æµ‹è¯•ç­–ç•¥">#</a> ğŸ¯ æµ‹è¯•ç­–ç•¥</h2>
<h3 id="æµ‹è¯•é‡‘å­—å¡”" tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•é‡‘å­—å¡”">#</a> æµ‹è¯•é‡‘å­—å¡”</h3>
<div class="language-mermaid line-numbers-mode" data-highlighter="prismjs" data-ext="mermaid"><pre v-pre><code class="language-mermaid"><span class="line"><span class="token keyword">graph</span> TB</span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"æµ‹è¯•é‡‘å­—å¡”"</span></span>
<span class="line">        A<span class="token text string">["ç«¯åˆ°ç«¯æµ‹è¯• (E2E)&lt;br/>å°‘é‡ï¼Œé«˜ä»·å€¼"]</span> </span>
<span class="line">        B<span class="token text string">["é›†æˆæµ‹è¯• (Integration)&lt;br/>é€‚é‡ï¼Œå…³é”®è·¯å¾„"]</span></span>
<span class="line">        C<span class="token text string">["å•å…ƒæµ‹è¯• (Unit)&lt;br/>å¤§é‡ï¼Œå¿«é€Ÿåé¦ˆ"]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">style</span> A <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#ff6b6b</span></span>
<span class="line">    <span class="token keyword">style</span> B <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#ffd93d</span></span>
<span class="line">    <span class="token keyword">style</span> C <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#6bcf7f</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æµ‹è¯•åˆ†å±‚ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•åˆ†å±‚ç­–ç•¥">#</a> æµ‹è¯•åˆ†å±‚ç­–ç•¥</h3>
<table>
<thead>
<tr>
<th>æµ‹è¯•ç±»å‹</th>
<th>å æ¯”</th>
<th>æ‰§è¡Œé€Ÿåº¦</th>
<th>è¦†ç›–èŒƒå›´</th>
<th>ç»´æŠ¤æˆæœ¬</th>
</tr>
</thead>
<tbody>
<tr>
<td>å•å…ƒæµ‹è¯•</td>
<td>70%</td>
<td>å¿«</td>
<td>å‡½æ•°/æ–¹æ³•çº§åˆ«</td>
<td>ä½</td>
</tr>
<tr>
<td>é›†æˆæµ‹è¯•</td>
<td>20%</td>
<td>ä¸­ç­‰</td>
<td>æœåŠ¡é—´äº¤äº’</td>
<td>ä¸­ç­‰</td>
</tr>
<tr>
<td>ç«¯åˆ°ç«¯æµ‹è¯•</td>
<td>10%</td>
<td>æ…¢</td>
<td>å®Œæ•´ä¸šåŠ¡æµç¨‹</td>
<td>é«˜</td>
</tr>
</tbody>
</table>
<h2 id="ğŸ§ª-æµ‹è¯•æ¡†æ¶" tabindex="-1"><a class="header-anchor" href="#ğŸ§ª-æµ‹è¯•æ¡†æ¶">#</a> ğŸ§ª æµ‹è¯•æ¡†æ¶</h2>
<h3 id="_1-å•å…ƒæµ‹è¯•æ¡†æ¶" tabindex="-1"><a class="header-anchor" href="#_1-å•å…ƒæµ‹è¯•æ¡†æ¶">#</a> 1. å•å…ƒæµ‹è¯•æ¡†æ¶</h3>
<h4 id="goæ ‡å‡†æµ‹è¯•åº“-testify" tabindex="-1"><a class="header-anchor" href="#goæ ‡å‡†æµ‹è¯•åº“-testify">#</a> Goæ ‡å‡†æµ‹è¯•åº“ + Testify</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> user</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"context"</span></span>
<span class="line">    <span class="token string">"testing"</span></span>
<span class="line">    <span class="token string">"time"</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">"github.com/stretchr/testify/assert"</span></span>
<span class="line">    <span class="token string">"github.com/stretchr/testify/mock"</span></span>
<span class="line">    <span class="token string">"github.com/stretchr/testify/suite"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æµ‹è¯•å¥—ä»¶</span></span>
<span class="line"><span class="token keyword">type</span> UserServiceTestSuite <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    suite<span class="token punctuation">.</span>Suite</span>
<span class="line">    service    <span class="token operator">*</span>UserService</span>
<span class="line">    mockRepo   <span class="token operator">*</span>MockUserRepository</span>
<span class="line">    mockCache  <span class="token operator">*</span>MockCacheService</span>
<span class="line">    mockLogger <span class="token operator">*</span>MockLogger</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è®¾ç½®æµ‹è¯•ç¯å¢ƒ</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>suite <span class="token operator">*</span>UserServiceTestSuite<span class="token punctuation">)</span> <span class="token function">SetupTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    suite<span class="token punctuation">.</span>mockRepo <span class="token operator">=</span> <span class="token operator">&amp;</span>MockUserRepository<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    suite<span class="token punctuation">.</span>mockCache <span class="token operator">=</span> <span class="token operator">&amp;</span>MockCacheService<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    suite<span class="token punctuation">.</span>mockLogger <span class="token operator">=</span> <span class="token operator">&amp;</span>MockLogger<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    suite<span class="token punctuation">.</span>service <span class="token operator">=</span> <span class="token operator">&amp;</span>UserService<span class="token punctuation">{</span></span>
<span class="line">        repo<span class="token punctuation">:</span>   suite<span class="token punctuation">.</span>mockRepo<span class="token punctuation">,</span></span>
<span class="line">        cache<span class="token punctuation">:</span>  suite<span class="token punctuation">.</span>mockCache<span class="token punctuation">,</span></span>
<span class="line">        logger<span class="token punctuation">:</span> suite<span class="token punctuation">.</span>mockLogger<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ¸…ç†æµ‹è¯•ç¯å¢ƒ</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>suite <span class="token operator">*</span>UserServiceTestSuite<span class="token punctuation">)</span> <span class="token function">TearDownTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    suite<span class="token punctuation">.</span>mockRepo<span class="token punctuation">.</span><span class="token function">AssertExpectations</span><span class="token punctuation">(</span>suite<span class="token punctuation">.</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span>mockCache<span class="token punctuation">.</span><span class="token function">AssertExpectations</span><span class="token punctuation">(</span>suite<span class="token punctuation">.</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æµ‹è¯•ç”¨ä¾‹ï¼šåˆ›å»ºç”¨æˆ·æˆåŠŸ</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>suite <span class="token operator">*</span>UserServiceTestSuite<span class="token punctuation">)</span> <span class="token function">TestCreateUser_Success</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// Arrange</span></span>
<span class="line">    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    user <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span></span>
<span class="line">        Username<span class="token punctuation">:</span> <span class="token string">"testuser"</span><span class="token punctuation">,</span></span>
<span class="line">        Email<span class="token punctuation">:</span>    <span class="token string">"test@example.com"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    suite<span class="token punctuation">.</span>mockRepo<span class="token punctuation">.</span><span class="token function">On</span><span class="token punctuation">(</span><span class="token string">"Create"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Return</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span>mockCache<span class="token punctuation">.</span><span class="token function">On</span><span class="token punctuation">(</span><span class="token string">"Delete"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> <span class="token string">"users:list"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Return</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// Act</span></span>
<span class="line">    err <span class="token operator">:=</span> suite<span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">CreateUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// Assert</span></span>
<span class="line">    assert<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>suite<span class="token punctuation">.</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    assert<span class="token punctuation">.</span><span class="token function">NotEmpty</span><span class="token punctuation">(</span>suite<span class="token punctuation">.</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span></span>
<span class="line">    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>suite<span class="token punctuation">.</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"active"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span>Status<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æµ‹è¯•ç”¨ä¾‹ï¼šåˆ›å»ºç”¨æˆ·å¤±è´¥ - ç”¨æˆ·åå·²å­˜åœ¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>suite <span class="token operator">*</span>UserServiceTestSuite<span class="token punctuation">)</span> <span class="token function">TestCreateUser_UsernameExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// Arrange</span></span>
<span class="line">    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    user <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span></span>
<span class="line">        Username<span class="token punctuation">:</span> <span class="token string">"existinguser"</span><span class="token punctuation">,</span></span>
<span class="line">        Email<span class="token punctuation">:</span>    <span class="token string">"test@example.com"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    suite<span class="token punctuation">.</span>mockRepo<span class="token punctuation">.</span><span class="token function">On</span><span class="token punctuation">(</span><span class="token string">"Create"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Return</span><span class="token punctuation">(</span>ErrUsernameExists<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// Act</span></span>
<span class="line">    err <span class="token operator">:=</span> suite<span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">CreateUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// Assert</span></span>
<span class="line">    assert<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>suite<span class="token punctuation">.</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>suite<span class="token punctuation">.</span><span class="token function">T</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ErrUsernameExists<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è¿è¡Œæµ‹è¯•å¥—ä»¶</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TestUserServiceTestSuite</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token function">new</span><span class="token punctuation">(</span>UserServiceTestSuite<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="mockç”Ÿæˆ" tabindex="-1"><a class="header-anchor" href="#mockç”Ÿæˆ">#</a> Mockç”Ÿæˆ</h4>
<p>ä½¿ç”¨mockeryè‡ªåŠ¨ç”ŸæˆMockå¯¹è±¡ï¼š</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># å®‰è£…mockery</span></span>
<span class="line">go <span class="token function">install</span> github.com/vektra/mockery/v2@latest</span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç”ŸæˆMock</span></span>
<span class="line">mockery <span class="token parameter variable">--name</span><span class="token operator">=</span>UserRepository <span class="token parameter variable">--output</span><span class="token operator">=</span>./mocks <span class="token parameter variable">--outpkg</span><span class="token operator">=</span>mocks</span>
<span class="line">mockery <span class="token parameter variable">--name</span><span class="token operator">=</span>CacheService <span class="token parameter variable">--output</span><span class="token operator">=</span>./mocks <span class="token parameter variable">--outpkg</span><span class="token operator">=</span>mocks</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// æ¥å£å®šä¹‰</span></span>
<span class="line"><span class="token keyword">type</span> UserRepository <span class="token keyword">interface</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> user <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token builtin">error</span></span>
<span class="line">    <span class="token function">GetByID</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">Update</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> user <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token builtin">error</span></span>
<span class="line">    <span class="token function">Delete</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span></span>
<span class="line">    <span class="token function">List</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> opts ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è‡ªåŠ¨ç”Ÿæˆçš„Mock</span></span>
<span class="line"><span class="token keyword">type</span> MockUserRepository <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    mock<span class="token punctuation">.</span>Mock</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>MockUserRepository<span class="token punctuation">)</span> <span class="token function">Create</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> user <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    args <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Called</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> args<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>MockUserRepository<span class="token punctuation">)</span> <span class="token function">GetByID</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    args <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Called</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> args<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-é›†æˆæµ‹è¯•æ¡†æ¶" tabindex="-1"><a class="header-anchor" href="#_2-é›†æˆæµ‹è¯•æ¡†æ¶">#</a> 2. é›†æˆæµ‹è¯•æ¡†æ¶</h3>
<h4 id="testcontainersé›†æˆæµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#testcontainersé›†æˆæµ‹è¯•">#</a> Testcontainersé›†æˆæµ‹è¯•</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> integration</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"context"</span></span>
<span class="line">    <span class="token string">"database/sql"</span></span>
<span class="line">    <span class="token string">"fmt"</span></span>
<span class="line">    <span class="token string">"testing"</span></span>
<span class="line">    <span class="token string">"time"</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">"github.com/testcontainers/testcontainers-go"</span></span>
<span class="line">    <span class="token string">"github.com/testcontainers/testcontainers-go/modules/postgres"</span></span>
<span class="line">    <span class="token string">"github.com/testcontainers/testcontainers-go/modules/redis"</span></span>
<span class="line">    <span class="token string">"github.com/stretchr/testify/suite"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> IntegrationTestSuite <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    suite<span class="token punctuation">.</span>Suite</span>
<span class="line">    pgContainer    <span class="token operator">*</span>postgres<span class="token punctuation">.</span>PostgresContainer</span>
<span class="line">    redisContainer <span class="token operator">*</span>redis<span class="token punctuation">.</span>RedisContainer</span>
<span class="line">    db             <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB</span>
<span class="line">    redisClient    <span class="token operator">*</span>redis<span class="token punctuation">.</span>Client</span>
<span class="line">    userService    <span class="token operator">*</span>UserService</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>suite <span class="token operator">*</span>IntegrationTestSuite<span class="token punctuation">)</span> <span class="token function">SetupSuite</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å¯åŠ¨PostgreSQLå®¹å™¨</span></span>
<span class="line">    pgContainer<span class="token punctuation">,</span> err <span class="token operator">:=</span> postgres<span class="token punctuation">.</span><span class="token function">RunContainer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span></span>
<span class="line">        testcontainers<span class="token punctuation">.</span><span class="token function">WithImage</span><span class="token punctuation">(</span><span class="token string">"postgres:15-alpine"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        postgres<span class="token punctuation">.</span><span class="token function">WithDatabase</span><span class="token punctuation">(</span><span class="token string">"testdb"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        postgres<span class="token punctuation">.</span><span class="token function">WithUsername</span><span class="token punctuation">(</span><span class="token string">"testuser"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        postgres<span class="token punctuation">.</span><span class="token function">WithPassword</span><span class="token punctuation">(</span><span class="token string">"testpass"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        testcontainers<span class="token punctuation">.</span><span class="token function">WithWaitStrategy</span><span class="token punctuation">(</span></span>
<span class="line">            wait<span class="token punctuation">.</span><span class="token function">ForLog</span><span class="token punctuation">(</span><span class="token string">"database system is ready to accept connections"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithOccurrence</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithStartupTimeout</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span>pgContainer <span class="token operator">=</span> pgContainer</span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å¯åŠ¨Rediså®¹å™¨</span></span>
<span class="line">    redisContainer<span class="token punctuation">,</span> err <span class="token operator">:=</span> redis<span class="token punctuation">.</span><span class="token function">RunContainer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span></span>
<span class="line">        testcontainers<span class="token punctuation">.</span><span class="token function">WithImage</span><span class="token punctuation">(</span><span class="token string">"redis:7-alpine"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span>redisContainer <span class="token operator">=</span> redisContainer</span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è¿æ¥æ•°æ®åº“</span></span>
<span class="line">    connStr<span class="token punctuation">,</span> err <span class="token operator">:=</span> pgContainer<span class="token punctuation">.</span><span class="token function">ConnectionString</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"sslmode=disable"</span><span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    suite<span class="token punctuation">.</span>db<span class="token punctuation">,</span> err <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"postgres"</span><span class="token punctuation">,</span> connStr<span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è¿æ¥Redis</span></span>
<span class="line">    redisEndpoint<span class="token punctuation">,</span> err <span class="token operator">:=</span> redisContainer<span class="token punctuation">.</span><span class="token function">Endpoint</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    suite<span class="token punctuation">.</span>redisClient <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>redis<span class="token punctuation">.</span>Options<span class="token punctuation">{</span></span>
<span class="line">        Addr<span class="token punctuation">:</span> redisEndpoint<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆå§‹åŒ–æœåŠ¡</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">setupServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è¿è¡Œæ•°æ®åº“è¿ç§»</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">runMigrations</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>suite <span class="token operator">*</span>IntegrationTestSuite<span class="token punctuation">)</span> <span class="token function">TearDownSuite</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> suite<span class="token punctuation">.</span>db <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        suite<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> suite<span class="token punctuation">.</span>redisClient <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        suite<span class="token punctuation">.</span>redisClient<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> suite<span class="token punctuation">.</span>pgContainer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        suite<span class="token punctuation">.</span>pgContainer<span class="token punctuation">.</span><span class="token function">Terminate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> suite<span class="token punctuation">.</span>redisContainer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        suite<span class="token punctuation">.</span>redisContainer<span class="token punctuation">.</span><span class="token function">Terminate</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>suite <span class="token operator">*</span>IntegrationTestSuite<span class="token punctuation">)</span> <span class="token function">TestUserCRUD</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆ›å»ºç”¨æˆ·</span></span>
<span class="line">    user <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span></span>
<span class="line">        Username<span class="token punctuation">:</span> <span class="token string">"testuser"</span><span class="token punctuation">,</span></span>
<span class="line">        Email<span class="token punctuation">:</span>    <span class="token string">"test@example.com"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    err <span class="token operator">:=</span> suite<span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">CreateUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NotEmpty</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è·å–ç”¨æˆ·</span></span>
<span class="line">    retrievedUser<span class="token punctuation">,</span> err <span class="token operator">:=</span> suite<span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">GetUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Username<span class="token punctuation">,</span> retrievedUser<span class="token punctuation">.</span>Username<span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Email<span class="token punctuation">,</span> retrievedUser<span class="token punctuation">.</span>Email<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ›´æ–°ç”¨æˆ·</span></span>
<span class="line">    user<span class="token punctuation">.</span>Email <span class="token operator">=</span> <span class="token string">"updated@example.com"</span></span>
<span class="line">    err <span class="token operator">=</span> suite<span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">UpdateUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// éªŒè¯æ›´æ–°</span></span>
<span class="line">    updatedUser<span class="token punctuation">,</span> err <span class="token operator">:=</span> suite<span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">GetUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span><span class="token string">"updated@example.com"</span><span class="token punctuation">,</span> updatedUser<span class="token punctuation">.</span>Email<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆ é™¤ç”¨æˆ·</span></span>
<span class="line">    err <span class="token operator">=</span> suite<span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">DeleteUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// éªŒè¯åˆ é™¤</span></span>
<span class="line">    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> suite<span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">GetUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TestIntegrationTestSuite</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token function">new</span><span class="token punctuation">(</span>IntegrationTestSuite<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-ç«¯åˆ°ç«¯æµ‹è¯•æ¡†æ¶" tabindex="-1"><a class="header-anchor" href="#_3-ç«¯åˆ°ç«¯æµ‹è¯•æ¡†æ¶">#</a> 3. ç«¯åˆ°ç«¯æµ‹è¯•æ¡†æ¶</h3>
<h4 id="apiæµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#apiæµ‹è¯•">#</a> APIæµ‹è¯•</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> e2e</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"bytes"</span></span>
<span class="line">    <span class="token string">"encoding/json"</span></span>
<span class="line">    <span class="token string">"fmt"</span></span>
<span class="line">    <span class="token string">"net/http"</span></span>
<span class="line">    <span class="token string">"testing"</span></span>
<span class="line">    <span class="token string">"time"</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">"github.com/stretchr/testify/suite"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> E2ETestSuite <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    suite<span class="token punctuation">.</span>Suite</span>
<span class="line">    baseURL    <span class="token builtin">string</span></span>
<span class="line">    httpClient <span class="token operator">*</span>http<span class="token punctuation">.</span>Client</span>
<span class="line">    authToken  <span class="token builtin">string</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>suite <span class="token operator">*</span>E2ETestSuite<span class="token punctuation">)</span> <span class="token function">SetupSuite</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    suite<span class="token punctuation">.</span>baseURL <span class="token operator">=</span> <span class="token string">"http://localhost:8080"</span></span>
<span class="line">    suite<span class="token punctuation">.</span>httpClient <span class="token operator">=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">{</span></span>
<span class="line">        Timeout<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç­‰å¾…æœåŠ¡å¯åŠ¨</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">waitForService</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è·å–è®¤è¯ä»¤ç‰Œ</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>suite <span class="token operator">*</span>E2ETestSuite<span class="token punctuation">)</span> <span class="token function">waitForService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">        resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> suite<span class="token punctuation">.</span>httpClient<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>suite<span class="token punctuation">.</span>baseURL <span class="token operator">+</span> <span class="token string">"/health"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> resp<span class="token punctuation">.</span>StatusCode <span class="token operator">==</span> http<span class="token punctuation">.</span>StatusOK <span class="token punctuation">{</span></span>
<span class="line">            resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> resp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">FailNow</span><span class="token punctuation">(</span><span class="token string">"Service did not start within 30 seconds"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>suite <span class="token operator">*</span>E2ETestSuite<span class="token punctuation">)</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    loginReq <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"admin123"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    body<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>loginReq<span class="token punctuation">)</span></span>
<span class="line">    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> suite<span class="token punctuation">.</span>httpClient<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span></span>
<span class="line">        suite<span class="token punctuation">.</span>baseURL<span class="token operator">+</span><span class="token string">"/api/v1/auth/login"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"application/json"</span><span class="token punctuation">,</span></span>
<span class="line">        bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">var</span> loginResp <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">        Token <span class="token builtin">string</span> <span class="token string">`json:"token"`</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loginResp<span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    suite<span class="token punctuation">.</span>authToken <span class="token operator">=</span> loginResp<span class="token punctuation">.</span>Token</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>suite <span class="token operator">*</span>E2ETestSuite<span class="token punctuation">)</span> <span class="token function">makeAuthenticatedRequest</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> body <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>http<span class="token punctuation">.</span>Response<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> reqBody <span class="token operator">*</span>bytes<span class="token punctuation">.</span>Buffer</span>
<span class="line">    <span class="token keyword">if</span> body <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        jsonBody<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span></span>
<span class="line">        reqBody <span class="token operator">=</span> bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>jsonBody<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> suite<span class="token punctuation">.</span>baseURL<span class="token operator">+</span>path<span class="token punctuation">,</span> reqBody<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">,</span> <span class="token string">"Bearer "</span><span class="token operator">+</span>suite<span class="token punctuation">.</span>authToken<span class="token punctuation">)</span></span>
<span class="line">    req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> suite<span class="token punctuation">.</span>httpClient<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>suite <span class="token operator">*</span>E2ETestSuite<span class="token punctuation">)</span> <span class="token function">TestUserManagementWorkflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 1. åˆ›å»ºç”¨æˆ·</span></span>
<span class="line">    createUserReq <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"testuser"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"email"</span><span class="token punctuation">:</span>    <span class="token string">"test@example.com"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"password123"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> suite<span class="token punctuation">.</span><span class="token function">makeAuthenticatedRequest</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token string">"/api/v1/users"</span><span class="token punctuation">,</span> createUserReq<span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusCreated<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">var</span> createResp <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">        User <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">            ID       <span class="token builtin">string</span> <span class="token string">`json:"id"`</span></span>
<span class="line">            Username <span class="token builtin">string</span> <span class="token string">`json:"username"`</span></span>
<span class="line">            Email    <span class="token builtin">string</span> <span class="token string">`json:"email"`</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token string">`json:"user"`</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>createResp<span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    userID <span class="token operator">:=</span> createResp<span class="token punctuation">.</span>User<span class="token punctuation">.</span>ID</span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NotEmpty</span><span class="token punctuation">(</span>userID<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. è·å–ç”¨æˆ·</span></span>
<span class="line">    resp<span class="token punctuation">,</span> err <span class="token operator">=</span> suite<span class="token punctuation">.</span><span class="token function">makeAuthenticatedRequest</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"/api/v1/users/"</span><span class="token operator">+</span>userID<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. æ›´æ–°ç”¨æˆ·</span></span>
<span class="line">    updateUserReq <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">"email"</span><span class="token punctuation">:</span> <span class="token string">"updated@example.com"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    resp<span class="token punctuation">,</span> err <span class="token operator">=</span> suite<span class="token punctuation">.</span><span class="token function">makeAuthenticatedRequest</span><span class="token punctuation">(</span><span class="token string">"PUT"</span><span class="token punctuation">,</span> <span class="token string">"/api/v1/users/"</span><span class="token operator">+</span>userID<span class="token punctuation">,</span> updateUserReq<span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. åˆ é™¤ç”¨æˆ·</span></span>
<span class="line">    resp<span class="token punctuation">,</span> err <span class="token operator">=</span> suite<span class="token punctuation">.</span><span class="token function">makeAuthenticatedRequest</span><span class="token punctuation">(</span><span class="token string">"DELETE"</span><span class="token punctuation">,</span> <span class="token string">"/api/v1/users/"</span><span class="token operator">+</span>userID<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusNoContent<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 5. éªŒè¯ç”¨æˆ·å·²åˆ é™¤</span></span>
<span class="line">    resp<span class="token punctuation">,</span> err <span class="token operator">=</span> suite<span class="token punctuation">.</span><span class="token function">makeAuthenticatedRequest</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"/api/v1/users/"</span><span class="token operator">+</span>userID<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Require</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Assert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusNotFound<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TestE2ETestSuite</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    suite<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token function">new</span><span class="token punctuation">(</span>E2ETestSuite<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”§-æµ‹è¯•å·¥å…·" tabindex="-1"><a class="header-anchor" href="#ğŸ”§-æµ‹è¯•å·¥å…·">#</a> ğŸ”§ æµ‹è¯•å·¥å…·</h2>
<h3 id="_1-æµ‹è¯•æ•°æ®ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#_1-æµ‹è¯•æ•°æ®ç®¡ç†">#</a> 1. æµ‹è¯•æ•°æ®ç®¡ç†</h3>
<h4 id="æµ‹è¯•æ•°æ®å·¥å‚" tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•æ•°æ®å·¥å‚">#</a> æµ‹è¯•æ•°æ®å·¥å‚</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> testdata</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"time"</span></span>
<span class="line">    <span class="token string">"github.com/google/uuid"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç”¨æˆ·æµ‹è¯•æ•°æ®å·¥å‚</span></span>
<span class="line"><span class="token keyword">type</span> UserFactory <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    defaults <span class="token operator">*</span>User</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewUserFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>UserFactory <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>UserFactory<span class="token punctuation">{</span></span>
<span class="line">        defaults<span class="token punctuation">:</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span></span>
<span class="line">            ID<span class="token punctuation">:</span>        uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            Username<span class="token punctuation">:</span>  <span class="token string">"testuser"</span><span class="token punctuation">,</span></span>
<span class="line">            Email<span class="token punctuation">:</span>     <span class="token string">"test@example.com"</span><span class="token punctuation">,</span></span>
<span class="line">            Status<span class="token punctuation">:</span>    <span class="token string">"active"</span><span class="token punctuation">,</span></span>
<span class="line">            CreatedAt<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            UpdatedAt<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>UserFactory<span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>User <span class="token punctuation">{</span></span>
<span class="line">    user <span class="token operator">:=</span> <span class="token operator">*</span>f<span class="token punctuation">.</span>defaults</span>
<span class="line">    user<span class="token punctuation">.</span>ID <span class="token operator">=</span> uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>user</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>UserFactory<span class="token punctuation">)</span> <span class="token function">WithUsername</span><span class="token punctuation">(</span>username <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>UserFactory <span class="token punctuation">{</span></span>
<span class="line">    f<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>Username <span class="token operator">=</span> username</span>
<span class="line">    <span class="token keyword">return</span> f</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>UserFactory<span class="token punctuation">)</span> <span class="token function">WithEmail</span><span class="token punctuation">(</span>email <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>UserFactory <span class="token punctuation">{</span></span>
<span class="line">    f<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>Email <span class="token operator">=</span> email</span>
<span class="line">    <span class="token keyword">return</span> f</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>UserFactory<span class="token punctuation">)</span> <span class="token function">WithStatus</span><span class="token punctuation">(</span>status <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>UserFactory <span class="token punctuation">{</span></span>
<span class="line">    f<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>Status <span class="token operator">=</span> status</span>
<span class="line">    <span class="token keyword">return</span> f</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TestUserCreation</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// åˆ›å»ºé»˜è®¤ç”¨æˆ·</span></span>
<span class="line">    user1 <span class="token operator">:=</span> <span class="token function">NewUserFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆ›å»ºè‡ªå®šä¹‰ç”¨æˆ·</span></span>
<span class="line">    user2 <span class="token operator">:=</span> <span class="token function">NewUserFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span></span>
<span class="line">        <span class="token function">WithUsername</span><span class="token punctuation">(</span><span class="token string">"customuser"</span><span class="token punctuation">)</span><span class="token punctuation">.</span></span>
<span class="line">        <span class="token function">WithEmail</span><span class="token punctuation">(</span><span class="token string">"custom@example.com"</span><span class="token punctuation">)</span><span class="token punctuation">.</span></span>
<span class="line">        <span class="token function">WithStatus</span><span class="token punctuation">(</span><span class="token string">"inactive"</span><span class="token punctuation">)</span><span class="token punctuation">.</span></span>
<span class="line">        <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æµ‹è¯•é€»è¾‘...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æµ‹è¯•æ•°æ®æ¸…ç†" tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•æ•°æ®æ¸…ç†">#</a> æµ‹è¯•æ•°æ®æ¸…ç†</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> testutil</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"context"</span></span>
<span class="line">    <span class="token string">"database/sql"</span></span>
<span class="line">    <span class="token string">"fmt"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> DatabaseCleaner <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    db <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewDatabaseCleaner</span><span class="token punctuation">(</span>db <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>DatabaseCleaner <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>DatabaseCleaner<span class="token punctuation">{</span>db<span class="token punctuation">:</span> db<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ¸…ç†æ‰€æœ‰æµ‹è¯•æ•°æ®</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>DatabaseCleaner<span class="token punctuation">)</span> <span class="token function">CleanAll</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    tables <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">"user_roles"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"policy_attachments"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"access_key_usage"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"access_keys"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"policies"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"users"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"roles"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"applications"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    tx<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">BeginTx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> tx<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç¦ç”¨å¤–é”®çº¦æŸ</span></span>
<span class="line">    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">ExecContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"SET FOREIGN_KEY_CHECKS = 0"</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ¸…ç†è¡¨æ•°æ®</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> table <span class="token operator">:=</span> <span class="token keyword">range</span> tables <span class="token punctuation">{</span></span>
<span class="line">        <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">ExecContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"DELETE FROM %s"</span><span class="token punctuation">,</span> table<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// é‡æ–°å¯ç”¨å¤–é”®çº¦æŸ</span></span>
<span class="line">    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">ExecContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"SET FOREIGN_KEY_CHECKS = 1"</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> tx<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ¸…ç†ç‰¹å®šè¡¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>DatabaseCleaner<span class="token punctuation">)</span> <span class="token function">CleanTable</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> table <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">ExecContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"DELETE FROM %s"</span><span class="token punctuation">,</span> table<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> err</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-æ€§èƒ½æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_2-æ€§èƒ½æµ‹è¯•">#</a> 2. æ€§èƒ½æµ‹è¯•</h3>
<h4 id="åŸºå‡†æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#åŸºå‡†æµ‹è¯•">#</a> åŸºå‡†æµ‹è¯•</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> benchmark</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"context"</span></span>
<span class="line">    <span class="token string">"testing"</span></span>
<span class="line">    <span class="token string">"time"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç”¨æˆ·æœåŠ¡æ€§èƒ½æµ‹è¯•</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">BenchmarkUserService_CreateUser</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    service <span class="token operator">:=</span> <span class="token function">setupUserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    b<span class="token punctuation">.</span><span class="token function">ResetTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    b<span class="token punctuation">.</span><span class="token function">RunParallel</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>pb <span class="token operator">*</span>testing<span class="token punctuation">.</span>PB<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> pb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            user <span class="token operator">:=</span> <span class="token function">NewUserFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            err <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">CreateUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                b<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">BenchmarkUserService_GetUser</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    service <span class="token operator">:=</span> <span class="token function">setupUserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// é¢„åˆ›å»ºç”¨æˆ·</span></span>
<span class="line">    user <span class="token operator">:=</span> <span class="token function">NewUserFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    err <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">CreateUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        b<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    b<span class="token punctuation">.</span><span class="token function">ResetTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    b<span class="token punctuation">.</span><span class="token function">RunParallel</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>pb <span class="token operator">*</span>testing<span class="token punctuation">.</span>PB<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> pb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">GetUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                b<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æƒé™æ£€æŸ¥æ€§èƒ½æµ‹è¯•</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">BenchmarkPermissionService_CheckPermission</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    service <span class="token operator">:=</span> <span class="token function">setupPermissionService</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    req <span class="token operator">:=</span> <span class="token operator">&amp;</span>CheckPermissionRequest<span class="token punctuation">{</span></span>
<span class="line">        UserId<span class="token punctuation">:</span>   <span class="token string">"user123"</span><span class="token punctuation">,</span></span>
<span class="line">        Resource<span class="token punctuation">:</span> <span class="token string">"users"</span><span class="token punctuation">,</span></span>
<span class="line">        Action<span class="token punctuation">:</span>   <span class="token string">"read"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    b<span class="token punctuation">.</span><span class="token function">ResetTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    b<span class="token punctuation">.</span><span class="token function">RunParallel</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>pb <span class="token operator">*</span>testing<span class="token punctuation">.</span>PB<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> pb<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">CheckPermission</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                b<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å†…å­˜åˆ†é…æµ‹è¯•</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">BenchmarkUserService_CreateUser_Memory</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    service <span class="token operator">:=</span> <span class="token function">setupUserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    b<span class="token punctuation">.</span><span class="token function">ReportAllocs</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    b<span class="token punctuation">.</span><span class="token function">ResetTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">        user <span class="token operator">:=</span> <span class="token function">NewUserFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        err <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">CreateUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            b<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å‹åŠ›æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#å‹åŠ›æµ‹è¯•">#</a> å‹åŠ›æµ‹è¯•</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> stress</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"context"</span></span>
<span class="line">    <span class="token string">"sync"</span></span>
<span class="line">    <span class="token string">"testing"</span></span>
<span class="line">    <span class="token string">"time"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å¹¶å‘ç”¨æˆ·åˆ›å»ºå‹åŠ›æµ‹è¯•</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TestConcurrentUserCreation</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    service <span class="token operator">:=</span> <span class="token function">setupUserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    concurrency <span class="token operator">:=</span> <span class="token number">100</span></span>
<span class="line">    iterations <span class="token operator">:=</span> <span class="token number">1000</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup</span>
<span class="line">    errors <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">error</span><span class="token punctuation">,</span> concurrency<span class="token operator">*</span>iterations<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> concurrency<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">        wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> iterations<span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">                user <span class="token operator">:=</span> <span class="token function">NewUserFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">if</span> err <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">CreateUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                    errors <span class="token operator">&lt;-</span> err</span>
<span class="line">                    <span class="token keyword">return</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">close</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    duration <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span></span>
<span class="line">    totalOps <span class="token operator">:=</span> concurrency <span class="token operator">*</span> iterations</span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ£€æŸ¥é”™è¯¯</span></span>
<span class="line">    errorCount <span class="token operator">:=</span> <span class="token number">0</span></span>
<span class="line">    <span class="token keyword">for</span> err <span class="token operator">:=</span> <span class="token keyword">range</span> errors <span class="token punctuation">{</span></span>
<span class="line">        t<span class="token punctuation">.</span><span class="token function">Logf</span><span class="token punctuation">(</span><span class="token string">"Error: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        errorCount<span class="token operator">++</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> errorCount <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"Failed operations: %d/%d"</span><span class="token punctuation">,</span> errorCount<span class="token punctuation">,</span> totalOps<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ€§èƒ½æŒ‡æ ‡</span></span>
<span class="line">    opsPerSecond <span class="token operator">:=</span> <span class="token function">float64</span><span class="token punctuation">(</span>totalOps<span class="token punctuation">)</span> <span class="token operator">/</span> duration<span class="token punctuation">.</span><span class="token function">Seconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    t<span class="token punctuation">.</span><span class="token function">Logf</span><span class="token punctuation">(</span><span class="token string">"Operations: %d"</span><span class="token punctuation">,</span> totalOps<span class="token punctuation">)</span></span>
<span class="line">    t<span class="token punctuation">.</span><span class="token function">Logf</span><span class="token punctuation">(</span><span class="token string">"Duration: %v"</span><span class="token punctuation">,</span> duration<span class="token punctuation">)</span></span>
<span class="line">    t<span class="token punctuation">.</span><span class="token function">Logf</span><span class="token punctuation">(</span><span class="token string">"Ops/sec: %.2f"</span><span class="token punctuation">,</span> opsPerSecond<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ€§èƒ½æ–­è¨€</span></span>
<span class="line">    <span class="token keyword">if</span> opsPerSecond <span class="token operator">&lt;</span> <span class="token number">1000</span> <span class="token punctuation">{</span></span>
<span class="line">        t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Performance below threshold: %.2f ops/sec &lt; 1000 ops/sec"</span><span class="token punctuation">,</span> opsPerSecond<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-æµ‹è¯•è¦†ç›–ç‡" tabindex="-1"><a class="header-anchor" href="#_3-æµ‹è¯•è¦†ç›–ç‡">#</a> 3. æµ‹è¯•è¦†ç›–ç‡</h3>
<h4 id="è¦†ç›–ç‡é…ç½®" tabindex="-1"><a class="header-anchor" href="#è¦†ç›–ç‡é…ç½®">#</a> è¦†ç›–ç‡é…ç½®</h4>
<div class="language-makefile line-numbers-mode" data-highlighter="prismjs" data-ext="makefile"><pre v-pre><code class="language-makefile"><span class="line"><span class="token comment"># Makefile</span></span>
<span class="line"><span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> test test-unit test-integration test-e2e test-coverage</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å•å…ƒæµ‹è¯•</span></span>
<span class="line"><span class="token target symbol">test-unit</span><span class="token punctuation">:</span></span>
<span class="line">	go test -v -race -short ./...</span>
<span class="line"></span>
<span class="line"><span class="token comment"># é›†æˆæµ‹è¯•</span></span>
<span class="line"><span class="token target symbol">test-integration</span><span class="token punctuation">:</span></span>
<span class="line">	go test -v -race -tags<span class="token operator">=</span>integration ./...</span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç«¯åˆ°ç«¯æµ‹è¯•</span></span>
<span class="line"><span class="token target symbol">test-e2e</span><span class="token punctuation">:</span></span>
<span class="line">	go test -v -race -tags<span class="token operator">=</span>e2e ./...</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ‰€æœ‰æµ‹è¯•</span></span>
<span class="line"><span class="token target symbol">test</span><span class="token punctuation">:</span> test-unit test-integration test-e2e</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æµ‹è¯•è¦†ç›–ç‡</span></span>
<span class="line"><span class="token target symbol">test-coverage</span><span class="token punctuation">:</span></span>
<span class="line">	go test -v -race -coverprofile<span class="token operator">=</span>coverage.out -covermode<span class="token operator">=</span>atomic ./...</span>
<span class="line">	go tool cover -html<span class="token operator">=</span>coverage.out -o coverage.html</span>
<span class="line">	go tool cover -func<span class="token operator">=</span>coverage.out</span>
<span class="line"></span>
<span class="line"><span class="token comment"># è¦†ç›–ç‡æŠ¥å‘Š</span></span>
<span class="line"><span class="token target symbol">coverage-report</span><span class="token punctuation">:</span></span>
<span class="line">	go tool cover -html<span class="token operator">=</span>coverage.out</span>
<span class="line"></span>
<span class="line"><span class="token comment"># åŸºå‡†æµ‹è¯•</span></span>
<span class="line"><span class="token target symbol">benchmark</span><span class="token punctuation">:</span></span>
<span class="line">	go test -bench<span class="token operator">=</span>. -benchmem -cpuprofile<span class="token operator">=</span>cpu.prof -memprofile<span class="token operator">=</span>mem.prof ./...</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å‹åŠ›æµ‹è¯•</span></span>
<span class="line"><span class="token target symbol">stress-test</span><span class="token punctuation">:</span></span>
<span class="line">	go test -v -race -tags<span class="token operator">=</span>stress ./...</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="è¦†ç›–ç‡åˆ†æ" tabindex="-1"><a class="header-anchor" href="#è¦†ç›–ç‡åˆ†æ">#</a> è¦†ç›–ç‡åˆ†æ</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># scripts/coverage.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">set</span> <span class="token parameter variable">-e</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Running tests with coverage..."</span></span>
<span class="line">go <span class="token builtin class-name">test</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-race</span> <span class="token parameter variable">-coverprofile</span><span class="token operator">=</span>coverage.out <span class="token parameter variable">-covermode</span><span class="token operator">=</span>atomic ./<span class="token punctuation">..</span>.</span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç”ŸæˆHTMLæŠ¥å‘Š</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Generating HTML coverage report..."</span></span>
<span class="line">go tool cover <span class="token parameter variable">-html</span><span class="token operator">=</span>coverage.out <span class="token parameter variable">-o</span> coverage.html</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ˜¾ç¤ºè¦†ç›–ç‡ç»Ÿè®¡</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Coverage statistics:"</span></span>
<span class="line">go tool cover <span class="token parameter variable">-func</span><span class="token operator">=</span>coverage.out</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥è¦†ç›–ç‡é˜ˆå€¼</span></span>
<span class="line"><span class="token assign-left variable">COVERAGE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>go tool cover <span class="token parameter variable">-func</span><span class="token operator">=</span>coverage.out <span class="token operator">|</span> <span class="token function">grep</span> total <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $3}'</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/%//'</span><span class="token variable">)</span></span></span>
<span class="line"><span class="token assign-left variable">THRESHOLD</span><span class="token operator">=</span><span class="token number">80</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Total coverage: <span class="token variable">${COVERAGE}</span>%"</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> <span class="token variable"><span class="token punctuation">((</span> $<span class="token punctuation">(</span>echo "$COVERAGE <span class="token operator">&lt;</span> $THRESHOLD" <span class="token operator">|</span> bc <span class="token operator">-</span>l<span class="token punctuation">)</span> <span class="token punctuation">))</span></span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"âŒ Coverage <span class="token variable">${COVERAGE}</span>% is below threshold <span class="token variable">${THRESHOLD}</span>%"</span></span>
<span class="line">    <span class="token builtin class-name">exit</span> <span class="token number">1</span></span>
<span class="line"><span class="token keyword">else</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"âœ… Coverage <span class="token variable">${COVERAGE}</span>% meets threshold <span class="token variable">${THRESHOLD}</span>%"</span></span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç”Ÿæˆè¦†ç›–ç‡å¾½ç« </span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Generating coverage badge..."</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">"https://img.shields.io/badge/coverage-<span class="token variable">${COVERAGE}</span>%25-brightgreen"</span> <span class="token operator">></span> coverage-badge.svg</span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Coverage report generated: coverage.html"</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸš€-æµ‹è¯•è‡ªåŠ¨åŒ–" tabindex="-1"><a class="header-anchor" href="#ğŸš€-æµ‹è¯•è‡ªåŠ¨åŒ–">#</a> ğŸš€ æµ‹è¯•è‡ªåŠ¨åŒ–</h2>
<h3 id="_1-ci-cdé›†æˆ" tabindex="-1"><a class="header-anchor" href="#_1-ci-cdé›†æˆ">#</a> 1. CI/CDé›†æˆ</h3>
<h4 id="github-actionsé…ç½®" tabindex="-1"><a class="header-anchor" href="#github-actionsé…ç½®">#</a> GitHub Actionsé…ç½®</h4>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># .github/workflows/test.yml</span></span>
<span class="line"><span class="token key atrule">name</span><span class="token punctuation">:</span> Tests</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">on</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">push</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> main<span class="token punctuation">,</span> develop <span class="token punctuation">]</span></span>
<span class="line">  <span class="token key atrule">pull_request</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> main <span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">jobs</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">unit-tests</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest</span>
<span class="line">    </span>
<span class="line">    <span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">postgres</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span><span class="token number">15</span></span>
<span class="line">        <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">POSTGRES_PASSWORD</span><span class="token punctuation">:</span> postgres</span>
<span class="line">          <span class="token key atrule">POSTGRES_DB</span><span class="token punctuation">:</span> testdb</span>
<span class="line">        <span class="token key atrule">options</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token punctuation">-</span></span>
<span class="line">          <span class="token punctuation">-</span><span class="token punctuation">-</span>health<span class="token punctuation">-</span>cmd pg_isready</span>
<span class="line">          <span class="token punctuation">-</span><span class="token punctuation">-</span>health<span class="token punctuation">-</span>interval 10s</span>
<span class="line">          <span class="token punctuation">-</span><span class="token punctuation">-</span>health<span class="token punctuation">-</span>timeout 5s</span>
<span class="line">          <span class="token punctuation">-</span><span class="token punctuation">-</span>health<span class="token punctuation">-</span>retries 5</span>
<span class="line">        <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> 5432<span class="token punctuation">:</span><span class="token number">5432</span></span>
<span class="line">      </span>
<span class="line">      <span class="token key atrule">redis</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span><span class="token number">7</span></span>
<span class="line">        <span class="token key atrule">options</span><span class="token punctuation">:</span> <span class="token punctuation">></span><span class="token punctuation">-</span></span>
<span class="line">          <span class="token punctuation">-</span><span class="token punctuation">-</span>health<span class="token punctuation">-</span>cmd "redis<span class="token punctuation">-</span>cli ping"</span>
<span class="line">          <span class="token punctuation">-</span><span class="token punctuation">-</span>health<span class="token punctuation">-</span>interval 10s</span>
<span class="line">          <span class="token punctuation">-</span><span class="token punctuation">-</span>health<span class="token punctuation">-</span>timeout 5s</span>
<span class="line">          <span class="token punctuation">-</span><span class="token punctuation">-</span>health<span class="token punctuation">-</span>retries 5</span>
<span class="line">        <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> 6379<span class="token punctuation">:</span><span class="token number">6379</span></span>
<span class="line">    </span>
<span class="line">    <span class="token key atrule">steps</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v4</span>
<span class="line">    </span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Go</span>
<span class="line">      <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>go@v4</span>
<span class="line">      <span class="token key atrule">with</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">go-version</span><span class="token punctuation">:</span> <span class="token string">'1.21'</span></span>
<span class="line">    </span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Cache Go modules</span>
<span class="line">      <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/cache@v3</span>
<span class="line">      <span class="token key atrule">with</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">path</span><span class="token punctuation">:</span> ~/go/pkg/mod</span>
<span class="line">        <span class="token key atrule">key</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> runner.os <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>go<span class="token punctuation">-</span>$<span class="token punctuation">{</span><span class="token punctuation">{</span> hashFiles('<span class="token important">**/go.sum')</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token key atrule">restore-keys</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">          ${{ runner.os }}-go-</span></span>
<span class="line">    </span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install dependencies</span>
<span class="line">      <span class="token key atrule">run</span><span class="token punctuation">:</span> go mod download</span>
<span class="line">    </span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Run unit tests</span>
<span class="line">      <span class="token key atrule">run</span><span class="token punctuation">:</span> make test<span class="token punctuation">-</span>unit</span>
<span class="line">      <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">DATABASE_URL</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span>//postgres<span class="token punctuation">:</span>postgres@localhost<span class="token punctuation">:</span>5432/testdb<span class="token punctuation">?</span>sslmode=disable</span>
<span class="line">        <span class="token key atrule">REDIS_URL</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">6379</span></span>
<span class="line">    </span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Run integration tests</span>
<span class="line">      <span class="token key atrule">run</span><span class="token punctuation">:</span> make test<span class="token punctuation">-</span>integration</span>
<span class="line">      <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">DATABASE_URL</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span>//postgres<span class="token punctuation">:</span>postgres@localhost<span class="token punctuation">:</span>5432/testdb<span class="token punctuation">?</span>sslmode=disable</span>
<span class="line">        <span class="token key atrule">REDIS_URL</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">6379</span></span>
<span class="line">    </span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Generate coverage report</span>
<span class="line">      <span class="token key atrule">run</span><span class="token punctuation">:</span> make test<span class="token punctuation">-</span>coverage</span>
<span class="line">      <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">DATABASE_URL</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span>//postgres<span class="token punctuation">:</span>postgres@localhost<span class="token punctuation">:</span>5432/testdb<span class="token punctuation">?</span>sslmode=disable</span>
<span class="line">        <span class="token key atrule">REDIS_URL</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">6379</span></span>
<span class="line">    </span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Upload coverage to Codecov</span>
<span class="line">      <span class="token key atrule">uses</span><span class="token punctuation">:</span> codecov/codecov<span class="token punctuation">-</span>action@v3</span>
<span class="line">      <span class="token key atrule">with</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">file</span><span class="token punctuation">:</span> ./coverage.out</span>
<span class="line">        <span class="token key atrule">flags</span><span class="token punctuation">:</span> unittests</span>
<span class="line">        <span class="token key atrule">name</span><span class="token punctuation">:</span> codecov<span class="token punctuation">-</span>umbrella</span>
<span class="line"></span>
<span class="line">  <span class="token key atrule">e2e-tests</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest</span>
<span class="line">    <span class="token key atrule">needs</span><span class="token punctuation">:</span> unit<span class="token punctuation">-</span>tests</span>
<span class="line">    </span>
<span class="line">    <span class="token key atrule">steps</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v4</span>
<span class="line">    </span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Go</span>
<span class="line">      <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>go@v4</span>
<span class="line">      <span class="token key atrule">with</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">go-version</span><span class="token punctuation">:</span> <span class="token string">'1.21'</span></span>
<span class="line">    </span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build application</span>
<span class="line">      <span class="token key atrule">run</span><span class="token punctuation">:</span> make build</span>
<span class="line">    </span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Start services</span>
<span class="line">      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">        docker-compose -f docker-compose.test.yml up -d</span>
<span class="line">        sleep 30</span></span>
<span class="line">    </span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Run E2E tests</span>
<span class="line">      <span class="token key atrule">run</span><span class="token punctuation">:</span> make test<span class="token punctuation">-</span>e2e</span>
<span class="line">    </span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Stop services</span>
<span class="line">      <span class="token key atrule">run</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>compose <span class="token punctuation">-</span>f docker<span class="token punctuation">-</span>compose.test.yml down</span>
<span class="line">      <span class="token key atrule">if</span><span class="token punctuation">:</span> always()</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-æµ‹è¯•æ•°æ®ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#_2-æµ‹è¯•æ•°æ®ç®¡ç†">#</a> 2. æµ‹è¯•æ•°æ®ç®¡ç†</h3>
<h4 id="æµ‹è¯•æ•°æ®åº“è¿ç§»" tabindex="-1"><a class="header-anchor" href="#æµ‹è¯•æ•°æ®åº“è¿ç§»">#</a> æµ‹è¯•æ•°æ®åº“è¿ç§»</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> testutil</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"database/sql"</span></span>
<span class="line">    <span class="token string">"fmt"</span></span>
<span class="line">    <span class="token string">"io/ioutil"</span></span>
<span class="line">    <span class="token string">"path/filepath"</span></span>
<span class="line">    <span class="token string">"sort"</span></span>
<span class="line">    <span class="token string">"strings"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> TestMigrator <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    db          <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB</span>
<span class="line">    migrationsDir <span class="token builtin">string</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewTestMigrator</span><span class="token punctuation">(</span>db <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> migrationsDir <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>TestMigrator <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>TestMigrator<span class="token punctuation">{</span></span>
<span class="line">        db<span class="token punctuation">:</span>          db<span class="token punctuation">,</span></span>
<span class="line">        migrationsDir<span class="token punctuation">:</span> migrationsDir<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>TestMigrator<span class="token punctuation">)</span> <span class="token function">Up</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    files<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadDir</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>migrationsDir<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">var</span> migrations <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> file <span class="token operator">:=</span> <span class="token keyword">range</span> files <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">".up.sql"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            migrations <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>migrations<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    sort<span class="token punctuation">.</span><span class="token function">Strings</span><span class="token punctuation">(</span>migrations<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> migration <span class="token operator">:=</span> <span class="token keyword">range</span> migrations <span class="token punctuation">{</span></span>
<span class="line">        content<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>migrationsDir<span class="token punctuation">,</span> migration<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> m<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to execute migration %s: %w"</span><span class="token punctuation">,</span> migration<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>TestMigrator<span class="token punctuation">)</span> <span class="token function">Down</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    files<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadDir</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>migrationsDir<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">var</span> migrations <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> file <span class="token operator">:=</span> <span class="token keyword">range</span> files <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">".down.sql"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            migrations <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>migrations<span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// é€†åºæ‰§è¡Œ</span></span>
<span class="line">    sort<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span>sort<span class="token punctuation">.</span><span class="token function">Reverse</span><span class="token punctuation">(</span>sort<span class="token punctuation">.</span><span class="token function">StringSlice</span><span class="token punctuation">(</span>migrations<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> migration <span class="token operator">:=</span> <span class="token keyword">range</span> migrations <span class="token punctuation">{</span></span>
<span class="line">        content<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>filepath<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>migrationsDir<span class="token punctuation">,</span> migration<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">=</span> m<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to execute migration %s: %w"</span><span class="token punctuation">,</span> migration<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“Š-æµ‹è¯•æœ€ä½³å®è·µ" tabindex="-1"><a class="header-anchor" href="#ğŸ“Š-æµ‹è¯•æœ€ä½³å®è·µ">#</a> ğŸ“Š æµ‹è¯•æœ€ä½³å®è·µ</h2>
<h3 id="_1-æµ‹è¯•å‘½åè§„èŒƒ" tabindex="-1"><a class="header-anchor" href="#_1-æµ‹è¯•å‘½åè§„èŒƒ">#</a> 1. æµ‹è¯•å‘½åè§„èŒƒ</h3>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// å¥½çš„æµ‹è¯•å‘½å</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TestUserService_CreateUser_Success</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TestUserService_CreateUser_UsernameExists_ReturnsError</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TestUserService_GetUser_NotFound_ReturnsError</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ä¸å¥½çš„æµ‹è¯•å‘½å</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TestCreateUser</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TestUser</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TestError</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-æµ‹è¯•ç»“æ„æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#_2-æµ‹è¯•ç»“æ„æ¨¡å¼">#</a> 2. æµ‹è¯•ç»“æ„æ¨¡å¼</h3>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// AAAæ¨¡å¼ï¼šArrange, Act, Assert</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TestUserService_CreateUser_Success</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// Arrange - å‡†å¤‡æµ‹è¯•æ•°æ®å’Œç¯å¢ƒ</span></span>
<span class="line">    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    mockRepo <span class="token operator">:=</span> <span class="token operator">&amp;</span>MockUserRepository<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    service <span class="token operator">:=</span> <span class="token operator">&amp;</span>UserService<span class="token punctuation">{</span>repo<span class="token punctuation">:</span> mockRepo<span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    user <span class="token operator">:=</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span></span>
<span class="line">        Username<span class="token punctuation">:</span> <span class="token string">"testuser"</span><span class="token punctuation">,</span></span>
<span class="line">        Email<span class="token punctuation">:</span>    <span class="token string">"test@example.com"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    mockRepo<span class="token punctuation">.</span><span class="token function">On</span><span class="token punctuation">(</span><span class="token string">"Create"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Return</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// Act - æ‰§è¡Œè¢«æµ‹è¯•çš„æ“ä½œ</span></span>
<span class="line">    err <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">CreateUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// Assert - éªŒè¯ç»“æœ</span></span>
<span class="line">    assert<span class="token punctuation">.</span><span class="token function">NoError</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    assert<span class="token punctuation">.</span><span class="token function">NotEmpty</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> user<span class="token punctuation">.</span>ID<span class="token punctuation">)</span></span>
<span class="line">    mockRepo<span class="token punctuation">.</span><span class="token function">AssertExpectations</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-æµ‹è¯•éš”ç¦»" tabindex="-1"><a class="header-anchor" href="#_3-æµ‹è¯•éš”ç¦»">#</a> 3. æµ‹è¯•éš”ç¦»</h3>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// æ¯ä¸ªæµ‹è¯•éƒ½åº”è¯¥æ˜¯ç‹¬ç«‹çš„</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TestUserService_CRUD</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">        name <span class="token builtin">string</span></span>
<span class="line">        test <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">,</span> service <span class="token operator">*</span>UserService<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            name<span class="token punctuation">:</span> <span class="token string">"CreateUser_Success"</span><span class="token punctuation">,</span></span>
<span class="line">            test<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">,</span> service <span class="token operator">*</span>UserService<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// æµ‹è¯•é€»è¾‘</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            name<span class="token punctuation">:</span> <span class="token string">"GetUser_Success"</span><span class="token punctuation">,</span></span>
<span class="line">            test<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">,</span> service <span class="token operator">*</span>UserService<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// æµ‹è¯•é€»è¾‘</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tt <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span></span>
<span class="line">        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// ä¸ºæ¯ä¸ªæµ‹è¯•åˆ›å»ºç‹¬ç«‹çš„æœåŠ¡å®ä¾‹</span></span>
<span class="line">            service <span class="token operator">:=</span> <span class="token function">setupUserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">defer</span> <span class="token function">cleanupUserService</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            tt<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> service<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-é”™è¯¯æµ‹è¯•" tabindex="-1"><a class="header-anchor" href="#_4-é”™è¯¯æµ‹è¯•">#</a> 4. é”™è¯¯æµ‹è¯•</h3>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// æµ‹è¯•é”™è¯¯åœºæ™¯</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">TestUserService_CreateUser_ErrorCases</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    tests <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">        name          <span class="token builtin">string</span></span>
<span class="line">        user          <span class="token operator">*</span>User</span>
<span class="line">        mockSetup     <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>MockUserRepository<span class="token punctuation">)</span></span>
<span class="line">        expectedError <span class="token builtin">error</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            name<span class="token punctuation">:</span> <span class="token string">"EmptyUsername"</span><span class="token punctuation">,</span></span>
<span class="line">            user<span class="token punctuation">:</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>Email<span class="token punctuation">:</span> <span class="token string">"test@example.com"</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            mockSetup<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>mock <span class="token operator">*</span>MockUserRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// ä¸è®¾ç½®ä»»ä½•æœŸæœ›ï¼Œå› ä¸ºéªŒè¯åº”è¯¥åœ¨è°ƒç”¨repoä¹‹å‰å¤±è´¥</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            expectedError<span class="token punctuation">:</span> ErrEmptyUsername<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            name<span class="token punctuation">:</span> <span class="token string">"InvalidEmail"</span><span class="token punctuation">,</span></span>
<span class="line">            user<span class="token punctuation">:</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>Username<span class="token punctuation">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span> Email<span class="token punctuation">:</span> <span class="token string">"invalid-email"</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            mockSetup<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>mock <span class="token operator">*</span>MockUserRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            expectedError<span class="token punctuation">:</span> ErrInvalidEmail<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            name<span class="token punctuation">:</span> <span class="token string">"DatabaseError"</span><span class="token punctuation">,</span></span>
<span class="line">            user<span class="token punctuation">:</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span>Username<span class="token punctuation">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span> Email<span class="token punctuation">:</span> <span class="token string">"test@example.com"</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            mockSetup<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>mock <span class="token operator">*</span>MockUserRepository<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                mock<span class="token punctuation">.</span><span class="token function">On</span><span class="token punctuation">(</span><span class="token string">"Create"</span><span class="token punctuation">,</span> mock<span class="token punctuation">.</span>Anything<span class="token punctuation">,</span> mock<span class="token punctuation">.</span>Anything<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Return</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"database error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            expectedError<span class="token punctuation">:</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"database error"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> tt <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span></span>
<span class="line">        t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            mockRepo <span class="token operator">:=</span> <span class="token operator">&amp;</span>MockUserRepository<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">            tt<span class="token punctuation">.</span><span class="token function">mockSetup</span><span class="token punctuation">(</span>mockRepo<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            service <span class="token operator">:=</span> <span class="token operator">&amp;</span>UserService<span class="token punctuation">{</span>repo<span class="token punctuation">:</span> mockRepo<span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            err <span class="token operator">:=</span> service<span class="token punctuation">.</span><span class="token function">CreateUser</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tt<span class="token punctuation">.</span>user<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            assert<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">            assert<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>expectedError<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“š-ç›¸å…³æ–‡æ¡£" tabindex="-1"><a class="header-anchor" href="#ğŸ“š-ç›¸å…³æ–‡æ¡£">#</a> ğŸ“š ç›¸å…³æ–‡æ¡£</h2>
<ul>
<li><RouteLink to="/development/">å¼€å‘æŒ‡å—</RouteLink></li>
<li><RouteLink to="/development/architecture.html">æ¶æ„è®¾è®¡</RouteLink></li>
<li><RouteLink to="/development/debugging.html">è°ƒè¯•æŒ‡å—</RouteLink></li>
<li><RouteLink to="/development/performance.html">æ€§èƒ½ä¼˜åŒ–</RouteLink></li>
<li><RouteLink to="/api/">APIæ–‡æ¡£</RouteLink></li>
<li><RouteLink to="/deployment/">éƒ¨ç½²æŒ‡å—</RouteLink></li>
</ul>
</div></template>


