<template><div><h1 id="æ€§èƒ½ä¼˜åŒ–æŒ‡å—" tabindex="-1"><a class="header-anchor" href="#æ€§èƒ½ä¼˜åŒ–æŒ‡å—">#</a> æ€§èƒ½ä¼˜åŒ–æŒ‡å—</h1>
<p>æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†VGOå¾®æœåŠ¡çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ã€æŠ€æœ¯å’Œæœ€ä½³å®è·µã€‚</p>
<h2 id="ğŸ¯-æ€§èƒ½ç›®æ ‡" tabindex="-1"><a class="header-anchor" href="#ğŸ¯-æ€§èƒ½ç›®æ ‡">#</a> ğŸ¯ æ€§èƒ½ç›®æ ‡</h2>
<h3 id="æ€§èƒ½æŒ‡æ ‡" tabindex="-1"><a class="header-anchor" href="#æ€§èƒ½æŒ‡æ ‡">#</a> æ€§èƒ½æŒ‡æ ‡</h3>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡ç±»å‹</th>
<th>ç›®æ ‡å€¼</th>
<th>ç›‘æ§æ–¹å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>APIå“åº”æ—¶é—´</td>
<td>P95 &lt; 200ms</td>
<td>Prometheus + Grafana</td>
</tr>
<tr>
<td>APIååé‡</td>
<td>&gt; 1000 RPS</td>
<td>è´Ÿè½½æµ‹è¯•</td>
</tr>
<tr>
<td>æ•°æ®åº“æŸ¥è¯¢</td>
<td>P95 &lt; 50ms</td>
<td>æ…¢æŸ¥è¯¢æ—¥å¿—</td>
</tr>
<tr>
<td>å†…å­˜ä½¿ç”¨</td>
<td>&lt; 512MB</td>
<td>å†…å­˜ç›‘æ§</td>
</tr>
<tr>
<td>CPUä½¿ç”¨ç‡</td>
<td>&lt; 70%</td>
<td>ç³»ç»Ÿç›‘æ§</td>
</tr>
<tr>
<td>é”™è¯¯ç‡</td>
<td>&lt; 0.1%</td>
<td>é”™è¯¯ç›‘æ§</td>
</tr>
</tbody>
</table>
<h3 id="æ€§èƒ½æµ‹è¯•é‡‘å­—å¡”" tabindex="-1"><a class="header-anchor" href="#æ€§èƒ½æµ‹è¯•é‡‘å­—å¡”">#</a> æ€§èƒ½æµ‹è¯•é‡‘å­—å¡”</h3>
<div class="language-mermaid line-numbers-mode" data-highlighter="prismjs" data-ext="mermaid"><pre v-pre><code class="language-mermaid"><span class="line"><span class="token keyword">graph</span> TB</span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"æ€§èƒ½æµ‹è¯•å±‚æ¬¡"</span></span>
<span class="line">        A<span class="token text string">["å‹åŠ›æµ‹è¯•&lt;br/>æé™è´Ÿè½½æµ‹è¯•"]</span></span>
<span class="line">        B<span class="token text string">["è´Ÿè½½æµ‹è¯•&lt;br/>é¢„æœŸè´Ÿè½½æµ‹è¯•"]</span></span>
<span class="line">        C<span class="token text string">["åŸºå‡†æµ‹è¯•&lt;br/>å•ç»„ä»¶æ€§èƒ½æµ‹è¯•"]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">style</span> A <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#ff6b6b</span></span>
<span class="line">    <span class="token keyword">style</span> B <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#ffd93d</span></span>
<span class="line">    <span class="token keyword">style</span> C <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#6bcf7f</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸš€-åº”ç”¨å±‚ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#ğŸš€-åº”ç”¨å±‚ä¼˜åŒ–">#</a> ğŸš€ åº”ç”¨å±‚ä¼˜åŒ–</h2>
<h3 id="_1-goè¯­è¨€ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_1-goè¯­è¨€ä¼˜åŒ–">#</a> 1. Goè¯­è¨€ä¼˜åŒ–</h3>
<h4 id="å†…å­˜ç®¡ç†ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#å†…å­˜ç®¡ç†ä¼˜åŒ–">#</a> å†…å­˜ç®¡ç†ä¼˜åŒ–</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> optimization</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"context"</span></span>
<span class="line">    <span class="token string">"sync"</span></span>
<span class="line">    <span class="token string">"time"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å¯¹è±¡æ± ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">type</span> UserPool <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    pool sync<span class="token punctuation">.</span>Pool</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewUserPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>UserPool <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>UserPool<span class="token punctuation">{</span></span>
<span class="line">        pool<span class="token punctuation">:</span> sync<span class="token punctuation">.</span>Pool<span class="token punctuation">{</span></span>
<span class="line">            New<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token operator">&amp;</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>UserPool<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>User <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> p<span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>UserPool<span class="token punctuation">)</span> <span class="token function">Put</span><span class="token punctuation">(</span>user <span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// é‡ç½®å¯¹è±¡çŠ¶æ€</span></span>
<span class="line">    user<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    p<span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ä½¿ç”¨å¯¹è±¡æ± çš„æœåŠ¡</span></span>
<span class="line"><span class="token keyword">type</span> UserService <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    repo     UserRepository</span>
<span class="line">    userPool <span class="token operator">*</span>UserPool</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>UserService<span class="token punctuation">)</span> <span class="token function">ProcessUsers</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> userIDs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    users <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>userIDs<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> id <span class="token operator">:=</span> <span class="token keyword">range</span> userIDs <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ä»å¯¹è±¡æ± è·å–ç”¨æˆ·å¯¹è±¡</span></span>
<span class="line">        user <span class="token operator">:=</span> s<span class="token punctuation">.</span>userPool<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">defer</span> s<span class="token punctuation">.</span>userPool<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>repo<span class="token punctuation">.</span><span class="token function">LoadUser</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> id<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// å¤åˆ¶ç”¨æˆ·æ•°æ®ï¼Œé¿å…æ± å¯¹è±¡è¢«ä¿®æ”¹</span></span>
<span class="line">        userCopy <span class="token operator">:=</span> <span class="token operator">*</span>user</span>
<span class="line">        users <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>users<span class="token punctuation">,</span> <span class="token operator">&amp;</span>userCopy<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> users<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å­—ç¬¦ä¸²æ„å»ºä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">BuildQuery</span><span class="token punctuation">(</span>conditions <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>conditions<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">""</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// é¢„åˆ†é…å®¹é‡ï¼Œé¿å…å¤šæ¬¡å†…å­˜åˆ†é…</span></span>
<span class="line">    <span class="token keyword">var</span> builder strings<span class="token punctuation">.</span>Builder</span>
<span class="line">    builder<span class="token punctuation">.</span><span class="token function">Grow</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>conditions<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token comment">// ä¼°ç®—æ€»é•¿åº¦</span></span>
<span class="line">    </span>
<span class="line">    builder<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM users WHERE "</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> i<span class="token punctuation">,</span> condition <span class="token operator">:=</span> <span class="token keyword">range</span> conditions <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> i <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">            builder<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">" AND "</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        builder<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>condition<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// åˆ‡ç‰‡é¢„åˆ†é…ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">ProcessLargeDataset</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span>DataItem<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>ProcessedItem <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// é¢„åˆ†é…åˆ‡ç‰‡å®¹é‡ï¼Œé¿å…åŠ¨æ€æ‰©å®¹</span></span>
<span class="line">    result <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>ProcessedItem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> data <span class="token punctuation">{</span></span>
<span class="line">        processed <span class="token operator">:=</span> <span class="token function">ProcessItem</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span></span>
<span class="line">        result <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> processed<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> result</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// é¿å…ä¸å¿…è¦çš„å†…å­˜åˆ†é…</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>UserService<span class="token punctuation">)</span> <span class="token function">ValidateUsers</span><span class="token punctuation">(</span>users <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>User<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> errors <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span> <span class="token comment">// å»¶è¿Ÿåˆ†é…ï¼Œåªåœ¨éœ€è¦æ—¶åˆ†é…</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> user <span class="token operator">:=</span> <span class="token keyword">range</span> users <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">validateUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> errors <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                errors <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// é¦–æ¬¡åˆ†é…</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            errors <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errors<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> errors</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å¹¶å‘ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#å¹¶å‘ä¼˜åŒ–">#</a> å¹¶å‘ä¼˜åŒ–</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// å·¥ä½œæ± æ¨¡å¼</span></span>
<span class="line"><span class="token keyword">type</span> WorkerPool <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    workerCount <span class="token builtin">int</span></span>
<span class="line">    jobQueue    <span class="token keyword">chan</span> Job</span>
<span class="line">    workers     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Worker</span>
<span class="line">    wg          sync<span class="token punctuation">.</span>WaitGroup</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Job <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    ID   <span class="token builtin">string</span></span>
<span class="line">    Data <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    Done <span class="token keyword">chan</span> Result</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Result <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Data  <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    Error <span class="token builtin">error</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Worker <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    id       <span class="token builtin">int</span></span>
<span class="line">    jobQueue <span class="token keyword">chan</span> Job</span>
<span class="line">    quit     <span class="token keyword">chan</span> <span class="token builtin">bool</span></span>
<span class="line">    handler  JobHandler</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> JobHandler <span class="token keyword">func</span><span class="token punctuation">(</span>Job<span class="token punctuation">)</span> Result</span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewWorkerPool</span><span class="token punctuation">(</span>workerCount <span class="token builtin">int</span><span class="token punctuation">,</span> queueSize <span class="token builtin">int</span><span class="token punctuation">,</span> handler JobHandler<span class="token punctuation">)</span> <span class="token operator">*</span>WorkerPool <span class="token punctuation">{</span></span>
<span class="line">    pool <span class="token operator">:=</span> <span class="token operator">&amp;</span>WorkerPool<span class="token punctuation">{</span></span>
<span class="line">        workerCount<span class="token punctuation">:</span> workerCount<span class="token punctuation">,</span></span>
<span class="line">        jobQueue<span class="token punctuation">:</span>    <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> Job<span class="token punctuation">,</span> queueSize<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        workers<span class="token punctuation">:</span>     <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Worker<span class="token punctuation">,</span> workerCount<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆ›å»ºå·¥ä½œè€…</span></span>
<span class="line">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> workerCount<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">        worker <span class="token operator">:=</span> <span class="token operator">&amp;</span>Worker<span class="token punctuation">{</span></span>
<span class="line">            id<span class="token punctuation">:</span>       i<span class="token punctuation">,</span></span>
<span class="line">            jobQueue<span class="token punctuation">:</span> pool<span class="token punctuation">.</span>jobQueue<span class="token punctuation">,</span></span>
<span class="line">            quit<span class="token punctuation">:</span>     <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            handler<span class="token punctuation">:</span>  handler<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        pool<span class="token punctuation">.</span>workers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> worker</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> pool</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> worker <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>workers <span class="token punctuation">{</span></span>
<span class="line">        p<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">go</span> worker<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>wg<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> worker <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>workers <span class="token punctuation">{</span></span>
<span class="line">        worker<span class="token punctuation">.</span>quit <span class="token operator">&lt;-</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    p<span class="token punctuation">.</span>wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>WorkerPool<span class="token punctuation">)</span> <span class="token function">Submit</span><span class="token punctuation">(</span>job Job<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    p<span class="token punctuation">.</span>jobQueue <span class="token operator">&lt;-</span> job</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>Worker<span class="token punctuation">)</span> <span class="token function">start</span><span class="token punctuation">(</span>wg <span class="token operator">*</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">select</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> job <span class="token operator">:=</span> <span class="token operator">&lt;-</span>w<span class="token punctuation">.</span>jobQueue<span class="token punctuation">:</span></span>
<span class="line">            result <span class="token operator">:=</span> w<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span></span>
<span class="line">            job<span class="token punctuation">.</span>Done <span class="token operator">&lt;-</span> result</span>
<span class="line">        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>w<span class="token punctuation">.</span>quit<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ä½¿ç”¨å·¥ä½œæ± å¤„ç†æ‰¹é‡ä»»åŠ¡</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>UserService<span class="token punctuation">)</span> <span class="token function">ProcessUsersBatch</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> userIDs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    workerPool <span class="token operator">:=</span> <span class="token function">NewWorkerPool</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>job Job<span class="token punctuation">)</span> Result <span class="token punctuation">{</span></span>
<span class="line">        userID <span class="token operator">:=</span> job<span class="token punctuation">.</span>Data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span></span>
<span class="line">        user<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>repo<span class="token punctuation">.</span><span class="token function">GetByID</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> userID<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> Result<span class="token punctuation">{</span>Data<span class="token punctuation">:</span> user<span class="token punctuation">,</span> Error<span class="token punctuation">:</span> err<span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    workerPool<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> workerPool<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æäº¤ä»»åŠ¡</span></span>
<span class="line">    results <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">chan</span> Result<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>userIDs<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> i<span class="token punctuation">,</span> userID <span class="token operator">:=</span> <span class="token keyword">range</span> userIDs <span class="token punctuation">{</span></span>
<span class="line">        done <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> Result<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        results<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> done</span>
<span class="line">        </span>
<span class="line">        job <span class="token operator">:=</span> Job<span class="token punctuation">{</span></span>
<span class="line">            ID<span class="token punctuation">:</span>   userID<span class="token punctuation">,</span></span>
<span class="line">            Data<span class="token punctuation">:</span> userID<span class="token punctuation">,</span></span>
<span class="line">            Done<span class="token punctuation">:</span> done<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        workerPool<span class="token punctuation">.</span><span class="token function">Submit</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ”¶é›†ç»“æœ</span></span>
<span class="line">    users <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>userIDs<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> resultChan <span class="token operator">:=</span> <span class="token keyword">range</span> results <span class="token punctuation">{</span></span>
<span class="line">        result <span class="token operator">:=</span> <span class="token operator">&lt;-</span>resultChan</span>
<span class="line">        <span class="token keyword">if</span> result<span class="token punctuation">.</span>Error <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>Error</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        users <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>users<span class="token punctuation">,</span> result<span class="token punctuation">.</span>Data<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>User<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> users<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// é™æµå™¨</span></span>
<span class="line"><span class="token keyword">type</span> RateLimiter <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    tokens <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    ticker <span class="token operator">*</span>time<span class="token punctuation">.</span>Ticker</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewRateLimiter</span><span class="token punctuation">(</span>rate <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>RateLimiter <span class="token punctuation">{</span></span>
<span class="line">    rl <span class="token operator">:=</span> <span class="token operator">&amp;</span>RateLimiter<span class="token punctuation">{</span></span>
<span class="line">        tokens<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> rate<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        ticker<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">/</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>rate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åˆå§‹å¡«å……ä»¤ç‰Œ</span></span>
<span class="line">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rate<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">        rl<span class="token punctuation">.</span>tokens <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å®šæœŸæ·»åŠ ä»¤ç‰Œ</span></span>
<span class="line">    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token keyword">range</span> rl<span class="token punctuation">.</span>ticker<span class="token punctuation">.</span>C <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">select</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">case</span> rl<span class="token punctuation">.</span>tokens <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">default</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token comment">// ä»¤ç‰Œæ¡¶å·²æ»¡</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> rl</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>rl <span class="token operator">*</span>RateLimiter<span class="token punctuation">)</span> <span class="token function">Wait</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">select</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>rl<span class="token punctuation">.</span>tokens<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>rl <span class="token operator">*</span>RateLimiter<span class="token punctuation">)</span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    rl<span class="token punctuation">.</span>ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-httpæœåŠ¡ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_2-httpæœåŠ¡ä¼˜åŒ–">#</a> 2. HTTPæœåŠ¡ä¼˜åŒ–</h3>
<h4 id="è¿æ¥æ± ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#è¿æ¥æ± ä¼˜åŒ–">#</a> è¿æ¥æ± ä¼˜åŒ–</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> http</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"net"</span></span>
<span class="line">    <span class="token string">"net/http"</span></span>
<span class="line">    <span class="token string">"time"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// HTTPå®¢æˆ·ç«¯ä¼˜åŒ–é…ç½®</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewOptimizedHTTPClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>http<span class="token punctuation">.</span>Client <span class="token punctuation">{</span></span>
<span class="line">    transport <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// è¿æ¥æ± é…ç½®</span></span>
<span class="line">        MaxIdleConns<span class="token punctuation">:</span>        <span class="token number">100</span><span class="token punctuation">,</span>              <span class="token comment">// æœ€å¤§ç©ºé—²è¿æ¥æ•°</span></span>
<span class="line">        MaxIdleConnsPerHost<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>               <span class="token comment">// æ¯ä¸ªä¸»æœºæœ€å¤§ç©ºé—²è¿æ¥æ•°</span></span>
<span class="line">        MaxConnsPerHost<span class="token punctuation">:</span>     <span class="token number">50</span><span class="token punctuation">,</span>               <span class="token comment">// æ¯ä¸ªä¸»æœºæœ€å¤§è¿æ¥æ•°</span></span>
<span class="line">        IdleConnTimeout<span class="token punctuation">:</span>     <span class="token number">90</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">// ç©ºé—²è¿æ¥è¶…æ—¶</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// TCPé…ç½®</span></span>
<span class="line">        DialContext<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>net<span class="token punctuation">.</span>Dialer<span class="token punctuation">{</span></span>
<span class="line">            Timeout<span class="token punctuation">:</span>   <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">// è¿æ¥è¶…æ—¶</span></span>
<span class="line">            KeepAlive<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">// Keep-Aliveé—´éš”</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>DialContext<span class="token punctuation">,</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// TLSé…ç½®</span></span>
<span class="line">        TLSHandshakeTimeout<span class="token punctuation">:</span>   <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span></span>
<span class="line">        ResponseHeaderTimeout<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span></span>
<span class="line">        ExpectContinueTimeout<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// ç¦ç”¨HTTP/2ï¼ˆå¦‚æœéœ€è¦ï¼‰</span></span>
<span class="line">        ForceAttemptHTTP2<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">{</span></span>
<span class="line">        Transport<span class="token punctuation">:</span> transport<span class="token punctuation">,</span></span>
<span class="line">        Timeout<span class="token punctuation">:</span>   <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">// æ€»è¶…æ—¶æ—¶é—´</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// HTTPæœåŠ¡å™¨ä¼˜åŒ–é…ç½®</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewOptimizedHTTPServer</span><span class="token punctuation">(</span>handler http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> <span class="token operator">*</span>http<span class="token punctuation">.</span>Server <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{</span></span>
<span class="line">        Handler<span class="token punctuation">:</span> handler<span class="token punctuation">,</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// è¶…æ—¶é…ç½®</span></span>
<span class="line">        ReadTimeout<span class="token punctuation">:</span>       <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span></span>
<span class="line">        ReadHeaderTimeout<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span></span>
<span class="line">        WriteTimeout<span class="token punctuation">:</span>      <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span></span>
<span class="line">        IdleTimeout<span class="token punctuation">:</span>       <span class="token number">120</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// ç¼“å†²åŒºå¤§å°</span></span>
<span class="line">        MaxHeaderBytes<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// 1MB</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å“åº”å‹ç¼©ä¸­é—´ä»¶</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">CompressionMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦æ”¯æŒå‹ç¼©</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"Accept-Encoding"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"gzip"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                next<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">return</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// è®¾ç½®å‹ç¼©å“åº”å¤´</span></span>
<span class="line">            w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Encoding"</span><span class="token punctuation">,</span> <span class="token string">"gzip"</span><span class="token punctuation">)</span></span>
<span class="line">            w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Vary"</span><span class="token punctuation">,</span> <span class="token string">"Accept-Encoding"</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// åˆ›å»ºgzipå†™å…¥å™¨</span></span>
<span class="line">            gz <span class="token operator">:=</span> gzip<span class="token punctuation">.</span><span class="token function">NewWriter</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">defer</span> gz<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// åŒ…è£…å“åº”å†™å…¥å™¨</span></span>
<span class="line">            gzw <span class="token operator">:=</span> <span class="token operator">&amp;</span>gzipResponseWriter<span class="token punctuation">{</span></span>
<span class="line">                ResponseWriter<span class="token punctuation">:</span> w<span class="token punctuation">,</span></span>
<span class="line">                Writer<span class="token punctuation">:</span>         gz<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            next<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>gzw<span class="token punctuation">,</span> r<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> gzipResponseWriter <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    http<span class="token punctuation">.</span>ResponseWriter</span>
<span class="line">    io<span class="token punctuation">.</span>Writer</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>w <span class="token operator">*</span>gzipResponseWriter<span class="token punctuation">)</span> <span class="token function">Write</span><span class="token punctuation">(</span>b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> w<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç¼“å­˜ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜ä¼˜åŒ–">#</a> ç¼“å­˜ä¼˜åŒ–</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// å¤šçº§ç¼“å­˜å®ç°</span></span>
<span class="line"><span class="token keyword">type</span> MultiLevelCache <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    l1 <span class="token operator">*</span>sync<span class="token punctuation">.</span>Map           <span class="token comment">// å†…å­˜ç¼“å­˜</span></span>
<span class="line">    l2 <span class="token operator">*</span>redis<span class="token punctuation">.</span>Client       <span class="token comment">// Redisç¼“å­˜</span></span>
<span class="line">    l3 Database            <span class="token comment">// æ•°æ®åº“</span></span>
<span class="line">    </span>
<span class="line">    l1TTL time<span class="token punctuation">.</span>Duration</span>
<span class="line">    l2TTL time<span class="token punctuation">.</span>Duration</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> CacheItem <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Data      <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    ExpiresAt time<span class="token punctuation">.</span>Time</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewMultiLevelCache</span><span class="token punctuation">(</span>redisClient <span class="token operator">*</span>redis<span class="token punctuation">.</span>Client<span class="token punctuation">,</span> db Database<span class="token punctuation">)</span> <span class="token operator">*</span>MultiLevelCache <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>MultiLevelCache<span class="token punctuation">{</span></span>
<span class="line">        l1<span class="token punctuation">:</span>    <span class="token operator">&amp;</span>sync<span class="token punctuation">.</span>Map<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        l2<span class="token punctuation">:</span>    redisClient<span class="token punctuation">,</span></span>
<span class="line">        l3<span class="token punctuation">:</span>    db<span class="token punctuation">,</span></span>
<span class="line">        l1TTL<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">,</span></span>
<span class="line">        l2TTL<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>MultiLevelCache<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// L1ç¼“å­˜æŸ¥è¯¢</span></span>
<span class="line">    <span class="token keyword">if</span> item<span class="token punctuation">,</span> ok <span class="token operator">:=</span> c<span class="token punctuation">.</span>l1<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span></span>
<span class="line">        cacheItem <span class="token operator">:=</span> item<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>CacheItem<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span>cacheItem<span class="token punctuation">.</span>ExpiresAt<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> cacheItem<span class="token punctuation">.</span>Data<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        c<span class="token punctuation">.</span>l1<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token comment">// åˆ é™¤è¿‡æœŸé¡¹</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// L2ç¼“å­˜æŸ¥è¯¢</span></span>
<span class="line">    data<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>l2<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">var</span> value <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// å›å¡«L1ç¼“å­˜</span></span>
<span class="line">            c<span class="token punctuation">.</span><span class="token function">setL1</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> value<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// L3æ•°æ®åº“æŸ¥è¯¢</span></span>
<span class="line">    value<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>l3<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å›å¡«ç¼“å­˜</span></span>
<span class="line">    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        c<span class="token punctuation">.</span><span class="token function">setL1</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span>
<span class="line">        c<span class="token punctuation">.</span><span class="token function">setL2</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> value<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>MultiLevelCache<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// åŒæ—¶è®¾ç½®æ‰€æœ‰ç¼“å­˜å±‚</span></span>
<span class="line">    c<span class="token punctuation">.</span><span class="token function">setL1</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">setL2</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>MultiLevelCache<span class="token punctuation">)</span> <span class="token function">setL1</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    item <span class="token operator">:=</span> <span class="token operator">&amp;</span>CacheItem<span class="token punctuation">{</span></span>
<span class="line">        Data<span class="token punctuation">:</span>      value<span class="token punctuation">,</span></span>
<span class="line">        ExpiresAt<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>l1TTL<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    c<span class="token punctuation">.</span>l1<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> item<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>MultiLevelCache<span class="token punctuation">)</span> <span class="token function">setL2</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    data<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> c<span class="token punctuation">.</span>l2<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> data<span class="token punctuation">,</span> c<span class="token punctuation">.</span>l2TTL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç¼“å­˜é¢„çƒ­</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>MultiLevelCache<span class="token punctuation">)</span> <span class="token function">Warmup</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> keys <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å¹¶å‘é¢„çƒ­</span></span>
<span class="line">    sem <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// é™åˆ¶å¹¶å‘æ•°</span></span>
<span class="line">    <span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> key <span class="token operator">:=</span> <span class="token keyword">range</span> keys <span class="token punctuation">{</span></span>
<span class="line">        wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>k <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            sem <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">&lt;-</span>sem <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token comment">// å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­é¢„çƒ­å…¶ä»–é”®</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ—„ï¸-æ•°æ®åº“ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#ğŸ—„ï¸-æ•°æ®åº“ä¼˜åŒ–">#</a> ğŸ—„ï¸ æ•°æ®åº“ä¼˜åŒ–</h2>
<h3 id="_1-postgresqlä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_1-postgresqlä¼˜åŒ–">#</a> 1. PostgreSQLä¼˜åŒ–</h3>
<h4 id="è¿æ¥æ± ä¼˜åŒ–-1" tabindex="-1"><a class="header-anchor" href="#è¿æ¥æ± ä¼˜åŒ–-1">#</a> è¿æ¥æ± ä¼˜åŒ–</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> database</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"database/sql"</span></span>
<span class="line">    <span class="token string">"time"</span></span>
<span class="line">    </span>
<span class="line">    <span class="token boolean">_</span> <span class="token string">"github.com/lib/pq"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ•°æ®åº“è¿æ¥æ± é…ç½®</span></span>
<span class="line"><span class="token keyword">type</span> DBConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Host            <span class="token builtin">string</span>        <span class="token string">`json:"host"`</span></span>
<span class="line">    Port            <span class="token builtin">int</span>           <span class="token string">`json:"port"`</span></span>
<span class="line">    Database        <span class="token builtin">string</span>        <span class="token string">`json:"database"`</span></span>
<span class="line">    Username        <span class="token builtin">string</span>        <span class="token string">`json:"username"`</span></span>
<span class="line">    Password        <span class="token builtin">string</span>        <span class="token string">`json:"password"`</span></span>
<span class="line">    MaxOpenConns    <span class="token builtin">int</span>           <span class="token string">`json:"max_open_conns"`</span></span>
<span class="line">    MaxIdleConns    <span class="token builtin">int</span>           <span class="token string">`json:"max_idle_conns"`</span></span>
<span class="line">    ConnMaxLifetime time<span class="token punctuation">.</span>Duration <span class="token string">`json:"conn_max_lifetime"`</span></span>
<span class="line">    ConnMaxIdleTime time<span class="token punctuation">.</span>Duration <span class="token string">`json:"conn_max_idle_time"`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewOptimizedDB</span><span class="token punctuation">(</span>cfg DBConfig<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>sql<span class="token punctuation">.</span>DB<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    dsn <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token string">"host=%s port=%d dbname=%s user=%s password=%s sslmode=disable"</span><span class="token punctuation">,</span></span>
<span class="line">        cfg<span class="token punctuation">.</span>Host<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>Port<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>Database<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>Username<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>Password<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> sql<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"postgres"</span><span class="token punctuation">,</span> dsn<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è¿æ¥æ± é…ç½®</span></span>
<span class="line">    db<span class="token punctuation">.</span><span class="token function">SetMaxOpenConns</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>MaxOpenConns<span class="token punctuation">)</span>       <span class="token comment">// æœ€å¤§æ‰“å¼€è¿æ¥æ•°</span></span>
<span class="line">    db<span class="token punctuation">.</span><span class="token function">SetMaxIdleConns</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>MaxIdleConns<span class="token punctuation">)</span>       <span class="token comment">// æœ€å¤§ç©ºé—²è¿æ¥æ•°</span></span>
<span class="line">    db<span class="token punctuation">.</span><span class="token function">SetConnMaxLifetime</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>ConnMaxLifetime<span class="token punctuation">)</span> <span class="token comment">// è¿æ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´</span></span>
<span class="line">    db<span class="token punctuation">.</span><span class="token function">SetConnMaxIdleTime</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>ConnMaxIdleTime<span class="token punctuation">)</span> <span class="token comment">// è¿æ¥æœ€å¤§ç©ºé—²æ—¶é—´</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æµ‹è¯•è¿æ¥</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> db<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// é»˜è®¤ä¼˜åŒ–é…ç½®</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">DefaultDBConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> DBConfig <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> DBConfig<span class="token punctuation">{</span></span>
<span class="line">        MaxOpenConns<span class="token punctuation">:</span>    <span class="token number">25</span><span class="token punctuation">,</span>                <span class="token comment">// æœ€å¤§æ‰“å¼€è¿æ¥æ•°</span></span>
<span class="line">        MaxIdleConns<span class="token punctuation">:</span>    <span class="token number">5</span><span class="token punctuation">,</span>                 <span class="token comment">// æœ€å¤§ç©ºé—²è¿æ¥æ•°</span></span>
<span class="line">        ConnMaxLifetime<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">,</span>  <span class="token comment">// è¿æ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´</span></span>
<span class="line">        ConnMaxIdleTime<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">,</span>   <span class="token comment">// è¿æ¥æœ€å¤§ç©ºé—²æ—¶é—´</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æŸ¥è¯¢ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#æŸ¥è¯¢ä¼˜åŒ–">#</a> æŸ¥è¯¢ä¼˜åŒ–</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>UserRepository<span class="token punctuation">)</span> <span class="token function">GetUsersByIDs</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> ids <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ä½¿ç”¨ANYæ“ä½œç¬¦è¿›è¡Œæ‰¹é‡æŸ¥è¯¢</span></span>
<span class="line">    query <span class="token operator">:=</span> <span class="token string">`</span>
<span class="line">        SELECT id, username, email, created_at </span>
<span class="line">        FROM users </span>
<span class="line">        WHERE id = ANY($1) AND deleted_at IS NULL</span>
<span class="line">        ORDER BY created_at DESC</span>
<span class="line">    `</span></span>
<span class="line">    </span>
<span class="line">    rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">QueryContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> query<span class="token punctuation">,</span> pq<span class="token punctuation">.</span><span class="token function">Array</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to query users: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> rows<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    users <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">var</span> user User</span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>user<span class="token punctuation">.</span>Username<span class="token punctuation">,</span> <span class="token operator">&amp;</span>user<span class="token punctuation">.</span>Email<span class="token punctuation">,</span> <span class="token operator">&amp;</span>user<span class="token punctuation">.</span>CreatedAt<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to scan user: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        users <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>users<span class="token punctuation">,</span> <span class="token operator">&amp;</span>user<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> users<span class="token punctuation">,</span> rows<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>UserRepository<span class="token punctuation">)</span> <span class="token function">ListUsers</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> opts ListOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>UserList<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µè€Œä¸æ˜¯OFFSET</span></span>
<span class="line">    <span class="token keyword">var</span> query <span class="token builtin">string</span></span>
<span class="line">    <span class="token keyword">var</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> opts<span class="token punctuation">.</span>Cursor <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span></span>
<span class="line">        query <span class="token operator">=</span> <span class="token string">`</span>
<span class="line">            SELECT id, username, email, created_at </span>
<span class="line">            FROM users </span>
<span class="line">            WHERE created_at &lt; $1 AND deleted_at IS NULL</span>
<span class="line">            ORDER BY created_at DESC </span>
<span class="line">            LIMIT $2</span>
<span class="line">        `</span></span>
<span class="line">        </span>
<span class="line">        cursorTime<span class="token punctuation">,</span> err <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>RFC3339<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>Cursor<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid cursor: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>cursorTime<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>Limit<span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        query <span class="token operator">=</span> <span class="token string">`</span>
<span class="line">            SELECT id, username, email, created_at </span>
<span class="line">            FROM users </span>
<span class="line">            WHERE deleted_at IS NULL</span>
<span class="line">            ORDER BY created_at DESC </span>
<span class="line">            LIMIT $1</span>
<span class="line">        `</span></span>
<span class="line">        args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>opts<span class="token punctuation">.</span>Limit<span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    rows<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">QueryContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> query<span class="token punctuation">,</span> args<span class="token operator">...</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to query users: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> rows<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    users <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> opts<span class="token punctuation">.</span>Limit<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> rows<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">var</span> user User</span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> rows<span class="token punctuation">.</span><span class="token function">Scan</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>user<span class="token punctuation">.</span>Username<span class="token punctuation">,</span> <span class="token operator">&amp;</span>user<span class="token punctuation">.</span>Email<span class="token punctuation">,</span> <span class="token operator">&amp;</span>user<span class="token punctuation">.</span>CreatedAt<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to scan user: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        users <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>users<span class="token punctuation">,</span> <span class="token operator">&amp;</span>user<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è®¡ç®—ä¸‹ä¸€é¡µæ¸¸æ ‡</span></span>
<span class="line">    <span class="token keyword">var</span> nextCursor <span class="token builtin">string</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span> <span class="token operator">==</span> opts<span class="token punctuation">.</span>Limit <span class="token punctuation">{</span></span>
<span class="line">        nextCursor <span class="token operator">=</span> users<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>CreatedAt<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>RFC3339<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>UserList<span class="token punctuation">{</span></span>
<span class="line">        Users<span class="token punctuation">:</span>      users<span class="token punctuation">,</span></span>
<span class="line">        NextCursor<span class="token punctuation">:</span> nextCursor<span class="token punctuation">,</span></span>
<span class="line">        HasMore<span class="token punctuation">:</span>    nextCursor <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> rows<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// é¢„ç¼–è¯‘è¯­å¥ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">type</span> PreparedStatements <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    getUserByID    <span class="token operator">*</span>sql<span class="token punctuation">.</span>Stmt</span>
<span class="line">    createUser     <span class="token operator">*</span>sql<span class="token punctuation">.</span>Stmt</span>
<span class="line">    updateUser     <span class="token operator">*</span>sql<span class="token punctuation">.</span>Stmt</span>
<span class="line">    deleteUser     <span class="token operator">*</span>sql<span class="token punctuation">.</span>Stmt</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewPreparedStatements</span><span class="token punctuation">(</span>db <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>PreparedStatements<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    ps <span class="token operator">:=</span> <span class="token operator">&amp;</span>PreparedStatements<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">var</span> err <span class="token builtin">error</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// é¢„ç¼–è¯‘å¸¸ç”¨æŸ¥è¯¢</span></span>
<span class="line">    ps<span class="token punctuation">.</span>getUserByID<span class="token punctuation">,</span> err <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Prepare</span><span class="token punctuation">(</span><span class="token string">`</span>
<span class="line">        SELECT id, username, email, created_at </span>
<span class="line">        FROM users </span>
<span class="line">        WHERE id = $1 AND deleted_at IS NULL</span>
<span class="line">    `</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    ps<span class="token punctuation">.</span>createUser<span class="token punctuation">,</span> err <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Prepare</span><span class="token punctuation">(</span><span class="token string">`</span>
<span class="line">        INSERT INTO users (id, username, email, created_at) </span>
<span class="line">        VALUES ($1, $2, $3, $4)</span>
<span class="line">    `</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    ps<span class="token punctuation">.</span>updateUser<span class="token punctuation">,</span> err <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Prepare</span><span class="token punctuation">(</span><span class="token string">`</span>
<span class="line">        UPDATE users </span>
<span class="line">        SET username = $2, email = $3, updated_at = $4 </span>
<span class="line">        WHERE id = $1 AND deleted_at IS NULL</span>
<span class="line">    `</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    ps<span class="token punctuation">.</span>deleteUser<span class="token punctuation">,</span> err <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Prepare</span><span class="token punctuation">(</span><span class="token string">`</span>
<span class="line">        UPDATE users </span>
<span class="line">        SET deleted_at = $2 </span>
<span class="line">        WHERE id = $1 AND deleted_at IS NULL</span>
<span class="line">    `</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> ps<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>ps <span class="token operator">*</span>PreparedStatements<span class="token punctuation">)</span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> errs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> ps<span class="token punctuation">.</span>getUserByID<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> ps<span class="token punctuation">.</span>createUser<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> ps<span class="token punctuation">.</span>updateUser<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> ps<span class="token punctuation">.</span>deleteUser<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to close prepared statements: %v"</span><span class="token punctuation">,</span> errs<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç´¢å¼•ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#ç´¢å¼•ä¼˜åŒ–">#</a> ç´¢å¼•ä¼˜åŒ–</h4>
<div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre v-pre><code class="language-sql"><span class="line"><span class="token comment">-- ç”¨æˆ·è¡¨ç´¢å¼•ä¼˜åŒ–</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- ä¸»é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> users_pkey <span class="token keyword">ON</span> users <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- å”¯ä¸€ç´¢å¼•</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> users_username_key <span class="token keyword">ON</span> users <span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> deleted_at <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> users_email_key <span class="token keyword">ON</span> users <span class="token punctuation">(</span>email<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> deleted_at <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- å¤åˆç´¢å¼•</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> users_status_created_at_idx <span class="token keyword">ON</span> users <span class="token punctuation">(</span><span class="token keyword">status</span><span class="token punctuation">,</span> created_at <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">WHERE</span> deleted_at <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> users_created_at_idx <span class="token keyword">ON</span> users <span class="token punctuation">(</span>created_at <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">WHERE</span> deleted_at <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æ´»è·ƒç”¨æˆ·ï¼‰</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> users_active_username_idx <span class="token keyword">ON</span> users <span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> <span class="token keyword">status</span> <span class="token operator">=</span> <span class="token string">'active'</span> <span class="token operator">AND</span> deleted_at <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- è¡¨è¾¾å¼ç´¢å¼•</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> users_email_lower_idx <span class="token keyword">ON</span> users <span class="token punctuation">(</span>LOWER<span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">WHERE</span> deleted_at <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- ç­–ç•¥è¡¨ç´¢å¼•</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> policies_user_id_idx <span class="token keyword">ON</span> policies <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> deleted_at <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> policies_name_idx <span class="token keyword">ON</span> policies <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> deleted_at <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> policies_status_created_at_idx <span class="token keyword">ON</span> policies <span class="token punctuation">(</span><span class="token keyword">status</span><span class="token punctuation">,</span> created_at <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">WHERE</span> deleted_at <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- è®¿é—®å¯†é’¥è¡¨ç´¢å¼•</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> access_keys_access_key_id_key <span class="token keyword">ON</span> access_keys <span class="token punctuation">(</span>access_key_id<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> deleted_at <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> access_keys_user_id_idx <span class="token keyword">ON</span> access_keys <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token keyword">WHERE</span> deleted_at <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> access_keys_status_idx <span class="token keyword">ON</span> access_keys <span class="token punctuation">(</span><span class="token keyword">status</span><span class="token punctuation">)</span> <span class="token keyword">WHERE</span> deleted_at <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- å®¡è®¡æ—¥å¿—è¡¨ç´¢å¼•ï¼ˆæ—¶é—´åºåˆ—ä¼˜åŒ–ï¼‰</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> audit_logs_user_id_created_at_idx <span class="token keyword">ON</span> audit_logs <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> created_at <span class="token keyword">DESC</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> audit_logs_action_created_at_idx <span class="token keyword">ON</span> audit_logs <span class="token punctuation">(</span><span class="token keyword">action</span><span class="token punctuation">,</span> created_at <span class="token keyword">DESC</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> audit_logs_created_at_idx <span class="token keyword">ON</span> audit_logs <span class="token punctuation">(</span>created_at <span class="token keyword">DESC</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- åˆ†åŒºè¡¨ï¼ˆæŒ‰æ—¶é—´åˆ†åŒºï¼‰</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> audit_logs_2024_01 <span class="token keyword">PARTITION</span> <span class="token keyword">OF</span> audit_logs </span>
<span class="line"><span class="token keyword">FOR</span> <span class="token keyword">VALUES</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token string">'2024-01-01'</span><span class="token punctuation">)</span> <span class="token keyword">TO</span> <span class="token punctuation">(</span><span class="token string">'2024-02-01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> audit_logs_2024_02 <span class="token keyword">PARTITION</span> <span class="token keyword">OF</span> audit_logs </span>
<span class="line"><span class="token keyword">FOR</span> <span class="token keyword">VALUES</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token string">'2024-02-01'</span><span class="token punctuation">)</span> <span class="token keyword">TO</span> <span class="token punctuation">(</span><span class="token string">'2024-03-01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-redisä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_2-redisä¼˜åŒ–">#</a> 2. Redisä¼˜åŒ–</h3>
<h4 id="redisé…ç½®ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#redisé…ç½®ä¼˜åŒ–">#</a> Redisé…ç½®ä¼˜åŒ–</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> cache</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"context"</span></span>
<span class="line">    <span class="token string">"time"</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">"github.com/redis/go-redis/v9"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Redisé…ç½®ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewOptimizedRedisClient</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> password <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>redis<span class="token punctuation">.</span>Client <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>redis<span class="token punctuation">.</span>Options<span class="token punctuation">{</span></span>
<span class="line">        Addr<span class="token punctuation">:</span>     addr<span class="token punctuation">,</span></span>
<span class="line">        Password<span class="token punctuation">:</span> password<span class="token punctuation">,</span></span>
<span class="line">        DB<span class="token punctuation">:</span>       <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// è¿æ¥æ± é…ç½®</span></span>
<span class="line">        PoolSize<span class="token punctuation">:</span>        <span class="token number">20</span><span class="token punctuation">,</span>               <span class="token comment">// è¿æ¥æ± å¤§å°</span></span>
<span class="line">        MinIdleConns<span class="token punctuation">:</span>    <span class="token number">5</span><span class="token punctuation">,</span>                <span class="token comment">// æœ€å°ç©ºé—²è¿æ¥æ•°</span></span>
<span class="line">        MaxIdleConns<span class="token punctuation">:</span>    <span class="token number">10</span><span class="token punctuation">,</span>               <span class="token comment">// æœ€å¤§ç©ºé—²è¿æ¥æ•°</span></span>
<span class="line">        ConnMaxIdleTime<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">,</span>  <span class="token comment">// è¿æ¥æœ€å¤§ç©ºé—²æ—¶é—´</span></span>
<span class="line">        ConnMaxLifetime<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">,</span> <span class="token comment">// è¿æ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// è¶…æ—¶é…ç½®</span></span>
<span class="line">        DialTimeout<span class="token punctuation">:</span>  <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span></span>
<span class="line">        ReadTimeout<span class="token punctuation">:</span>  <span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span></span>
<span class="line">        WriteTimeout<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// é‡è¯•é…ç½®</span></span>
<span class="line">        MaxRetries<span class="token punctuation">:</span>      <span class="token number">3</span><span class="token punctuation">,</span></span>
<span class="line">        MinRetryBackoff<span class="token punctuation">:</span> <span class="token number">8</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">,</span></span>
<span class="line">        MaxRetryBackoff<span class="token punctuation">:</span> <span class="token number">512</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Redisé›†ç¾¤é…ç½®</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewOptimizedRedisCluster</span><span class="token punctuation">(</span>addrs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> password <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>redis<span class="token punctuation">.</span>ClusterClient <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">NewClusterClient</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>redis<span class="token punctuation">.</span>ClusterOptions<span class="token punctuation">{</span></span>
<span class="line">        Addrs<span class="token punctuation">:</span>    addrs<span class="token punctuation">,</span></span>
<span class="line">        Password<span class="token punctuation">:</span> password<span class="token punctuation">,</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// è¿æ¥æ± é…ç½®</span></span>
<span class="line">        PoolSize<span class="token punctuation">:</span>        <span class="token number">20</span><span class="token punctuation">,</span></span>
<span class="line">        MinIdleConns<span class="token punctuation">:</span>    <span class="token number">5</span><span class="token punctuation">,</span></span>
<span class="line">        ConnMaxIdleTime<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">,</span></span>
<span class="line">        ConnMaxLifetime<span class="token punctuation">:</span> <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Minute<span class="token punctuation">,</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// è¶…æ—¶é…ç½®</span></span>
<span class="line">        DialTimeout<span class="token punctuation">:</span>  <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span></span>
<span class="line">        ReadTimeout<span class="token punctuation">:</span>  <span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span></span>
<span class="line">        WriteTimeout<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// é›†ç¾¤é…ç½®</span></span>
<span class="line">        MaxRedirects<span class="token punctuation">:</span>   <span class="token number">8</span><span class="token punctuation">,</span></span>
<span class="line">        ReadOnly<span class="token punctuation">:</span>       <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// å…è®¸ä»ä»èŠ‚ç‚¹è¯»å–</span></span>
<span class="line">        RouteByLatency<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// æŒ‰å»¶è¿Ÿè·¯ç”±</span></span>
<span class="line">        RouteRandomly<span class="token punctuation">:</span>  <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// ä¸éšæœºè·¯ç”±</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç¼“å­˜ç­–ç•¥ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜ç­–ç•¥ä¼˜åŒ–">#</a> ç¼“å­˜ç­–ç•¥ä¼˜åŒ–</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// ç¼“å­˜é”®ç®¡ç†</span></span>
<span class="line"><span class="token keyword">type</span> CacheKeyManager <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    prefix <span class="token builtin">string</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewCacheKeyManager</span><span class="token punctuation">(</span>prefix <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>CacheKeyManager <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>CacheKeyManager<span class="token punctuation">{</span>prefix<span class="token punctuation">:</span> prefix<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>CacheKeyManager<span class="token punctuation">)</span> <span class="token function">UserKey</span><span class="token punctuation">(</span>userID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s:user:%s"</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>prefix<span class="token punctuation">,</span> userID<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>CacheKeyManager<span class="token punctuation">)</span> <span class="token function">UserListKey</span><span class="token punctuation">(</span>page <span class="token builtin">int</span><span class="token punctuation">,</span> limit <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s:users:list:%d:%d"</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>prefix<span class="token punctuation">,</span> page<span class="token punctuation">,</span> limit<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>CacheKeyManager<span class="token punctuation">)</span> <span class="token function">PermissionKey</span><span class="token punctuation">(</span>userID<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> action <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s:permission:%s:%s:%s"</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>prefix<span class="token punctuation">,</span> userID<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> action<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç¼“å­˜æœåŠ¡ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">type</span> CacheService <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    client    <span class="token operator">*</span>redis<span class="token punctuation">.</span>Client</span>
<span class="line">    keyMgr    <span class="token operator">*</span>CacheKeyManager</span>
<span class="line">    serializer Serializer</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Serializer <span class="token keyword">interface</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">Marshal</span><span class="token punctuation">(</span>v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">Unmarshal</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// JSONåºåˆ—åŒ–å™¨</span></span>
<span class="line"><span class="token keyword">type</span> JSONSerializer <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>JSONSerializer<span class="token punctuation">)</span> <span class="token function">Marshal</span><span class="token punctuation">(</span>v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>JSONSerializer<span class="token punctuation">)</span> <span class="token function">Unmarshal</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> v<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// MessagePackåºåˆ—åŒ–å™¨ï¼ˆæ›´é«˜æ•ˆï¼‰</span></span>
<span class="line"><span class="token keyword">type</span> MsgPackSerializer <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>MsgPackSerializer<span class="token punctuation">)</span> <span class="token function">Marshal</span><span class="token punctuation">(</span>v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> msgpack<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>MsgPackSerializer<span class="token punctuation">)</span> <span class="token function">Unmarshal</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> msgpack<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> v<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewCacheService</span><span class="token punctuation">(</span>client <span class="token operator">*</span>redis<span class="token punctuation">.</span>Client<span class="token punctuation">,</span> keyMgr <span class="token operator">*</span>CacheKeyManager<span class="token punctuation">)</span> <span class="token operator">*</span>CacheService <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>CacheService<span class="token punctuation">{</span></span>
<span class="line">        client<span class="token punctuation">:</span>     client<span class="token punctuation">,</span></span>
<span class="line">        keyMgr<span class="token punctuation">:</span>     keyMgr<span class="token punctuation">,</span></span>
<span class="line">        serializer<span class="token punctuation">:</span> <span class="token operator">&amp;</span>MsgPackSerializer<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// ä½¿ç”¨æ›´é«˜æ•ˆçš„åºåˆ—åŒ–å™¨</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ‰¹é‡æ“ä½œä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>CacheService<span class="token punctuation">)</span> <span class="token function">GetUsers</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> userIDs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>userIDs<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>User<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ„å»ºç¼“å­˜é”®</span></span>
<span class="line">    keys <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>userIDs<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> i<span class="token punctuation">,</span> id <span class="token operator">:=</span> <span class="token keyword">range</span> userIDs <span class="token punctuation">{</span></span>
<span class="line">        keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">.</span>keyMgr<span class="token punctuation">.</span><span class="token function">UserKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ‰¹é‡è·å–</span></span>
<span class="line">    values<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">MGet</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> keys<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// è§£æç»“æœ</span></span>
<span class="line">    users <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>User<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> i<span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> values <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> value <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span> <span class="token comment">// ç¼“å­˜æœªå‘½ä¸­</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">var</span> user User</span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span> <span class="token comment">// ååºåˆ—åŒ–å¤±è´¥ï¼Œè·³è¿‡</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        users<span class="token punctuation">[</span>userIDs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>user</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> users<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç®¡é“æ“ä½œä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>CacheService<span class="token punctuation">)</span> <span class="token function">SetUsers</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> users <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>User<span class="token punctuation">,</span> ttl time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ä½¿ç”¨ç®¡é“æ‰¹é‡è®¾ç½®</span></span>
<span class="line">    pipe <span class="token operator">:=</span> s<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> userID<span class="token punctuation">,</span> user <span class="token operator">:=</span> <span class="token keyword">range</span> users <span class="token punctuation">{</span></span>
<span class="line">        data<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span> <span class="token comment">// åºåˆ—åŒ–å¤±è´¥ï¼Œè·³è¿‡</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        key <span class="token operator">:=</span> s<span class="token punctuation">.</span>keyMgr<span class="token punctuation">.</span><span class="token function">UserKey</span><span class="token punctuation">(</span>userID<span class="token punctuation">)</span></span>
<span class="line">        pipe<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> key<span class="token punctuation">,</span> data<span class="token punctuation">,</span> ttl<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> pipe<span class="token punctuation">.</span><span class="token function">Exec</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> err</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç¼“å­˜é¢„çƒ­</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>CacheService<span class="token punctuation">)</span> <span class="token function">WarmupUsers</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> userIDs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> loader <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>User<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ£€æŸ¥å“ªäº›ç”¨æˆ·ä¸åœ¨ç¼“å­˜ä¸­</span></span>
<span class="line">    cached<span class="token punctuation">,</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">GetUsers</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> userIDs<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">var</span> missing <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> id <span class="token operator">:=</span> <span class="token keyword">range</span> userIDs <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> exists <span class="token operator">:=</span> cached<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>exists <span class="token punctuation">{</span></span>
<span class="line">            missing <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>missing<span class="token punctuation">,</span> id<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>missing<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span> <span class="token comment">// æ‰€æœ‰æ•°æ®éƒ½å·²ç¼“å­˜</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// åŠ è½½ç¼ºå¤±çš„æ•°æ®</span></span>
<span class="line">    users<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">loader</span><span class="token punctuation">(</span>missing<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç¼“å­˜æ–°æ•°æ®</span></span>
<span class="line">    <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">SetUsers</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> users<span class="token punctuation">,</span> <span class="token number">30</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸŒ-ç½‘ç»œä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#ğŸŒ-ç½‘ç»œä¼˜åŒ–">#</a> ğŸŒ ç½‘ç»œä¼˜åŒ–</h2>
<h3 id="_1-grpcä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_1-grpcä¼˜åŒ–">#</a> 1. gRPCä¼˜åŒ–</h3>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> grpc</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"context"</span></span>
<span class="line">    <span class="token string">"time"</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">"google.golang.org/grpc"</span></span>
<span class="line">    <span class="token string">"google.golang.org/grpc/keepalive"</span></span>
<span class="line">    <span class="token string">"google.golang.org/grpc/credentials/insecure"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// gRPCå®¢æˆ·ç«¯ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewOptimizedGRPCClient</span><span class="token punctuation">(</span>target <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>grpc<span class="token punctuation">.</span>ClientConn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span></span>
<span class="line">        grpc<span class="token punctuation">.</span><span class="token function">WithTransportCredentials</span><span class="token punctuation">(</span>insecure<span class="token punctuation">.</span><span class="token function">NewCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// è¿æ¥æ± é…ç½®</span></span>
<span class="line">        grpc<span class="token punctuation">.</span><span class="token function">WithDefaultCallOptions</span><span class="token punctuation">(</span></span>
<span class="line">            grpc<span class="token punctuation">.</span><span class="token function">MaxCallRecvMsgSize</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 4MB</span></span>
<span class="line">            grpc<span class="token punctuation">.</span><span class="token function">MaxCallSendMsgSize</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 4MB</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// Keep-Aliveé…ç½®</span></span>
<span class="line">        grpc<span class="token punctuation">.</span><span class="token function">WithKeepaliveParams</span><span class="token punctuation">(</span>keepalive<span class="token punctuation">.</span>ClientParameters<span class="token punctuation">{</span></span>
<span class="line">            Time<span class="token punctuation">:</span>                <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">// å‘é€keepalive pingçš„é—´éš”</span></span>
<span class="line">            Timeout<span class="token punctuation">:</span>             <span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>  <span class="token comment">// ç­‰å¾…keepalive pingå“åº”çš„è¶…æ—¶</span></span>
<span class="line">            PermitWithoutStream<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>             <span class="token comment">// å…è®¸åœ¨æ²¡æœ‰æ´»è·ƒæµæ—¶å‘é€keepalive ping</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// è¿æ¥çŠ¶æ€ç›‘æ§</span></span>
<span class="line">        grpc<span class="token punctuation">.</span><span class="token function">WithBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        grpc<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// gRPCæœåŠ¡å™¨ä¼˜åŒ–</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewOptimizedGRPCServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>grpc<span class="token punctuation">.</span>Server <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token comment">// æ¶ˆæ¯å¤§å°é™åˆ¶</span></span>
<span class="line">        grpc<span class="token punctuation">.</span><span class="token function">MaxRecvMsgSize</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 4MB</span></span>
<span class="line">        grpc<span class="token punctuation">.</span><span class="token function">MaxSendMsgSize</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 4MB</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// Keep-Aliveé…ç½®</span></span>
<span class="line">        grpc<span class="token punctuation">.</span><span class="token function">KeepaliveParams</span><span class="token punctuation">(</span>keepalive<span class="token punctuation">.</span>ServerParameters<span class="token punctuation">{</span></span>
<span class="line">            Time<span class="token punctuation">:</span>    <span class="token number">60</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">// æœåŠ¡å™¨å‘é€keepalive pingçš„é—´éš”</span></span>
<span class="line">            Timeout<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>  <span class="token comment">// ç­‰å¾…keepalive pingå“åº”çš„è¶…æ—¶</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        </span>
<span class="line">        grpc<span class="token punctuation">.</span><span class="token function">KeepaliveEnforcementPolicy</span><span class="token punctuation">(</span>keepalive<span class="token punctuation">.</span>EnforcementPolicy<span class="token punctuation">{</span></span>
<span class="line">            MinTime<span class="token punctuation">:</span>             <span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> <span class="token comment">// å®¢æˆ·ç«¯å‘é€keepalive pingçš„æœ€å°é—´éš”</span></span>
<span class="line">            PermitWithoutStream<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>             <span class="token comment">// å…è®¸åœ¨æ²¡æœ‰æ´»è·ƒæµæ—¶å‘é€keepalive ping</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// è¿æ¥è¶…æ—¶</span></span>
<span class="line">        grpc<span class="token punctuation">.</span><span class="token function">ConnectionTimeout</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è¿æ¥æ± ç®¡ç†</span></span>
<span class="line"><span class="token keyword">type</span> GRPCConnectionPool <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    connections <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>grpc<span class="token punctuation">.</span>ClientConn</span>
<span class="line">    current     <span class="token builtin">int</span></span>
<span class="line">    mu          sync<span class="token punctuation">.</span>RWMutex</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewGRPCConnectionPool</span><span class="token punctuation">(</span>target <span class="token builtin">string</span><span class="token punctuation">,</span> size <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>GRPCConnectionPool<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    pool <span class="token operator">:=</span> <span class="token operator">&amp;</span>GRPCConnectionPool<span class="token punctuation">{</span></span>
<span class="line">        connections<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>grpc<span class="token punctuation">.</span>ClientConn<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">        conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NewOptimizedGRPCClient</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// å…³é—­å·²åˆ›å»ºçš„è¿æ¥</span></span>
<span class="line">            <span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> i<span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">                pool<span class="token punctuation">.</span>connections<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        pool<span class="token punctuation">.</span>connections<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> conn</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> pool<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>GRPCConnectionPool<span class="token punctuation">)</span> <span class="token function">GetConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>grpc<span class="token punctuation">.</span>ClientConn <span class="token punctuation">{</span></span>
<span class="line">    p<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> p<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    conn <span class="token operator">:=</span> p<span class="token punctuation">.</span>connections<span class="token punctuation">[</span>p<span class="token punctuation">.</span>current<span class="token punctuation">]</span></span>
<span class="line">    p<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">len</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>connections<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> conn</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>GRPCConnectionPool<span class="token punctuation">)</span> <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    p<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> p<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">var</span> errs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">error</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> conn <span class="token operator">:=</span> <span class="token keyword">range</span> p<span class="token punctuation">.</span>connections <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            errs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>errs<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>errs<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to close connections: %v"</span><span class="token punctuation">,</span> errs<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-è´Ÿè½½å‡è¡¡ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_2-è´Ÿè½½å‡è¡¡ä¼˜åŒ–">#</a> 2. è´Ÿè½½å‡è¡¡ä¼˜åŒ–</h3>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// è´Ÿè½½å‡è¡¡å™¨</span></span>
<span class="line"><span class="token keyword">type</span> LoadBalancer <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    servers <span class="token punctuation">[</span><span class="token punctuation">]</span>Server</span>
<span class="line">    current <span class="token builtin">int</span></span>
<span class="line">    mu      sync<span class="token punctuation">.</span>RWMutex</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Server <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Address <span class="token builtin">string</span></span>
<span class="line">    Weight  <span class="token builtin">int</span></span>
<span class="line">    Active  <span class="token builtin">bool</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è½®è¯¢è´Ÿè½½å‡è¡¡</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>lb <span class="token operator">*</span>LoadBalancer<span class="token punctuation">)</span> <span class="token function">RoundRobin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Server <span class="token punctuation">{</span></span>
<span class="line">    lb<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> lb<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>lb<span class="token punctuation">.</span>servers<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">        server <span class="token operator">:=</span> <span class="token operator">&amp;</span>lb<span class="token punctuation">.</span>servers<span class="token punctuation">[</span>lb<span class="token punctuation">.</span>current<span class="token punctuation">]</span></span>
<span class="line">        lb<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token punctuation">(</span>lb<span class="token punctuation">.</span>current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">len</span><span class="token punctuation">(</span>lb<span class="token punctuation">.</span>servers<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> server<span class="token punctuation">.</span>Active <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> server</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span> <span class="token comment">// æ²¡æœ‰å¯ç”¨æœåŠ¡å™¨</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// åŠ æƒè½®è¯¢è´Ÿè½½å‡è¡¡</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>lb <span class="token operator">*</span>LoadBalancer<span class="token punctuation">)</span> <span class="token function">WeightedRoundRobin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Server <span class="token punctuation">{</span></span>
<span class="line">    lb<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> lb<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    totalWeight <span class="token operator">:=</span> <span class="token number">0</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> server <span class="token operator">:=</span> <span class="token keyword">range</span> lb<span class="token punctuation">.</span>servers <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> server<span class="token punctuation">.</span>Active <span class="token punctuation">{</span></span>
<span class="line">            totalWeight <span class="token operator">+=</span> server<span class="token punctuation">.</span>Weight</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> totalWeight <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    target <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span>totalWeight<span class="token punctuation">)</span></span>
<span class="line">    current <span class="token operator">:=</span> <span class="token number">0</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> server <span class="token operator">:=</span> <span class="token keyword">range</span> lb<span class="token punctuation">.</span>servers <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token operator">!</span>server<span class="token punctuation">.</span>Active <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">continue</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        current <span class="token operator">+=</span> server<span class="token punctuation">.</span>Weight</span>
<span class="line">        <span class="token keyword">if</span> current <span class="token operator">></span> target <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token operator">&amp;</span>server</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å¥åº·æ£€æŸ¥</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>lb <span class="token operator">*</span>LoadBalancer<span class="token punctuation">)</span> <span class="token function">HealthCheck</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">select</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span></span>
<span class="line">            lb<span class="token punctuation">.</span><span class="token function">checkServers</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>lb <span class="token operator">*</span>LoadBalancer<span class="token punctuation">)</span> <span class="token function">checkServers</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> lb<span class="token punctuation">.</span>servers <span class="token punctuation">{</span></span>
<span class="line">        wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>index <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            server <span class="token operator">:=</span> <span class="token operator">&amp;</span>lb<span class="token punctuation">.</span>servers<span class="token punctuation">[</span>index<span class="token punctuation">]</span></span>
<span class="line">            active <span class="token operator">:=</span> lb<span class="token punctuation">.</span><span class="token function">isServerHealthy</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> server<span class="token punctuation">.</span>Address<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            lb<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            server<span class="token punctuation">.</span>Active <span class="token operator">=</span> active</span>
<span class="line">            lb<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>lb <span class="token operator">*</span>LoadBalancer<span class="token punctuation">)</span> <span class="token function">isServerHealthy</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">    client <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">{</span>Timeout<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequestWithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"GET"</span><span class="token punctuation">,</span> address<span class="token operator">+</span><span class="token string">"/health"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> resp<span class="token punctuation">.</span>StatusCode <span class="token operator">==</span> http<span class="token punctuation">.</span>StatusOK</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“Š-ç›‘æ§å’Œåˆ†æ" tabindex="-1"><a class="header-anchor" href="#ğŸ“Š-ç›‘æ§å’Œåˆ†æ">#</a> ğŸ“Š ç›‘æ§å’Œåˆ†æ</h2>
<h3 id="_1-æ€§èƒ½æŒ‡æ ‡æ”¶é›†" tabindex="-1"><a class="header-anchor" href="#_1-æ€§èƒ½æŒ‡æ ‡æ”¶é›†">#</a> 1. æ€§èƒ½æŒ‡æ ‡æ”¶é›†</h3>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> metrics</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"context"</span></span>
<span class="line">    <span class="token string">"runtime"</span></span>
<span class="line">    <span class="token string">"time"</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">"github.com/prometheus/client_golang/prometheus"</span></span>
<span class="line">    <span class="token string">"github.com/prometheus/client_golang/prometheus/promauto"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ€§èƒ½æŒ‡æ ‡å®šä¹‰</span></span>
<span class="line"><span class="token keyword">var</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token comment">// HTTPæŒ‡æ ‡</span></span>
<span class="line">    httpRequestsTotal <span class="token operator">=</span> promauto<span class="token punctuation">.</span><span class="token function">NewCounterVec</span><span class="token punctuation">(</span></span>
<span class="line">        prometheus<span class="token punctuation">.</span>CounterOpts<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span> <span class="token string">"http_requests_total"</span><span class="token punctuation">,</span></span>
<span class="line">            Help<span class="token punctuation">:</span> <span class="token string">"Total number of HTTP requests"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"method"</span><span class="token punctuation">,</span> <span class="token string">"endpoint"</span><span class="token punctuation">,</span> <span class="token string">"status"</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    httpRequestDuration <span class="token operator">=</span> promauto<span class="token punctuation">.</span><span class="token function">NewHistogramVec</span><span class="token punctuation">(</span></span>
<span class="line">        prometheus<span class="token punctuation">.</span>HistogramOpts<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span>    <span class="token string">"http_request_duration_seconds"</span><span class="token punctuation">,</span></span>
<span class="line">            Help<span class="token punctuation">:</span>    <span class="token string">"HTTP request duration in seconds"</span><span class="token punctuation">,</span></span>
<span class="line">            Buckets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">{</span><span class="token number">.005</span><span class="token punctuation">,</span> <span class="token number">.01</span><span class="token punctuation">,</span> <span class="token number">.025</span><span class="token punctuation">,</span> <span class="token number">.05</span><span class="token punctuation">,</span> <span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"method"</span><span class="token punctuation">,</span> <span class="token string">"endpoint"</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ•°æ®åº“æŒ‡æ ‡</span></span>
<span class="line">    dbConnectionsActive <span class="token operator">=</span> promauto<span class="token punctuation">.</span><span class="token function">NewGauge</span><span class="token punctuation">(</span></span>
<span class="line">        prometheus<span class="token punctuation">.</span>GaugeOpts<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span> <span class="token string">"db_connections_active"</span><span class="token punctuation">,</span></span>
<span class="line">            Help<span class="token punctuation">:</span> <span class="token string">"Number of active database connections"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    dbQueryDuration <span class="token operator">=</span> promauto<span class="token punctuation">.</span><span class="token function">NewHistogramVec</span><span class="token punctuation">(</span></span>
<span class="line">        prometheus<span class="token punctuation">.</span>HistogramOpts<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span>    <span class="token string">"db_query_duration_seconds"</span><span class="token punctuation">,</span></span>
<span class="line">            Help<span class="token punctuation">:</span>    <span class="token string">"Database query duration in seconds"</span><span class="token punctuation">,</span></span>
<span class="line">            Buckets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">{</span><span class="token number">.001</span><span class="token punctuation">,</span> <span class="token number">.005</span><span class="token punctuation">,</span> <span class="token number">.01</span><span class="token punctuation">,</span> <span class="token number">.025</span><span class="token punctuation">,</span> <span class="token number">.05</span><span class="token punctuation">,</span> <span class="token number">.1</span><span class="token punctuation">,</span> <span class="token number">.25</span><span class="token punctuation">,</span> <span class="token number">.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2.5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"query_type"</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç¼“å­˜æŒ‡æ ‡</span></span>
<span class="line">    cacheHitsTotal <span class="token operator">=</span> promauto<span class="token punctuation">.</span><span class="token function">NewCounterVec</span><span class="token punctuation">(</span></span>
<span class="line">        prometheus<span class="token punctuation">.</span>CounterOpts<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span> <span class="token string">"cache_hits_total"</span><span class="token punctuation">,</span></span>
<span class="line">            Help<span class="token punctuation">:</span> <span class="token string">"Total number of cache hits"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"cache_type"</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    cacheMissesTotal <span class="token operator">=</span> promauto<span class="token punctuation">.</span><span class="token function">NewCounterVec</span><span class="token punctuation">(</span></span>
<span class="line">        prometheus<span class="token punctuation">.</span>CounterOpts<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span> <span class="token string">"cache_misses_total"</span><span class="token punctuation">,</span></span>
<span class="line">            Help<span class="token punctuation">:</span> <span class="token string">"Total number of cache misses"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"cache_type"</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç³»ç»ŸæŒ‡æ ‡</span></span>
<span class="line">    memoryUsage <span class="token operator">=</span> promauto<span class="token punctuation">.</span><span class="token function">NewGauge</span><span class="token punctuation">(</span></span>
<span class="line">        prometheus<span class="token punctuation">.</span>GaugeOpts<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span> <span class="token string">"memory_usage_bytes"</span><span class="token punctuation">,</span></span>
<span class="line">            Help<span class="token punctuation">:</span> <span class="token string">"Memory usage in bytes"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    goroutinesActive <span class="token operator">=</span> promauto<span class="token punctuation">.</span><span class="token function">NewGauge</span><span class="token punctuation">(</span></span>
<span class="line">        prometheus<span class="token punctuation">.</span>GaugeOpts<span class="token punctuation">{</span></span>
<span class="line">            Name<span class="token punctuation">:</span> <span class="token string">"goroutines_active"</span><span class="token punctuation">,</span></span>
<span class="line">            Help<span class="token punctuation">:</span> <span class="token string">"Number of active goroutines"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æŒ‡æ ‡æ”¶é›†å™¨</span></span>
<span class="line"><span class="token keyword">type</span> MetricsCollector <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    db <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewMetricsCollector</span><span class="token punctuation">(</span>db <span class="token operator">*</span>sql<span class="token punctuation">.</span>DB<span class="token punctuation">)</span> <span class="token operator">*</span>MetricsCollector <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>MetricsCollector<span class="token punctuation">{</span>db<span class="token punctuation">:</span> db<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å¯åŠ¨æŒ‡æ ‡æ”¶é›†</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>MetricsCollector<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">15</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">select</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span></span>
<span class="line">            m<span class="token punctuation">.</span><span class="token function">collectSystemMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            m<span class="token punctuation">.</span><span class="token function">collectDatabaseMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>MetricsCollector<span class="token punctuation">)</span> <span class="token function">collectSystemMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> memStats runtime<span class="token punctuation">.</span>MemStats</span>
<span class="line">    runtime<span class="token punctuation">.</span><span class="token function">ReadMemStats</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>memStats<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    memoryUsage<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>memStats<span class="token punctuation">.</span>Alloc<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    goroutinesActive<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>runtime<span class="token punctuation">.</span><span class="token function">NumGoroutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>MetricsCollector<span class="token punctuation">)</span> <span class="token function">collectDatabaseMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    stats <span class="token operator">:=</span> m<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">Stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    dbConnectionsActive<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>OpenConnections<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// HTTPæŒ‡æ ‡ä¸­é—´ä»¶</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">MetricsMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// åŒ…è£…å“åº”å†™å…¥å™¨ä»¥æ•è·çŠ¶æ€ç </span></span>
<span class="line">            rw <span class="token operator">:=</span> <span class="token operator">&amp;</span>responseWriter<span class="token punctuation">{</span>ResponseWriter<span class="token punctuation">:</span> w<span class="token punctuation">,</span> statusCode<span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// æ‰§è¡Œè¯·æ±‚</span></span>
<span class="line">            next<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>rw<span class="token punctuation">,</span> r<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// è®°å½•æŒ‡æ ‡</span></span>
<span class="line">            duration <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Seconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            httpRequestsTotal<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span></span>
<span class="line">                r<span class="token punctuation">.</span>Method<span class="token punctuation">,</span></span>
<span class="line">                r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span></span>
<span class="line">                fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> rw<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            httpRequestDuration<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span></span>
<span class="line">                r<span class="token punctuation">.</span>Method<span class="token punctuation">,</span></span>
<span class="line">                r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ•°æ®åº“æŒ‡æ ‡è£…é¥°å™¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>MetricsCollector<span class="token punctuation">)</span> <span class="token function">WrapDBQuery</span><span class="token punctuation">(</span>queryType <span class="token builtin">string</span><span class="token punctuation">,</span> fn <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">    start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    err <span class="token operator">:=</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    duration <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Seconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    dbQueryDuration<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>queryType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Observe</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> err</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ç¼“å­˜æŒ‡æ ‡è£…é¥°å™¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">RecordCacheHit</span><span class="token punctuation">(</span>cacheType <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    cacheHitsTotal<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>cacheType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">RecordCacheMiss</span><span class="token punctuation">(</span>cacheType <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    cacheMissesTotal<span class="token punctuation">.</span><span class="token function">WithLabelValues</span><span class="token punctuation">(</span>cacheType<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-æ€§èƒ½åˆ†æå·¥å…·" tabindex="-1"><a class="header-anchor" href="#_2-æ€§èƒ½åˆ†æå·¥å…·">#</a> 2. æ€§èƒ½åˆ†æå·¥å…·</h3>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># scripts/performance-analysis.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">SERVICE_URL</span><span class="token operator">=</span><span class="token string">"http://localhost:8080"</span></span>
<span class="line"><span class="token assign-left variable">DURATION</span><span class="token operator">=</span><span class="token string">"60s"</span></span>
<span class="line"><span class="token assign-left variable">OUTPUT_DIR</span><span class="token operator">=</span><span class="token string">"./performance-analysis"</span></span>
<span class="line"></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$OUTPUT_DIR</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Starting performance analysis for <span class="token variable">$DURATION</span>..."</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ”¶é›†CPU profile</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Collecting CPU profile..."</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">"<span class="token variable">$SERVICE_URL</span>/debug/pprof/profile?seconds=60"</span> <span class="token operator">></span> <span class="token string">"<span class="token variable">$OUTPUT_DIR</span>/cpu.prof"</span> <span class="token operator">&amp;</span></span>
<span class="line"><span class="token assign-left variable">CPU_PID</span><span class="token operator">=</span><span class="token variable">$!</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ”¶é›†å†…å­˜profile</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Collecting memory profile..."</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">"<span class="token variable">$SERVICE_URL</span>/debug/pprof/heap"</span> <span class="token operator">></span> <span class="token string">"<span class="token variable">$OUTPUT_DIR</span>/heap.prof"</span> <span class="token operator">&amp;</span></span>
<span class="line"><span class="token assign-left variable">MEM_PID</span><span class="token operator">=</span><span class="token variable">$!</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ”¶é›†goroutine profile</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Collecting goroutine profile..."</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">"<span class="token variable">$SERVICE_URL</span>/debug/pprof/goroutine"</span> <span class="token operator">></span> <span class="token string">"<span class="token variable">$OUTPUT_DIR</span>/goroutine.prof"</span> <span class="token operator">&amp;</span></span>
<span class="line"><span class="token assign-left variable">GOR_PID</span><span class="token operator">=</span><span class="token variable">$!</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># è¿è¡Œè´Ÿè½½æµ‹è¯•</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Running load test..."</span></span>
<span class="line">wrk <span class="token parameter variable">-t12</span> <span class="token parameter variable">-c400</span> <span class="token parameter variable">-d60s</span> <span class="token parameter variable">--latency</span> <span class="token string">"<span class="token variable">$SERVICE_URL</span>/api/v1/users"</span> <span class="token operator">></span> <span class="token string">"<span class="token variable">$OUTPUT_DIR</span>/load-test.txt"</span> <span class="token operator">&amp;</span></span>
<span class="line"><span class="token assign-left variable">LOAD_PID</span><span class="token operator">=</span><span class="token variable">$!</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç›‘æ§ç³»ç»Ÿèµ„æº</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Monitoring system resources..."</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"timestamp,cpu_percent,memory_percent,disk_io,network_io"</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">60</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">        <span class="token assign-left variable">timestamp</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token variable">)</span></span></span>
<span class="line">        <span class="token assign-left variable">cpu</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">top</span> <span class="token parameter variable">-l</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"CPU usage"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $3}'</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/%//'</span><span class="token variable">)</span></span></span>
<span class="line">        <span class="token assign-left variable">memory</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">top</span> <span class="token parameter variable">-l</span> <span class="token number">1</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"PhysMem"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $2}'</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/M//'</span><span class="token variable">)</span></span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$timestamp</span>,<span class="token variable">$cpu</span>,<span class="token variable">$memory</span>,0,0"</span></span>
<span class="line">        <span class="token function">sleep</span> <span class="token number">1</span></span>
<span class="line">    <span class="token keyword">done</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token operator">></span> <span class="token string">"<span class="token variable">$OUTPUT_DIR</span>/system-metrics.csv"</span> <span class="token operator">&amp;</span></span>
<span class="line"><span class="token assign-left variable">SYS_PID</span><span class="token operator">=</span><span class="token variable">$!</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ</span></span>
<span class="line"><span class="token function">wait</span> <span class="token variable">$CPU_PID</span> <span class="token variable">$MEM_PID</span> <span class="token variable">$GOR_PID</span> <span class="token variable">$LOAD_PID</span> <span class="token variable">$SYS_PID</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Performance analysis completed. Results saved to <span class="token variable">$OUTPUT_DIR</span>"</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç”Ÿæˆåˆ†ææŠ¥å‘Š</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Generating analysis report..."</span></span>
<span class="line">go tool pprof <span class="token parameter variable">-top</span> <span class="token string">"<span class="token variable">$OUTPUT_DIR</span>/cpu.prof"</span> <span class="token operator">></span> <span class="token string">"<span class="token variable">$OUTPUT_DIR</span>/cpu-analysis.txt"</span></span>
<span class="line">go tool pprof <span class="token parameter variable">-top</span> <span class="token string">"<span class="token variable">$OUTPUT_DIR</span>/heap.prof"</span> <span class="token operator">></span> <span class="token string">"<span class="token variable">$OUTPUT_DIR</span>/memory-analysis.txt"</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"Analysis report generated."</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"View CPU analysis: cat <span class="token variable">$OUTPUT_DIR</span>/cpu-analysis.txt"</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"View memory analysis: cat <span class="token variable">$OUTPUT_DIR</span>/memory-analysis.txt"</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"View load test results: cat <span class="token variable">$OUTPUT_DIR</span>/load-test.txt"</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“š-ç›¸å…³æ–‡æ¡£" tabindex="-1"><a class="header-anchor" href="#ğŸ“š-ç›¸å…³æ–‡æ¡£">#</a> ğŸ“š ç›¸å…³æ–‡æ¡£</h2>
<ul>
<li><RouteLink to="/development/">å¼€å‘æŒ‡å—</RouteLink></li>
<li><RouteLink to="/development/architecture.html">æ¶æ„è®¾è®¡</RouteLink></li>
<li><RouteLink to="/development/testing.html">æµ‹è¯•æŒ‡å—</RouteLink></li>
<li><RouteLink to="/development/debugging.html">è°ƒè¯•æŒ‡å—</RouteLink></li>
<li><RouteLink to="/api/">APIæ–‡æ¡£</RouteLink></li>
<li><RouteLink to="/deployment/">éƒ¨ç½²æŒ‡å—</RouteLink></li>
</ul>
</div></template>


