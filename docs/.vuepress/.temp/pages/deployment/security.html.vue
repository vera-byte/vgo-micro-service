<template><div><h1 id="å®‰å…¨é…ç½®" tabindex="-1"><a class="header-anchor" href="#å®‰å…¨é…ç½®">#</a> å®‰å…¨é…ç½®</h1>
<p>VGOå¾®æœåŠ¡çš„å®‰å…¨é…ç½®æ˜¯ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚æœ¬æŒ‡å—è¯¦ç»†ä»‹ç»äº†å¦‚ä½•é…ç½®å’ŒåŠ å¼ºVGOå¾®æœåŠ¡çš„å®‰å…¨æ€§ï¼ŒåŒ…æ‹¬è®¤è¯ã€æˆæƒã€ç½‘ç»œå®‰å…¨ã€æ•°æ®ä¿æŠ¤ç­‰æ–¹é¢ã€‚</p>
<h2 id="ğŸ”’-å®‰å…¨æ¶æ„" tabindex="-1"><a class="header-anchor" href="#ğŸ”’-å®‰å…¨æ¶æ„">#</a> ğŸ”’ å®‰å…¨æ¶æ„</h2>
<h3 id="å®‰å…¨å±‚æ¬¡å›¾" tabindex="-1"><a class="header-anchor" href="#å®‰å…¨å±‚æ¬¡å›¾">#</a> å®‰å…¨å±‚æ¬¡å›¾</h3>
<div class="language-mermaid line-numbers-mode" data-highlighter="prismjs" data-ext="mermaid"><pre v-pre><code class="language-mermaid"><span class="line"><span class="token keyword">graph</span> TB</span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"ç½‘ç»œå®‰å…¨å±‚"</span></span>
<span class="line">        A<span class="token text string">[é˜²ç«å¢™]</span></span>
<span class="line">        B<span class="token text string">[è´Ÿè½½å‡è¡¡å™¨]</span></span>
<span class="line">        C<span class="token text string">[WAF]</span></span>
<span class="line">        D<span class="token text string">[DDoSé˜²æŠ¤]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"ä¼ è¾“å®‰å…¨å±‚"</span></span>
<span class="line">        E<span class="token text string">[TLS/SSL]</span></span>
<span class="line">        F<span class="token text string">[è¯ä¹¦ç®¡ç†]</span></span>
<span class="line">        G<span class="token text string">[mTLS]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"åº”ç”¨å®‰å…¨å±‚"</span></span>
<span class="line">        H<span class="token text string">[èº«ä»½è®¤è¯]</span></span>
<span class="line">        I<span class="token text string">[è®¿é—®æ§åˆ¶]</span></span>
<span class="line">        J<span class="token text string">[APIç½‘å…³]</span></span>
<span class="line">        K<span class="token text string">[é™æµç†”æ–­]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"æ•°æ®å®‰å…¨å±‚"</span></span>
<span class="line">        L<span class="token text string">[æ•°æ®åŠ å¯†]</span></span>
<span class="line">        M<span class="token text string">[å¯†é’¥ç®¡ç†]</span></span>
<span class="line">        N<span class="token text string">[æ•°æ®è„±æ•]</span></span>
<span class="line">        O<span class="token text string">[å¤‡ä»½åŠ å¯†]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"è¿ç»´å®‰å…¨å±‚"</span></span>
<span class="line">        P<span class="token text string">[å®¡è®¡æ—¥å¿—]</span></span>
<span class="line">        Q<span class="token text string">[å®‰å…¨ç›‘æ§]</span></span>
<span class="line">        R<span class="token text string">[æ¼æ´æ‰«æ]</span></span>
<span class="line">        S<span class="token text string">[åˆè§„æ£€æŸ¥]</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    A <span class="token arrow operator">--></span> B</span>
<span class="line">    B <span class="token arrow operator">--></span> C</span>
<span class="line">    C <span class="token arrow operator">--></span> E</span>
<span class="line">    E <span class="token arrow operator">--></span> H</span>
<span class="line">    H <span class="token arrow operator">--></span> I</span>
<span class="line">    I <span class="token arrow operator">--></span> L</span>
<span class="line">    L <span class="token arrow operator">--></span> P</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å®‰å…¨å¨èƒæ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#å®‰å…¨å¨èƒæ¨¡å‹">#</a> å®‰å…¨å¨èƒæ¨¡å‹</h3>
<table>
<thead>
<tr>
<th>å¨èƒç±»å‹</th>
<th>é£é™©ç­‰çº§</th>
<th>é˜²æŠ¤æªæ–½</th>
<th>æ£€æµ‹æ–¹æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td>æœªæˆæƒè®¿é—®</td>
<td>é«˜</td>
<td>å¼ºè®¤è¯ã€è®¿é—®æ§åˆ¶</td>
<td>ç™»å½•ç›‘æ§ã€å¼‚å¸¸æ£€æµ‹</td>
</tr>
<tr>
<td>æ•°æ®æ³„éœ²</td>
<td>é«˜</td>
<td>æ•°æ®åŠ å¯†ã€æƒé™æ§åˆ¶</td>
<td>æ•°æ®è®¿é—®å®¡è®¡</td>
</tr>
<tr>
<td>DDoSæ”»å‡»</td>
<td>ä¸­</td>
<td>é™æµã€è´Ÿè½½å‡è¡¡</td>
<td>æµé‡ç›‘æ§</td>
</tr>
<tr>
<td>SQLæ³¨å…¥</td>
<td>ä¸­</td>
<td>å‚æ•°åŒ–æŸ¥è¯¢ã€è¾“å…¥éªŒè¯</td>
<td>WAFæ—¥å¿—åˆ†æ</td>
</tr>
<tr>
<td>ä¸­é—´äººæ”»å‡»</td>
<td>ä¸­</td>
<td>TLSåŠ å¯†ã€è¯ä¹¦éªŒè¯</td>
<td>è¯ä¹¦ç›‘æ§</td>
</tr>
<tr>
<td>å†…éƒ¨å¨èƒ</td>
<td>ä¸­</td>
<td>æœ€å°æƒé™ã€å®¡è®¡æ—¥å¿—</td>
<td>è¡Œä¸ºåˆ†æ</td>
</tr>
</tbody>
</table>
<h2 id="ğŸ”-èº«ä»½è®¤è¯ä¸æˆæƒ" tabindex="-1"><a class="header-anchor" href="#ğŸ”-èº«ä»½è®¤è¯ä¸æˆæƒ">#</a> ğŸ” èº«ä»½è®¤è¯ä¸æˆæƒ</h2>
<h3 id="_1-jwté…ç½®" tabindex="-1"><a class="header-anchor" href="#_1-jwté…ç½®">#</a> 1. JWTé…ç½®</h3>
<h4 id="jwtå¯†é’¥ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#jwtå¯†é’¥ç®¡ç†">#</a> JWTå¯†é’¥ç®¡ç†</h4>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># config/security.yaml</span></span>
<span class="line"><span class="token key atrule">security</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">jwt</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># ä½¿ç”¨å¼ºéšæœºå¯†é’¥ï¼Œè‡³å°‘32å­—ç¬¦</span></span>
<span class="line">    <span class="token key atrule">secret_key</span><span class="token punctuation">:</span> <span class="token string">"${JWT_SECRET_KEY}"</span></span>
<span class="line">    <span class="token comment"># Tokenæœ‰æ•ˆæœŸ</span></span>
<span class="line">    <span class="token key atrule">access_token_ttl</span><span class="token punctuation">:</span> 15m</span>
<span class="line">    <span class="token key atrule">refresh_token_ttl</span><span class="token punctuation">:</span> 7d</span>
<span class="line">    <span class="token comment"># ç­¾åç®—æ³•</span></span>
<span class="line">    <span class="token key atrule">algorithm</span><span class="token punctuation">:</span> <span class="token string">"HS256"</span></span>
<span class="line">    <span class="token comment"># å‘è¡Œè€…</span></span>
<span class="line">    <span class="token key atrule">issuer</span><span class="token punctuation">:</span> <span class="token string">"vgo-iam"</span></span>
<span class="line">    <span class="token comment"># å—ä¼—</span></span>
<span class="line">    <span class="token key atrule">audience</span><span class="token punctuation">:</span> <span class="token string">"vgo-api"</span></span>
<span class="line">    <span class="token comment"># æ—¶é’Ÿåç§»å®¹å¿åº¦</span></span>
<span class="line">    <span class="token key atrule">clock_skew</span><span class="token punctuation">:</span> 5m</span>
<span class="line">  </span>
<span class="line">  <span class="token comment"># å¯†é’¥è½®æ¢é…ç½®</span></span>
<span class="line">  <span class="token key atrule">key_rotation</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token comment"># è½®æ¢é—´éš”</span></span>
<span class="line">    <span class="token key atrule">interval</span><span class="token punctuation">:</span> 30d</span>
<span class="line">    <span class="token comment"># ä¿ç•™æ—§å¯†é’¥æ•°é‡</span></span>
<span class="line">    <span class="token key atrule">keep_old_keys</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="jwtä¸­é—´ä»¶é…ç½®" tabindex="-1"><a class="header-anchor" href="#jwtä¸­é—´ä»¶é…ç½®">#</a> JWTä¸­é—´ä»¶é…ç½®</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// internal/middleware/auth.go</span></span>
<span class="line"><span class="token keyword">package</span> middleware</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">	<span class="token string">"context"</span></span>
<span class="line">	<span class="token string">"fmt"</span></span>
<span class="line">	<span class="token string">"strings"</span></span>
<span class="line">	<span class="token string">"time"</span></span>
<span class="line"></span>
<span class="line">	<span class="token string">"github.com/golang-jwt/jwt/v5"</span></span>
<span class="line">	<span class="token string">"google.golang.org/grpc"</span></span>
<span class="line">	<span class="token string">"google.golang.org/grpc/codes"</span></span>
<span class="line">	<span class="token string">"google.golang.org/grpc/metadata"</span></span>
<span class="line">	<span class="token string">"google.golang.org/grpc/status"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// JWTConfig JWTé…ç½®</span></span>
<span class="line"><span class="token keyword">type</span> JWTConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	SecretKey     <span class="token builtin">string</span>        <span class="token string">`yaml:"secret_key"`</span></span>
<span class="line">	AccessTTL     time<span class="token punctuation">.</span>Duration <span class="token string">`yaml:"access_token_ttl"`</span></span>
<span class="line">	RefreshTTL    time<span class="token punctuation">.</span>Duration <span class="token string">`yaml:"refresh_token_ttl"`</span></span>
<span class="line">	Algorithm     <span class="token builtin">string</span>        <span class="token string">`yaml:"algorithm"`</span></span>
<span class="line">	Issuer        <span class="token builtin">string</span>        <span class="token string">`yaml:"issuer"`</span></span>
<span class="line">	Audience      <span class="token builtin">string</span>        <span class="token string">`yaml:"audience"`</span></span>
<span class="line">	ClockSkew     time<span class="token punctuation">.</span>Duration <span class="token string">`yaml:"clock_skew"`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Claims JWTå£°æ˜</span></span>
<span class="line"><span class="token keyword">type</span> Claims <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	UserID      <span class="token builtin">string</span>   <span class="token string">`json:"user_id"`</span></span>
<span class="line">	Username    <span class="token builtin">string</span>   <span class="token string">`json:"username"`</span></span>
<span class="line">	Email       <span class="token builtin">string</span>   <span class="token string">`json:"email"`</span></span>
<span class="line">	Roles       <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:"roles"`</span></span>
<span class="line">	Permissions <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:"permissions"`</span></span>
<span class="line">	jwt<span class="token punctuation">.</span>RegisteredClaims</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// JWTAuthInterceptor JWTè®¤è¯æ‹¦æˆªå™¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">JWTAuthInterceptor</span><span class="token punctuation">(</span>config JWTConfig<span class="token punctuation">)</span> grpc<span class="token punctuation">.</span>UnaryServerInterceptor <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> info <span class="token operator">*</span>grpc<span class="token punctuation">.</span>UnaryServerInfo<span class="token punctuation">,</span> handler grpc<span class="token punctuation">.</span>UnaryHandler<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token comment">// è·³è¿‡å¥åº·æ£€æŸ¥å’Œå…¬å¼€æ¥å£</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token function">isPublicMethod</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>FullMethod<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		<span class="token comment">// æå–Token</span></span>
<span class="line">		token<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">extractToken</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line">		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Unauthenticated<span class="token punctuation">,</span> <span class="token string">"missing or invalid token: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		<span class="token comment">// éªŒè¯Token</span></span>
<span class="line">		claims<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">validateToken</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> config<span class="token punctuation">)</span></span>
<span class="line">		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>Unauthenticated<span class="token punctuation">,</span> <span class="token string">"invalid token: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		<span class="token comment">// å°†ç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°ä¸Šä¸‹æ–‡</span></span>
<span class="line">		ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"user_id"</span><span class="token punctuation">,</span> claims<span class="token punctuation">.</span>UserID<span class="token punctuation">)</span></span>
<span class="line">		ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"username"</span><span class="token punctuation">,</span> claims<span class="token punctuation">.</span>Username<span class="token punctuation">)</span></span>
<span class="line">		ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"roles"</span><span class="token punctuation">,</span> claims<span class="token punctuation">.</span>Roles<span class="token punctuation">)</span></span>
<span class="line">		ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"permissions"</span><span class="token punctuation">,</span> claims<span class="token punctuation">.</span>Permissions<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">		<span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// extractToken ä»è¯·æ±‚ä¸­æå–Token</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">extractToken</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	md<span class="token punctuation">,</span> ok <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">FromIncomingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"missing metadata"</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	authorization <span class="token operator">:=</span> md<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"authorization"</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>authorization<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"missing authorization header"</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	token <span class="token operator">:=</span> authorization<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line">	<span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token string">"Bearer "</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid authorization header format"</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">return</span> strings<span class="token punctuation">.</span><span class="token function">TrimPrefix</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token string">"Bearer "</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// validateToken éªŒè¯Token</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">validateToken</span><span class="token punctuation">(</span>tokenString <span class="token builtin">string</span><span class="token punctuation">,</span> config JWTConfig<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Claims<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	token<span class="token punctuation">,</span> err <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">ParseWithClaims</span><span class="token punctuation">(</span>tokenString<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Claims<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>token <span class="token operator">*</span>jwt<span class="token punctuation">.</span>Token<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token comment">// éªŒè¯ç­¾åç®—æ³•</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> token<span class="token punctuation">.</span>Method<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>jwt<span class="token punctuation">.</span>SigningMethodHMAC<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unexpected signing method: %v"</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span>Header<span class="token punctuation">[</span><span class="token string">"alg"</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>SecretKey<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	claims<span class="token punctuation">,</span> ok <span class="token operator">:=</span> token<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Claims<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token operator">||</span> <span class="token operator">!</span>token<span class="token punctuation">.</span>Valid <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid token claims"</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">// éªŒè¯å‘è¡Œè€…å’Œå—ä¼—</span></span>
<span class="line">	<span class="token keyword">if</span> claims<span class="token punctuation">.</span>Issuer <span class="token operator">!=</span> config<span class="token punctuation">.</span>Issuer <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid issuer"</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>claims<span class="token punctuation">.</span>Audience<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> claims<span class="token punctuation">.</span>Audience<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> config<span class="token punctuation">.</span>Audience <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid audience"</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">// éªŒè¯æ—¶é—´</span></span>
<span class="line">	now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> claims<span class="token punctuation">.</span>ExpiresAt <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> claims<span class="token punctuation">.</span>ExpiresAt<span class="token punctuation">.</span>Time<span class="token punctuation">.</span><span class="token function">Before</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token operator">-</span>config<span class="token punctuation">.</span>ClockSkew<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"token expired"</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">if</span> claims<span class="token punctuation">.</span>NotBefore <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> claims<span class="token punctuation">.</span>NotBefore<span class="token punctuation">.</span>Time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>ClockSkew<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"token not valid yet"</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">return</span> claims<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// isPublicMethod æ£€æŸ¥æ˜¯å¦ä¸ºå…¬å¼€æ–¹æ³•</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">isPublicMethod</span><span class="token punctuation">(</span>method <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">	publicMethods <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">		<span class="token string">"/grpc.health.v1.Health/Check"</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token string">"/grpc.health.v1.Health/Watch"</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token string">"/vgo.iam.v1.AuthService/Login"</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token string">"/vgo.iam.v1.AuthService/RefreshToken"</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> publicMethod <span class="token operator">:=</span> <span class="token keyword">range</span> publicMethods <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">if</span> method <span class="token operator">==</span> publicMethod <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-rbacæƒé™æ§åˆ¶" tabindex="-1"><a class="header-anchor" href="#_2-rbacæƒé™æ§åˆ¶">#</a> 2. RBACæƒé™æ§åˆ¶</h3>
<h4 id="æƒé™æ£€æŸ¥ä¸­é—´ä»¶" tabindex="-1"><a class="header-anchor" href="#æƒé™æ£€æŸ¥ä¸­é—´ä»¶">#</a> æƒé™æ£€æŸ¥ä¸­é—´ä»¶</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// internal/middleware/rbac.go</span></span>
<span class="line"><span class="token keyword">package</span> middleware</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">	<span class="token string">"context"</span></span>
<span class="line">	<span class="token string">"fmt"</span></span>
<span class="line">	<span class="token string">"strings"</span></span>
<span class="line"></span>
<span class="line">	<span class="token string">"google.golang.org/grpc"</span></span>
<span class="line">	<span class="token string">"google.golang.org/grpc/codes"</span></span>
<span class="line">	<span class="token string">"google.golang.org/grpc/status"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Permission æƒé™å®šä¹‰</span></span>
<span class="line"><span class="token keyword">type</span> Permission <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	Resource <span class="token builtin">string</span> <span class="token string">`json:"resource"`</span></span>
<span class="line">	Action   <span class="token builtin">string</span> <span class="token string">`json:"action"`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// RBACConfig RBACé…ç½®</span></span>
<span class="line"><span class="token keyword">type</span> RBACConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token comment">// æ–¹æ³•æƒé™æ˜ å°„</span></span>
<span class="line">	MethodPermissions <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Permission <span class="token string">`yaml:"method_permissions"`</span></span>
<span class="line">	<span class="token comment">// è¶…çº§ç®¡ç†å‘˜è§’è‰²</span></span>
<span class="line">	SuperAdminRole <span class="token builtin">string</span> <span class="token string">`yaml:"super_admin_role"`</span></span>
<span class="line">	<span class="token comment">// å¯ç”¨æƒé™æ£€æŸ¥</span></span>
<span class="line">	Enabled <span class="token builtin">bool</span> <span class="token string">`yaml:"enabled"`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// RBACInterceptor RBACæƒé™æ£€æŸ¥æ‹¦æˆªå™¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">RBACInterceptor</span><span class="token punctuation">(</span>config RBACConfig<span class="token punctuation">)</span> grpc<span class="token punctuation">.</span>UnaryServerInterceptor <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> info <span class="token operator">*</span>grpc<span class="token punctuation">.</span>UnaryServerInfo<span class="token punctuation">,</span> handler grpc<span class="token punctuation">.</span>UnaryHandler<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token operator">!</span>config<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		<span class="token comment">// è·³è¿‡å…¬å¼€æ–¹æ³•</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token function">isPublicMethod</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>FullMethod<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		<span class="token comment">// è·å–ç”¨æˆ·ä¿¡æ¯</span></span>
<span class="line">		userRoles<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"roles"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>PermissionDenied<span class="token punctuation">,</span> <span class="token string">"missing user roles"</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		userPermissions<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"permissions"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>PermissionDenied<span class="token punctuation">,</span> <span class="token string">"missing user permissions"</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		<span class="token comment">// æ£€æŸ¥è¶…çº§ç®¡ç†å‘˜æƒé™</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token function">contains</span><span class="token punctuation">(</span>userRoles<span class="token punctuation">,</span> config<span class="token punctuation">.</span>SuperAdminRole<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		<span class="token comment">// è·å–æ–¹æ³•æ‰€éœ€æƒé™</span></span>
<span class="line">		requiredPermission<span class="token punctuation">,</span> exists <span class="token operator">:=</span> config<span class="token punctuation">.</span>MethodPermissions<span class="token punctuation">[</span>info<span class="token punctuation">.</span>FullMethod<span class="token punctuation">]</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token operator">!</span>exists <span class="token punctuation">{</span></span>
<span class="line">			<span class="token comment">// å¦‚æœæ²¡æœ‰é…ç½®æƒé™ï¼Œé»˜è®¤æ‹’ç»</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>PermissionDenied<span class="token punctuation">,</span> <span class="token string">"method not configured: %s"</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>FullMethod<span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		<span class="token comment">// æ£€æŸ¥ç”¨æˆ·æƒé™</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">hasPermission</span><span class="token punctuation">(</span>userPermissions<span class="token punctuation">,</span> requiredPermission<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span>codes<span class="token punctuation">.</span>PermissionDenied<span class="token punctuation">,</span> <span class="token string">"insufficient permissions for %s"</span><span class="token punctuation">,</span> info<span class="token punctuation">.</span>FullMethod<span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		<span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// hasPermission æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šæƒé™</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">hasPermission</span><span class="token punctuation">(</span>userPermissions <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> required Permission<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">	requiredPerm <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s:%s"</span><span class="token punctuation">,</span> required<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> required<span class="token punctuation">.</span>Action<span class="token punctuation">)</span></span>
<span class="line">	</span>
<span class="line">	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> perm <span class="token operator">:=</span> <span class="token keyword">range</span> userPermissions <span class="token punctuation">{</span></span>
<span class="line">		<span class="token comment">// ç²¾ç¡®åŒ¹é…</span></span>
<span class="line">		<span class="token keyword">if</span> perm <span class="token operator">==</span> requiredPerm <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">		</span>
<span class="line">		<span class="token comment">// é€šé…ç¬¦åŒ¹é…</span></span>
<span class="line">		<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>perm<span class="token punctuation">,</span> <span class="token string">":*"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">			resource <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSuffix</span><span class="token punctuation">(</span>perm<span class="token punctuation">,</span> <span class="token string">":*"</span><span class="token punctuation">)</span></span>
<span class="line">			<span class="token keyword">if</span> resource <span class="token operator">==</span> required<span class="token punctuation">.</span>Resource <span class="token punctuation">{</span></span>
<span class="line">				<span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">			<span class="token punctuation">}</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">		</span>
<span class="line">		<span class="token comment">// å…¨å±€æƒé™</span></span>
<span class="line">		<span class="token keyword">if</span> perm <span class="token operator">==</span> <span class="token string">"*:*"</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	</span>
<span class="line">	<span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// contains æ£€æŸ¥åˆ‡ç‰‡æ˜¯å¦åŒ…å«æŒ‡å®šå…ƒç´ </span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">contains</span><span class="token punctuation">(</span>slice <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> item <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> s <span class="token operator">:=</span> <span class="token keyword">range</span> slice <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">if</span> s <span class="token operator">==</span> item <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”’-tls-sslé…ç½®" tabindex="-1"><a class="header-anchor" href="#ğŸ”’-tls-sslé…ç½®">#</a> ğŸ”’ TLS/SSLé…ç½®</h2>
<h3 id="_1-è¯ä¹¦ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#_1-è¯ä¹¦ç®¡ç†">#</a> 1. è¯ä¹¦ç®¡ç†</h3>
<h4 id="è‡ªç­¾åè¯ä¹¦ç”Ÿæˆ" tabindex="-1"><a class="header-anchor" href="#è‡ªç­¾åè¯ä¹¦ç”Ÿæˆ">#</a> è‡ªç­¾åè¯ä¹¦ç”Ÿæˆ</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># scripts/generate-certs.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">set</span> <span class="token parameter variable">-e</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">CERT_DIR</span><span class="token operator">=</span><span class="token string">"certs"</span></span>
<span class="line"><span class="token assign-left variable">CA_KEY</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$CERT_DIR</span>/ca-key.pem"</span></span>
<span class="line"><span class="token assign-left variable">CA_CERT</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$CERT_DIR</span>/ca-cert.pem"</span></span>
<span class="line"><span class="token assign-left variable">SERVER_KEY</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$CERT_DIR</span>/server-key.pem"</span></span>
<span class="line"><span class="token assign-left variable">SERVER_CERT</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$CERT_DIR</span>/server-cert.pem"</span></span>
<span class="line"><span class="token assign-left variable">CLIENT_KEY</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$CERT_DIR</span>/client-key.pem"</span></span>
<span class="line"><span class="token assign-left variable">CLIENT_CERT</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$CERT_DIR</span>/client-cert.pem"</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ” ç”ŸæˆTLSè¯ä¹¦..."</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># åˆ›å»ºè¯ä¹¦ç›®å½•</span></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$CERT_DIR</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç”ŸæˆCAç§é’¥</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ“ ç”ŸæˆCAç§é’¥..."</span></span>
<span class="line">openssl genrsa <span class="token parameter variable">-out</span> <span class="token variable">$CA_KEY</span> <span class="token number">4096</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç”ŸæˆCAè¯ä¹¦</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ“œ ç”ŸæˆCAè¯ä¹¦..."</span></span>
<span class="line">openssl req <span class="token parameter variable">-new</span> <span class="token parameter variable">-x509</span> <span class="token parameter variable">-key</span> <span class="token variable">$CA_KEY</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-subj</span> <span class="token string">"/C=CN/ST=Beijing/L=Beijing/O=VGO/OU=Security/CN=VGO-CA"</span> <span class="token parameter variable">-days</span> <span class="token number">3650</span> <span class="token parameter variable">-out</span> <span class="token variable">$CA_CERT</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç”ŸæˆæœåŠ¡å™¨ç§é’¥</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ”‘ ç”ŸæˆæœåŠ¡å™¨ç§é’¥..."</span></span>
<span class="line">openssl genrsa <span class="token parameter variable">-out</span> <span class="token variable">$SERVER_KEY</span> <span class="token number">4096</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦ç­¾åè¯·æ±‚</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ“‹ ç”ŸæˆæœåŠ¡å™¨CSR..."</span></span>
<span class="line">openssl req <span class="token parameter variable">-new</span> <span class="token parameter variable">-key</span> <span class="token variable">$SERVER_KEY</span> <span class="token parameter variable">-subj</span> <span class="token string">"/C=CN/ST=Beijing/L=Beijing/O=VGO/OU=Server/CN=vgo-iam"</span> <span class="token parameter variable">-out</span> server.csr</span>
<span class="line"></span>
<span class="line"><span class="token comment"># åˆ›å»ºæœåŠ¡å™¨è¯ä¹¦æ‰©å±•æ–‡ä»¶</span></span>
<span class="line"><span class="token function">cat</span> <span class="token operator">></span> server.ext <span class="token operator">&lt;&lt;</span> <span class="token string">EOF</span>
<span class="line">authorityKeyIdentifier=keyid,issuer</span>
<span class="line">basicConstraints=CA:FALSE</span>
<span class="line">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span>
<span class="line">subjectAltName = @alt_names</span>
<span class="line"></span>
<span class="line">[alt_names]</span>
<span class="line">DNS.1 = vgo-iam</span>
<span class="line">DNS.2 = localhost</span>
<span class="line">DNS.3 = *.vgo.local</span>
<span class="line">IP.1 = 127.0.0.1</span>
<span class="line">IP.2 = ::1</span>
<span class="line">EOF</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ† ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦..."</span></span>
<span class="line">openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-in</span> server.csr <span class="token parameter variable">-CA</span> <span class="token variable">$CA_CERT</span> <span class="token parameter variable">-CAkey</span> <span class="token variable">$CA_KEY</span> <span class="token parameter variable">-CAcreateserial</span> <span class="token parameter variable">-out</span> <span class="token variable">$SERVER_CERT</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-extfile</span> server.ext</span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç”Ÿæˆå®¢æˆ·ç«¯ç§é’¥</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ” ç”Ÿæˆå®¢æˆ·ç«¯ç§é’¥..."</span></span>
<span class="line">openssl genrsa <span class="token parameter variable">-out</span> <span class="token variable">$CLIENT_KEY</span> <span class="token number">4096</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦ç­¾åè¯·æ±‚</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ“„ ç”Ÿæˆå®¢æˆ·ç«¯CSR..."</span></span>
<span class="line">openssl req <span class="token parameter variable">-new</span> <span class="token parameter variable">-key</span> <span class="token variable">$CLIENT_KEY</span> <span class="token parameter variable">-subj</span> <span class="token string">"/C=CN/ST=Beijing/L=Beijing/O=VGO/OU=Client/CN=vgo-client"</span> <span class="token parameter variable">-out</span> client.csr</span>
<span class="line"></span>
<span class="line"><span class="token comment"># åˆ›å»ºå®¢æˆ·ç«¯è¯ä¹¦æ‰©å±•æ–‡ä»¶</span></span>
<span class="line"><span class="token function">cat</span> <span class="token operator">></span> client.ext <span class="token operator">&lt;&lt;</span> <span class="token string">EOF</span>
<span class="line">authorityKeyIdentifier=keyid,issuer</span>
<span class="line">basicConstraints=CA:FALSE</span>
<span class="line">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span>
<span class="line">extendedKeyUsage = clientAuth</span>
<span class="line">EOF</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ« ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦..."</span></span>
<span class="line">openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-in</span> client.csr <span class="token parameter variable">-CA</span> <span class="token variable">$CA_CERT</span> <span class="token parameter variable">-CAkey</span> <span class="token variable">$CA_KEY</span> <span class="token parameter variable">-CAcreateserial</span> <span class="token parameter variable">-out</span> <span class="token variable">$CLIENT_CERT</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-extfile</span> client.ext</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ¸…ç†ä¸´æ—¶æ–‡ä»¶</span></span>
<span class="line"><span class="token function">rm</span> <span class="token parameter variable">-f</span> server.csr client.csr server.ext client.ext ca-cert.srl</span>
<span class="line"></span>
<span class="line"><span class="token comment"># è®¾ç½®æƒé™</span></span>
<span class="line"><span class="token function">chmod</span> <span class="token number">600</span> <span class="token variable">$CERT_DIR</span>/*.pem</span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"âœ… è¯ä¹¦ç”Ÿæˆå®Œæˆï¼"</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ“ è¯ä¹¦ä½ç½®: <span class="token variable">$CERT_DIR</span>/"</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ“‹ è¯ä¹¦åˆ—è¡¨:"</span></span>
<span class="line"><span class="token function">ls</span> <span class="token parameter variable">-la</span> <span class="token variable">$CERT_DIR</span>/</span>
<span class="line"></span>
<span class="line"><span class="token comment"># éªŒè¯è¯ä¹¦</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ” éªŒè¯è¯ä¹¦..."</span></span>
<span class="line">openssl x509 <span class="token parameter variable">-in</span> <span class="token variable">$SERVER_CERT</span> <span class="token parameter variable">-text</span> <span class="token parameter variable">-noout</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-A</span> <span class="token number">1</span> <span class="token string">"Subject:"</span></span>
<span class="line">openssl x509 <span class="token parameter variable">-in</span> <span class="token variable">$CLIENT_CERT</span> <span class="token parameter variable">-text</span> <span class="token parameter variable">-noout</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-A</span> <span class="token number">1</span> <span class="token string">"Subject:"</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ‰ è¯ä¹¦éªŒè¯å®Œæˆï¼"</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="tlsæœåŠ¡å™¨é…ç½®" tabindex="-1"><a class="header-anchor" href="#tlsæœåŠ¡å™¨é…ç½®">#</a> TLSæœåŠ¡å™¨é…ç½®</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// internal/server/tls.go</span></span>
<span class="line"><span class="token keyword">package</span> server</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">	<span class="token string">"crypto/tls"</span></span>
<span class="line">	<span class="token string">"crypto/x509"</span></span>
<span class="line">	<span class="token string">"fmt"</span></span>
<span class="line">	<span class="token string">"io/ioutil"</span></span>
<span class="line"></span>
<span class="line">	<span class="token string">"google.golang.org/grpc"</span></span>
<span class="line">	<span class="token string">"google.golang.org/grpc/credentials"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// TLSConfig TLSé…ç½®</span></span>
<span class="line"><span class="token keyword">type</span> TLSConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	Enabled    <span class="token builtin">bool</span>   <span class="token string">`yaml:"enabled"`</span></span>
<span class="line">	CertFile   <span class="token builtin">string</span> <span class="token string">`yaml:"cert_file"`</span></span>
<span class="line">	KeyFile    <span class="token builtin">string</span> <span class="token string">`yaml:"key_file"`</span></span>
<span class="line">	CAFile     <span class="token builtin">string</span> <span class="token string">`yaml:"ca_file"`</span></span>
<span class="line">	ClientAuth <span class="token builtin">bool</span>   <span class="token string">`yaml:"client_auth"`</span></span>
<span class="line">	MinVersion <span class="token builtin">string</span> <span class="token string">`yaml:"min_version"`</span></span>
<span class="line">	MaxVersion <span class="token builtin">string</span> <span class="token string">`yaml:"max_version"`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// LoadTLSCredentials åŠ è½½TLSå‡­æ®</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">LoadTLSCredentials</span><span class="token punctuation">(</span>config TLSConfig<span class="token punctuation">)</span> <span class="token punctuation">(</span>credentials<span class="token punctuation">.</span>TransportCredentials<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">if</span> <span class="token operator">!</span>config<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"TLS not enabled"</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">// åŠ è½½æœåŠ¡å™¨è¯ä¹¦</span></span>
<span class="line">	serverCert<span class="token punctuation">,</span> err <span class="token operator">:=</span> tls<span class="token punctuation">.</span><span class="token function">LoadX509KeyPair</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>CertFile<span class="token punctuation">,</span> config<span class="token punctuation">.</span>KeyFile<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to load server certificate: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">// TLSé…ç½®</span></span>
<span class="line">	tlsConfig <span class="token operator">:=</span> <span class="token operator">&amp;</span>tls<span class="token punctuation">.</span>Config<span class="token punctuation">{</span></span>
<span class="line">		Certificates<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tls<span class="token punctuation">.</span>Certificate<span class="token punctuation">{</span>serverCert<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">		MinVersion<span class="token punctuation">:</span>   <span class="token function">getTLSVersion</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>MinVersion<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">		MaxVersion<span class="token punctuation">:</span>   <span class="token function">getTLSVersion</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>MaxVersion<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">		CipherSuites<span class="token punctuation">:</span> <span class="token function">getSecureCipherSuites</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">// å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯</span></span>
<span class="line">	<span class="token keyword">if</span> config<span class="token punctuation">.</span>ClientAuth <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>CAFile <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span></span>
<span class="line">		caCert<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>CAFile<span class="token punctuation">)</span></span>
<span class="line">		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to read CA certificate: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		caCertPool <span class="token operator">:=</span> x509<span class="token punctuation">.</span><span class="token function">NewCertPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token operator">!</span>caCertPool<span class="token punctuation">.</span><span class="token function">AppendCertsFromPEM</span><span class="token punctuation">(</span>caCert<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to parse CA certificate"</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">		tlsConfig<span class="token punctuation">.</span>ClientAuth <span class="token operator">=</span> tls<span class="token punctuation">.</span>RequireAndVerifyClientCert</span>
<span class="line">		tlsConfig<span class="token punctuation">.</span>ClientCAs <span class="token operator">=</span> caCertPool</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">return</span> credentials<span class="token punctuation">.</span><span class="token function">NewTLS</span><span class="token punctuation">(</span>tlsConfig<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// getTLSVersion è·å–TLSç‰ˆæœ¬</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">getTLSVersion</span><span class="token punctuation">(</span>version <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">uint16</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">switch</span> version <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">case</span> <span class="token string">"1.0"</span><span class="token punctuation">:</span></span>
<span class="line">		<span class="token keyword">return</span> tls<span class="token punctuation">.</span>VersionTLS10</span>
<span class="line">	<span class="token keyword">case</span> <span class="token string">"1.1"</span><span class="token punctuation">:</span></span>
<span class="line">		<span class="token keyword">return</span> tls<span class="token punctuation">.</span>VersionTLS11</span>
<span class="line">	<span class="token keyword">case</span> <span class="token string">"1.2"</span><span class="token punctuation">:</span></span>
<span class="line">		<span class="token keyword">return</span> tls<span class="token punctuation">.</span>VersionTLS12</span>
<span class="line">	<span class="token keyword">case</span> <span class="token string">"1.3"</span><span class="token punctuation">:</span></span>
<span class="line">		<span class="token keyword">return</span> tls<span class="token punctuation">.</span>VersionTLS13</span>
<span class="line">	<span class="token keyword">default</span><span class="token punctuation">:</span></span>
<span class="line">		<span class="token keyword">return</span> tls<span class="token punctuation">.</span>VersionTLS12 <span class="token comment">// é»˜è®¤ä½¿ç”¨TLS 1.2</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// getSecureCipherSuites è·å–å®‰å…¨çš„å¯†ç å¥—ä»¶</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">getSecureCipherSuites</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint16</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint16</span><span class="token punctuation">{</span></span>
<span class="line">		tls<span class="token punctuation">.</span>TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384<span class="token punctuation">,</span></span>
<span class="line">		tls<span class="token punctuation">.</span>TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305<span class="token punctuation">,</span></span>
<span class="line">		tls<span class="token punctuation">.</span>TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384<span class="token punctuation">,</span></span>
<span class="line">		tls<span class="token punctuation">.</span>TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305<span class="token punctuation">,</span></span>
<span class="line">		tls<span class="token punctuation">.</span>TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256<span class="token punctuation">,</span></span>
<span class="line">		tls<span class="token punctuation">.</span>TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256<span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-mtlsé…ç½®" tabindex="-1"><a class="header-anchor" href="#_2-mtlsé…ç½®">#</a> 2. mTLSé…ç½®</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># config/tls.yaml</span></span>
<span class="line"><span class="token key atrule">tls</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">  <span class="token key atrule">cert_file</span><span class="token punctuation">:</span> <span class="token string">"certs/server-cert.pem"</span></span>
<span class="line">  <span class="token key atrule">key_file</span><span class="token punctuation">:</span> <span class="token string">"certs/server-key.pem"</span></span>
<span class="line">  <span class="token key atrule">ca_file</span><span class="token punctuation">:</span> <span class="token string">"certs/ca-cert.pem"</span></span>
<span class="line">  <span class="token key atrule">client_auth</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">  <span class="token key atrule">min_version</span><span class="token punctuation">:</span> <span class="token string">"1.2"</span></span>
<span class="line">  <span class="token key atrule">max_version</span><span class="token punctuation">:</span> <span class="token string">"1.3"</span></span>
<span class="line">  </span>
<span class="line">  <span class="token comment"># å®¢æˆ·ç«¯é…ç½®</span></span>
<span class="line">  <span class="token key atrule">client</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">cert_file</span><span class="token punctuation">:</span> <span class="token string">"certs/client-cert.pem"</span></span>
<span class="line">    <span class="token key atrule">key_file</span><span class="token punctuation">:</span> <span class="token string">"certs/client-key.pem"</span></span>
<span class="line">    <span class="token key atrule">ca_file</span><span class="token punctuation">:</span> <span class="token string">"certs/ca-cert.pem"</span></span>
<span class="line">    <span class="token key atrule">server_name</span><span class="token punctuation">:</span> <span class="token string">"vgo-iam"</span></span>
<span class="line">    <span class="token key atrule">insecure_skip_verify</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ›¡ï¸-æ•°æ®ä¿æŠ¤" tabindex="-1"><a class="header-anchor" href="#ğŸ›¡ï¸-æ•°æ®ä¿æŠ¤">#</a> ğŸ›¡ï¸ æ•°æ®ä¿æŠ¤</h2>
<h3 id="_1-æ•°æ®åŠ å¯†" tabindex="-1"><a class="header-anchor" href="#_1-æ•°æ®åŠ å¯†">#</a> 1. æ•°æ®åŠ å¯†</h3>
<h4 id="æ•æ„Ÿæ•°æ®åŠ å¯†" tabindex="-1"><a class="header-anchor" href="#æ•æ„Ÿæ•°æ®åŠ å¯†">#</a> æ•æ„Ÿæ•°æ®åŠ å¯†</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// internal/crypto/encryption.go</span></span>
<span class="line"><span class="token keyword">package</span> crypto</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">	<span class="token string">"crypto/aes"</span></span>
<span class="line">	<span class="token string">"crypto/cipher"</span></span>
<span class="line">	<span class="token string">"crypto/rand"</span></span>
<span class="line">	<span class="token string">"crypto/sha256"</span></span>
<span class="line">	<span class="token string">"encoding/base64"</span></span>
<span class="line">	<span class="token string">"fmt"</span></span>
<span class="line">	<span class="token string">"io"</span></span>
<span class="line"></span>
<span class="line">	<span class="token string">"golang.org/x/crypto/pbkdf2"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// EncryptionConfig åŠ å¯†é…ç½®</span></span>
<span class="line"><span class="token keyword">type</span> EncryptionConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	Key       <span class="token builtin">string</span> <span class="token string">`yaml:"key"`</span></span>
<span class="line">	Salt      <span class="token builtin">string</span> <span class="token string">`yaml:"salt"`</span></span>
<span class="line">	KeyLength <span class="token builtin">int</span>    <span class="token string">`yaml:"key_length"`</span></span>
<span class="line">	Iterations <span class="token builtin">int</span>   <span class="token string">`yaml:"iterations"`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Encryptor åŠ å¯†å™¨</span></span>
<span class="line"><span class="token keyword">type</span> Encryptor <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	key <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// NewEncryptor åˆ›å»ºåŠ å¯†å™¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewEncryptor</span><span class="token punctuation">(</span>config EncryptionConfig<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Encryptor<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Key<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">32</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"encryption key must be at least 32 characters"</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">// ä½¿ç”¨PBKDF2æ´¾ç”Ÿå¯†é’¥</span></span>
<span class="line">	key <span class="token operator">:=</span> pbkdf2<span class="token punctuation">.</span><span class="token function">Key</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Key<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Salt<span class="token punctuation">)</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>Iterations<span class="token punctuation">,</span> config<span class="token punctuation">.</span>KeyLength<span class="token punctuation">,</span> sha256<span class="token punctuation">.</span>New<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Encryptor<span class="token punctuation">{</span>key<span class="token punctuation">:</span> key<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Encrypt åŠ å¯†æ•°æ®</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Encryptor<span class="token punctuation">)</span> <span class="token function">Encrypt</span><span class="token punctuation">(</span>plaintext <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	block<span class="token punctuation">,</span> err <span class="token operator">:=</span> aes<span class="token punctuation">.</span><span class="token function">NewCipher</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>key<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">// ç”ŸæˆéšæœºIV</span></span>
<span class="line">	iv <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> aes<span class="token punctuation">.</span>BlockSize<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">ReadFull</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">// ä½¿ç”¨GCMæ¨¡å¼</span></span>
<span class="line">	gcm<span class="token punctuation">,</span> err <span class="token operator">:=</span> cipher<span class="token punctuation">.</span><span class="token function">NewGCM</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">// åŠ å¯†</span></span>
<span class="line">	ciphertext <span class="token operator">:=</span> gcm<span class="token punctuation">.</span><span class="token function">Seal</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> iv<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">// å°†IVå’Œå¯†æ–‡ç»„åˆ</span></span>
<span class="line">	result <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>iv<span class="token punctuation">,</span> ciphertext<span class="token operator">...</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">return</span> base64<span class="token punctuation">.</span>StdEncoding<span class="token punctuation">.</span><span class="token function">EncodeToString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Decrypt è§£å¯†æ•°æ®</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Encryptor<span class="token punctuation">)</span> <span class="token function">Decrypt</span><span class="token punctuation">(</span>ciphertext <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	data<span class="token punctuation">,</span> err <span class="token operator">:=</span> base64<span class="token punctuation">.</span>StdEncoding<span class="token punctuation">.</span><span class="token function">DecodeString</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&lt;</span> aes<span class="token punctuation">.</span>BlockSize <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"ciphertext too short"</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	block<span class="token punctuation">,</span> err <span class="token operator">:=</span> aes<span class="token punctuation">.</span><span class="token function">NewCipher</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>key<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	gcm<span class="token punctuation">,</span> err <span class="token operator">:=</span> cipher<span class="token punctuation">.</span><span class="token function">NewGCM</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">// åˆ†ç¦»IVå’Œå¯†æ–‡</span></span>
<span class="line">	iv <span class="token operator">:=</span> data<span class="token punctuation">[</span><span class="token punctuation">:</span>aes<span class="token punctuation">.</span>BlockSize<span class="token punctuation">]</span></span>
<span class="line">	cipherData <span class="token operator">:=</span> data<span class="token punctuation">[</span>aes<span class="token punctuation">.</span>BlockSize<span class="token punctuation">:</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">// è§£å¯†</span></span>
<span class="line">	plaintext<span class="token punctuation">,</span> err <span class="token operator">:=</span> gcm<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> iv<span class="token punctuation">,</span> cipherData<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// HashPassword å¯†ç å“ˆå¸Œ</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">HashPassword</span><span class="token punctuation">(</span>password <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token comment">// ç”Ÿæˆéšæœºç›</span></span>
<span class="line">	salt <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>salt<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> err</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">// ä½¿ç”¨PBKDF2å“ˆå¸Œ</span></span>
<span class="line">	hash <span class="token operator">:=</span> pbkdf2<span class="token punctuation">.</span><span class="token function">Key</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">,</span> salt<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> sha256<span class="token punctuation">.</span>New<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">// ç»„åˆç›å’Œå“ˆå¸Œ</span></span>
<span class="line">	result <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> hash<span class="token operator">...</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">return</span> base64<span class="token punctuation">.</span>StdEncoding<span class="token punctuation">.</span><span class="token function">EncodeToString</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// VerifyPassword éªŒè¯å¯†ç </span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">VerifyPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> hashedPassword <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">	data<span class="token punctuation">,</span> err <span class="token operator">:=</span> base64<span class="token punctuation">.</span>StdEncoding<span class="token punctuation">.</span><span class="token function">DecodeString</span><span class="token punctuation">(</span>hashedPassword<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">48</span> <span class="token punctuation">{</span> <span class="token comment">// 16å­—èŠ‚ç› + 32å­—èŠ‚å“ˆå¸Œ</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	salt <span class="token operator">:=</span> data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span></span>
<span class="line">	hash <span class="token operator">:=</span> data<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">// è®¡ç®—è¾“å…¥å¯†ç çš„å“ˆå¸Œ</span></span>
<span class="line">	inputHash <span class="token operator">:=</span> pbkdf2<span class="token punctuation">.</span><span class="token function">Key</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">,</span> salt<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> sha256<span class="token punctuation">.</span>New<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">	<span class="token comment">// æ¯”è¾ƒå“ˆå¸Œ</span></span>
<span class="line">	<span class="token keyword">return</span> <span class="token function">compareHashes</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> inputHash<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// compareHashes å®‰å…¨æ¯”è¾ƒå“ˆå¸Œå€¼</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">compareHashes</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	result <span class="token operator">:=</span> <span class="token function">byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span></span>
<span class="line">		result <span class="token operator">|=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">return</span> result <span class="token operator">==</span> <span class="token number">0</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-æ•°æ®åº“å®‰å…¨" tabindex="-1"><a class="header-anchor" href="#_2-æ•°æ®åº“å®‰å…¨">#</a> 2. æ•°æ®åº“å®‰å…¨</h3>
<h4 id="postgresqlå®‰å…¨é…ç½®" tabindex="-1"><a class="header-anchor" href="#postgresqlå®‰å…¨é…ç½®">#</a> PostgreSQLå®‰å…¨é…ç½®</h4>
<div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre v-pre><code class="language-sql"><span class="line"><span class="token comment">-- scripts/security-setup.sql</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- åˆ›å»ºåªè¯»ç”¨æˆ·</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> vgo_readonly <span class="token keyword">WITH</span> PASSWORD <span class="token string">'readonly_password'</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">CONNECT</span> <span class="token keyword">ON</span> <span class="token keyword">DATABASE</span> vgo_db <span class="token keyword">TO</span> vgo_readonly<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">USAGE</span> <span class="token keyword">ON</span> <span class="token keyword">SCHEMA</span> <span class="token keyword">public</span> <span class="token keyword">TO</span> vgo_readonly<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> <span class="token keyword">ALL</span> <span class="token keyword">TABLES</span> <span class="token operator">IN</span> <span class="token keyword">SCHEMA</span> <span class="token keyword">public</span> <span class="token keyword">TO</span> vgo_readonly<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">PRIVILEGES</span> <span class="token operator">IN</span> <span class="token keyword">SCHEMA</span> <span class="token keyword">public</span> <span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> <span class="token keyword">TABLES</span> <span class="token keyword">TO</span> vgo_readonly<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- åˆ›å»ºåº”ç”¨ç”¨æˆ·ï¼ˆé™åˆ¶æƒé™ï¼‰</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">USER</span> vgo_app <span class="token keyword">WITH</span> PASSWORD <span class="token string">'app_password'</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">CONNECT</span> <span class="token keyword">ON</span> <span class="token keyword">DATABASE</span> vgo_db <span class="token keyword">TO</span> vgo_app<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">USAGE</span> <span class="token keyword">ON</span> <span class="token keyword">SCHEMA</span> <span class="token keyword">public</span> <span class="token keyword">TO</span> vgo_app<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span><span class="token punctuation">,</span> <span class="token keyword">INSERT</span><span class="token punctuation">,</span> <span class="token keyword">UPDATE</span><span class="token punctuation">,</span> <span class="token keyword">DELETE</span> <span class="token keyword">ON</span> <span class="token keyword">ALL</span> <span class="token keyword">TABLES</span> <span class="token operator">IN</span> <span class="token keyword">SCHEMA</span> <span class="token keyword">public</span> <span class="token keyword">TO</span> vgo_app<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">GRANT</span> <span class="token keyword">USAGE</span><span class="token punctuation">,</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> <span class="token keyword">ALL</span> SEQUENCES <span class="token operator">IN</span> <span class="token keyword">SCHEMA</span> <span class="token keyword">public</span> <span class="token keyword">TO</span> vgo_app<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">PRIVILEGES</span> <span class="token operator">IN</span> <span class="token keyword">SCHEMA</span> <span class="token keyword">public</span> <span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span><span class="token punctuation">,</span> <span class="token keyword">INSERT</span><span class="token punctuation">,</span> <span class="token keyword">UPDATE</span><span class="token punctuation">,</span> <span class="token keyword">DELETE</span> <span class="token keyword">ON</span> <span class="token keyword">TABLES</span> <span class="token keyword">TO</span> vgo_app<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">PRIVILEGES</span> <span class="token operator">IN</span> <span class="token keyword">SCHEMA</span> <span class="token keyword">public</span> <span class="token keyword">GRANT</span> <span class="token keyword">USAGE</span><span class="token punctuation">,</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> SEQUENCES <span class="token keyword">TO</span> vgo_app<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- å¯ç”¨è¡Œçº§å®‰å…¨</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> users <span class="token keyword">ENABLE</span> <span class="token keyword">ROW</span> <span class="token keyword">LEVEL</span> SECURITY<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> policies <span class="token keyword">ENABLE</span> <span class="token keyword">ROW</span> <span class="token keyword">LEVEL</span> SECURITY<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> access_keys <span class="token keyword">ENABLE</span> <span class="token keyword">ROW</span> <span class="token keyword">LEVEL</span> SECURITY<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- åˆ›å»ºè¡Œçº§å®‰å…¨ç­–ç•¥</span></span>
<span class="line"><span class="token keyword">CREATE</span> POLICY user_isolation <span class="token keyword">ON</span> users</span>
<span class="line">    <span class="token keyword">FOR</span> <span class="token keyword">ALL</span> <span class="token keyword">TO</span> vgo_app</span>
<span class="line">    <span class="token keyword">USING</span> <span class="token punctuation">(</span>created_by <span class="token operator">=</span> current_setting<span class="token punctuation">(</span><span class="token string">'app.current_user_id'</span><span class="token punctuation">)</span>::uuid <span class="token operator">OR</span> </span>
<span class="line">           current_setting<span class="token punctuation">(</span><span class="token string">'app.current_user_role'</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">CREATE</span> POLICY policy_isolation <span class="token keyword">ON</span> policies</span>
<span class="line">    <span class="token keyword">FOR</span> <span class="token keyword">ALL</span> <span class="token keyword">TO</span> vgo_app</span>
<span class="line">    <span class="token keyword">USING</span> <span class="token punctuation">(</span>created_by <span class="token operator">=</span> current_setting<span class="token punctuation">(</span><span class="token string">'app.current_user_id'</span><span class="token punctuation">)</span>::uuid <span class="token operator">OR</span> </span>
<span class="line">           current_setting<span class="token punctuation">(</span><span class="token string">'app.current_user_role'</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- åˆ›å»ºå®¡è®¡è¡¨</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> audit_log <span class="token punctuation">(</span></span>
<span class="line">    id <span class="token keyword">SERIAL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span></span>
<span class="line">    table_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    operation <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    old_values JSONB<span class="token punctuation">,</span></span>
<span class="line">    new_values JSONB<span class="token punctuation">,</span></span>
<span class="line">    user_id UUID<span class="token punctuation">,</span></span>
<span class="line">    user_ip INET<span class="token punctuation">,</span></span>
<span class="line">    created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- åˆ›å»ºå®¡è®¡è§¦å‘å™¨å‡½æ•°</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> audit_trigger_function<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">RETURNS</span> <span class="token keyword">TRIGGER</span> <span class="token keyword">AS</span> $$</span>
<span class="line"><span class="token keyword">BEGIN</span></span>
<span class="line">    <span class="token keyword">IF</span> TG_OP <span class="token operator">=</span> <span class="token string">'DELETE'</span> <span class="token keyword">THEN</span></span>
<span class="line">        <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> audit_log <span class="token punctuation">(</span>table_name<span class="token punctuation">,</span> operation<span class="token punctuation">,</span> old_values<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> user_ip<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>TG_TABLE_NAME<span class="token punctuation">,</span> TG_OP<span class="token punctuation">,</span> row_to_json<span class="token punctuation">(</span>OLD<span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line">                current_setting<span class="token punctuation">(</span><span class="token string">'app.current_user_id'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>::uuid<span class="token punctuation">,</span></span>
<span class="line">                current_setting<span class="token punctuation">(</span><span class="token string">'app.current_user_ip'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>::inet<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">RETURN</span> OLD<span class="token punctuation">;</span></span>
<span class="line">    ELSIF TG_OP <span class="token operator">=</span> <span class="token string">'UPDATE'</span> <span class="token keyword">THEN</span></span>
<span class="line">        <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> audit_log <span class="token punctuation">(</span>table_name<span class="token punctuation">,</span> operation<span class="token punctuation">,</span> old_values<span class="token punctuation">,</span> new_values<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> user_ip<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>TG_TABLE_NAME<span class="token punctuation">,</span> TG_OP<span class="token punctuation">,</span> row_to_json<span class="token punctuation">(</span>OLD<span class="token punctuation">)</span><span class="token punctuation">,</span> row_to_json<span class="token punctuation">(</span>NEW<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                current_setting<span class="token punctuation">(</span><span class="token string">'app.current_user_id'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>::uuid<span class="token punctuation">,</span></span>
<span class="line">                current_setting<span class="token punctuation">(</span><span class="token string">'app.current_user_ip'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>::inet<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">RETURN</span> NEW<span class="token punctuation">;</span></span>
<span class="line">    ELSIF TG_OP <span class="token operator">=</span> <span class="token string">'INSERT'</span> <span class="token keyword">THEN</span></span>
<span class="line">        <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> audit_log <span class="token punctuation">(</span>table_name<span class="token punctuation">,</span> operation<span class="token punctuation">,</span> new_values<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> user_ip<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>TG_TABLE_NAME<span class="token punctuation">,</span> TG_OP<span class="token punctuation">,</span> row_to_json<span class="token punctuation">(</span>NEW<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                current_setting<span class="token punctuation">(</span><span class="token string">'app.current_user_id'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>::uuid<span class="token punctuation">,</span></span>
<span class="line">                current_setting<span class="token punctuation">(</span><span class="token string">'app.current_user_ip'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>::inet<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">RETURN</span> NEW<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">RETURN</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">END</span><span class="token punctuation">;</span></span>
<span class="line">$$ <span class="token keyword">LANGUAGE</span> plpgsql<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- ä¸ºæ•æ„Ÿè¡¨åˆ›å»ºå®¡è®¡è§¦å‘å™¨</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> users_audit_trigger</span>
<span class="line">    <span class="token keyword">AFTER</span> <span class="token keyword">INSERT</span> <span class="token operator">OR</span> <span class="token keyword">UPDATE</span> <span class="token operator">OR</span> <span class="token keyword">DELETE</span> <span class="token keyword">ON</span> users</span>
<span class="line">    <span class="token keyword">FOR EACH ROW</span> <span class="token keyword">EXECUTE</span> <span class="token keyword">FUNCTION</span> audit_trigger_function<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> policies_audit_trigger</span>
<span class="line">    <span class="token keyword">AFTER</span> <span class="token keyword">INSERT</span> <span class="token operator">OR</span> <span class="token keyword">UPDATE</span> <span class="token operator">OR</span> <span class="token keyword">DELETE</span> <span class="token keyword">ON</span> policies</span>
<span class="line">    <span class="token keyword">FOR EACH ROW</span> <span class="token keyword">EXECUTE</span> <span class="token keyword">FUNCTION</span> audit_trigger_function<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> access_keys_audit_trigger</span>
<span class="line">    <span class="token keyword">AFTER</span> <span class="token keyword">INSERT</span> <span class="token operator">OR</span> <span class="token keyword">UPDATE</span> <span class="token operator">OR</span> <span class="token keyword">DELETE</span> <span class="token keyword">ON</span> access_keys</span>
<span class="line">    <span class="token keyword">FOR EACH ROW</span> <span class="token keyword">EXECUTE</span> <span class="token keyword">FUNCTION</span> audit_trigger_function<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”¥-é˜²ç«å¢™å’Œç½‘ç»œå®‰å…¨" tabindex="-1"><a class="header-anchor" href="#ğŸ”¥-é˜²ç«å¢™å’Œç½‘ç»œå®‰å…¨">#</a> ğŸ”¥ é˜²ç«å¢™å’Œç½‘ç»œå®‰å…¨</h2>
<h3 id="_1-iptablesé…ç½®" tabindex="-1"><a class="header-anchor" href="#_1-iptablesé…ç½®">#</a> 1. iptablesé…ç½®</h3>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># scripts/setup-firewall.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">set</span> <span class="token parameter variable">-e</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ”¥ é…ç½®é˜²ç«å¢™è§„åˆ™..."</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ¸…ç©ºç°æœ‰è§„åˆ™</span></span>
<span class="line">iptables <span class="token parameter variable">-F</span></span>
<span class="line">iptables <span class="token parameter variable">-X</span></span>
<span class="line">iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-F</span></span>
<span class="line">iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-X</span></span>
<span class="line">iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-F</span></span>
<span class="line">iptables <span class="token parameter variable">-t</span> mangle <span class="token parameter variable">-X</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># è®¾ç½®é»˜è®¤ç­–ç•¥</span></span>
<span class="line">iptables <span class="token parameter variable">-P</span> INPUT DROP</span>
<span class="line">iptables <span class="token parameter variable">-P</span> FORWARD DROP</span>
<span class="line">iptables <span class="token parameter variable">-P</span> OUTPUT ACCEPT</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å…è®¸æœ¬åœ°å›ç¯</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-i</span> lo <span class="token parameter variable">-j</span> ACCEPT</span>
<span class="line">iptables <span class="token parameter variable">-A</span> OUTPUT <span class="token parameter variable">-o</span> lo <span class="token parameter variable">-j</span> ACCEPT</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å…è®¸å·²å»ºç«‹çš„è¿æ¥</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-m</span> state <span class="token parameter variable">--state</span> ESTABLISHED,RELATED <span class="token parameter variable">-j</span> ACCEPT</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å…è®¸SSHï¼ˆè¯·æ ¹æ®å®é™…ç«¯å£ä¿®æ”¹ï¼‰</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">22</span> <span class="token parameter variable">-j</span> ACCEPT</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å…è®¸HTTPå’ŒHTTPS</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">80</span> <span class="token parameter variable">-j</span> ACCEPT</span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">443</span> <span class="token parameter variable">-j</span> ACCEPT</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å…è®¸VGOæœåŠ¡ç«¯å£</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">8080</span> <span class="token parameter variable">-j</span> ACCEPT  <span class="token comment"># HTTP API</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">50051</span> <span class="token parameter variable">-j</span> ACCEPT <span class="token comment"># gRPC</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">8081</span> <span class="token parameter variable">-j</span> ACCEPT  <span class="token comment"># Health Check</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">8082</span> <span class="token parameter variable">-j</span> ACCEPT  <span class="token comment"># Metrics</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å…è®¸æ•°æ®åº“è¿æ¥ï¼ˆä»…é™å†…ç½‘ï¼‰</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-s</span> <span class="token number">10.0</span>.0.0/8 <span class="token parameter variable">--dport</span> <span class="token number">5432</span> <span class="token parameter variable">-j</span> ACCEPT</span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-s</span> <span class="token number">172.16</span>.0.0/12 <span class="token parameter variable">--dport</span> <span class="token number">5432</span> <span class="token parameter variable">-j</span> ACCEPT</span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-s</span> <span class="token number">192.168</span>.0.0/16 <span class="token parameter variable">--dport</span> <span class="token number">5432</span> <span class="token parameter variable">-j</span> ACCEPT</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å…è®¸Redisè¿æ¥ï¼ˆä»…é™å†…ç½‘ï¼‰</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-s</span> <span class="token number">10.0</span>.0.0/8 <span class="token parameter variable">--dport</span> <span class="token number">6379</span> <span class="token parameter variable">-j</span> ACCEPT</span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-s</span> <span class="token number">172.16</span>.0.0/12 <span class="token parameter variable">--dport</span> <span class="token number">6379</span> <span class="token parameter variable">-j</span> ACCEPT</span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-s</span> <span class="token number">192.168</span>.0.0/16 <span class="token parameter variable">--dport</span> <span class="token number">6379</span> <span class="token parameter variable">-j</span> ACCEPT</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å…è®¸ç›‘æ§ç«¯å£ï¼ˆä»…é™å†…ç½‘ï¼‰</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-s</span> <span class="token number">10.0</span>.0.0/8 <span class="token parameter variable">--dport</span> <span class="token number">9090</span> <span class="token parameter variable">-j</span> ACCEPT  <span class="token comment"># Prometheus</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-s</span> <span class="token number">10.0</span>.0.0/8 <span class="token parameter variable">--dport</span> <span class="token number">3000</span> <span class="token parameter variable">-j</span> ACCEPT  <span class="token comment"># Grafana</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-s</span> <span class="token number">10.0</span>.0.0/8 <span class="token parameter variable">--dport</span> <span class="token number">9093</span> <span class="token parameter variable">-j</span> ACCEPT  <span class="token comment"># AlertManager</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># é˜²æ­¢DDoSæ”»å‡»</span></span>
<span class="line"><span class="token comment"># é™åˆ¶æ–°è¿æ¥é€Ÿç‡</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">80</span> <span class="token parameter variable">-m</span> limit <span class="token parameter variable">--limit</span> <span class="token number">25</span>/minute --limit-burst <span class="token number">100</span> <span class="token parameter variable">-j</span> ACCEPT</span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">443</span> <span class="token parameter variable">-m</span> limit <span class="token parameter variable">--limit</span> <span class="token number">25</span>/minute --limit-burst <span class="token number">100</span> <span class="token parameter variable">-j</span> ACCEPT</span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">8080</span> <span class="token parameter variable">-m</span> limit <span class="token parameter variable">--limit</span> <span class="token number">25</span>/minute --limit-burst <span class="token number">100</span> <span class="token parameter variable">-j</span> ACCEPT</span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">50051</span> <span class="token parameter variable">-m</span> limit <span class="token parameter variable">--limit</span> <span class="token number">25</span>/minute --limit-burst <span class="token number">100</span> <span class="token parameter variable">-j</span> ACCEPT</span>
<span class="line"></span>
<span class="line"><span class="token comment"># é˜²æ­¢ç«¯å£æ‰«æ</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-m</span> recent <span class="token parameter variable">--name</span> portscan <span class="token parameter variable">--rcheck</span> <span class="token parameter variable">--seconds</span> <span class="token number">86400</span> <span class="token parameter variable">-j</span> DROP</span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-m</span> recent <span class="token parameter variable">--name</span> portscan <span class="token parameter variable">--remove</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">139</span> <span class="token parameter variable">-m</span> recent <span class="token parameter variable">--name</span> portscan <span class="token parameter variable">--set</span> <span class="token parameter variable">-j</span> LOG --log-prefix <span class="token string">"portscan:"</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">139</span> <span class="token parameter variable">-m</span> recent <span class="token parameter variable">--name</span> portscan <span class="token parameter variable">--set</span> <span class="token parameter variable">-j</span> DROP</span>
<span class="line"></span>
<span class="line"><span class="token comment"># é˜²æ­¢SYNæ´ªæ°´æ”»å‡»</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--syn</span> <span class="token parameter variable">-m</span> limit <span class="token parameter variable">--limit</span> <span class="token number">1</span>/s --limit-burst <span class="token number">3</span> <span class="token parameter variable">-j</span> RETURN</span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--syn</span> <span class="token parameter variable">-j</span> DROP</span>
<span class="line"></span>
<span class="line"><span class="token comment"># é˜²æ­¢pingæ´ªæ°´æ”»å‡»</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> icmp --icmp-type echo-request <span class="token parameter variable">-m</span> limit <span class="token parameter variable">--limit</span> <span class="token number">1</span>/s --limit-burst <span class="token number">1</span> <span class="token parameter variable">-j</span> ACCEPT</span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-p</span> icmp --icmp-type echo-request <span class="token parameter variable">-j</span> DROP</span>
<span class="line"></span>
<span class="line"><span class="token comment"># è®°å½•è¢«ä¸¢å¼ƒçš„åŒ…</span></span>
<span class="line">iptables <span class="token parameter variable">-A</span> INPUT <span class="token parameter variable">-m</span> limit <span class="token parameter variable">--limit</span> <span class="token number">5</span>/min <span class="token parameter variable">-j</span> LOG --log-prefix <span class="token string">"iptables denied: "</span> --log-level <span class="token number">7</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ä¿å­˜è§„åˆ™</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-v</span> iptables-save <span class="token operator">&amp;></span> /dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    iptables-save <span class="token operator">></span> /etc/iptables/rules.v4</span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"âœ… é˜²ç«å¢™é…ç½®å®Œæˆï¼"</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ“‹ å½“å‰è§„åˆ™ï¼š"</span></span>
<span class="line">iptables <span class="token parameter variable">-L</span> <span class="token parameter variable">-n</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-fail2bané…ç½®" tabindex="-1"><a class="header-anchor" href="#_2-fail2bané…ç½®">#</a> 2. fail2bané…ç½®</h3>
<div class="language-ini line-numbers-mode" data-highlighter="prismjs" data-ext="ini"><pre v-pre><code class="language-ini"><span class="line"><span class="token comment"># /etc/fail2ban/jail.local</span></span>
<span class="line"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">DEFAULT</span><span class="token punctuation">]</span></span></span>
<span class="line"><span class="token key attr-name">bantime</span> <span class="token punctuation">=</span> <span class="token value attr-value">3600</span></span>
<span class="line"><span class="token key attr-name">findtime</span> <span class="token punctuation">=</span> <span class="token value attr-value">600</span></span>
<span class="line"><span class="token key attr-name">maxretry</span> <span class="token punctuation">=</span> <span class="token value attr-value">5</span></span>
<span class="line"><span class="token key attr-name">backend</span> <span class="token punctuation">=</span> <span class="token value attr-value">systemd</span></span>
<span class="line"></span>
<span class="line"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">sshd</span><span class="token punctuation">]</span></span></span>
<span class="line"><span class="token key attr-name">enabled</span> <span class="token punctuation">=</span> <span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">port</span> <span class="token punctuation">=</span> <span class="token value attr-value">ssh</span></span>
<span class="line"><span class="token key attr-name">logpath</span> <span class="token punctuation">=</span> <span class="token value attr-value">/var/log/auth.log</span></span>
<span class="line"><span class="token key attr-name">maxretry</span> <span class="token punctuation">=</span> <span class="token value attr-value">3</span></span>
<span class="line"><span class="token key attr-name">bantime</span> <span class="token punctuation">=</span> <span class="token value attr-value">86400</span></span>
<span class="line"></span>
<span class="line"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">vgo-auth</span><span class="token punctuation">]</span></span></span>
<span class="line"><span class="token key attr-name">enabled</span> <span class="token punctuation">=</span> <span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">port</span> <span class="token punctuation">=</span> <span class="token value attr-value">8080,50051</span></span>
<span class="line"><span class="token key attr-name">logpath</span> <span class="token punctuation">=</span> <span class="token value attr-value">/var/log/vgo/auth.log</span></span>
<span class="line"><span class="token key attr-name">failregex</span> <span class="token punctuation">=</span> <span class="token value attr-value">.*authentication failed.*from &lt;HOST></span></span>
<span class="line"><span class="token key attr-name">maxretry</span> <span class="token punctuation">=</span> <span class="token value attr-value">5</span></span>
<span class="line"><span class="token key attr-name">bantime</span> <span class="token punctuation">=</span> <span class="token value attr-value">3600</span></span>
<span class="line"></span>
<span class="line"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">vgo-api</span><span class="token punctuation">]</span></span></span>
<span class="line"><span class="token key attr-name">enabled</span> <span class="token punctuation">=</span> <span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">port</span> <span class="token punctuation">=</span> <span class="token value attr-value">8080,50051</span></span>
<span class="line"><span class="token key attr-name">logpath</span> <span class="token punctuation">=</span> <span class="token value attr-value">/var/log/vgo/access.log</span></span>
<span class="line"><span class="token key attr-name">failregex</span> <span class="token punctuation">=</span> <span class="token value attr-value">.*"(GET|POST|PUT|DELETE).*" (4[0-9]{2}|5[0-9]{2}) .*&lt;HOST></span></span>
<span class="line"><span class="token key attr-name">maxretry</span> <span class="token punctuation">=</span> <span class="token value attr-value">20</span></span>
<span class="line"><span class="token key attr-name">bantime</span> <span class="token punctuation">=</span> <span class="token value attr-value">1800</span></span>
<span class="line"></span>
<span class="line"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">nginx-http-auth</span><span class="token punctuation">]</span></span></span>
<span class="line"><span class="token key attr-name">enabled</span> <span class="token punctuation">=</span> <span class="token value attr-value">true</span></span>
<span class="line"><span class="token key attr-name">port</span> <span class="token punctuation">=</span> <span class="token value attr-value">http,https</span></span>
<span class="line"><span class="token key attr-name">logpath</span> <span class="token punctuation">=</span> <span class="token value attr-value">/var/log/nginx/error.log</span></span>
<span class="line"><span class="token key attr-name">failregex</span> <span class="token punctuation">=</span> <span class="token value attr-value">no user/password was provided for basic authentication.*client: &lt;HOST></span></span>
<span class="line">            user .* was not found in.*client: &lt;HOST></span>
<span class="line">            user .* password mismatch.*client: &lt;HOST></span>
<span class="line"><span class="token key attr-name">maxretry</span> <span class="token punctuation">=</span> <span class="token value attr-value">3</span></span>
<span class="line"><span class="token key attr-name">bantime</span> <span class="token punctuation">=</span> <span class="token value attr-value">3600</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”-å®‰å…¨ç›‘æ§å’Œå®¡è®¡" tabindex="-1"><a class="header-anchor" href="#ğŸ”-å®‰å…¨ç›‘æ§å’Œå®¡è®¡">#</a> ğŸ” å®‰å…¨ç›‘æ§å’Œå®¡è®¡</h2>
<h3 id="_1-å®‰å…¨äº‹ä»¶ç›‘æ§" tabindex="-1"><a class="header-anchor" href="#_1-å®‰å…¨äº‹ä»¶ç›‘æ§">#</a> 1. å®‰å…¨äº‹ä»¶ç›‘æ§</h3>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// internal/security/monitor.go</span></span>
<span class="line"><span class="token keyword">package</span> security</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">	<span class="token string">"context"</span></span>
<span class="line">	<span class="token string">"fmt"</span></span>
<span class="line">	<span class="token string">"log"</span></span>
<span class="line">	<span class="token string">"net"</span></span>
<span class="line">	<span class="token string">"strings"</span></span>
<span class="line">	<span class="token string">"time"</span></span>
<span class="line"></span>
<span class="line">	<span class="token string">"google.golang.org/grpc"</span></span>
<span class="line">	<span class="token string">"google.golang.org/grpc/metadata"</span></span>
<span class="line">	<span class="token string">"google.golang.org/grpc/peer"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// SecurityEvent å®‰å…¨äº‹ä»¶</span></span>
<span class="line"><span class="token keyword">type</span> SecurityEvent <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	Type        <span class="token builtin">string</span>            <span class="token string">`json:"type"`</span></span>
<span class="line">	Severity    <span class="token builtin">string</span>            <span class="token string">`json:"severity"`</span></span>
<span class="line">	Message     <span class="token builtin">string</span>            <span class="token string">`json:"message"`</span></span>
<span class="line">	UserID      <span class="token builtin">string</span>            <span class="token string">`json:"user_id,omitempty"`</span></span>
<span class="line">	ClientIP    <span class="token builtin">string</span>            <span class="token string">`json:"client_ip"`</span></span>
<span class="line">	UserAgent   <span class="token builtin">string</span>            <span class="token string">`json:"user_agent,omitempty"`</span></span>
<span class="line">	Method      <span class="token builtin">string</span>            <span class="token string">`json:"method"`</span></span>
<span class="line">	Timestamp   time<span class="token punctuation">.</span>Time         <span class="token string">`json:"timestamp"`</span></span>
<span class="line">	Metadata    <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:"metadata,omitempty"`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// SecurityMonitor å®‰å…¨ç›‘æ§å™¨</span></span>
<span class="line"><span class="token keyword">type</span> SecurityMonitor <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	events <span class="token keyword">chan</span> SecurityEvent</span>
<span class="line">	logger <span class="token operator">*</span>log<span class="token punctuation">.</span>Logger</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// NewSecurityMonitor åˆ›å»ºå®‰å…¨ç›‘æ§å™¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewSecurityMonitor</span><span class="token punctuation">(</span>logger <span class="token operator">*</span>log<span class="token punctuation">.</span>Logger<span class="token punctuation">)</span> <span class="token operator">*</span>SecurityMonitor <span class="token punctuation">{</span></span>
<span class="line">	m <span class="token operator">:=</span> <span class="token operator">&amp;</span>SecurityMonitor<span class="token punctuation">{</span></span>
<span class="line">		events<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> SecurityEvent<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">		logger<span class="token punctuation">:</span> logger<span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	</span>
<span class="line">	<span class="token comment">// å¯åŠ¨äº‹ä»¶å¤„ç†å™¨</span></span>
<span class="line">	<span class="token keyword">go</span> m<span class="token punctuation">.</span><span class="token function">processEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">	</span>
<span class="line">	<span class="token keyword">return</span> m</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// SecurityMonitorInterceptor å®‰å…¨ç›‘æ§æ‹¦æˆªå™¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">SecurityMonitorInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> grpc<span class="token punctuation">.</span>UnaryServerInterceptor <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> info <span class="token operator">*</span>grpc<span class="token punctuation">.</span>UnaryServerInfo<span class="token punctuation">,</span> handler grpc<span class="token punctuation">.</span>UnaryHandler<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">		</span>
<span class="line">		<span class="token comment">// è·å–å®¢æˆ·ç«¯ä¿¡æ¯</span></span>
<span class="line">		clientIP <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">getClientIP</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line">		userAgent <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">getUserAgent</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line">		userID <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">getUserID</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line">		</span>
<span class="line">		<span class="token comment">// æ£€æµ‹å¯ç–‘æ´»åŠ¨</span></span>
<span class="line">		m<span class="token punctuation">.</span><span class="token function">detectSuspiciousActivity</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> info<span class="token punctuation">.</span>FullMethod<span class="token punctuation">,</span> clientIP<span class="token punctuation">,</span> userID<span class="token punctuation">)</span></span>
<span class="line">		</span>
<span class="line">		<span class="token comment">// æ‰§è¡Œè¯·æ±‚</span></span>
<span class="line">		resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span></span>
<span class="line">		</span>
<span class="line">		duration <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span></span>
<span class="line">		</span>
<span class="line">		<span class="token comment">// è®°å½•å®‰å…¨äº‹ä»¶</span></span>
<span class="line">		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">			m<span class="token punctuation">.</span><span class="token function">logSecurityEvent</span><span class="token punctuation">(</span>SecurityEvent<span class="token punctuation">{</span></span>
<span class="line">				Type<span class="token punctuation">:</span>      <span class="token string">"request_failed"</span><span class="token punctuation">,</span></span>
<span class="line">				Severity<span class="token punctuation">:</span>  <span class="token string">"warning"</span><span class="token punctuation">,</span></span>
<span class="line">				Message<span class="token punctuation">:</span>   fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Request failed: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">				UserID<span class="token punctuation">:</span>    userID<span class="token punctuation">,</span></span>
<span class="line">				ClientIP<span class="token punctuation">:</span>  clientIP<span class="token punctuation">,</span></span>
<span class="line">				UserAgent<span class="token punctuation">:</span> userAgent<span class="token punctuation">,</span></span>
<span class="line">				Method<span class="token punctuation">:</span>    info<span class="token punctuation">.</span>FullMethod<span class="token punctuation">,</span></span>
<span class="line">				Timestamp<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">				Metadata<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">					<span class="token string">"duration"</span><span class="token punctuation">:</span> duration<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">					<span class="token string">"error"</span><span class="token punctuation">:</span>    err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">				<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">			<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">		</span>
<span class="line">		<span class="token keyword">return</span> resp<span class="token punctuation">,</span> err</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// detectSuspiciousActivity æ£€æµ‹å¯ç–‘æ´»åŠ¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">detectSuspiciousActivity</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> method<span class="token punctuation">,</span> clientIP<span class="token punctuation">,</span> userID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token comment">// æ£€æµ‹æš´åŠ›ç ´è§£</span></span>
<span class="line">	<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token string">"Login"</span><span class="token punctuation">)</span> <span class="token operator">||</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token string">"Auth"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token comment">// è¿™é‡Œå¯ä»¥å®ç°æ›´å¤æ‚çš„æ£€æµ‹é€»è¾‘</span></span>
<span class="line">		<span class="token comment">// ä¾‹å¦‚ï¼šæ£€æŸ¥IPçš„ç™»å½•å¤±è´¥æ¬¡æ•°ã€é¢‘ç‡ç­‰</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	</span>
<span class="line">	<span class="token comment">// æ£€æµ‹å¼‚å¸¸IP</span></span>
<span class="line">	<span class="token keyword">if</span> m<span class="token punctuation">.</span><span class="token function">isAnomalousIP</span><span class="token punctuation">(</span>clientIP<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		m<span class="token punctuation">.</span><span class="token function">logSecurityEvent</span><span class="token punctuation">(</span>SecurityEvent<span class="token punctuation">{</span></span>
<span class="line">			Type<span class="token punctuation">:</span>      <span class="token string">"anomalous_ip"</span><span class="token punctuation">,</span></span>
<span class="line">			Severity<span class="token punctuation">:</span>  <span class="token string">"warning"</span><span class="token punctuation">,</span></span>
<span class="line">			Message<span class="token punctuation">:</span>   fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Request from anomalous IP: %s"</span><span class="token punctuation">,</span> clientIP<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">			UserID<span class="token punctuation">:</span>    userID<span class="token punctuation">,</span></span>
<span class="line">			ClientIP<span class="token punctuation">:</span>  clientIP<span class="token punctuation">,</span></span>
<span class="line">			Method<span class="token punctuation">:</span>    method<span class="token punctuation">,</span></span>
<span class="line">			Timestamp<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	</span>
<span class="line">	<span class="token comment">// æ£€æµ‹æƒé™æå‡å°è¯•</span></span>
<span class="line">	<span class="token keyword">if</span> m<span class="token punctuation">.</span><span class="token function">isPrivilegeEscalationAttempt</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> userID<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		m<span class="token punctuation">.</span><span class="token function">logSecurityEvent</span><span class="token punctuation">(</span>SecurityEvent<span class="token punctuation">{</span></span>
<span class="line">			Type<span class="token punctuation">:</span>      <span class="token string">"privilege_escalation"</span><span class="token punctuation">,</span></span>
<span class="line">			Severity<span class="token punctuation">:</span>  <span class="token string">"critical"</span><span class="token punctuation">,</span></span>
<span class="line">			Message<span class="token punctuation">:</span>   fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Privilege escalation attempt detected"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">			UserID<span class="token punctuation">:</span>    userID<span class="token punctuation">,</span></span>
<span class="line">			ClientIP<span class="token punctuation">:</span>  clientIP<span class="token punctuation">,</span></span>
<span class="line">			Method<span class="token punctuation">:</span>    method<span class="token punctuation">,</span></span>
<span class="line">			Timestamp<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// getClientIP è·å–å®¢æˆ·ç«¯IP</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">getClientIP</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">	p<span class="token punctuation">,</span> ok <span class="token operator">:=</span> peer<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token string">"unknown"</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	</span>
<span class="line">	<span class="token keyword">if</span> addr<span class="token punctuation">,</span> ok <span class="token operator">:=</span> p<span class="token punctuation">.</span>Addr<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>net<span class="token punctuation">.</span>TCPAddr<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> addr<span class="token punctuation">.</span>IP<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	</span>
<span class="line">	<span class="token keyword">return</span> p<span class="token punctuation">.</span>Addr<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// getUserAgent è·å–ç”¨æˆ·ä»£ç†</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">getUserAgent</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">	md<span class="token punctuation">,</span> ok <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">FromIncomingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token string">""</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	</span>
<span class="line">	userAgent <span class="token operator">:=</span> md<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"user-agent"</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>userAgent<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> userAgent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	</span>
<span class="line">	<span class="token keyword">return</span> <span class="token string">""</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// getUserID è·å–ç”¨æˆ·ID</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">getUserID</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">if</span> userID<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> userID</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token keyword">return</span> <span class="token string">""</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// isAnomalousIP æ£€æŸ¥æ˜¯å¦ä¸ºå¼‚å¸¸IP</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">isAnomalousIP</span><span class="token punctuation">(</span>ip <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token comment">// è¿™é‡Œå¯ä»¥å®ç°IPä¿¡èª‰æ£€æŸ¥ã€åœ°ç†ä½ç½®æ£€æŸ¥ç­‰</span></span>
<span class="line">	<span class="token comment">// ä¾‹å¦‚ï¼šæ£€æŸ¥æ˜¯å¦æ¥è‡ªå·²çŸ¥çš„æ¶æ„IPæ®µã€Torç½‘ç»œç­‰</span></span>
<span class="line">	<span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// isPrivilegeEscalationAttempt æ£€æŸ¥æ˜¯å¦ä¸ºæƒé™æå‡å°è¯•</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">isPrivilegeEscalationAttempt</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> userID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token comment">// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å°è¯•è®¿é—®è¶…å‡ºå…¶æƒé™çš„æ–¹æ³•</span></span>
<span class="line">	<span class="token comment">// è¿™é‡Œéœ€è¦ç»“åˆç”¨æˆ·è§’è‰²å’Œæ–¹æ³•æƒé™è¿›è¡Œåˆ¤æ–­</span></span>
<span class="line">	<span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// logSecurityEvent è®°å½•å®‰å…¨äº‹ä»¶</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">logSecurityEvent</span><span class="token punctuation">(</span>event SecurityEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">select</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">case</span> m<span class="token punctuation">.</span>events <span class="token operator">&lt;-</span> event<span class="token punctuation">:</span></span>
<span class="line">	<span class="token keyword">default</span><span class="token punctuation">:</span></span>
<span class="line">		m<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Security event channel full, dropping event: %+v"</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// processEvents å¤„ç†å®‰å…¨äº‹ä»¶</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">processEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">for</span> event <span class="token operator">:=</span> <span class="token keyword">range</span> m<span class="token punctuation">.</span>events <span class="token punctuation">{</span></span>
<span class="line">		<span class="token comment">// è®°å½•åˆ°æ—¥å¿—</span></span>
<span class="line">		m<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Security Event: %+v"</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span></span>
<span class="line">		</span>
<span class="line">		<span class="token comment">// å‘é€åˆ°SIEMç³»ç»Ÿ</span></span>
<span class="line">		m<span class="token punctuation">.</span><span class="token function">sendToSIEM</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span></span>
<span class="line">		</span>
<span class="line">		<span class="token comment">// è§¦å‘å‘Šè­¦</span></span>
<span class="line">		<span class="token keyword">if</span> event<span class="token punctuation">.</span>Severity <span class="token operator">==</span> <span class="token string">"critical"</span> <span class="token punctuation">{</span></span>
<span class="line">			m<span class="token punctuation">.</span><span class="token function">triggerAlert</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// sendToSIEM å‘é€åˆ°SIEMç³»ç»Ÿ</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">sendToSIEM</span><span class="token punctuation">(</span>event SecurityEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token comment">// å®ç°å‘é€åˆ°SIEMç³»ç»Ÿçš„é€»è¾‘</span></span>
<span class="line">	<span class="token comment">// ä¾‹å¦‚ï¼šå‘é€åˆ°Elasticsearchã€Splunkç­‰</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// triggerAlert è§¦å‘å‘Šè­¦</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>SecurityMonitor<span class="token punctuation">)</span> <span class="token function">triggerAlert</span><span class="token punctuation">(</span>event SecurityEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token comment">// å®ç°å‘Šè­¦é€»è¾‘</span></span>
<span class="line">	<span class="token comment">// ä¾‹å¦‚ï¼šå‘é€é‚®ä»¶ã€Slacké€šçŸ¥ã€è°ƒç”¨Webhookç­‰</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-å®¡è®¡æ—¥å¿—é…ç½®" tabindex="-1"><a class="header-anchor" href="#_2-å®¡è®¡æ—¥å¿—é…ç½®">#</a> 2. å®¡è®¡æ—¥å¿—é…ç½®</h3>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// internal/audit/logger.go</span></span>
<span class="line"><span class="token keyword">package</span> audit</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">	<span class="token string">"context"</span></span>
<span class="line">	<span class="token string">"encoding/json"</span></span>
<span class="line">	<span class="token string">"fmt"</span></span>
<span class="line">	<span class="token string">"log"</span></span>
<span class="line">	<span class="token string">"time"</span></span>
<span class="line"></span>
<span class="line">	<span class="token string">"google.golang.org/grpc"</span></span>
<span class="line">	<span class="token string">"google.golang.org/grpc/metadata"</span></span>
<span class="line">	<span class="token string">"google.golang.org/grpc/peer"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// AuditLog å®¡è®¡æ—¥å¿—</span></span>
<span class="line"><span class="token keyword">type</span> AuditLog <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	ID          <span class="token builtin">string</span>            <span class="token string">`json:"id"`</span></span>
<span class="line">	Timestamp   time<span class="token punctuation">.</span>Time         <span class="token string">`json:"timestamp"`</span></span>
<span class="line">	UserID      <span class="token builtin">string</span>            <span class="token string">`json:"user_id"`</span></span>
<span class="line">	Username    <span class="token builtin">string</span>            <span class="token string">`json:"username"`</span></span>
<span class="line">	ClientIP    <span class="token builtin">string</span>            <span class="token string">`json:"client_ip"`</span></span>
<span class="line">	UserAgent   <span class="token builtin">string</span>            <span class="token string">`json:"user_agent"`</span></span>
<span class="line">	Method      <span class="token builtin">string</span>            <span class="token string">`json:"method"`</span></span>
<span class="line">	Request     <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>       <span class="token string">`json:"request,omitempty"`</span></span>
<span class="line">	Response    <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>       <span class="token string">`json:"response,omitempty"`</span></span>
<span class="line">	Error       <span class="token builtin">string</span>            <span class="token string">`json:"error,omitempty"`</span></span>
<span class="line">	Duration    time<span class="token punctuation">.</span>Duration     <span class="token string">`json:"duration"`</span></span>
<span class="line">	Metadata    <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:"metadata,omitempty"`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// AuditLogger å®¡è®¡æ—¥å¿—è®°å½•å™¨</span></span>
<span class="line"><span class="token keyword">type</span> AuditLogger <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	logger <span class="token operator">*</span>log<span class="token punctuation">.</span>Logger</span>
<span class="line">	config AuditConfig</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// AuditConfig å®¡è®¡é…ç½®</span></span>
<span class="line"><span class="token keyword">type</span> AuditConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	Enabled         <span class="token builtin">bool</span>     <span class="token string">`yaml:"enabled"`</span></span>
<span class="line">	LogRequests     <span class="token builtin">bool</span>     <span class="token string">`yaml:"log_requests"`</span></span>
<span class="line">	LogResponses    <span class="token builtin">bool</span>     <span class="token string">`yaml:"log_responses"`</span></span>
<span class="line">	SensitiveFields <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`yaml:"sensitive_fields"`</span></span>
<span class="line">	ExcludeMethods  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`yaml:"exclude_methods"`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// NewAuditLogger åˆ›å»ºå®¡è®¡æ—¥å¿—è®°å½•å™¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewAuditLogger</span><span class="token punctuation">(</span>logger <span class="token operator">*</span>log<span class="token punctuation">.</span>Logger<span class="token punctuation">,</span> config AuditConfig<span class="token punctuation">)</span> <span class="token operator">*</span>AuditLogger <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">return</span> <span class="token operator">&amp;</span>AuditLogger<span class="token punctuation">{</span></span>
<span class="line">		logger<span class="token punctuation">:</span> logger<span class="token punctuation">,</span></span>
<span class="line">		config<span class="token punctuation">:</span> config<span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// AuditInterceptor å®¡è®¡æ‹¦æˆªå™¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>AuditLogger<span class="token punctuation">)</span> <span class="token function">AuditInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> grpc<span class="token punctuation">.</span>UnaryServerInterceptor <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> info <span class="token operator">*</span>grpc<span class="token punctuation">.</span>UnaryServerInfo<span class="token punctuation">,</span> handler grpc<span class="token punctuation">.</span>UnaryHandler<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token operator">!</span>a<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">		</span>
<span class="line">		<span class="token comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦æ’é™¤æ­¤æ–¹æ³•</span></span>
<span class="line">		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> excludeMethod <span class="token operator">:=</span> <span class="token keyword">range</span> a<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ExcludeMethods <span class="token punctuation">{</span></span>
<span class="line">			<span class="token keyword">if</span> info<span class="token punctuation">.</span>FullMethod <span class="token operator">==</span> excludeMethod <span class="token punctuation">{</span></span>
<span class="line">				<span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span></span>
<span class="line">			<span class="token punctuation">}</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">		</span>
<span class="line">		start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">		</span>
<span class="line">		<span class="token comment">// åˆ›å»ºå®¡è®¡æ—¥å¿—</span></span>
<span class="line">		auditLog <span class="token operator">:=</span> AuditLog<span class="token punctuation">{</span></span>
<span class="line">			ID<span class="token punctuation">:</span>        <span class="token function">generateAuditID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">			Timestamp<span class="token punctuation">:</span> start<span class="token punctuation">,</span></span>
<span class="line">			UserID<span class="token punctuation">:</span>    a<span class="token punctuation">.</span><span class="token function">getUserID</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">			Username<span class="token punctuation">:</span>  a<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">			ClientIP<span class="token punctuation">:</span>  a<span class="token punctuation">.</span><span class="token function">getClientIP</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">			UserAgent<span class="token punctuation">:</span> a<span class="token punctuation">.</span><span class="token function">getUserAgent</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">			Method<span class="token punctuation">:</span>    info<span class="token punctuation">.</span>FullMethod<span class="token punctuation">,</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">		</span>
<span class="line">		<span class="token comment">// è®°å½•è¯·æ±‚</span></span>
<span class="line">		<span class="token keyword">if</span> a<span class="token punctuation">.</span>config<span class="token punctuation">.</span>LogRequests <span class="token punctuation">{</span></span>
<span class="line">			auditLog<span class="token punctuation">.</span>Request <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">sanitizeData</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">		</span>
<span class="line">		<span class="token comment">// æ‰§è¡Œè¯·æ±‚</span></span>
<span class="line">		resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">handler</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span></span>
<span class="line">		</span>
<span class="line">		auditLog<span class="token punctuation">.</span>Duration <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span></span>
<span class="line">		</span>
<span class="line">		<span class="token comment">// è®°å½•å“åº”</span></span>
<span class="line">		<span class="token keyword">if</span> a<span class="token punctuation">.</span>config<span class="token punctuation">.</span>LogResponses <span class="token operator">&amp;&amp;</span> resp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">			auditLog<span class="token punctuation">.</span>Response <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">sanitizeData</span><span class="token punctuation">(</span>resp<span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">		</span>
<span class="line">		<span class="token comment">// è®°å½•é”™è¯¯</span></span>
<span class="line">		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">			auditLog<span class="token punctuation">.</span>Error <span class="token operator">=</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">		</span>
<span class="line">		<span class="token comment">// è¾“å‡ºå®¡è®¡æ—¥å¿—</span></span>
<span class="line">		a<span class="token punctuation">.</span><span class="token function">writeAuditLog</span><span class="token punctuation">(</span>auditLog<span class="token punctuation">)</span></span>
<span class="line">		</span>
<span class="line">		<span class="token keyword">return</span> resp<span class="token punctuation">,</span> err</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// sanitizeData æ¸…ç†æ•æ„Ÿæ•°æ®</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>AuditLogger<span class="token punctuation">)</span> <span class="token function">sanitizeData</span><span class="token punctuation">(</span>data <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token comment">// å°†æ•°æ®è½¬æ¢ä¸ºJSONï¼Œç„¶åæ¸…ç†æ•æ„Ÿå­—æ®µ</span></span>
<span class="line">	jsonData<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> data</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	</span>
<span class="line">	<span class="token keyword">var</span> result <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>jsonData<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> data</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	</span>
<span class="line">	<span class="token comment">// æ¸…ç†æ•æ„Ÿå­—æ®µ</span></span>
<span class="line">	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> field <span class="token operator">:=</span> <span class="token keyword">range</span> a<span class="token punctuation">.</span>config<span class="token punctuation">.</span>SensitiveFields <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> exists <span class="token operator">:=</span> result<span class="token punctuation">[</span>field<span class="token punctuation">]</span><span class="token punctuation">;</span> exists <span class="token punctuation">{</span></span>
<span class="line">			result<span class="token punctuation">[</span>field<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"[REDACTED]"</span></span>
<span class="line">		<span class="token punctuation">}</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	</span>
<span class="line">	<span class="token keyword">return</span> result</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// writeAuditLog å†™å…¥å®¡è®¡æ—¥å¿—</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>AuditLogger<span class="token punctuation">)</span> <span class="token function">writeAuditLog</span><span class="token punctuation">(</span>auditLog AuditLog<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	jsonData<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>auditLog<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		a<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Failed to marshal audit log: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">		<span class="token keyword">return</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	</span>
<span class="line">	a<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"AUDIT: %s"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>jsonData<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è¾…åŠ©æ–¹æ³•</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>AuditLogger<span class="token punctuation">)</span> <span class="token function">getUserID</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">if</span> userID<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> userID</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token keyword">return</span> <span class="token string">""</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>AuditLogger<span class="token punctuation">)</span> <span class="token function">getUsername</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">if</span> username<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> username</span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	<span class="token keyword">return</span> <span class="token string">""</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>AuditLogger<span class="token punctuation">)</span> <span class="token function">getClientIP</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">	p<span class="token punctuation">,</span> ok <span class="token operator">:=</span> peer<span class="token punctuation">.</span><span class="token function">FromContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token string">"unknown"</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	</span>
<span class="line">	<span class="token keyword">if</span> addr<span class="token punctuation">,</span> ok <span class="token operator">:=</span> p<span class="token punctuation">.</span>Addr<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>net<span class="token punctuation">.</span>TCPAddr<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> addr<span class="token punctuation">.</span>IP<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	</span>
<span class="line">	<span class="token keyword">return</span> p<span class="token punctuation">.</span>Addr<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>AuditLogger<span class="token punctuation">)</span> <span class="token function">getUserAgent</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">	md<span class="token punctuation">,</span> ok <span class="token operator">:=</span> metadata<span class="token punctuation">.</span><span class="token function">FromIncomingContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token string">""</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	</span>
<span class="line">	userAgent <span class="token operator">:=</span> md<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"user-agent"</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>userAgent<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> userAgent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line">	</span>
<span class="line">	<span class="token keyword">return</span> <span class="token string">""</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">generateAuditID</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸš¨-å®‰å…¨å‘Šè­¦é…ç½®" tabindex="-1"><a class="header-anchor" href="#ğŸš¨-å®‰å…¨å‘Šè­¦é…ç½®">#</a> ğŸš¨ å®‰å…¨å‘Šè­¦é…ç½®</h2>
<h3 id="_1-alertmanageré…ç½®" tabindex="-1"><a class="header-anchor" href="#_1-alertmanageré…ç½®">#</a> 1. AlertManageré…ç½®</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># config/alertmanager.yml</span></span>
<span class="line"><span class="token key atrule">global</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">smtp_smarthost</span><span class="token punctuation">:</span> <span class="token string">'localhost:587'</span></span>
<span class="line">  <span class="token key atrule">smtp_from</span><span class="token punctuation">:</span> <span class="token string">'alerts@vgo.local'</span></span>
<span class="line">  <span class="token key atrule">smtp_auth_username</span><span class="token punctuation">:</span> <span class="token string">'alerts@vgo.local'</span></span>
<span class="line">  <span class="token key atrule">smtp_auth_password</span><span class="token punctuation">:</span> <span class="token string">'password'</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">route</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">group_by</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'alertname'</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token key atrule">group_wait</span><span class="token punctuation">:</span> 10s</span>
<span class="line">  <span class="token key atrule">group_interval</span><span class="token punctuation">:</span> 10s</span>
<span class="line">  <span class="token key atrule">repeat_interval</span><span class="token punctuation">:</span> 1h</span>
<span class="line">  <span class="token key atrule">receiver</span><span class="token punctuation">:</span> <span class="token string">'web.hook'</span></span>
<span class="line">  <span class="token key atrule">routes</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical</span>
<span class="line">    <span class="token key atrule">receiver</span><span class="token punctuation">:</span> <span class="token string">'critical-alerts'</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning</span>
<span class="line">    <span class="token key atrule">receiver</span><span class="token punctuation">:</span> <span class="token string">'warning-alerts'</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">receivers</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'web.hook'</span></span>
<span class="line">  <span class="token key atrule">webhook_configs</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">'http://127.0.0.1:5001/'</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'critical-alerts'</span></span>
<span class="line">  <span class="token key atrule">email_configs</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">'security@vgo.local'</span></span>
<span class="line">    <span class="token key atrule">subject</span><span class="token punctuation">:</span> <span class="token string">'ğŸš¨ VGO Critical Security Alert'</span></span>
<span class="line">    <span class="token key atrule">body</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">      Alert: {{ .GroupLabels.alertname }}</span>
<span class="line">      Severity: {{ .CommonLabels.severity }}</span>
<span class="line">      Instance: {{ .CommonLabels.instance }}</span>
<span class="line">      Description: {{ .CommonAnnotations.description }}</span></span>
<span class="line">      </span>
<span class="line">      <span class="token key atrule">Time</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .CommonAnnotations.timestamp <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">  <span class="token key atrule">slack_configs</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">api_url</span><span class="token punctuation">:</span> <span class="token string">'YOUR_SLACK_WEBHOOK_URL'</span></span>
<span class="line">    <span class="token key atrule">channel</span><span class="token punctuation">:</span> <span class="token string">'#security-alerts'</span></span>
<span class="line">    <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">'ğŸš¨ Critical Security Alert'</span></span>
<span class="line">    <span class="token key atrule">text</span><span class="token punctuation">:</span> <span class="token string">'{{ .CommonAnnotations.description }}'</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'warning-alerts'</span></span>
<span class="line">  <span class="token key atrule">email_configs</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">'ops@vgo.local'</span></span>
<span class="line">    <span class="token key atrule">subject</span><span class="token punctuation">:</span> <span class="token string">'âš ï¸ VGO Security Warning'</span></span>
<span class="line">    <span class="token key atrule">body</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">      Alert: {{ .GroupLabels.alertname }}</span>
<span class="line">      Severity: {{ .CommonLabels.severity }}</span>
<span class="line">      Instance: {{ .CommonLabels.instance }}</span>
<span class="line">      Description: {{ .CommonAnnotations.description }}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-prometheuså‘Šè­¦è§„åˆ™" tabindex="-1"><a class="header-anchor" href="#_2-prometheuså‘Šè­¦è§„åˆ™">#</a> 2. Prometheuså‘Šè­¦è§„åˆ™</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># config/security-alerts.yml</span></span>
<span class="line"><span class="token key atrule">groups</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> security.rules</span>
<span class="line">  <span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token comment"># è®¤è¯å¤±è´¥å‘Šè­¦</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> HighAuthenticationFailureRate</span>
<span class="line">    <span class="token key atrule">expr</span><span class="token punctuation">:</span> rate(vgo_auth_failures_total<span class="token punctuation">[</span>5m<span class="token punctuation">]</span>) <span class="token punctuation">></span> 0.1</span>
<span class="line">    <span class="token key atrule">for</span><span class="token punctuation">:</span> 2m</span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning</span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"High authentication failure rate detected"</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"Authentication failure rate is {{ $value }} failures/sec"</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># æƒé™æ‹’ç»å‘Šè­¦</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> HighPermissionDeniedRate</span>
<span class="line">    <span class="token key atrule">expr</span><span class="token punctuation">:</span> rate(vgo_permission_denied_total<span class="token punctuation">[</span>5m<span class="token punctuation">]</span>) <span class="token punctuation">></span> 0.05</span>
<span class="line">    <span class="token key atrule">for</span><span class="token punctuation">:</span> 2m</span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning</span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"High permission denied rate detected"</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"Permission denied rate is {{ $value }} denials/sec"</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># å¼‚å¸¸IPè®¿é—®</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> AnomalousIPAccess</span>
<span class="line">    <span class="token key atrule">expr</span><span class="token punctuation">:</span> vgo_anomalous_ip_access_total <span class="token punctuation">></span> 0</span>
<span class="line">    <span class="token key atrule">for</span><span class="token punctuation">:</span> 0m</span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical</span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"Anomalous IP access detected"</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"Access from anomalous IP: {{ $labels.client_ip }}"</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># æƒé™æå‡å°è¯•</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> PrivilegeEscalationAttempt</span>
<span class="line">    <span class="token key atrule">expr</span><span class="token punctuation">:</span> vgo_privilege_escalation_attempts_total <span class="token punctuation">></span> 0</span>
<span class="line">    <span class="token key atrule">for</span><span class="token punctuation">:</span> 0m</span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical</span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"Privilege escalation attempt detected"</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"User {{ $labels.user_id }} attempted privilege escalation"</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># æœåŠ¡ä¸å¯ç”¨</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> ServiceDown</span>
<span class="line">    <span class="token key atrule">expr</span><span class="token punctuation">:</span> up<span class="token punctuation">{</span>job="vgo<span class="token punctuation">-</span>iam"<span class="token punctuation">}</span> == 0</span>
<span class="line">    <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m</span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical</span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"VGO IAM service is down"</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"VGO IAM service has been down for more than 1 minute"</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># é«˜é”™è¯¯ç‡</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> HighErrorRate</span>
<span class="line">    <span class="token key atrule">expr</span><span class="token punctuation">:</span> rate(vgo_requests_total<span class="token punctuation">{</span>status=~"5.."<span class="token punctuation">}</span><span class="token punctuation">[</span>5m<span class="token punctuation">]</span>) <span class="token punctuation">></span> 0.1</span>
<span class="line">    <span class="token key atrule">for</span><span class="token punctuation">:</span> 2m</span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning</span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"High error rate detected"</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"Error rate is {{ $value }} errors/sec"</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># æ•°æ®åº“è¿æ¥å¤±è´¥</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> DatabaseConnectionFailure</span>
<span class="line">    <span class="token key atrule">expr</span><span class="token punctuation">:</span> vgo_database_connection_failures_total <span class="token punctuation">></span> 0</span>
<span class="line">    <span class="token key atrule">for</span><span class="token punctuation">:</span> 0m</span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical</span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"Database connection failure"</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"Failed to connect to database"</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># ç£ç›˜ç©ºé—´ä¸è¶³</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> DiskSpaceLow</span>
<span class="line">    <span class="token key atrule">expr</span><span class="token punctuation">:</span> (node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 &lt; 10</span>
<span class="line">    <span class="token key atrule">for</span><span class="token punctuation">:</span> 5m</span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning</span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"Disk space is running low"</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"Disk space is {{ $value }}% full"</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> HighMemoryUsage</span>
<span class="line">    <span class="token key atrule">expr</span><span class="token punctuation">:</span> (1 <span class="token punctuation">-</span> (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 <span class="token punctuation">></span> 90</span>
<span class="line">    <span class="token key atrule">for</span><span class="token punctuation">:</span> 5m</span>
<span class="line">    <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning</span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">"High memory usage detected"</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"Memory usage is {{ $value }}%"</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”-å¯†é’¥ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#ğŸ”-å¯†é’¥ç®¡ç†">#</a> ğŸ” å¯†é’¥ç®¡ç†</h2>
<h3 id="_1-hashicorp-vaulté›†æˆ" tabindex="-1"><a class="header-anchor" href="#_1-hashicorp-vaulté›†æˆ">#</a> 1. HashiCorp Vaulté›†æˆ</h3>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// internal/vault/client.go</span></span>
<span class="line"><span class="token keyword">package</span> vault</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">	<span class="token string">"context"</span></span>
<span class="line">	<span class="token string">"fmt"</span></span>
<span class="line">	<span class="token string">"time"</span></span>
<span class="line"></span>
<span class="line">	vaultapi <span class="token string">"github.com/hashicorp/vault/api"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// VaultConfig Vaulté…ç½®</span></span>
<span class="line"><span class="token keyword">type</span> VaultConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	Address   <span class="token builtin">string</span> <span class="token string">`yaml:"address"`</span></span>
<span class="line">	Token     <span class="token builtin">string</span> <span class="token string">`yaml:"token"`</span></span>
<span class="line">	Namespace <span class="token builtin">string</span> <span class="token string">`yaml:"namespace"`</span></span>
<span class="line">	Timeout   time<span class="token punctuation">.</span>Duration <span class="token string">`yaml:"timeout"`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// VaultClient Vaultå®¢æˆ·ç«¯</span></span>
<span class="line"><span class="token keyword">type</span> VaultClient <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">	client <span class="token operator">*</span>vaultapi<span class="token punctuation">.</span>Client</span>
<span class="line">	config VaultConfig</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// NewVaultClient åˆ›å»ºVaultå®¢æˆ·ç«¯</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewVaultClient</span><span class="token punctuation">(</span>config VaultConfig<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>VaultClient<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	vaultConfig <span class="token operator">:=</span> vaultapi<span class="token punctuation">.</span><span class="token function">DefaultConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">	vaultConfig<span class="token punctuation">.</span>Address <span class="token operator">=</span> config<span class="token punctuation">.</span>Address</span>
<span class="line">	vaultConfig<span class="token punctuation">.</span>Timeout <span class="token operator">=</span> config<span class="token punctuation">.</span>Timeout</span>
<span class="line"></span>
<span class="line">	client<span class="token punctuation">,</span> err <span class="token operator">:=</span> vaultapi<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>vaultConfig<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to create vault client: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	client<span class="token punctuation">.</span><span class="token function">SetToken</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Token<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> config<span class="token punctuation">.</span>Namespace <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span></span>
<span class="line">		client<span class="token punctuation">.</span><span class="token function">SetNamespace</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>Namespace<span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">return</span> <span class="token operator">&amp;</span>VaultClient<span class="token punctuation">{</span></span>
<span class="line">		client<span class="token punctuation">:</span> client<span class="token punctuation">,</span></span>
<span class="line">		config<span class="token punctuation">:</span> config<span class="token punctuation">,</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// GetSecret è·å–å¯†é’¥</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VaultClient<span class="token punctuation">)</span> <span class="token function">GetSecret</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	secret<span class="token punctuation">,</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Logical</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ReadWithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> path<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to read secret: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">if</span> secret <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"secret not found at path: %s"</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">return</span> secret<span class="token punctuation">.</span>Data<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// PutSecret å­˜å‚¨å¯†é’¥</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VaultClient<span class="token punctuation">)</span> <span class="token function">PutSecret</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">,</span> data <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Logical</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteWithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> path<span class="token punctuation">,</span> data<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to write secret: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// DeleteSecret åˆ é™¤å¯†é’¥</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VaultClient<span class="token punctuation">)</span> <span class="token function">DeleteSecret</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Logical</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">DeleteWithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> path<span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to delete secret: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// RenewToken ç»­æœŸToken</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>VaultClient<span class="token punctuation">)</span> <span class="token function">RenewToken</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> v<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">Auth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RenewSelfWithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to renew token: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">	<span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-å¯†é’¥è½®æ¢è„šæœ¬" tabindex="-1"><a class="header-anchor" href="#_2-å¯†é’¥è½®æ¢è„šæœ¬">#</a> 2. å¯†é’¥è½®æ¢è„šæœ¬</h3>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># scripts/rotate-keys.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">set</span> <span class="token parameter variable">-e</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">VAULT_ADDR</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${VAULT_ADDR<span class="token operator">:-</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span>8200}</span>"</span></span>
<span class="line"><span class="token assign-left variable">VAULT_TOKEN</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${VAULT_TOKEN}</span>"</span></span>
<span class="line"><span class="token assign-left variable">KEY_PATH</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${KEY_PATH<span class="token operator">:-</span>secret<span class="token operator">/</span>vgo}</span>"</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ”„ å¼€å§‹å¯†é’¥è½®æ¢..."</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥Vaultè¿æ¥</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token operator">!</span> vault status <span class="token operator">></span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"âŒ æ— æ³•è¿æ¥åˆ°VaultæœåŠ¡å™¨"</span></span>
<span class="line">    <span class="token builtin class-name">exit</span> <span class="token number">1</span></span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç”Ÿæˆæ–°çš„JWTå¯†é’¥</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ”‘ ç”Ÿæˆæ–°çš„JWTå¯†é’¥..."</span></span>
<span class="line"><span class="token assign-left variable">NEW_JWT_SECRET</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>openssl rand <span class="token parameter variable">-base64</span> <span class="token number">32</span><span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç”Ÿæˆæ–°çš„åŠ å¯†å¯†é’¥</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ” ç”Ÿæˆæ–°çš„åŠ å¯†å¯†é’¥..."</span></span>
<span class="line"><span class="token assign-left variable">NEW_ENCRYPTION_KEY</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>openssl rand <span class="token parameter variable">-base64</span> <span class="token number">32</span><span class="token variable">)</span></span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å¤‡ä»½å½“å‰å¯†é’¥</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ’¾ å¤‡ä»½å½“å‰å¯†é’¥..."</span></span>
<span class="line"><span class="token assign-left variable">BACKUP_PATH</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${KEY_PATH}</span>/backup/<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d_%H%M%S<span class="token variable">)</span></span>"</span></span>
<span class="line">vault kv put <span class="token string">"<span class="token variable">${BACKUP_PATH}</span>"</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token assign-left variable">jwt_secret</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>vault kv get <span class="token parameter variable">-field</span><span class="token operator">=</span>jwt_secret $<span class="token punctuation">{</span>KEY_PATH<span class="token punctuation">}</span><span class="token variable">)</span></span>"</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token assign-left variable">encryption_key</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>vault kv get <span class="token parameter variable">-field</span><span class="token operator">=</span>encryption_key $<span class="token punctuation">{</span>KEY_PATH<span class="token punctuation">}</span><span class="token variable">)</span></span>"</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ›´æ–°å¯†é’¥</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ”„ æ›´æ–°å¯†é’¥..."</span></span>
<span class="line">vault kv put <span class="token string">"<span class="token variable">${KEY_PATH}</span>"</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token assign-left variable">jwt_secret</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${NEW_JWT_SECRET}</span>"</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token assign-left variable">encryption_key</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${NEW_ENCRYPTION_KEY}</span>"</span> <span class="token punctuation">\</span></span>
<span class="line">    <span class="token assign-left variable">rotated_at</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> <span class="token parameter variable">-u</span> +%Y-%m-%dT%H:%M:%SZ<span class="token variable">)</span></span>"</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># é€šçŸ¥åº”ç”¨é‡æ–°åŠ è½½é…ç½®</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ“¡ é€šçŸ¥åº”ç”¨é‡æ–°åŠ è½½é…ç½®..."</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-v</span> kubectl <span class="token operator">&amp;></span> /dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    kubectl rollout restart deployment/vgo-iam</span>
<span class="line"><span class="token keyword">else</span></span>
<span class="line">    <span class="token comment"># å‘é€SIGHUPä¿¡å·é‡æ–°åŠ è½½é…ç½®</span></span>
<span class="line">    <span class="token function">pkill</span> <span class="token parameter variable">-HUP</span> vgo-iam <span class="token operator">||</span> <span class="token boolean">true</span></span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"âœ… å¯†é’¥è½®æ¢å®Œæˆï¼"</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ“‹ å¤‡ä»½è·¯å¾„: <span class="token variable">${BACKUP_PATH}</span>"</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ›¡ï¸-å®‰å…¨æœ€ä½³å®è·µ" tabindex="-1"><a class="header-anchor" href="#ğŸ›¡ï¸-å®‰å…¨æœ€ä½³å®è·µ">#</a> ğŸ›¡ï¸ å®‰å…¨æœ€ä½³å®è·µ</h2>
<h3 id="_1-ç”Ÿäº§ç¯å¢ƒå®‰å…¨æ¸…å•" tabindex="-1"><a class="header-anchor" href="#_1-ç”Ÿäº§ç¯å¢ƒå®‰å…¨æ¸…å•">#</a> 1. ç”Ÿäº§ç¯å¢ƒå®‰å…¨æ¸…å•</h3>
<ul>
<li>
<p>[ ] <strong>è®¤è¯å’Œæˆæƒ</strong></p>
<ul>
<li>[ ] å¯ç”¨å¼ºå¯†ç ç­–ç•¥</li>
<li>[ ] é…ç½®å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰</li>
<li>[ ] å®æ–½æœ€å°æƒé™åŸåˆ™</li>
<li>[ ] å®šæœŸå®¡æŸ¥ç”¨æˆ·æƒé™</li>
<li>[ ] é…ç½®ä¼šè¯è¶…æ—¶</li>
</ul>
</li>
<li>
<p>[ ] <strong>ç½‘ç»œå®‰å…¨</strong></p>
<ul>
<li>[ ] é…ç½®é˜²ç«å¢™è§„åˆ™</li>
<li>[ ] å¯ç”¨TLS/SSLåŠ å¯†</li>
<li>[ ] å®æ–½ç½‘ç»œåˆ†æ®µ</li>
<li>[ ] é…ç½®DDoSé˜²æŠ¤</li>
<li>[ ] å¯ç”¨å…¥ä¾µæ£€æµ‹ç³»ç»Ÿ</li>
</ul>
</li>
<li>
<p>[ ] <strong>æ•°æ®ä¿æŠ¤</strong></p>
<ul>
<li>[ ] åŠ å¯†æ•æ„Ÿæ•°æ®</li>
<li>[ ] é…ç½®æ•°æ®å¤‡ä»½</li>
<li>[ ] å®æ–½æ•°æ®è„±æ•</li>
<li>[ ] é…ç½®è®¿é—®æ—¥å¿—</li>
<li>[ ] å®šæœŸæ•°æ®æ¸…ç†</li>
</ul>
</li>
<li>
<p>[ ] <strong>ç³»ç»Ÿå®‰å…¨</strong></p>
<ul>
<li>[ ] å®šæœŸå®‰å…¨æ›´æ–°</li>
<li>[ ] é…ç½®å®‰å…¨ç›‘æ§</li>
<li>[ ] å®æ–½æ¼æ´æ‰«æ</li>
<li>[ ] é…ç½®å®‰å…¨å‘Šè­¦</li>
<li>[ ] å®šæœŸå®‰å…¨å®¡è®¡</li>
</ul>
</li>
<li>
<p>[ ] <strong>è¿ç»´å®‰å…¨</strong></p>
<ul>
<li>[ ] é™åˆ¶ç®¡ç†å‘˜æƒé™</li>
<li>[ ] é…ç½®å®¡è®¡æ—¥å¿—</li>
<li>[ ] å®æ–½å˜æ›´ç®¡ç†</li>
<li>[ ] é…ç½®å¤‡ä»½éªŒè¯</li>
<li>[ ] åˆ¶å®šåº”æ€¥å“åº”è®¡åˆ’</li>
</ul>
</li>
</ul>
<h3 id="_2-å®‰å…¨é…ç½®éªŒè¯" tabindex="-1"><a class="header-anchor" href="#_2-å®‰å…¨é…ç½®éªŒè¯">#</a> 2. å®‰å…¨é…ç½®éªŒè¯</h3>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># scripts/security-check.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">set</span> <span class="token parameter variable">-e</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ” å¼€å§‹å®‰å…¨é…ç½®æ£€æŸ¥..."</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥TLSé…ç½®</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ“‹ æ£€æŸ¥TLSé…ç½®..."</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">"certs/server-cert.pem"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"âœ… æœåŠ¡å™¨è¯ä¹¦å­˜åœ¨"</span></span>
<span class="line">    <span class="token comment"># æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ</span></span>
<span class="line">    <span class="token assign-left variable">EXPIRY</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>openssl x509 <span class="token parameter variable">-in</span> certs/server-cert.pem <span class="token parameter variable">-noout</span> <span class="token parameter variable">-enddate</span> <span class="token operator">|</span> <span class="token function">cut</span> <span class="token parameter variable">-d</span><span class="token operator">=</span> <span class="token parameter variable">-f2</span><span class="token variable">)</span></span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"ğŸ“… è¯ä¹¦è¿‡æœŸæ—¶é—´: <span class="token variable">$EXPIRY</span>"</span></span>
<span class="line"><span class="token keyword">else</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"âŒ æœåŠ¡å™¨è¯ä¹¦ä¸å­˜åœ¨"</span></span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥å¯†é’¥æƒé™</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ” æ£€æŸ¥å¯†é’¥æ–‡ä»¶æƒé™..."</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> certs/*.pem<span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">"<span class="token variable">$file</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token assign-left variable">PERMS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">stat</span> <span class="token parameter variable">-c</span> <span class="token string">"%a"</span> <span class="token string">"<span class="token variable">$file</span>"</span><span class="token variable">)</span></span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$PERMS</span>"</span> <span class="token operator">=</span> <span class="token string">"600"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">            <span class="token builtin class-name">echo</span> <span class="token string">"âœ… <span class="token variable">$file</span> æƒé™æ­£ç¡® (<span class="token variable">$PERMS</span>)"</span></span>
<span class="line">        <span class="token keyword">else</span></span>
<span class="line">            <span class="token builtin class-name">echo</span> <span class="token string">"âš ï¸ <span class="token variable">$file</span> æƒé™ä¸å®‰å…¨ (<span class="token variable">$PERMS</span>)ï¼Œå»ºè®®è®¾ç½®ä¸º600"</span></span>
<span class="line">        <span class="token keyword">fi</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line"><span class="token keyword">done</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ”¥ æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€..."</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-v</span> ufw <span class="token operator">&amp;></span> /dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token assign-left variable">UFW_STATUS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>ufw status <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-1</span><span class="token variable">)</span></span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"ğŸ“Š UFWçŠ¶æ€: <span class="token variable">$UFW_STATUS</span>"</span></span>
<span class="line"><span class="token keyword">elif</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-v</span> iptables <span class="token operator">&amp;></span> /dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token assign-left variable">IPTABLES_RULES</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>iptables <span class="token parameter variable">-L</span> <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span><span class="token variable">)</span></span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"ğŸ“Š iptablesè§„åˆ™æ•°é‡: <span class="token variable">$IPTABLES_RULES</span>"</span></span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥æœåŠ¡çŠ¶æ€</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸš€ æ£€æŸ¥æœåŠ¡çŠ¶æ€..."</span></span>
<span class="line"><span class="token assign-left variable">SERVICES</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">"vgo-iam"</span> <span class="token string">"postgresql"</span> <span class="token string">"redis"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token for-or-select variable">service</span> <span class="token keyword">in</span> <span class="token string">"<span class="token variable">${SERVICES<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>"</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">    <span class="token keyword">if</span> systemctl is-active <span class="token parameter variable">--quiet</span> <span class="token string">"<span class="token variable">$service</span>"</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">"âœ… <span class="token variable">$service</span> æœåŠ¡è¿è¡Œæ­£å¸¸"</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">"âŒ <span class="token variable">$service</span> æœåŠ¡æœªè¿è¡Œ"</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line"><span class="token keyword">done</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥æ—¥å¿—é…ç½®</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ“ æ£€æŸ¥æ—¥å¿—é…ç½®..."</span></span>
<span class="line"><span class="token assign-left variable">LOG_DIRS</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">"/var/log/vgo"</span> <span class="token string">"/var/log/audit"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token for-or-select variable">dir</span> <span class="token keyword">in</span> <span class="token string">"<span class="token variable">${LOG_DIRS<span class="token punctuation">[</span>@<span class="token punctuation">]</span>}</span>"</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-d</span> <span class="token string">"<span class="token variable">$dir</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">"âœ… æ—¥å¿—ç›®å½•å­˜åœ¨: <span class="token variable">$dir</span>"</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">"âš ï¸ æ—¥å¿—ç›®å½•ä¸å­˜åœ¨: <span class="token variable">$dir</span>"</span></span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line"><span class="token keyword">done</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥å¤‡ä»½é…ç½®</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ’¾ æ£€æŸ¥å¤‡ä»½é…ç½®..."</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">"/etc/cron.d/vgo-backup"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"âœ… å¤‡ä»½è®¡åˆ’ä»»åŠ¡å·²é…ç½®"</span></span>
<span class="line"><span class="token keyword">else</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"âš ï¸ å¤‡ä»½è®¡åˆ’ä»»åŠ¡æœªé…ç½®"</span></span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ğŸ‰ å®‰å…¨é…ç½®æ£€æŸ¥å®Œæˆï¼"</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“š-ç›¸å…³æ–‡æ¡£" tabindex="-1"><a class="header-anchor" href="#ğŸ“š-ç›¸å…³æ–‡æ¡£">#</a> ğŸ“š ç›¸å…³æ–‡æ¡£</h2>
<ul>
<li><RouteLink to="/deployment/">éƒ¨ç½²æŒ‡å—</RouteLink></li>
<li><RouteLink to="/deployment/docker-compose.html">Docker Composeéƒ¨ç½²</RouteLink></li>
<li><RouteLink to="/deployment/kubernetes.html">Kuberneteséƒ¨ç½²</RouteLink></li>
<li><RouteLink to="/deployment/monitoring.html">ç›‘æ§é…ç½®</RouteLink></li>
<li><RouteLink to="/api/">APIæ–‡æ¡£</RouteLink></li>
<li><RouteLink to="/guide/quick-start.html">å¿«é€Ÿå¼€å§‹</RouteLink></li>
</ul>
</div></template>


