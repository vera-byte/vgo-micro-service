<template><div><h1 id="docker-compose-éƒ¨ç½²" tabindex="-1"><a class="header-anchor" href="#docker-compose-éƒ¨ç½²">#</a> Docker Compose éƒ¨ç½²</h1>
<p>Docker Composeæ˜¯éƒ¨ç½²VGOå¾®æœåŠ¡æœ€ç®€å•å¿«æ·çš„æ–¹å¼ï¼Œç‰¹åˆ«é€‚åˆå¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒå’Œå°è§„æ¨¡ç”Ÿäº§ç¯å¢ƒã€‚æœ¬æŒ‡å—å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨Docker Composeéƒ¨ç½²å®Œæ•´çš„VGOå¾®æœåŠ¡æ ˆã€‚</p>
<h2 id="ğŸ“‹-éƒ¨ç½²æ¦‚è§ˆ" tabindex="-1"><a class="header-anchor" href="#ğŸ“‹-éƒ¨ç½²æ¦‚è§ˆ">#</a> ğŸ“‹ éƒ¨ç½²æ¦‚è§ˆ</h2>
<h3 id="æœåŠ¡ç»„ä»¶" tabindex="-1"><a class="header-anchor" href="#æœåŠ¡ç»„ä»¶">#</a> æœåŠ¡ç»„ä»¶</h3>
<div class="language-mermaid line-numbers-mode" data-highlighter="prismjs" data-ext="mermaid"><pre v-pre><code class="language-mermaid"><span class="line"><span class="token keyword">graph</span> TB</span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"Docker Compose Stack"</span></span>
<span class="line">        A<span class="token text string">[Nginx]</span> <span class="token arrow operator">--></span> B<span class="token text string">[IAM Service]</span></span>
<span class="line">        B <span class="token arrow operator">--></span> C<span class="token text string">[PostgreSQL]</span></span>
<span class="line">        B <span class="token arrow operator">--></span> D<span class="token text string">[Redis]</span></span>
<span class="line">        E<span class="token text string">[Prometheus]</span> <span class="token arrow operator">--></span> B</span>
<span class="line">        F<span class="token text string">[Grafana]</span> <span class="token arrow operator">--></span> E</span>
<span class="line">        G<span class="token text string">[Jaeger]</span> <span class="token arrow operator">--></span> B</span>
<span class="line">        H<span class="token text string">[Postgres Exporter]</span> <span class="token arrow operator">--></span> C</span>
<span class="line">        I<span class="token text string">[Redis Exporter]</span> <span class="token arrow operator">--></span> D</span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    J<span class="token text string">[External Client]</span> <span class="token arrow operator">--></span> A</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">style</span> A <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#e1f5fe</span></span>
<span class="line">    <span class="token keyword">style</span> B <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#f3e5f5</span></span>
<span class="line">    <span class="token keyword">style</span> C <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#e8f5e8</span></span>
<span class="line">    <span class="token keyword">style</span> D <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#fff3e0</span></span>
<span class="line">    <span class="token keyword">style</span> E <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#fce4ec</span></span>
<span class="line">    <span class="token keyword">style</span> F <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#f1f8e9</span></span>
<span class="line">    <span class="token keyword">style</span> G <span class="token style"><span class="token property">fill</span><span class="token operator">:</span>#e0f2f1</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ç«¯å£æ˜ å°„" tabindex="-1"><a class="header-anchor" href="#ç«¯å£æ˜ å°„">#</a> ç«¯å£æ˜ å°„</h3>
<table>
<thead>
<tr>
<th>æœåŠ¡</th>
<th>å†…éƒ¨ç«¯å£</th>
<th>å¤–éƒ¨ç«¯å£</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>Nginx</td>
<td>80/443</td>
<td>80/443</td>
<td>Webå…¥å£</td>
</tr>
<tr>
<td>IAM gRPC</td>
<td>50051</td>
<td>50051</td>
<td>gRPC API</td>
</tr>
<tr>
<td>IAM HTTP</td>
<td>8080</td>
<td>-</td>
<td>å†…éƒ¨HTTP API</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>5432</td>
<td>5432</td>
<td>æ•°æ®åº“ï¼ˆå¼€å‘ç¯å¢ƒï¼‰</td>
</tr>
<tr>
<td>Redis</td>
<td>6379</td>
<td>6379</td>
<td>ç¼“å­˜ï¼ˆå¼€å‘ç¯å¢ƒï¼‰</td>
</tr>
<tr>
<td>Prometheus</td>
<td>9090</td>
<td>9090</td>
<td>ç›‘æ§æœåŠ¡</td>
</tr>
<tr>
<td>Grafana</td>
<td>3000</td>
<td>3000</td>
<td>å¯è§†åŒ–ç•Œé¢</td>
</tr>
<tr>
<td>Jaeger</td>
<td>16686</td>
<td>16686</td>
<td>é“¾è·¯è¿½è¸ªç•Œé¢</td>
</tr>
</tbody>
</table>
<h2 id="ğŸš€-å¿«é€Ÿå¼€å§‹" tabindex="-1"><a class="header-anchor" href="#ğŸš€-å¿«é€Ÿå¼€å§‹">#</a> ğŸš€ å¿«é€Ÿå¼€å§‹</h2>
<h3 id="_1-ç¯å¢ƒå‡†å¤‡" tabindex="-1"><a class="header-anchor" href="#_1-ç¯å¢ƒå‡†å¤‡">#</a> 1. ç¯å¢ƒå‡†å¤‡</h3>
<h4 id="ç³»ç»Ÿè¦æ±‚" tabindex="-1"><a class="header-anchor" href="#ç³»ç»Ÿè¦æ±‚">#</a> ç³»ç»Ÿè¦æ±‚</h4>
<ul>
<li><strong>æ“ä½œç³»ç»Ÿ</strong>: Linux, macOS, Windows</li>
<li><strong>Docker</strong>: 20.10+</li>
<li><strong>Docker Compose</strong>: 2.0+</li>
<li><strong>å†…å­˜</strong>: æœ€å°‘4GBï¼Œæ¨è8GB+</li>
<li><strong>å­˜å‚¨</strong>: æœ€å°‘10GBå¯ç”¨ç©ºé—´</li>
</ul>
<h4 id="å®‰è£…dockerå’Œdocker-compose" tabindex="-1"><a class="header-anchor" href="#å®‰è£…dockerå’Œdocker-compose">#</a> å®‰è£…Dockerå’ŒDocker Compose</h4>
<p><strong>Ubuntu/Debian:</strong></p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># å®‰è£…Docker</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://get.docker.com <span class="token parameter variable">-o</span> get-docker.sh</span>
<span class="line"><span class="token function">sudo</span> <span class="token function">sh</span> get-docker.sh</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å®‰è£…Docker Compose</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">curl</span> <span class="token parameter variable">-L</span> <span class="token string">"https://github.com/docker/compose/releases/latest/download/docker-compose-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-s</span><span class="token variable">)</span></span>-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-m</span><span class="token variable">)</span></span>"</span> <span class="token parameter variable">-o</span> /usr/local/bin/docker-compose</span>
<span class="line"><span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/docker-compose</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ·»åŠ ç”¨æˆ·åˆ°dockerç»„</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">usermod</span> <span class="token parameter variable">-aG</span> <span class="token function">docker</span> <span class="token environment constant">$USER</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>CentOS/RHEL:</strong></p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># å®‰è£…Docker</span></span>
<span class="line"><span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils</span>
<span class="line"><span class="token function">sudo</span> yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span>
<span class="line"><span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> docker-ce docker-ce-cli containerd.io</span>
<span class="line"><span class="token function">sudo</span> systemctl start <span class="token function">docker</span></span>
<span class="line"><span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å®‰è£…Docker Compose</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">curl</span> <span class="token parameter variable">-L</span> <span class="token string">"https://github.com/docker/compose/releases/latest/download/docker-compose-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-s</span><span class="token variable">)</span></span>-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-m</span><span class="token variable">)</span></span>"</span> <span class="token parameter variable">-o</span> /usr/local/bin/docker-compose</span>
<span class="line"><span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/docker-compose</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>macOS:</strong></p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># ä½¿ç”¨Homebrew</span></span>
<span class="line">brew <span class="token function">install</span> <span class="token function">docker</span> <span class="token function">docker-compose</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æˆ–ä¸‹è½½Docker Desktop</span></span>
<span class="line"><span class="token comment"># https://www.docker.com/products/docker-desktop</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-è·å–é¡¹ç›®æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#_2-è·å–é¡¹ç›®æ–‡ä»¶">#</a> 2. è·å–é¡¹ç›®æ–‡ä»¶</h3>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># å…‹éš†é¡¹ç›®</span></span>
<span class="line"><span class="token function">git</span> clone https://github.com/your-org/vgo-microservice.git</span>
<span class="line"><span class="token builtin class-name">cd</span> vgo-microservice</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æˆ–è€…åˆ›å»ºé¡¹ç›®ç›®å½•</span></span>
<span class="line"><span class="token function">mkdir</span> vgo-deployment</span>
<span class="line"><span class="token builtin class-name">cd</span> vgo-deployment</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-é…ç½®æ–‡ä»¶å‡†å¤‡" tabindex="-1"><a class="header-anchor" href="#_3-é…ç½®æ–‡ä»¶å‡†å¤‡">#</a> 3. é…ç½®æ–‡ä»¶å‡†å¤‡</h3>
<h4 id="åˆ›å»ºdocker-compose-yml" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºdocker-compose-yml">#</a> åˆ›å»ºdocker-compose.yml</h4>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># docker-compose.yml</span></span>
<span class="line"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.8'</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token comment"># PostgreSQLæ•°æ®åº“</span></span>
<span class="line">  <span class="token key atrule">postgres</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span>15<span class="token punctuation">-</span>alpine</span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>postgres</span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">POSTGRES_DB</span><span class="token punctuation">:</span> vgo_db</span>
<span class="line">      <span class="token key atrule">POSTGRES_USER</span><span class="token punctuation">:</span> vgo_user</span>
<span class="line">      <span class="token key atrule">POSTGRES_PASSWORD</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>POSTGRES_PASSWORD<span class="token punctuation">:</span><span class="token punctuation">-</span>vgo_password<span class="token punctuation">}</span></span>
<span class="line">      <span class="token key atrule">POSTGRES_INITDB_ARGS</span><span class="token punctuation">:</span> <span class="token string">"--encoding=UTF8 --locale=C"</span></span>
<span class="line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> postgres_data<span class="token punctuation">:</span>/var/lib/postgresql/data</span>
<span class="line">      <span class="token punctuation">-</span> ./init<span class="token punctuation">-</span>scripts<span class="token punctuation">:</span>/docker<span class="token punctuation">-</span>entrypoint<span class="token punctuation">-</span>initdb.d</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">"5432:5432"</span></span>
<span class="line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> backend</span>
<span class="line">    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped</span>
<span class="line">    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">test</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"CMD-SHELL"</span><span class="token punctuation">,</span> <span class="token string">"pg_isready -U vgo_user -d vgo_db"</span><span class="token punctuation">]</span></span>
<span class="line">      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s</span>
<span class="line">      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 5s</span>
<span class="line">      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># Redisç¼“å­˜</span></span>
<span class="line">  <span class="token key atrule">redis</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>7<span class="token punctuation">-</span>alpine</span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>redis</span>
<span class="line">    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server <span class="token punctuation">-</span><span class="token punctuation">-</span>requirepass $<span class="token punctuation">{</span>REDIS_PASSWORD<span class="token punctuation">:</span><span class="token punctuation">-</span>redis_password<span class="token punctuation">}</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>appendonly yes</span>
<span class="line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> redis_data<span class="token punctuation">:</span>/data</span>
<span class="line">      <span class="token punctuation">-</span> ./redis.conf<span class="token punctuation">:</span>/usr/local/etc/redis/redis.conf</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">"6379:6379"</span></span>
<span class="line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> backend</span>
<span class="line">    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped</span>
<span class="line">    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">test</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"CMD"</span><span class="token punctuation">,</span> <span class="token string">"redis-cli"</span><span class="token punctuation">,</span> <span class="token string">"--raw"</span><span class="token punctuation">,</span> <span class="token string">"incr"</span><span class="token punctuation">,</span> <span class="token string">"ping"</span><span class="token punctuation">]</span></span>
<span class="line">      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s</span>
<span class="line">      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 3s</span>
<span class="line">      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># IAMå¾®æœåŠ¡</span></span>
<span class="line">  <span class="token key atrule">iam</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> vgo/iam<span class="token punctuation">:</span>latest</span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">    <span class="token key atrule">build</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">context</span><span class="token punctuation">:</span> .</span>
<span class="line">      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile</span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token comment"># æ•°æ®åº“é…ç½®</span></span>
<span class="line">      <span class="token punctuation">-</span> DB_HOST=postgres</span>
<span class="line">      <span class="token punctuation">-</span> DB_PORT=5432</span>
<span class="line">      <span class="token punctuation">-</span> DB_NAME=vgo_db</span>
<span class="line">      <span class="token punctuation">-</span> DB_USER=vgo_user</span>
<span class="line">      <span class="token punctuation">-</span> DB_PASSWORD=$<span class="token punctuation">{</span>POSTGRES_PASSWORD<span class="token punctuation">:</span><span class="token punctuation">-</span>vgo_password<span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">-</span> DB_SSLMODE=disable</span>
<span class="line">      <span class="token punctuation">-</span> DB_MAX_OPEN_CONNS=25</span>
<span class="line">      <span class="token punctuation">-</span> DB_MAX_IDLE_CONNS=5</span>
<span class="line">      <span class="token punctuation">-</span> DB_CONN_MAX_LIFETIME=300s</span>
<span class="line">      </span>
<span class="line">      <span class="token comment"># Redisé…ç½®</span></span>
<span class="line">      <span class="token punctuation">-</span> REDIS_HOST=redis</span>
<span class="line">      <span class="token punctuation">-</span> REDIS_PORT=6379</span>
<span class="line">      <span class="token punctuation">-</span> REDIS_PASSWORD=$<span class="token punctuation">{</span>REDIS_PASSWORD<span class="token punctuation">:</span><span class="token punctuation">-</span>redis_password<span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">-</span> REDIS_DB=0</span>
<span class="line">      <span class="token punctuation">-</span> REDIS_POOL_SIZE=10</span>
<span class="line">      </span>
<span class="line">      <span class="token comment"># æœåŠ¡é…ç½®</span></span>
<span class="line">      <span class="token punctuation">-</span> GRPC_PORT=50051</span>
<span class="line">      <span class="token punctuation">-</span> HTTP_PORT=8080</span>
<span class="line">      <span class="token punctuation">-</span> HEALTH_PORT=8081</span>
<span class="line">      <span class="token punctuation">-</span> METRICS_PORT=8082</span>
<span class="line">      </span>
<span class="line">      <span class="token comment"># å®‰å…¨é…ç½®</span></span>
<span class="line">      <span class="token punctuation">-</span> JWT_SECRET=$<span class="token punctuation">{</span>JWT_SECRET<span class="token punctuation">:</span><span class="token punctuation">-</span>your<span class="token punctuation">-</span>jwt<span class="token punctuation">-</span>secret<span class="token punctuation">-</span>key<span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">-</span> ENCRYPTION_KEY=$<span class="token punctuation">{</span>ENCRYPTION_KEY<span class="token punctuation">:</span><span class="token punctuation">-</span>your<span class="token punctuation">-</span>encryption<span class="token punctuation">-</span>key<span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">-</span> TLS_ENABLED=false</span>
<span class="line">      </span>
<span class="line">      <span class="token comment"># æ—¥å¿—é…ç½®</span></span>
<span class="line">      <span class="token punctuation">-</span> LOG_LEVEL=info</span>
<span class="line">      <span class="token punctuation">-</span> LOG_FORMAT=json</span>
<span class="line">      </span>
<span class="line">      <span class="token comment"># ç›‘æ§é…ç½®</span></span>
<span class="line">      <span class="token punctuation">-</span> METRICS_ENABLED=true</span>
<span class="line">      <span class="token punctuation">-</span> TRACING_ENABLED=true</span>
<span class="line">      <span class="token punctuation">-</span> JAEGER_ENDPOINT=http<span class="token punctuation">:</span>//jaeger<span class="token punctuation">:</span>14268/api/traces</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">"50051:50051"</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">"8080:8080"</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">"8081:8081"</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">"8082:8082"</span></span>
<span class="line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> ./configs<span class="token punctuation">:</span>/app/configs</span>
<span class="line">      <span class="token punctuation">-</span> ./logs<span class="token punctuation">:</span>/app/logs</span>
<span class="line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> frontend</span>
<span class="line">      <span class="token punctuation">-</span> backend</span>
<span class="line">    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">postgres</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">condition</span><span class="token punctuation">:</span> service_healthy</span>
<span class="line">      <span class="token key atrule">redis</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">condition</span><span class="token punctuation">:</span> service_healthy</span>
<span class="line">    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped</span>
<span class="line">    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">test</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"CMD"</span><span class="token punctuation">,</span> <span class="token string">"curl"</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> <span class="token string">"http://localhost:8081/health"</span><span class="token punctuation">]</span></span>
<span class="line">      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 30s</span>
<span class="line">      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 10s</span>
<span class="line">      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">      <span class="token key atrule">start_period</span><span class="token punctuation">:</span> 40s</span>
<span class="line"></span>
<span class="line">  <span class="token comment"># Nginxåå‘ä»£ç†</span></span>
<span class="line">  <span class="token key atrule">nginx</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine</span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>nginx</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">"80:80"</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">"443:443"</span></span>
<span class="line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> ./nginx/nginx.conf<span class="token punctuation">:</span>/etc/nginx/nginx.conf</span>
<span class="line">      <span class="token punctuation">-</span> ./nginx/conf.d<span class="token punctuation">:</span>/etc/nginx/conf.d</span>
<span class="line">      <span class="token punctuation">-</span> ./certs<span class="token punctuation">:</span>/etc/nginx/certs</span>
<span class="line">      <span class="token punctuation">-</span> ./logs/nginx<span class="token punctuation">:</span>/var/log/nginx</span>
<span class="line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> frontend</span>
<span class="line">    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> iam</span>
<span class="line">    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped</span>
<span class="line">    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">test</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"CMD"</span><span class="token punctuation">,</span> <span class="token string">"curl"</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> <span class="token string">"http://localhost/health"</span><span class="token punctuation">]</span></span>
<span class="line">      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 30s</span>
<span class="line">      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 10s</span>
<span class="line">      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment"># Prometheusç›‘æ§</span></span>
<span class="line">  <span class="token key atrule">prometheus</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> prom/prometheus<span class="token punctuation">:</span>latest</span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>prometheus</span>
<span class="line">    <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">'--config.file=/etc/prometheus/prometheus.yml'</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">'--storage.tsdb.path=/prometheus'</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">'--web.console.libraries=/etc/prometheus/console_libraries'</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">'--web.console.templates=/etc/prometheus/consoles'</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">'--storage.tsdb.retention.time=200h'</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">'--web.enable-lifecycle'</span></span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">"9090:9090"</span></span>
<span class="line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> ./prometheus/prometheus.yml<span class="token punctuation">:</span>/etc/prometheus/prometheus.yml</span>
<span class="line">      <span class="token punctuation">-</span> prometheus_data<span class="token punctuation">:</span>/prometheus</span>
<span class="line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> backend</span>
<span class="line">    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped</span>
<span class="line"></span>
<span class="line">  <span class="token comment"># Grafanaå¯è§†åŒ–</span></span>
<span class="line">  <span class="token key atrule">grafana</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> grafana/grafana<span class="token punctuation">:</span>latest</span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>grafana</span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> GF_SECURITY_ADMIN_PASSWORD=$<span class="token punctuation">{</span>GRAFANA_PASSWORD<span class="token punctuation">:</span><span class="token punctuation">-</span>admin<span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">-</span> GF_USERS_ALLOW_SIGN_UP=false</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">"3000:3000"</span></span>
<span class="line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> grafana_data<span class="token punctuation">:</span>/var/lib/grafana</span>
<span class="line">      <span class="token punctuation">-</span> ./grafana/provisioning<span class="token punctuation">:</span>/etc/grafana/provisioning</span>
<span class="line">      <span class="token punctuation">-</span> ./grafana/dashboards<span class="token punctuation">:</span>/var/lib/grafana/dashboards</span>
<span class="line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> backend</span>
<span class="line">    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> prometheus</span>
<span class="line">    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped</span>
<span class="line"></span>
<span class="line">  <span class="token comment"># Jaegeré“¾è·¯è¿½è¸ª</span></span>
<span class="line">  <span class="token key atrule">jaeger</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> jaegertracing/all<span class="token punctuation">-</span>in<span class="token punctuation">-</span>one<span class="token punctuation">:</span>latest</span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>jaeger</span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> COLLECTOR_OTLP_ENABLED=true</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">"16686:16686"</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">"14268:14268"</span></span>
<span class="line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> backend</span>
<span class="line">    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped</span>
<span class="line"></span>
<span class="line">  <span class="token comment"># PostgreSQLç›‘æ§</span></span>
<span class="line">  <span class="token key atrule">postgres-exporter</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> prometheuscommunity/postgres<span class="token punctuation">-</span>exporter<span class="token punctuation">:</span>latest</span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>postgres<span class="token punctuation">-</span>exporter</span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> DATA_SOURCE_NAME=postgresql<span class="token punctuation">:</span>//vgo_user<span class="token punctuation">:</span>$<span class="token punctuation">{</span>POSTGRES_PASSWORD<span class="token punctuation">:</span><span class="token punctuation">-</span>vgo_password<span class="token punctuation">}</span>@postgres<span class="token punctuation">:</span>5432/vgo_db<span class="token punctuation">?</span>sslmode=disable</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">"9187:9187"</span></span>
<span class="line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> backend</span>
<span class="line">    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> postgres</span>
<span class="line">    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped</span>
<span class="line"></span>
<span class="line">  <span class="token comment"># Redisç›‘æ§</span></span>
<span class="line">  <span class="token key atrule">redis-exporter</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> oliver006/redis_exporter<span class="token punctuation">:</span>latest</span>
<span class="line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>redis<span class="token punctuation">-</span>exporter</span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> REDIS_ADDR=redis<span class="token punctuation">:</span>//redis<span class="token punctuation">:</span><span class="token number">6379</span></span>
<span class="line">      <span class="token punctuation">-</span> REDIS_PASSWORD=$<span class="token punctuation">{</span>REDIS_PASSWORD<span class="token punctuation">:</span><span class="token punctuation">-</span>redis_password<span class="token punctuation">}</span></span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">"9121:9121"</span></span>
<span class="line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> backend</span>
<span class="line">    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> redis</span>
<span class="line">    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped</span>
<span class="line"></span>
<span class="line"><span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">postgres_data</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">redis_data</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">prometheus_data</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">grafana_data</span><span class="token punctuation">:</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">networks</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">frontend</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge</span>
<span class="line">  <span class="token key atrule">backend</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge</span>
<span class="line">    <span class="token key atrule">internal</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶">#</a> åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># .env</span></span>
<span class="line"><span class="token comment"># æ•°æ®åº“é…ç½®</span></span>
<span class="line"><span class="token assign-left variable">POSTGRES_PASSWORD</span><span class="token operator">=</span>your-secure-postgres-password</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Redisé…ç½®</span></span>
<span class="line"><span class="token assign-left variable">REDIS_PASSWORD</span><span class="token operator">=</span>your-secure-redis-password</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å®‰å…¨é…ç½®</span></span>
<span class="line"><span class="token assign-left variable">JWT_SECRET</span><span class="token operator">=</span>your-very-long-jwt-secret-key-at-least-32-characters</span>
<span class="line"><span class="token assign-left variable">ENCRYPTION_KEY</span><span class="token operator">=</span>your-32-character-encryption-key</span>
<span class="line"></span>
<span class="line"><span class="token comment"># Grafanaé…ç½®</span></span>
<span class="line"><span class="token assign-left variable">GRAFANA_PASSWORD</span><span class="token operator">=</span>your-grafana-admin-password</span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç¯å¢ƒæ ‡è¯†</span></span>
<span class="line"><span class="token assign-left variable">ENVIRONMENT</span><span class="token operator">=</span>development</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="åˆ›å»ºnginxé…ç½®" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºnginxé…ç½®">#</a> åˆ›å»ºNginxé…ç½®</h4>
<div class="language-nginx line-numbers-mode" data-highlighter="prismjs" data-ext="nginx"><pre v-pre><code class="language-nginx"><span class="line"><span class="token comment"># nginx/nginx.conf</span></span>
<span class="line"><span class="token directive"><span class="token keyword">user</span> nginx</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token directive"><span class="token keyword">worker_processes</span> auto</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token directive"><span class="token keyword">error_log</span> /var/log/nginx/error.log warn</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token directive"><span class="token keyword">pid</span> /var/run/nginx.pid</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token directive"><span class="token keyword">events</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">worker_connections</span> <span class="token number">1024</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">use</span> epoll</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">multi_accept</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">include</span> /etc/nginx/mime.types</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">default_type</span> application/octet-stream</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># æ—¥å¿—æ ¼å¼</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">log_format</span> main <span class="token string">'<span class="token variable">$remote_addr</span> - <span class="token variable">$remote_user</span> [<span class="token variable">$time_local]</span> "<span class="token variable">$request</span>" '</span></span>
<span class="line">                    <span class="token string">'<span class="token variable">$status</span> <span class="token variable">$body_bytes_sent</span> "<span class="token variable">$http_referer</span>" '</span></span>
<span class="line">                    <span class="token string">'"<span class="token variable">$http_user_agent</span>" "<span class="token variable">$http_x_forwarded_for</span>" '</span></span>
<span class="line">                    <span class="token string">'rt=<span class="token variable">$request_time</span> uct="<span class="token variable">$upstream_connect_time</span>" '</span></span>
<span class="line">                    <span class="token string">'uht="<span class="token variable">$upstream_header_time</span>" urt="<span class="token variable">$upstream_response_time</span>"'</span></span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token directive"><span class="token keyword">access_log</span> /var/log/nginx/access.log main</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># åŸºç¡€é…ç½®</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">sendfile</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">tcp_nopush</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">tcp_nodelay</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">keepalive_timeout</span> <span class="token number">65</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">types_hash_max_size</span> <span class="token number">2048</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">100M</span></span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># Gzipå‹ç¼©</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">gzip</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">gzip_vary</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">gzip_min_length</span> <span class="token number">1024</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">gzip_types</span> text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># ä¸Šæ¸¸æœåŠ¡å™¨</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">upstream</span> iam_backend</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">least_conn</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">server</span> iam:8080 max_fails=3 fail_timeout=30s</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">keepalive</span> <span class="token number">32</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token directive"><span class="token keyword">upstream</span> iam_grpc</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">server</span> iam:50051</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># HTTPæœåŠ¡å™¨</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">server_name</span> _</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># å¥åº·æ£€æŸ¥</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">location</span> /health</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">access_log</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_pass</span> http://iam_backend/health</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Proto <span class="token variable">$scheme</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># APIä»£ç†</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">location</span> /api/</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_pass</span> http://iam_backend</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Proto <span class="token variable">$scheme</span></span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># è¶…æ—¶é…ç½®</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_connect_timeout</span> <span class="token number">5s</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_send_timeout</span> <span class="token number">60s</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_read_timeout</span> <span class="token number">60s</span></span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># ç¼“å†²é…ç½®</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_buffering</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_buffer_size</span> <span class="token number">4k</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_buffers</span> <span class="token number">8</span> <span class="token number">4k</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># Webç•Œé¢</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_pass</span> http://iam_backend</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Proto <span class="token variable">$scheme</span></span><span class="token punctuation">;</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># WebSocketæ”¯æŒ</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_http_version</span> 1.1</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_set_header</span> Connection <span class="token string">"upgrade"</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># é™æ€æ–‡ä»¶ç¼“å­˜</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">location</span> ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_pass</span> http://iam_backend</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">expires</span> <span class="token number">1y</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">add_header</span> Cache-Control <span class="token string">"public, immutable"</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># gRPCæœåŠ¡å™¨ï¼ˆå¦‚æœéœ€è¦ç›´æ¥æš´éœ²gRPCï¼‰</span></span>
<span class="line">    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">50051</span> http2</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">grpc_pass</span> grpc://iam_grpc</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">grpc_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">grpc_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token directive"><span class="token keyword">grpc_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="åˆ›å»ºprometheusé…ç½®" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºprometheusé…ç½®">#</a> åˆ›å»ºPrometheusé…ç½®</h4>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># prometheus/prometheus.yml</span></span>
<span class="line"><span class="token key atrule">global</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 15s</span>
<span class="line">  <span class="token key atrule">evaluation_interval</span><span class="token punctuation">:</span> 15s</span>
<span class="line">  <span class="token key atrule">external_labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">cluster</span><span class="token punctuation">:</span> <span class="token string">'vgo-cluster'</span></span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">'development'</span></span>
<span class="line"></span>
<span class="line"><span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token comment"># VGO IAMæœåŠ¡</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'vgo-iam'</span></span>
<span class="line">    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'iam:8082'</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">metrics_path</span><span class="token punctuation">:</span> /metrics</span>
<span class="line">    <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 10s</span>
<span class="line">    <span class="token key atrule">scrape_timeout</span><span class="token punctuation">:</span> 5s</span>
<span class="line">    </span>
<span class="line">  <span class="token comment"># PostgreSQL</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'postgres'</span></span>
<span class="line">    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'postgres-exporter:9187'</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 15s</span>
<span class="line">    </span>
<span class="line">  <span class="token comment"># Redis</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'redis'</span></span>
<span class="line">    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'redis-exporter:9121'</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 15s</span>
<span class="line">    </span>
<span class="line">  <span class="token comment"># Prometheusè‡ªèº«</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'prometheus'</span></span>
<span class="line">    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'localhost:9090'</span><span class="token punctuation">]</span></span>
<span class="line">    </span>
<span class="line">  <span class="token comment"># Nginxï¼ˆå¦‚æœé…ç½®äº†nginx-prometheus-exporterï¼‰</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'nginx'</span></span>
<span class="line">    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'nginx-exporter:9113'</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 15s</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å‘Šè­¦è§„åˆ™</span></span>
<span class="line"><span class="token key atrule">rule_files</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token string">"alert_rules.yml"</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å‘Šè­¦ç®¡ç†å™¨é…ç½®ï¼ˆå¯é€‰ï¼‰</span></span>
<span class="line"><span class="token comment"># alerting:</span></span>
<span class="line"><span class="token comment">#   alertmanagers:</span></span>
<span class="line"><span class="token comment">#     - static_configs:</span></span>
<span class="line"><span class="token comment">#         - targets:</span></span>
<span class="line"><span class="token comment">#           - alertmanager:9093</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-å¯åŠ¨æœåŠ¡" tabindex="-1"><a class="header-anchor" href="#_4-å¯åŠ¨æœåŠ¡">#</a> 4. å¯åŠ¨æœåŠ¡</h3>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># åˆ›å»ºå¿…è¦çš„ç›®å½•</span></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token punctuation">{</span>configs,logs,nginx/conf.d,prometheus,grafana/<span class="token punctuation">{</span>provisioning,dashboards<span class="token punctuation">}</span>,certs,init-scripts<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># è®¾ç½®æƒé™</span></span>
<span class="line"><span class="token function">chmod</span> +x scripts/*.sh</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å¯åŠ¨æ‰€æœ‰æœåŠ¡</span></span>
<span class="line"><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹æœåŠ¡çŠ¶æ€</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token function">ps</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹æ—¥å¿—</span></span>
<span class="line"><span class="token function">docker-compose</span> logs <span class="token parameter variable">-f</span> iam</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-éªŒè¯éƒ¨ç½²" tabindex="-1"><a class="header-anchor" href="#_5-éªŒè¯éƒ¨ç½²">#</a> 5. éªŒè¯éƒ¨ç½²</h3>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€</span></span>
<span class="line"><span class="token function">curl</span> http://localhost/health</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æµ‹è¯•gRPC API</span></span>
<span class="line">grpcurl <span class="token parameter variable">-plaintext</span> localhost:50051 list</span>
<span class="line"></span>
<span class="line"><span class="token comment"># è®¿é—®Webç•Œé¢</span></span>
<span class="line"><span class="token function">open</span> http://localhost</span>
<span class="line"></span>
<span class="line"><span class="token comment"># è®¿é—®ç›‘æ§ç•Œé¢</span></span>
<span class="line"><span class="token function">open</span> http://localhost:3000  <span class="token comment"># Grafana</span></span>
<span class="line"><span class="token function">open</span> http://localhost:9090  <span class="token comment"># Prometheus</span></span>
<span class="line"><span class="token function">open</span> http://localhost:16686 <span class="token comment"># Jaeger</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”§-é…ç½®è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#ğŸ”§-é…ç½®è¯¦è§£">#</a> ğŸ”§ é…ç½®è¯¦è§£</h2>
<h3 id="ç¯å¢ƒå˜é‡é…ç½®" tabindex="-1"><a class="header-anchor" href="#ç¯å¢ƒå˜é‡é…ç½®">#</a> ç¯å¢ƒå˜é‡é…ç½®</h3>
<h4 id="æ•°æ®åº“é…ç½®" tabindex="-1"><a class="header-anchor" href="#æ•°æ®åº“é…ç½®">#</a> æ•°æ®åº“é…ç½®</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># åŸºç¡€è¿æ¥é…ç½®</span></span>
<span class="line"><span class="token assign-left variable">DB_HOST</span><span class="token operator">=</span>postgres</span>
<span class="line"><span class="token assign-left variable">DB_PORT</span><span class="token operator">=</span><span class="token number">5432</span></span>
<span class="line"><span class="token assign-left variable">DB_NAME</span><span class="token operator">=</span>vgo_db</span>
<span class="line"><span class="token assign-left variable">DB_USER</span><span class="token operator">=</span>vgo_user</span>
<span class="line"><span class="token assign-left variable">DB_PASSWORD</span><span class="token operator">=</span>your-password</span>
<span class="line"><span class="token assign-left variable">DB_SSLMODE</span><span class="token operator">=</span>disable</span>
<span class="line"></span>
<span class="line"><span class="token comment"># è¿æ¥æ± é…ç½®</span></span>
<span class="line"><span class="token assign-left variable">DB_MAX_OPEN_CONNS</span><span class="token operator">=</span><span class="token number">25</span>        <span class="token comment"># æœ€å¤§æ‰“å¼€è¿æ¥æ•°</span></span>
<span class="line"><span class="token assign-left variable">DB_MAX_IDLE_CONNS</span><span class="token operator">=</span><span class="token number">5</span>         <span class="token comment"># æœ€å¤§ç©ºé—²è¿æ¥æ•°</span></span>
<span class="line"><span class="token assign-left variable">DB_CONN_MAX_LIFETIME</span><span class="token operator">=</span>300s   <span class="token comment"># è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥è¯¢é…ç½®</span></span>
<span class="line"><span class="token assign-left variable">DB_QUERY_TIMEOUT</span><span class="token operator">=</span>30s        <span class="token comment"># æŸ¥è¯¢è¶…æ—¶æ—¶é—´</span></span>
<span class="line"><span class="token assign-left variable">DB_EXEC_TIMEOUT</span><span class="token operator">=</span>30s         <span class="token comment"># æ‰§è¡Œè¶…æ—¶æ—¶é—´</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="redisé…ç½®" tabindex="-1"><a class="header-anchor" href="#redisé…ç½®">#</a> Redisé…ç½®</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># åŸºç¡€è¿æ¥é…ç½®</span></span>
<span class="line"><span class="token assign-left variable">REDIS_HOST</span><span class="token operator">=</span>redis</span>
<span class="line"><span class="token assign-left variable">REDIS_PORT</span><span class="token operator">=</span><span class="token number">6379</span></span>
<span class="line"><span class="token assign-left variable">REDIS_PASSWORD</span><span class="token operator">=</span>your-password</span>
<span class="line"><span class="token assign-left variable">REDIS_DB</span><span class="token operator">=</span><span class="token number">0</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># è¿æ¥æ± é…ç½®</span></span>
<span class="line"><span class="token assign-left variable">REDIS_POOL_SIZE</span><span class="token operator">=</span><span class="token number">10</span>          <span class="token comment"># è¿æ¥æ± å¤§å°</span></span>
<span class="line"><span class="token assign-left variable">REDIS_MIN_IDLE_CONNS</span><span class="token operator">=</span><span class="token number">5</span>      <span class="token comment"># æœ€å°ç©ºé—²è¿æ¥æ•°</span></span>
<span class="line"><span class="token assign-left variable">REDIS_POOL_TIMEOUT</span><span class="token operator">=</span>5s       <span class="token comment"># è¿æ¥æ± è¶…æ—¶</span></span>
<span class="line"><span class="token assign-left variable">REDIS_IDLE_TIMEOUT</span><span class="token operator">=</span>300s     <span class="token comment"># ç©ºé—²è¿æ¥è¶…æ—¶</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç¼“å­˜é…ç½®</span></span>
<span class="line"><span class="token assign-left variable">REDIS_DEFAULT_TTL</span><span class="token operator">=</span>3600s     <span class="token comment"># é»˜è®¤TTL</span></span>
<span class="line"><span class="token assign-left variable">REDIS_MAX_RETRIES</span><span class="token operator">=</span><span class="token number">3</span>         <span class="token comment"># æœ€å¤§é‡è¯•æ¬¡æ•°</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æœåŠ¡é…ç½®" tabindex="-1"><a class="header-anchor" href="#æœåŠ¡é…ç½®">#</a> æœåŠ¡é…ç½®</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># ç«¯å£é…ç½®</span></span>
<span class="line"><span class="token assign-left variable">GRPC_PORT</span><span class="token operator">=</span><span class="token number">50051</span></span>
<span class="line"><span class="token assign-left variable">HTTP_PORT</span><span class="token operator">=</span><span class="token number">8080</span></span>
<span class="line"><span class="token assign-left variable">HEALTH_PORT</span><span class="token operator">=</span><span class="token number">8081</span></span>
<span class="line"><span class="token assign-left variable">METRICS_PORT</span><span class="token operator">=</span><span class="token number">8082</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ€§èƒ½é…ç½®</span></span>
<span class="line"><span class="token assign-left variable">GOMEMLIMIT</span><span class="token operator">=</span>1GiB            <span class="token comment"># Goå†…å­˜é™åˆ¶</span></span>
<span class="line"><span class="token assign-left variable">GOMAXPROCS</span><span class="token operator">=</span><span class="token number">4</span>               <span class="token comment"># Goæœ€å¤§è¿›ç¨‹æ•°</span></span>
<span class="line"><span class="token assign-left variable">GOGC</span><span class="token operator">=</span><span class="token number">100</span>                   <span class="token comment"># GCç›®æ ‡ç™¾åˆ†æ¯”</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># è¶…æ—¶é…ç½®</span></span>
<span class="line"><span class="token assign-left variable">SERVER_READ_TIMEOUT</span><span class="token operator">=</span>30s    <span class="token comment"># è¯»å–è¶…æ—¶</span></span>
<span class="line"><span class="token assign-left variable">SERVER_WRITE_TIMEOUT</span><span class="token operator">=</span>30s   <span class="token comment"># å†™å…¥è¶…æ—¶</span></span>
<span class="line"><span class="token assign-left variable">SERVER_IDLE_TIMEOUT</span><span class="token operator">=</span>120s   <span class="token comment"># ç©ºé—²è¶…æ—¶</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ•°æ®åˆå§‹åŒ–" tabindex="-1"><a class="header-anchor" href="#æ•°æ®åˆå§‹åŒ–">#</a> æ•°æ®åˆå§‹åŒ–</h3>
<h4 id="åˆ›å»ºåˆå§‹åŒ–è„šæœ¬" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºåˆå§‹åŒ–è„šæœ¬">#</a> åˆ›å»ºåˆå§‹åŒ–è„šæœ¬</h4>
<div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre v-pre><code class="language-sql"><span class="line"><span class="token comment">-- init-scripts/01-init-database.sql</span></span>
<span class="line"><span class="token comment">-- åˆ›å»ºæ‰©å±•</span></span>
<span class="line"><span class="token keyword">CREATE</span> EXTENSION <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token string">"uuid-ossp"</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> EXTENSION <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token string">"pgcrypto"</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- åˆ›å»ºç”¨æˆ·è¡¨</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> users <span class="token punctuation">(</span></span>
<span class="line">    id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> uuid_generate_v4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    username <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    password_hash <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">status</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'active'</span><span class="token punctuation">,</span></span>
<span class="line">    created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- åˆ›å»ºç­–ç•¥è¡¨</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> policies <span class="token punctuation">(</span></span>
<span class="line">    id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> uuid_generate_v4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    description <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">    document JSONB <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    version <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'2025-01-01'</span><span class="token punctuation">,</span></span>
<span class="line">    created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- åˆ›å»ºç”¨æˆ·ç­–ç•¥å…³è”è¡¨</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> user_policies <span class="token punctuation">(</span></span>
<span class="line">    id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> uuid_generate_v4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    user_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span><span class="token punctuation">,</span></span>
<span class="line">    policy_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> policies<span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span><span class="token punctuation">,</span></span>
<span class="line">    created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">UNIQUE</span><span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> policy_id<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- åˆ›å»ºè®¿é—®å¯†é’¥è¡¨</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> access_keys <span class="token punctuation">(</span></span>
<span class="line">    id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> uuid_generate_v4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    user_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span><span class="token punctuation">,</span></span>
<span class="line">    access_key_id <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    secret_access_key_hash <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    description <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">status</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'active'</span><span class="token punctuation">,</span></span>
<span class="line">    last_used_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE<span class="token punctuation">,</span></span>
<span class="line">    created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- åˆ›å»ºåº”ç”¨è¡¨</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> applications <span class="token punctuation">(</span></span>
<span class="line">    id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">DEFAULT</span> uuid_generate_v4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    description <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">    client_id <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    client_secret_hash <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">type</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'web'</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">status</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'active'</span><span class="token punctuation">,</span></span>
<span class="line">    created_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    updated_at <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token keyword">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- åˆ›å»ºç´¢å¼•</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> idx_users_username <span class="token keyword">ON</span> users<span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> idx_users_email <span class="token keyword">ON</span> users<span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> idx_users_status <span class="token keyword">ON</span> users<span class="token punctuation">(</span><span class="token keyword">status</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> idx_policies_name <span class="token keyword">ON</span> policies<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> idx_user_policies_user_id <span class="token keyword">ON</span> user_policies<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> idx_user_policies_policy_id <span class="token keyword">ON</span> user_policies<span class="token punctuation">(</span>policy_id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> idx_access_keys_user_id <span class="token keyword">ON</span> access_keys<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> idx_access_keys_access_key_id <span class="token keyword">ON</span> access_keys<span class="token punctuation">(</span>access_key_id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> idx_applications_client_id <span class="token keyword">ON</span> applications<span class="token punctuation">(</span>client_id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre v-pre><code class="language-sql"><span class="line"><span class="token comment">-- init-scripts/02-seed-data.sql</span></span>
<span class="line"><span class="token comment">-- æ’å…¥ç®¡ç†å‘˜ç”¨æˆ·</span></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span> email<span class="token punctuation">,</span> password_hash<span class="token punctuation">,</span> <span class="token keyword">status</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> </span>
<span class="line"><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'admin@example.com'</span><span class="token punctuation">,</span> crypt<span class="token punctuation">(</span><span class="token string">'admin123'</span><span class="token punctuation">,</span> gen_salt<span class="token punctuation">(</span><span class="token string">'bf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'active'</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">ON</span> CONFLICT <span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token keyword">DO</span> NOTHING<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- æ’å…¥ç®¡ç†å‘˜ç­–ç•¥</span></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> policies <span class="token punctuation">(</span>name<span class="token punctuation">,</span> description<span class="token punctuation">,</span> document<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> </span>
<span class="line"><span class="token punctuation">(</span><span class="token string">'AdminPolicy'</span><span class="token punctuation">,</span> <span class="token string">'ç®¡ç†å‘˜å®Œå…¨æƒé™ç­–ç•¥'</span><span class="token punctuation">,</span> <span class="token string">'{</span>
<span class="line">  "Version": "2025-01-01",</span>
<span class="line">  "Statement": [</span>
<span class="line">    {</span>
<span class="line">      "Effect": "Allow",</span>
<span class="line">      "Action": "*",</span>
<span class="line">      "Resource": "*"</span>
<span class="line">    }</span>
<span class="line">  ]</span>
<span class="line">}'</span>::jsonb<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">ON</span> CONFLICT <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">DO</span> NOTHING<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- ç»‘å®šç®¡ç†å‘˜ç­–ç•¥</span></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> user_policies <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> policy_id<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">SELECT</span> u<span class="token punctuation">.</span>id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>id</span>
<span class="line"><span class="token keyword">FROM</span> users u<span class="token punctuation">,</span> policies p</span>
<span class="line"><span class="token keyword">WHERE</span> u<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token string">'admin'</span> <span class="token operator">AND</span> p<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'AdminPolicy'</span></span>
<span class="line"><span class="token keyword">ON</span> CONFLICT <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> policy_id<span class="token punctuation">)</span> <span class="token keyword">DO</span> NOTHING<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- æ’å…¥åªè¯»ç­–ç•¥</span></span>
<span class="line"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> policies <span class="token punctuation">(</span>name<span class="token punctuation">,</span> description<span class="token punctuation">,</span> document<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> </span>
<span class="line"><span class="token punctuation">(</span><span class="token string">'ReadOnlyPolicy'</span><span class="token punctuation">,</span> <span class="token string">'åªè¯»æƒé™ç­–ç•¥'</span><span class="token punctuation">,</span> <span class="token string">'{</span>
<span class="line">  "Version": "2025-01-01",</span>
<span class="line">  "Statement": [</span>
<span class="line">    {</span>
<span class="line">      "Effect": "Allow",</span>
<span class="line">      "Action": [</span>
<span class="line">        "iam:GetUser",</span>
<span class="line">        "iam:ListUsers",</span>
<span class="line">        "iam:GetPolicy",</span>
<span class="line">        "iam:ListPolicies",</span>
<span class="line">        "iam:ListUserPolicies",</span>
<span class="line">        "iam:CheckPermission"</span>
<span class="line">      ],</span>
<span class="line">      "Resource": "*"</span>
<span class="line">    }</span>
<span class="line">  ]</span>
<span class="line">}'</span>::jsonb<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">ON</span> CONFLICT <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">DO</span> NOTHING<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å¤‡ä»½å’Œæ¢å¤" tabindex="-1"><a class="header-anchor" href="#å¤‡ä»½å’Œæ¢å¤">#</a> å¤‡ä»½å’Œæ¢å¤</h3>
<h4 id="è‡ªåŠ¨å¤‡ä»½è„šæœ¬" tabindex="-1"><a class="header-anchor" href="#è‡ªåŠ¨å¤‡ä»½è„šæœ¬">#</a> è‡ªåŠ¨å¤‡ä»½è„šæœ¬</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># scripts/backup.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">set</span> <span class="token parameter variable">-e</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># é…ç½®</span></span>
<span class="line"><span class="token assign-left variable">BACKUP_DIR</span><span class="token operator">=</span><span class="token string">"./backups"</span></span>
<span class="line"><span class="token assign-left variable">DATE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d_%H%M%S<span class="token variable">)</span></span></span>
<span class="line"><span class="token assign-left variable">RETENTION_DAYS</span><span class="token operator">=</span><span class="token number">7</span></span>
<span class="line"><span class="token assign-left variable">COMPOSE_PROJECT</span><span class="token operator">=</span><span class="token string">"vgo"</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># åˆ›å»ºå¤‡ä»½ç›®å½•</span></span>
<span class="line"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$BACKUP_DIR</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"å¼€å§‹å¤‡ä»½ - <span class="token variable">$DATE</span>"</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å¤‡ä»½æ•°æ®åº“</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"å¤‡ä»½PostgreSQLæ•°æ®åº“..."</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-T</span> postgres pg_dump <span class="token parameter variable">-U</span> vgo_user vgo_db <span class="token operator">|</span> <span class="token function">gzip</span> <span class="token operator">></span> <span class="token variable">$BACKUP_DIR</span>/postgres_<span class="token variable">$DATE</span>.sql.gz</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å¤‡ä»½Redis</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"å¤‡ä»½Redisæ•°æ®..."</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> redis redis-cli BGSAVE</span>
<span class="line"><span class="token function">sleep</span> <span class="token number">5</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> redis <span class="token function">cat</span> /data/dump.rdb <span class="token operator">|</span> <span class="token function">gzip</span> <span class="token operator">></span> <span class="token variable">$BACKUP_DIR</span>/redis_<span class="token variable">$DATE</span>.rdb.gz</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å¤‡ä»½é…ç½®æ–‡ä»¶</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"å¤‡ä»½é…ç½®æ–‡ä»¶..."</span></span>
<span class="line"><span class="token function">tar</span> <span class="token parameter variable">-czf</span> <span class="token variable">$BACKUP_DIR</span>/configs_<span class="token variable">$DATE</span>.tar.gz configs/ .env docker-compose.yml nginx/ prometheus/ grafana/</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å¤‡ä»½æ—¥å¿—ï¼ˆæœ€è¿‘7å¤©ï¼‰</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"å¤‡ä»½æ—¥å¿—æ–‡ä»¶..."</span></span>
<span class="line"><span class="token function">find</span> logs/ <span class="token parameter variable">-name</span> <span class="token string">"*.log"</span> <span class="token parameter variable">-mtime</span> <span class="token parameter variable">-7</span> <span class="token operator">|</span> <span class="token function">tar</span> <span class="token parameter variable">-czf</span> <span class="token variable">$BACKUP_DIR</span>/logs_<span class="token variable">$DATE</span>.tar.gz <span class="token parameter variable">-T</span> -</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ¸…ç†æ—§å¤‡ä»½</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"æ¸…ç†æ—§å¤‡ä»½..."</span></span>
<span class="line"><span class="token function">find</span> <span class="token variable">$BACKUP_DIR</span> <span class="token parameter variable">-name</span> <span class="token string">"*.gz"</span> <span class="token parameter variable">-mtime</span> +<span class="token variable">$RETENTION_DAYS</span> <span class="token parameter variable">-delete</span></span>
<span class="line"><span class="token function">find</span> <span class="token variable">$BACKUP_DIR</span> <span class="token parameter variable">-name</span> <span class="token string">"*.tar.gz"</span> <span class="token parameter variable">-mtime</span> +<span class="token variable">$RETENTION_DAYS</span> <span class="token parameter variable">-delete</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"å¤‡ä»½å®Œæˆ - <span class="token variable">$DATE</span>"</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"å¤‡ä»½æ–‡ä»¶:"</span></span>
<span class="line"><span class="token function">ls</span> <span class="token parameter variable">-la</span> <span class="token variable">$BACKUP_DIR</span>/*<span class="token variable">$DATE</span>*</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ¢å¤è„šæœ¬" tabindex="-1"><a class="header-anchor" href="#æ¢å¤è„šæœ¬">#</a> æ¢å¤è„šæœ¬</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token shebang important">#!/bin/bash</span></span>
<span class="line"><span class="token comment"># scripts/restore.sh</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">set</span> <span class="token parameter variable">-e</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$#</span> <span class="token parameter variable">-ne</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"ç”¨æ³•: <span class="token variable">$0</span> &lt;å¤‡ä»½æ—¥æœŸ>"</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"ç¤ºä¾‹: <span class="token variable">$0</span> 20240115_103000"</span></span>
<span class="line">    <span class="token builtin class-name">exit</span> <span class="token number">1</span></span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">BACKUP_DATE</span><span class="token operator">=</span><span class="token variable">$1</span></span>
<span class="line"><span class="token assign-left variable">BACKUP_DIR</span><span class="token operator">=</span><span class="token string">"./backups"</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"å¼€å§‹æ¢å¤ - <span class="token variable">$BACKUP_DATE</span>"</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥å¤‡ä»½æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> <span class="token parameter variable">-f</span> <span class="token string">"<span class="token variable">$BACKUP_DIR</span>/postgres_<span class="token variable">$BACKUP_DATE</span>.sql.gz"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"é”™è¯¯: æ‰¾ä¸åˆ°æ•°æ®åº“å¤‡ä»½æ–‡ä»¶"</span></span>
<span class="line">    <span class="token builtin class-name">exit</span> <span class="token number">1</span></span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># åœæ­¢æœåŠ¡</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"åœæ­¢æœåŠ¡..."</span></span>
<span class="line"><span class="token function">docker-compose</span> stop iam</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ¢å¤æ•°æ®åº“</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"æ¢å¤PostgreSQLæ•°æ®åº“..."</span></span>
<span class="line">zcat <span class="token variable">$BACKUP_DIR</span>/postgres_<span class="token variable">$BACKUP_DATE</span>.sql.gz <span class="token operator">|</span> <span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-T</span> postgres psql <span class="token parameter variable">-U</span> vgo_user <span class="token parameter variable">-d</span> vgo_db</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ¢å¤Redis</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">"<span class="token variable">$BACKUP_DIR</span>/redis_<span class="token variable">$BACKUP_DATE</span>.rdb.gz"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"æ¢å¤Redisæ•°æ®..."</span></span>
<span class="line">    <span class="token function">docker-compose</span> stop redis</span>
<span class="line">    zcat <span class="token variable">$BACKUP_DIR</span>/redis_<span class="token variable">$BACKUP_DATE</span>.rdb.gz <span class="token operator">|</span> <span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-T</span> redis <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">'cat > /data/dump.rdb'</span></span>
<span class="line">    <span class="token function">docker-compose</span> start redis</span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ¢å¤é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-f</span> <span class="token string">"<span class="token variable">$BACKUP_DIR</span>/configs_<span class="token variable">$BACKUP_DATE</span>.tar.gz"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"æ˜¯å¦æ¢å¤é…ç½®æ–‡ä»¶? (y/N)"</span></span>
<span class="line">    <span class="token builtin class-name">read</span> <span class="token parameter variable">-r</span> response</span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$response</span>"</span> <span class="token operator">=~</span> ^<span class="token punctuation">[</span>Yy<span class="token punctuation">]</span>$ <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">        <span class="token builtin class-name">echo</span> <span class="token string">"æ¢å¤é…ç½®æ–‡ä»¶..."</span></span>
<span class="line">        <span class="token function">tar</span> <span class="token parameter variable">-xzf</span> <span class="token variable">$BACKUP_DIR</span>/configs_<span class="token variable">$BACKUP_DATE</span>.tar.gz</span>
<span class="line">    <span class="token keyword">fi</span></span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># å¯åŠ¨æœåŠ¡</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"å¯åŠ¨æœåŠ¡..."</span></span>
<span class="line"><span class="token function">docker-compose</span> start iam</span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç­‰å¾…æœåŠ¡å¯åŠ¨</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"ç­‰å¾…æœåŠ¡å¯åŠ¨..."</span></span>
<span class="line"><span class="token function">sleep</span> <span class="token number">10</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># éªŒè¯æ¢å¤</span></span>
<span class="line"><span class="token builtin class-name">echo</span> <span class="token string">"éªŒè¯æ¢å¤..."</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token function">curl</span> <span class="token parameter variable">-f</span> http://localhost/health <span class="token operator">></span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span><span class="token punctuation">;</span> <span class="token keyword">then</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"æ¢å¤æˆåŠŸ!"</span></span>
<span class="line"><span class="token keyword">else</span></span>
<span class="line">    <span class="token builtin class-name">echo</span> <span class="token string">"æ¢å¤å¯èƒ½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€"</span></span>
<span class="line">    <span class="token function">docker-compose</span> logs iam</span>
<span class="line"><span class="token keyword">fi</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”-æ•…éšœæ’é™¤" tabindex="-1"><a class="header-anchor" href="#ğŸ”-æ•…éšœæ’é™¤">#</a> ğŸ” æ•…éšœæ’é™¤</h2>
<h3 id="å¸¸è§é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#å¸¸è§é—®é¢˜">#</a> å¸¸è§é—®é¢˜</h3>
<h4 id="_1-å®¹å™¨å¯åŠ¨å¤±è´¥" tabindex="-1"><a class="header-anchor" href="#_1-å®¹å™¨å¯åŠ¨å¤±è´¥">#</a> 1. å®¹å™¨å¯åŠ¨å¤±è´¥</h4>
<p><strong>é—®é¢˜</strong>: å®¹å™¨æ— æ³•å¯åŠ¨æˆ–ç«‹å³é€€å‡º</p>
<p><strong>æ’æŸ¥æ­¥éª¤</strong>:</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># æŸ¥çœ‹å®¹å™¨çŠ¶æ€</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token function">ps</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹å®¹å™¨æ—¥å¿—</span></span>
<span class="line"><span class="token function">docker-compose</span> logs iam</span>
<span class="line"><span class="token function">docker-compose</span> logs postgres</span>
<span class="line"><span class="token function">docker-compose</span> logs redis</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥èµ„æºä½¿ç”¨</span></span>
<span class="line"><span class="token function">docker</span> stats</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥ç«¯å£å ç”¨</span></span>
<span class="line"><span class="token function">netstat</span> <span class="token parameter variable">-tlnp</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">':(50051|8080|5432|6379)'</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å¸¸è§è§£å†³æ–¹æ¡ˆ</strong>:</p>
<ul>
<li>æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨</li>
<li>ç¡®è®¤é…ç½®æ–‡ä»¶è¯­æ³•æ­£ç¡®</li>
<li>æ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³</li>
<li>éªŒè¯ç¯å¢ƒå˜é‡è®¾ç½®</li>
</ul>
<h4 id="_2-æ•°æ®åº“è¿æ¥å¤±è´¥" tabindex="-1"><a class="header-anchor" href="#_2-æ•°æ®åº“è¿æ¥å¤±è´¥">#</a> 2. æ•°æ®åº“è¿æ¥å¤±è´¥</h4>
<p><strong>é—®é¢˜</strong>: IAMæœåŠ¡æ— æ³•è¿æ¥åˆ°PostgreSQL</p>
<p><strong>æ’æŸ¥æ­¥éª¤</strong>:</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># æ£€æŸ¥PostgreSQLçŠ¶æ€</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> postgres pg_isready <span class="token parameter variable">-U</span> vgo_user</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æµ‹è¯•æ•°æ®åº“è¿æ¥</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> postgres psql <span class="token parameter variable">-U</span> vgo_user <span class="token parameter variable">-d</span> vgo_db <span class="token parameter variable">-c</span> <span class="token string">"SELECT 1;"</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥ç½‘ç»œè¿é€šæ€§</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> iam <span class="token function">ping</span> postgres</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—</span></span>
<span class="line"><span class="token function">docker-compose</span> logs postgres</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>è§£å†³æ–¹æ¡ˆ</strong>:</p>
<ul>
<li>ç¡®è®¤æ•°æ®åº“ç”¨æˆ·åå¯†ç æ­£ç¡®</li>
<li>æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²å®Œå…¨å¯åŠ¨</li>
<li>éªŒè¯ç½‘ç»œé…ç½®</li>
<li>æ£€æŸ¥é˜²ç«å¢™è®¾ç½®</li>
</ul>
<h4 id="_3-redisè¿æ¥é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#_3-redisè¿æ¥é—®é¢˜">#</a> 3. Redisè¿æ¥é—®é¢˜</h4>
<p><strong>é—®é¢˜</strong>: æ— æ³•è¿æ¥åˆ°Redisç¼“å­˜</p>
<p><strong>æ’æŸ¥æ­¥éª¤</strong>:</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># æ£€æŸ¥RedisçŠ¶æ€</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> redis redis-cli <span class="token function">ping</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æµ‹è¯•è®¤è¯</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> redis redis-cli <span class="token parameter variable">-a</span> your-password <span class="token function">ping</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥Redisé…ç½®</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> redis redis-cli CONFIG GET <span class="token string">'*'</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹Redisæ—¥å¿—</span></span>
<span class="line"><span class="token function">docker-compose</span> logs redis</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-æ€§èƒ½é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#_4-æ€§èƒ½é—®é¢˜">#</a> 4. æ€§èƒ½é—®é¢˜</h4>
<p><strong>é—®é¢˜</strong>: æœåŠ¡å“åº”ç¼“æ…¢</p>
<p><strong>æ’æŸ¥æ­¥éª¤</strong>:</p>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># æ£€æŸ¥èµ„æºä½¿ç”¨</span></span>
<span class="line"><span class="token function">docker</span> stats</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹æ•°æ®åº“æ€§èƒ½</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> postgres psql <span class="token parameter variable">-U</span> vgo_user <span class="token parameter variable">-d</span> vgo_db <span class="token parameter variable">-c</span> <span class="token string">"</span>
<span class="line">  SELECT query, mean_time, calls </span>
<span class="line">  FROM pg_stat_statements </span>
<span class="line">  ORDER BY mean_time DESC </span>
<span class="line">  LIMIT 10;"</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥Redisæ€§èƒ½</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> redis redis-cli --latency-history</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹åº”ç”¨æŒ‡æ ‡</span></span>
<span class="line"><span class="token function">curl</span> http://localhost:8082/metrics</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ç›‘æ§å’Œè°ƒè¯•" tabindex="-1"><a class="header-anchor" href="#ç›‘æ§å’Œè°ƒè¯•">#</a> ç›‘æ§å’Œè°ƒè¯•</h3>
<h4 id="å¯ç”¨è°ƒè¯•æ—¥å¿—" tabindex="-1"><a class="header-anchor" href="#å¯ç”¨è°ƒè¯•æ—¥å¿—">#</a> å¯ç”¨è°ƒè¯•æ—¥å¿—</h4>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># docker-compose.yml</span></span>
<span class="line"><span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">iam</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">environment</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> LOG_LEVEL=debug</span>
<span class="line">      <span class="token punctuation">-</span> DB_LOG_LEVEL=debug</span>
<span class="line">      <span class="token punctuation">-</span> GRPC_LOG_LEVEL=debug</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ€§èƒ½åˆ†æ" tabindex="-1"><a class="header-anchor" href="#æ€§èƒ½åˆ†æ">#</a> æ€§èƒ½åˆ†æ</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># å¯ç”¨Goæ€§èƒ½åˆ†æ</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> iam <span class="token function">curl</span> http://localhost:8082/debug/pprof/profile?seconds<span class="token operator">=</span><span class="token number">30</span> <span class="token operator">></span> cpu.prof</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å†…å­˜åˆ†æ</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> iam <span class="token function">curl</span> http://localhost:8082/debug/pprof/heap <span class="token operator">></span> heap.prof</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹goroutine</span></span>
<span class="line"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> iam <span class="token function">curl</span> http://localhost:8082/debug/pprof/goroutine?debug<span class="token operator">=</span><span class="token number">1</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“ˆ-ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#ğŸ“ˆ-ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–">#</a> ğŸ“ˆ ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–</h2>
<h3 id="èµ„æºé™åˆ¶" tabindex="-1"><a class="header-anchor" href="#èµ„æºé™åˆ¶">#</a> èµ„æºé™åˆ¶</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># docker-compose.yml</span></span>
<span class="line"><span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">iam</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">deploy</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">resources</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">limits</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">cpus</span><span class="token punctuation">:</span> <span class="token string">'2.0'</span></span>
<span class="line">          <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1G</span>
<span class="line">        <span class="token key atrule">reservations</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">cpus</span><span class="token punctuation">:</span> <span class="token string">'0.5'</span></span>
<span class="line">          <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512M</span>
<span class="line">    </span>
<span class="line">  <span class="token key atrule">postgres</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">deploy</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">resources</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">limits</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">cpus</span><span class="token punctuation">:</span> <span class="token string">'1.0'</span></span>
<span class="line">          <span class="token key atrule">memory</span><span class="token punctuation">:</span> 2G</span>
<span class="line">        <span class="token key atrule">reservations</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">cpus</span><span class="token punctuation">:</span> <span class="token string">'0.5'</span></span>
<span class="line">          <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1G</span>
<span class="line">    </span>
<span class="line">  <span class="token key atrule">redis</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">deploy</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">resources</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">limits</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">cpus</span><span class="token punctuation">:</span> <span class="token string">'0.5'</span></span>
<span class="line">          <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512M</span>
<span class="line">        <span class="token key atrule">reservations</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">cpus</span><span class="token punctuation">:</span> <span class="token string">'0.1'</span></span>
<span class="line">          <span class="token key atrule">memory</span><span class="token punctuation">:</span> 128M</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å®‰å…¨åŠ å›º" tabindex="-1"><a class="header-anchor" href="#å®‰å…¨åŠ å›º">#</a> å®‰å…¨åŠ å›º</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># docker-compose.yml</span></span>
<span class="line"><span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">iam</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">security_opt</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> no<span class="token punctuation">-</span>new<span class="token punctuation">-</span>privileges<span class="token punctuation">:</span><span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">read_only</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">tmpfs</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> /tmp</span>
<span class="line">      <span class="token punctuation">-</span> /var/tmp</span>
<span class="line">    <span class="token key atrule">user</span><span class="token punctuation">:</span> <span class="token string">"1000:1000"</span></span>
<span class="line">    <span class="token key atrule">cap_drop</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> ALL</span>
<span class="line">    <span class="token key atrule">cap_add</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> NET_BIND_SERVICE</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ—¥å¿—ç®¡ç†" tabindex="-1"><a class="header-anchor" href="#æ—¥å¿—ç®¡ç†">#</a> æ—¥å¿—ç®¡ç†</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># docker-compose.yml</span></span>
<span class="line"><span class="token key atrule">services</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">iam</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">logging</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">"json-file"</span></span>
<span class="line">      <span class="token key atrule">options</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">max-size</span><span class="token punctuation">:</span> <span class="token string">"100m"</span></span>
<span class="line">        <span class="token key atrule">max-file</span><span class="token punctuation">:</span> <span class="token string">"5"</span></span>
<span class="line">        <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token string">"service=iam,environment=production"</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“š-ç›¸å…³æ–‡æ¡£" tabindex="-1"><a class="header-anchor" href="#ğŸ“š-ç›¸å…³æ–‡æ¡£">#</a> ğŸ“š ç›¸å…³æ–‡æ¡£</h2>
<ul>
<li><RouteLink to="/deployment/kubernetes.html">Kuberneteséƒ¨ç½²</RouteLink> - ç”Ÿäº§çº§å®¹å™¨ç¼–æ’</li>
<li><RouteLink to="/deployment/monitoring.html">ç›‘æ§é…ç½®</RouteLink> - å®Œæ•´ç›‘æ§è§£å†³æ–¹æ¡ˆ</li>
<li><RouteLink to="/deployment/security.html">å®‰å…¨é…ç½®</RouteLink> - ç”Ÿäº§ç¯å¢ƒå®‰å…¨</li>
<li><RouteLink to="/deployment/troubleshooting.html">æ•…éšœæ’é™¤</RouteLink> - é—®é¢˜è¯Šæ–­æŒ‡å—</li>
<li><RouteLink to="/deployment/performance.html">æ€§èƒ½è°ƒä¼˜</RouteLink> - æ€§èƒ½ä¼˜åŒ–å»ºè®®</li>
</ul>
<hr>
<div class="hint-container tip">
<p class="hint-container-title">æç¤º</p>
<p>Docker Composeé€‚åˆä¸­å°è§„æ¨¡éƒ¨ç½²ï¼Œå¯¹äºå¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨Kubernetesã€‚</p>
</div>
<div class="hint-container warning">
<p class="hint-container-title">æ³¨æ„</p>
<p>ç”Ÿäº§ç¯å¢ƒè¯·åŠ¡å¿…ä¿®æ”¹é»˜è®¤å¯†ç ï¼Œå¯ç”¨TLSåŠ å¯†ï¼Œå¹¶é…ç½®é€‚å½“çš„èµ„æºé™åˆ¶ã€‚</p>
</div>
</div></template>


