<template><div><h1 id="kubernetes-éƒ¨ç½²" tabindex="-1"><a class="header-anchor" href="#kubernetes-éƒ¨ç½²">#</a> Kubernetes éƒ¨ç½²</h1>
<p>Kubernetesæ˜¯VGOå¾®æœåŠ¡åœ¨ç”Ÿäº§ç¯å¢ƒçš„æ¨èéƒ¨ç½²æ–¹å¼ï¼Œæä¾›äº†é«˜å¯ç”¨ã€è‡ªåŠ¨æ‰©ç¼©å®¹ã€æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ç­‰ä¼ä¸šçº§ç‰¹æ€§ã€‚æœ¬æŒ‡å—å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨Kubernetesé›†ç¾¤ä¸­éƒ¨ç½²VGOå¾®æœåŠ¡ã€‚</p>
<h2 id="ğŸ“‹-éƒ¨ç½²æ¶æ„" tabindex="-1"><a class="header-anchor" href="#ğŸ“‹-éƒ¨ç½²æ¶æ„">#</a> ğŸ“‹ éƒ¨ç½²æ¶æ„</h2>
<h3 id="é›†ç¾¤æ¶æ„å›¾" tabindex="-1"><a class="header-anchor" href="#é›†ç¾¤æ¶æ„å›¾">#</a> é›†ç¾¤æ¶æ„å›¾</h3>
<div class="language-mermaid line-numbers-mode" data-highlighter="prismjs" data-ext="mermaid"><pre v-pre><code class="language-mermaid"><span class="line"><span class="token keyword">graph</span> TB</span>
<span class="line">    <span class="token keyword">subgraph</span> <span class="token string">"Kubernetes Cluster"</span></span>
<span class="line">        <span class="token keyword">subgraph</span> <span class="token string">"Ingress Layer"</span></span>
<span class="line">            A<span class="token text string">[Ingress Controller]</span></span>
<span class="line">            B<span class="token text string">[Load Balancer]</span></span>
<span class="line">        <span class="token keyword">end</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">subgraph</span> <span class="token string">"Application Layer"</span></span>
<span class="line">            C<span class="token text string">[IAM Service Pod 1]</span></span>
<span class="line">            D<span class="token text string">[IAM Service Pod 2]</span></span>
<span class="line">            E<span class="token text string">[IAM Service Pod 3]</span></span>
<span class="line">        <span class="token keyword">end</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">subgraph</span> <span class="token string">"Data Layer"</span></span>
<span class="line">            F<span class="token text string">[PostgreSQL Primary]</span></span>
<span class="line">            G<span class="token text string">[PostgreSQL Replica]</span></span>
<span class="line">            H<span class="token text string">[Redis Cluster]</span></span>
<span class="line">        <span class="token keyword">end</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">subgraph</span> <span class="token string">"Monitoring Layer"</span></span>
<span class="line">            I<span class="token text string">[Prometheus]</span></span>
<span class="line">            J<span class="token text string">[Grafana]</span></span>
<span class="line">            K<span class="token text string">[Jaeger]</span></span>
<span class="line">            L<span class="token text string">[AlertManager]</span></span>
<span class="line">        <span class="token keyword">end</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">subgraph</span> <span class="token string">"Storage Layer"</span></span>
<span class="line">            M<span class="token text string">[Persistent Volumes]</span></span>
<span class="line">            N<span class="token text string">[ConfigMaps]</span></span>
<span class="line">            O<span class="token text string">[Secrets]</span></span>
<span class="line">        <span class="token keyword">end</span></span>
<span class="line">    <span class="token keyword">end</span></span>
<span class="line">    </span>
<span class="line">    P<span class="token text string">[External Users]</span> <span class="token arrow operator">--></span> B</span>
<span class="line">    B <span class="token arrow operator">--></span> A</span>
<span class="line">    A <span class="token arrow operator">--></span> C</span>
<span class="line">    A <span class="token arrow operator">--></span> D</span>
<span class="line">    A <span class="token arrow operator">--></span> E</span>
<span class="line">    C <span class="token arrow operator">--></span> F</span>
<span class="line">    D <span class="token arrow operator">--></span> F</span>
<span class="line">    E <span class="token arrow operator">--></span> F</span>
<span class="line">    F <span class="token arrow operator">--></span> G</span>
<span class="line">    C <span class="token arrow operator">--></span> H</span>
<span class="line">    D <span class="token arrow operator">--></span> H</span>
<span class="line">    E <span class="token arrow operator">--></span> H</span>
<span class="line">    </span>
<span class="line">    C <span class="token arrow operator">--></span> I</span>
<span class="line">    D <span class="token arrow operator">--></span> I</span>
<span class="line">    E <span class="token arrow operator">--></span> I</span>
<span class="line">    I <span class="token arrow operator">--></span> J</span>
<span class="line">    I <span class="token arrow operator">--></span> L</span>
<span class="line">    </span>
<span class="line">    F <span class="token arrow operator">--></span> M</span>
<span class="line">    H <span class="token arrow operator">--></span> M</span>
<span class="line">    C <span class="token arrow operator">--></span> N</span>
<span class="line">    C <span class="token arrow operator">--></span> O</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="èµ„æºåˆ†å¸ƒ" tabindex="-1"><a class="header-anchor" href="#èµ„æºåˆ†å¸ƒ">#</a> èµ„æºåˆ†å¸ƒ</h3>
<table>
<thead>
<tr>
<th>ç»„ä»¶</th>
<th>å‰¯æœ¬æ•°</th>
<th>CPUè¯·æ±‚</th>
<th>CPUé™åˆ¶</th>
<th>å†…å­˜è¯·æ±‚</th>
<th>å†…å­˜é™åˆ¶</th>
<th>å­˜å‚¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>IAM Service</td>
<td>3</td>
<td>500m</td>
<td>1000m</td>
<td>512Mi</td>
<td>1Gi</td>
<td>-</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>1+1</td>
<td>1000m</td>
<td>2000m</td>
<td>1Gi</td>
<td>2Gi</td>
<td>100Gi</td>
</tr>
<tr>
<td>Redis</td>
<td>3</td>
<td>250m</td>
<td>500m</td>
<td>256Mi</td>
<td>512Mi</td>
<td>10Gi</td>
</tr>
<tr>
<td>Prometheus</td>
<td>1</td>
<td>500m</td>
<td>1000m</td>
<td>1Gi</td>
<td>2Gi</td>
<td>50Gi</td>
</tr>
<tr>
<td>Grafana</td>
<td>1</td>
<td>100m</td>
<td>200m</td>
<td>128Mi</td>
<td>256Mi</td>
<td>10Gi</td>
</tr>
</tbody>
</table>
<h2 id="ğŸš€-å¿«é€Ÿå¼€å§‹" tabindex="-1"><a class="header-anchor" href="#ğŸš€-å¿«é€Ÿå¼€å§‹">#</a> ğŸš€ å¿«é€Ÿå¼€å§‹</h2>
<h3 id="_1-ç¯å¢ƒå‡†å¤‡" tabindex="-1"><a class="header-anchor" href="#_1-ç¯å¢ƒå‡†å¤‡">#</a> 1. ç¯å¢ƒå‡†å¤‡</h3>
<h4 id="é›†ç¾¤è¦æ±‚" tabindex="-1"><a class="header-anchor" href="#é›†ç¾¤è¦æ±‚">#</a> é›†ç¾¤è¦æ±‚</h4>
<ul>
<li><strong>Kubernetesç‰ˆæœ¬</strong>: 1.20+</li>
<li><strong>èŠ‚ç‚¹æ•°é‡</strong>: æœ€å°‘3ä¸ªèŠ‚ç‚¹</li>
<li><strong>æ€»CPU</strong>: æœ€å°‘8æ ¸</li>
<li><strong>æ€»å†…å­˜</strong>: æœ€å°‘16GB</li>
<li><strong>å­˜å‚¨</strong>: æ”¯æŒåŠ¨æ€PVä¾›åº”</li>
</ul>
<h4 id="å¿…éœ€ç»„ä»¶" tabindex="-1"><a class="header-anchor" href="#å¿…éœ€ç»„ä»¶">#</a> å¿…éœ€ç»„ä»¶</h4>
<ul>
<li><strong>Ingress Controller</strong>: Nginx, Traefik, æˆ– Istio</li>
<li><strong>å­˜å‚¨ç±»</strong>: æ”¯æŒReadWriteOnceå’ŒReadWriteMany</li>
<li><strong>DNS</strong>: CoreDNSæˆ–kube-dns</li>
<li><strong>ç½‘ç»œæ’ä»¶</strong>: Calico, Flannel, æˆ– Weave</li>
</ul>
<h4 id="å·¥å…·å®‰è£…" tabindex="-1"><a class="header-anchor" href="#å·¥å…·å®‰è£…">#</a> å·¥å…·å®‰è£…</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># å®‰è£…kubectl</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-LO</span> <span class="token string">"https://dl.k8s.io/release/<span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> <span class="token parameter variable">-L</span> <span class="token parameter variable">-s</span> https://dl.k8s.io/release/stable.txt<span class="token variable">)</span></span>/bin/linux/amd64/kubectl"</span></span>
<span class="line"><span class="token function">sudo</span> <span class="token function">install</span> <span class="token parameter variable">-o</span> root <span class="token parameter variable">-g</span> root <span class="token parameter variable">-m</span> 0755 kubectl /usr/local/bin/kubectl</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å®‰è£…Helm</span></span>
<span class="line"><span class="token function">curl</span> https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 <span class="token operator">|</span> <span class="token function">bash</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># éªŒè¯å®‰è£…</span></span>
<span class="line">kubectl version <span class="token parameter variable">--client</span></span>
<span class="line">helm version</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-åˆ›å»ºå‘½åç©ºé—´" tabindex="-1"><a class="header-anchor" href="#_2-åˆ›å»ºå‘½åç©ºé—´">#</a> 2. åˆ›å»ºå‘½åç©ºé—´</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># namespace.yaml</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line">    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> vgo</span>
<span class="line">    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>production</span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>monitoring</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>monitoring</span>
<span class="line">    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> monitoring</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># åº”ç”¨å‘½åç©ºé—´</span></span>
<span class="line">kubectl apply <span class="token parameter variable">-f</span> namespace.yaml</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-é…ç½®å­˜å‚¨" tabindex="-1"><a class="header-anchor" href="#_3-é…ç½®å­˜å‚¨">#</a> 3. é…ç½®å­˜å‚¨</h3>
<h4 id="å­˜å‚¨ç±»å®šä¹‰" tabindex="-1"><a class="header-anchor" href="#å­˜å‚¨ç±»å®šä¹‰">#</a> å­˜å‚¨ç±»å®šä¹‰</h4>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># storage-class.yaml</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>ssd</span>
<span class="line">  <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">storageclass.kubernetes.io/is-default-class</span><span class="token punctuation">:</span> <span class="token string">"false"</span></span>
<span class="line"><span class="token key atrule">provisioner</span><span class="token punctuation">:</span> kubernetes.io/aws<span class="token punctuation">-</span>ebs  <span class="token comment"># æ ¹æ®äº‘æä¾›å•†è°ƒæ•´</span></span>
<span class="line"><span class="token key atrule">parameters</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">type</span><span class="token punctuation">:</span> gp3</span>
<span class="line">  <span class="token key atrule">fsType</span><span class="token punctuation">:</span> ext4</span>
<span class="line">  <span class="token key atrule">encrypted</span><span class="token punctuation">:</span> <span class="token string">"true"</span></span>
<span class="line"><span class="token key atrule">volumeBindingMode</span><span class="token punctuation">:</span> WaitForFirstConsumer</span>
<span class="line"><span class="token key atrule">allowVolumeExpansion</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"><span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain</span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>standard</span>
<span class="line"><span class="token key atrule">provisioner</span><span class="token punctuation">:</span> kubernetes.io/aws<span class="token punctuation">-</span>ebs</span>
<span class="line"><span class="token key atrule">parameters</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">type</span><span class="token punctuation">:</span> gp2</span>
<span class="line">  <span class="token key atrule">fsType</span><span class="token punctuation">:</span> ext4</span>
<span class="line"><span class="token key atrule">volumeBindingMode</span><span class="token punctuation">:</span> WaitForFirstConsumer</span>
<span class="line"><span class="token key atrule">allowVolumeExpansion</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line"><span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Delete</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-é…ç½®å¯†é’¥å’Œé…ç½®" tabindex="-1"><a class="header-anchor" href="#_4-é…ç½®å¯†é’¥å’Œé…ç½®">#</a> 4. é…ç½®å¯†é’¥å’Œé…ç½®</h3>
<h4 id="åˆ›å»ºå¯†é’¥" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºå¯†é’¥">#</a> åˆ›å»ºå¯†é’¥</h4>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># secrets.yaml</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>database<span class="token punctuation">-</span>secret</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line"><span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque</span>
<span class="line"><span class="token key atrule">data</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">username</span><span class="token punctuation">:</span> dmdvX3VzZXI=  <span class="token comment"># base64ç¼–ç çš„ "vgo_user"</span></span>
<span class="line">  <span class="token key atrule">password</span><span class="token punctuation">:</span> eW91ci1zZWN1cmUtcGFzc3dvcmQ=  <span class="token comment"># base64ç¼–ç çš„å¯†ç </span></span>
<span class="line">  <span class="token key atrule">database</span><span class="token punctuation">:</span> dmdvX2Ri  <span class="token comment"># base64ç¼–ç çš„ "vgo_db"</span></span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>redis<span class="token punctuation">-</span>secret</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line"><span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque</span>
<span class="line"><span class="token key atrule">data</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">password</span><span class="token punctuation">:</span> eW91ci1yZWRpcy1wYXNzd29yZA==  <span class="token comment"># base64ç¼–ç çš„Rediså¯†ç </span></span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>app<span class="token punctuation">-</span>secret</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line"><span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque</span>
<span class="line"><span class="token key atrule">data</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">jwt-secret</span><span class="token punctuation">:</span> eW91ci12ZXJ5LWxvbmctand0LXNlY3JldC1rZXktYXQtbGVhc3QtMzItY2hhcmFjdGVycw==</span>
<span class="line">  <span class="token key atrule">encryption-key</span><span class="token punctuation">:</span> eW91ci0zMi1jaGFyYWN0ZXItZW5jcnlwdGlvbi1rZXk=</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="åˆ›å»ºé…ç½®æ˜ å°„" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºé…ç½®æ˜ å°„">#</a> åˆ›å»ºé…ç½®æ˜ å°„</h4>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># configmap.yaml</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>config</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line"><span class="token key atrule">data</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">app.yaml</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">    server:</span>
<span class="line">      grpc_port: 50051</span>
<span class="line">      http_port: 8080</span>
<span class="line">      health_port: 8081</span>
<span class="line">      metrics_port: 8082</span>
<span class="line">      read_timeout: 30s</span>
<span class="line">      write_timeout: 30s</span>
<span class="line">      idle_timeout: 120s</span></span>
<span class="line">    </span>
<span class="line">    <span class="token key atrule">database</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">host</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>postgres</span>
<span class="line">      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5432</span></span>
<span class="line">      <span class="token key atrule">sslmode</span><span class="token punctuation">:</span> require</span>
<span class="line">      <span class="token key atrule">max_open_conns</span><span class="token punctuation">:</span> <span class="token number">25</span></span>
<span class="line">      <span class="token key atrule">max_idle_conns</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line">      <span class="token key atrule">conn_max_lifetime</span><span class="token punctuation">:</span> 300s</span>
<span class="line">      <span class="token key atrule">query_timeout</span><span class="token punctuation">:</span> 30s</span>
<span class="line">    </span>
<span class="line">    <span class="token key atrule">redis</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">host</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>redis</span>
<span class="line">      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span></span>
<span class="line">      <span class="token key atrule">db</span><span class="token punctuation">:</span> <span class="token number">0</span></span>
<span class="line">      <span class="token key atrule">pool_size</span><span class="token punctuation">:</span> <span class="token number">10</span></span>
<span class="line">      <span class="token key atrule">min_idle_conns</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line">      <span class="token key atrule">pool_timeout</span><span class="token punctuation">:</span> 5s</span>
<span class="line">      <span class="token key atrule">idle_timeout</span><span class="token punctuation">:</span> 300s</span>
<span class="line">      <span class="token key atrule">default_ttl</span><span class="token punctuation">:</span> 3600s</span>
<span class="line">    </span>
<span class="line">    <span class="token key atrule">logging</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">level</span><span class="token punctuation">:</span> info</span>
<span class="line">      <span class="token key atrule">format</span><span class="token punctuation">:</span> json</span>
<span class="line">      <span class="token key atrule">output</span><span class="token punctuation">:</span> stdout</span>
<span class="line">    </span>
<span class="line">    <span class="token key atrule">metrics</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">path</span><span class="token punctuation">:</span> /metrics</span>
<span class="line">    </span>
<span class="line">    <span class="token key atrule">tracing</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">jaeger_endpoint</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//jaeger<span class="token punctuation">-</span>collector.vgo<span class="token punctuation">-</span>monitoring<span class="token punctuation">:</span>14268/api/traces</span>
<span class="line">      <span class="token key atrule">sample_rate</span><span class="token punctuation">:</span> <span class="token number">0.1</span></span>
<span class="line">    </span>
<span class="line">    <span class="token key atrule">security</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">tls_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">cors_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">      <span class="token key atrule">cors_origins</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token string">"https://vgo.example.com"</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token string">"https://admin.vgo.example.com"</span></span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> postgres<span class="token punctuation">-</span>config</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line"><span class="token key atrule">data</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">postgresql.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">    # è¿æ¥è®¾ç½®</span>
<span class="line">    listen_addresses = '*'</span>
<span class="line">    port = 5432</span>
<span class="line">    max_connections = 200</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># å†…å­˜è®¾ç½®</span></span>
<span class="line">    shared_buffers = 256MB</span>
<span class="line">    effective_cache_size = 1GB</span>
<span class="line">    work_mem = 4MB</span>
<span class="line">    maintenance_work_mem = 64MB</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># WALè®¾ç½®</span></span>
<span class="line">    wal_level = replica</span>
<span class="line">    max_wal_size = 1GB</span>
<span class="line">    min_wal_size = 80MB</span>
<span class="line">    checkpoint_completion_target = 0.9</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># å¤åˆ¶è®¾ç½®</span></span>
<span class="line">    hot_standby = on</span>
<span class="line">    max_replication_slots = 10</span>
<span class="line">    max_wal_senders = 10</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># æ—¥å¿—è®¾ç½®</span></span>
<span class="line">    log_destination = 'stderr'</span>
<span class="line">    logging_collector = on</span>
<span class="line">    log_directory = 'log'</span>
<span class="line">    log_filename = 'postgresql<span class="token punctuation">-</span>%Y<span class="token punctuation">-</span>%m<span class="token punctuation">-</span>%d_%H%M%S.log'</span>
<span class="line">    log_statement = 'mod'</span>
<span class="line">    log_min_duration_statement = 1000</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># æ€§èƒ½è®¾ç½®</span></span>
<span class="line">    random_page_cost = 1.1</span>
<span class="line">    effective_io_concurrency = 200</span>
<span class="line">  </span>
<span class="line">  <span class="token key atrule">pg_hba.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">    # TYPE  DATABASE        USER            ADDRESS                 METHOD</span>
<span class="line">    local   all             all                                     trust</span>
<span class="line">    host    all             all             127.0.0.1/32            md5</span>
<span class="line">    host    all             all             ::1/128                 md5</span>
<span class="line">    host    all             all             0.0.0.0/0               md5</span>
<span class="line">    host    replication     all             0.0.0.0/0               md5</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># åº”ç”¨å¯†é’¥å’Œé…ç½®</span></span>
<span class="line">kubectl apply <span class="token parameter variable">-f</span> secrets.yaml</span>
<span class="line">kubectl apply <span class="token parameter variable">-f</span> configmap.yaml</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-éƒ¨ç½²postgresql" tabindex="-1"><a class="header-anchor" href="#_5-éƒ¨ç½²postgresql">#</a> 5. éƒ¨ç½²PostgreSQL</h3>
<h4 id="postgresqlä¸»åº“" tabindex="-1"><a class="header-anchor" href="#postgresqlä¸»åº“">#</a> PostgreSQLä¸»åº“</h4>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># postgres-primary.yaml</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>postgres</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>postgres</span>
<span class="line">    <span class="token key atrule">role</span><span class="token punctuation">:</span> primary</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>postgres</span>
<span class="line">  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>postgres</span>
<span class="line">      <span class="token key atrule">role</span><span class="token punctuation">:</span> primary</span>
<span class="line">  <span class="token key atrule">template</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>postgres</span>
<span class="line">        <span class="token key atrule">role</span><span class="token punctuation">:</span> primary</span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">999</span></span>
<span class="line">      <span class="token key atrule">containers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> postgres</span>
<span class="line">        <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span>15<span class="token punctuation">-</span>alpine</span>
<span class="line">        <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">5432</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> postgres</span>
<span class="line">        <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_DB</span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>database<span class="token punctuation">-</span>secret</span>
<span class="line">              <span class="token key atrule">key</span><span class="token punctuation">:</span> database</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_USER</span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>database<span class="token punctuation">-</span>secret</span>
<span class="line">              <span class="token key atrule">key</span><span class="token punctuation">:</span> username</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_PASSWORD</span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>database<span class="token punctuation">-</span>secret</span>
<span class="line">              <span class="token key atrule">key</span><span class="token punctuation">:</span> password</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_INITDB_ARGS</span>
<span class="line">          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"--encoding=UTF8 --locale=C"</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PGDATA</span>
<span class="line">          <span class="token key atrule">value</span><span class="token punctuation">:</span> /var/lib/postgresql/data/pgdata</span>
<span class="line">        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> postgres<span class="token punctuation">-</span>data</span>
<span class="line">          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/postgresql/data</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> postgres<span class="token punctuation">-</span>config</span>
<span class="line">          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/postgresql</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> postgres<span class="token punctuation">-</span>init</span>
<span class="line">          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /docker<span class="token punctuation">-</span>entrypoint<span class="token punctuation">-</span>initdb.d</span>
<span class="line">        <span class="token key atrule">resources</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">requests</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 1000m</span>
<span class="line">            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi</span>
<span class="line">          <span class="token key atrule">limits</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 2000m</span>
<span class="line">            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 2Gi</span>
<span class="line">        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">exec</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> /bin/sh</span>
<span class="line">            <span class="token punctuation">-</span> <span class="token punctuation">-</span>c</span>
<span class="line">            <span class="token punctuation">-</span> pg_isready <span class="token punctuation">-</span>U $POSTGRES_USER <span class="token punctuation">-</span>d $POSTGRES_DB</span>
<span class="line">          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span></span>
<span class="line">          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span></span>
<span class="line">          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line">          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">exec</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> /bin/sh</span>
<span class="line">            <span class="token punctuation">-</span> <span class="token punctuation">-</span>c</span>
<span class="line">            <span class="token punctuation">-</span> pg_isready <span class="token punctuation">-</span>U $POSTGRES_USER <span class="token punctuation">-</span>d $POSTGRES_DB</span>
<span class="line">          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line">          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line">          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">      <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> postgres<span class="token punctuation">-</span>config</span>
<span class="line">        <span class="token key atrule">configMap</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> postgres<span class="token punctuation">-</span>config</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> postgres<span class="token punctuation">-</span>init</span>
<span class="line">        <span class="token key atrule">configMap</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> postgres<span class="token punctuation">-</span>init<span class="token punctuation">-</span>scripts</span>
<span class="line">  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">name</span><span class="token punctuation">:</span> postgres<span class="token punctuation">-</span>data</span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span></span>
<span class="line">      <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>ssd</span>
<span class="line">      <span class="token key atrule">resources</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">requests</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 100Gi</span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>postgres</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>postgres</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</span>
<span class="line">  <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5432</span></span>
<span class="line">    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">5432</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> postgres</span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>postgres</span>
<span class="line">    <span class="token key atrule">role</span><span class="token punctuation">:</span> primary</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-éƒ¨ç½²redis" tabindex="-1"><a class="header-anchor" href="#_6-éƒ¨ç½²redis">#</a> 6. éƒ¨ç½²Redis</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># redis.yaml</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>redis</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>redis</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>redis</span>
<span class="line">  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>redis</span>
<span class="line">  <span class="token key atrule">template</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>redis</span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">containers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis</span>
<span class="line">        <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>7<span class="token punctuation">-</span>alpine</span>
<span class="line">        <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> redis<span class="token punctuation">-</span>server</span>
<span class="line">        <span class="token punctuation">-</span> /etc/redis/redis.conf</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>requirepass</span>
<span class="line">        <span class="token punctuation">-</span> $(REDIS_PASSWORD)</span>
<span class="line">        <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">6379</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> redis</span>
<span class="line">        <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REDIS_PASSWORD</span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>redis<span class="token punctuation">-</span>secret</span>
<span class="line">              <span class="token key atrule">key</span><span class="token punctuation">:</span> password</span>
<span class="line">        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>data</span>
<span class="line">          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>config</span>
<span class="line">          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/redis</span>
<span class="line">        <span class="token key atrule">resources</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">requests</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 250m</span>
<span class="line">            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 256Mi</span>
<span class="line">          <span class="token key atrule">limits</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m</span>
<span class="line">            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi</span>
<span class="line">        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">exec</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> redis<span class="token punctuation">-</span>cli</span>
<span class="line">            <span class="token punctuation">-</span> <span class="token punctuation">-</span>a</span>
<span class="line">            <span class="token punctuation">-</span> $(REDIS_PASSWORD)</span>
<span class="line">            <span class="token punctuation">-</span> ping</span>
<span class="line">          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span></span>
<span class="line">          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span></span>
<span class="line">          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line">          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">exec</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> redis<span class="token punctuation">-</span>cli</span>
<span class="line">            <span class="token punctuation">-</span> <span class="token punctuation">-</span>a</span>
<span class="line">            <span class="token punctuation">-</span> $(REDIS_PASSWORD)</span>
<span class="line">            <span class="token punctuation">-</span> ping</span>
<span class="line">          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line">          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line">          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">      <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>config</span>
<span class="line">        <span class="token key atrule">configMap</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>config</span>
<span class="line">  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>data</span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span></span>
<span class="line">      <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>ssd</span>
<span class="line">      <span class="token key atrule">resources</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">requests</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi</span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>redis</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>redis</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</span>
<span class="line">  <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span></span>
<span class="line">    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">6379</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> redis</span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>redis</span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>config</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line"><span class="token key atrule">data</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">redis.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">    # ç½‘ç»œé…ç½®</span>
<span class="line">    bind 0.0.0.0</span>
<span class="line">    port 6379</span>
<span class="line">    tcp-backlog 511</span>
<span class="line">    timeout 0</span>
<span class="line">    tcp-keepalive 300</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># æŒä¹…åŒ–é…ç½®</span></span>
<span class="line">    save 900 1</span>
<span class="line">    save 300 10</span>
<span class="line">    save 60 10000</span>
<span class="line">    stop<span class="token punctuation">-</span>writes<span class="token punctuation">-</span>on<span class="token punctuation">-</span>bgsave<span class="token punctuation">-</span>error yes</span>
<span class="line">    rdbcompression yes</span>
<span class="line">    rdbchecksum yes</span>
<span class="line">    dbfilename dump.rdb</span>
<span class="line">    dir /data</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># AOFé…ç½®</span></span>
<span class="line">    appendonly yes</span>
<span class="line">    appendfilename "appendonly.aof"</span>
<span class="line">    appendfsync everysec</span>
<span class="line">    no<span class="token punctuation">-</span>appendfsync<span class="token punctuation">-</span>on<span class="token punctuation">-</span>rewrite no</span>
<span class="line">    auto<span class="token punctuation">-</span>aof<span class="token punctuation">-</span>rewrite<span class="token punctuation">-</span>percentage 100</span>
<span class="line">    auto<span class="token punctuation">-</span>aof<span class="token punctuation">-</span>rewrite<span class="token punctuation">-</span>min<span class="token punctuation">-</span>size 64mb</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># å†…å­˜é…ç½®</span></span>
<span class="line">    maxmemory 400mb</span>
<span class="line">    maxmemory<span class="token punctuation">-</span>policy allkeys<span class="token punctuation">-</span>lru</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># æ—¥å¿—é…ç½®</span></span>
<span class="line">    loglevel notice</span>
<span class="line">    logfile ""</span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># å®¢æˆ·ç«¯é…ç½®</span></span>
<span class="line">    maxclients 10000</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-éƒ¨ç½²iamæœåŠ¡" tabindex="-1"><a class="header-anchor" href="#_7-éƒ¨ç½²iamæœåŠ¡">#</a> 7. éƒ¨ç½²IAMæœåŠ¡</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># iam-deployment.yaml</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">    <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.0.0</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">  <span class="token key atrule">strategy</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate</span>
<span class="line">    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">1</span></span>
<span class="line">      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">  <span class="token key atrule">template</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.0.0</span>
<span class="line">      <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">prometheus.io/scrape</span><span class="token punctuation">:</span> <span class="token string">"true"</span></span>
<span class="line">        <span class="token key atrule">prometheus.io/port</span><span class="token punctuation">:</span> <span class="token string">"8082"</span></span>
<span class="line">        <span class="token key atrule">prometheus.io/path</span><span class="token punctuation">:</span> <span class="token string">"/metrics"</span></span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">        <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span></span>
<span class="line">        <span class="token key atrule">runAsGroup</span><span class="token punctuation">:</span> <span class="token number">1000</span></span>
<span class="line">        <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">1000</span></span>
<span class="line">      <span class="token key atrule">containers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> iam</span>
<span class="line">        <span class="token key atrule">image</span><span class="token punctuation">:</span> vgo/iam<span class="token punctuation">:</span>v1.0.0</span>
<span class="line">        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</span>
<span class="line">        <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">50051</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> grpc</span>
<span class="line">          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> http</span>
<span class="line">          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8081</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> health</span>
<span class="line">          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8082</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics</span>
<span class="line">          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">        <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CONFIG_FILE</span>
<span class="line">          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"/etc/vgo/app.yaml"</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DB_PASSWORD</span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>database<span class="token punctuation">-</span>secret</span>
<span class="line">              <span class="token key atrule">key</span><span class="token punctuation">:</span> password</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REDIS_PASSWORD</span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>redis<span class="token punctuation">-</span>secret</span>
<span class="line">              <span class="token key atrule">key</span><span class="token punctuation">:</span> password</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JWT_SECRET</span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>app<span class="token punctuation">-</span>secret</span>
<span class="line">              <span class="token key atrule">key</span><span class="token punctuation">:</span> jwt<span class="token punctuation">-</span>secret</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ENCRYPTION_KEY</span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>app<span class="token punctuation">-</span>secret</span>
<span class="line">              <span class="token key atrule">key</span><span class="token punctuation">:</span> encryption<span class="token punctuation">-</span>key</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME</span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE</span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_IP</span>
<span class="line">          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> status.podIP</span>
<span class="line">        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config</span>
<span class="line">          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/vgo</span>
<span class="line">          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp</span>
<span class="line">          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp</span>
<span class="line">        <span class="token key atrule">resources</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">requests</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m</span>
<span class="line">            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi</span>
<span class="line">          <span class="token key atrule">limits</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 1000m</span>
<span class="line">            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi</span>
<span class="line">        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">path</span><span class="token punctuation">:</span> /health</span>
<span class="line">            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span></span>
<span class="line">          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span></span>
<span class="line">          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span></span>
<span class="line">          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line">          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">path</span><span class="token punctuation">:</span> /ready</span>
<span class="line">            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span></span>
<span class="line">          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line">          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line">          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">        <span class="token key atrule">startupProbe</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">path</span><span class="token punctuation">:</span> /health</span>
<span class="line">            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span></span>
<span class="line">          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span></span>
<span class="line">          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span></span>
<span class="line">          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">30</span></span>
<span class="line">        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line">          <span class="token key atrule">readOnlyRootFilesystem</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">          <span class="token key atrule">capabilities</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">drop</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> ALL</span>
<span class="line">      <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config</span>
<span class="line">        <span class="token key atrule">configMap</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>config</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp</span>
<span class="line">        <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">      <span class="token key atrule">affinity</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span></span>
<span class="line">            <span class="token key atrule">podAffinityTerm</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app</span>
<span class="line">                  <span class="token key atrule">operator</span><span class="token punctuation">:</span> In</span>
<span class="line">                  <span class="token key atrule">values</span><span class="token punctuation">:</span></span>
<span class="line">                  <span class="token punctuation">-</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">              <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname</span>
<span class="line">      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"node.kubernetes.io/not-ready"</span></span>
<span class="line">        <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">"Exists"</span></span>
<span class="line">        <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">"NoExecute"</span></span>
<span class="line">        <span class="token key atrule">tolerationSeconds</span><span class="token punctuation">:</span> <span class="token number">300</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"node.kubernetes.io/unreachable"</span></span>
<span class="line">        <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">"Exists"</span></span>
<span class="line">        <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">"NoExecute"</span></span>
<span class="line">        <span class="token key atrule">tolerationSeconds</span><span class="token punctuation">:</span> <span class="token number">300</span></span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">  <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">service.beta.kubernetes.io/aws-load-balancer-type</span><span class="token punctuation">:</span> nlb</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</span>
<span class="line">  <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">50051</span></span>
<span class="line">    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">50051</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> grpc</span>
<span class="line">    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span></span>
<span class="line">    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> http</span>
<span class="line">    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span></span>
<span class="line">    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8081</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> health</span>
<span class="line">    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8082</span></span>
<span class="line">    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8082</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics</span>
<span class="line">    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line"><span class="token key atrule">automountServiceAccountToken</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-é…ç½®ingress" tabindex="-1"><a class="header-anchor" href="#_8-é…ç½®ingress">#</a> 8. é…ç½®Ingress</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># ingress.yaml</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>ingress</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo</span>
<span class="line">  <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">kubernetes.io/ingress.class</span><span class="token punctuation">:</span> nginx</span>
<span class="line">    <span class="token key atrule">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="token punctuation">:</span> <span class="token string">"true"</span></span>
<span class="line">    <span class="token key atrule">nginx.ingress.kubernetes.io/force-ssl-redirect</span><span class="token punctuation">:</span> <span class="token string">"true"</span></span>
<span class="line">    <span class="token key atrule">nginx.ingress.kubernetes.io/backend-protocol</span><span class="token punctuation">:</span> <span class="token string">"HTTP"</span></span>
<span class="line">    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-body-size</span><span class="token punctuation">:</span> <span class="token string">"100m"</span></span>
<span class="line">    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-connect-timeout</span><span class="token punctuation">:</span> <span class="token string">"5"</span></span>
<span class="line">    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-send-timeout</span><span class="token punctuation">:</span> <span class="token string">"60"</span></span>
<span class="line">    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-read-timeout</span><span class="token punctuation">:</span> <span class="token string">"60"</span></span>
<span class="line">    <span class="token key atrule">nginx.ingress.kubernetes.io/rate-limit</span><span class="token punctuation">:</span> <span class="token string">"100"</span></span>
<span class="line">    <span class="token key atrule">nginx.ingress.kubernetes.io/rate-limit-window</span><span class="token punctuation">:</span> <span class="token string">"1m"</span></span>
<span class="line">    <span class="token key atrule">cert-manager.io/cluster-issuer</span><span class="token punctuation">:</span> <span class="token string">"letsencrypt-prod"</span></span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">tls</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> vgo.example.com</span>
<span class="line">    <span class="token punctuation">-</span> api.vgo.example.com</span>
<span class="line">    <span class="token key atrule">secretName</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>tls<span class="token punctuation">-</span>secret</span>
<span class="line">  <span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> vgo.example.com</span>
<span class="line">    <span class="token key atrule">http</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">paths</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /</span>
<span class="line">        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix</span>
<span class="line">        <span class="token key atrule">backend</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">service</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">            <span class="token key atrule">port</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8080</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> api.vgo.example.com</span>
<span class="line">    <span class="token key atrule">http</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">paths</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /</span>
<span class="line">        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix</span>
<span class="line">        <span class="token key atrule">backend</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">service</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">            <span class="token key atrule">port</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8080</span></span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token comment"># gRPC Ingress (å¦‚æœéœ€è¦)</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>grpc<span class="token punctuation">-</span>ingress</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo</span>
<span class="line">  <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">kubernetes.io/ingress.class</span><span class="token punctuation">:</span> nginx</span>
<span class="line">    <span class="token key atrule">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="token punctuation">:</span> <span class="token string">"true"</span></span>
<span class="line">    <span class="token key atrule">nginx.ingress.kubernetes.io/backend-protocol</span><span class="token punctuation">:</span> <span class="token string">"GRPC"</span></span>
<span class="line">    <span class="token key atrule">nginx.ingress.kubernetes.io/grpc-backend</span><span class="token punctuation">:</span> <span class="token string">"true"</span></span>
<span class="line">    <span class="token key atrule">cert-manager.io/cluster-issuer</span><span class="token punctuation">:</span> <span class="token string">"letsencrypt-prod"</span></span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">tls</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> grpc.vgo.example.com</span>
<span class="line">    <span class="token key atrule">secretName</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>grpc<span class="token punctuation">-</span>tls<span class="token punctuation">-</span>secret</span>
<span class="line">  <span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> grpc.vgo.example.com</span>
<span class="line">    <span class="token key atrule">http</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">paths</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /</span>
<span class="line">        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix</span>
<span class="line">        <span class="token key atrule">backend</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">service</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">            <span class="token key atrule">port</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">50051</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-éƒ¨ç½²åº”ç”¨" tabindex="-1"><a class="header-anchor" href="#_9-éƒ¨ç½²åº”ç”¨">#</a> 9. éƒ¨ç½²åº”ç”¨</h3>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># æŒ‰é¡ºåºéƒ¨ç½²</span></span>
<span class="line">kubectl apply <span class="token parameter variable">-f</span> storage-class.yaml</span>
<span class="line">kubectl apply <span class="token parameter variable">-f</span> secrets.yaml</span>
<span class="line">kubectl apply <span class="token parameter variable">-f</span> configmap.yaml</span>
<span class="line">kubectl apply <span class="token parameter variable">-f</span> postgres-primary.yaml</span>
<span class="line">kubectl apply <span class="token parameter variable">-f</span> redis.yaml</span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç­‰å¾…æ•°æ®åº“å°±ç»ª</span></span>
<span class="line">kubectl <span class="token function">wait</span> <span class="token parameter variable">--for</span><span class="token operator">=</span>condition<span class="token operator">=</span>ready pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>vgo-postgres <span class="token parameter variable">-n</span> vgo-system <span class="token parameter variable">--timeout</span><span class="token operator">=</span>300s</span>
<span class="line">kubectl <span class="token function">wait</span> <span class="token parameter variable">--for</span><span class="token operator">=</span>condition<span class="token operator">=</span>ready pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>vgo-redis <span class="token parameter variable">-n</span> vgo-system <span class="token parameter variable">--timeout</span><span class="token operator">=</span>300s</span>
<span class="line"></span>
<span class="line"><span class="token comment"># éƒ¨ç½²åº”ç”¨</span></span>
<span class="line">kubectl apply <span class="token parameter variable">-f</span> iam-deployment.yaml</span>
<span class="line"></span>
<span class="line"><span class="token comment"># ç­‰å¾…åº”ç”¨å°±ç»ª</span></span>
<span class="line">kubectl <span class="token function">wait</span> <span class="token parameter variable">--for</span><span class="token operator">=</span>condition<span class="token operator">=</span>ready pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>vgo-iam <span class="token parameter variable">-n</span> vgo-system <span class="token parameter variable">--timeout</span><span class="token operator">=</span>300s</span>
<span class="line"></span>
<span class="line"><span class="token comment"># éƒ¨ç½²Ingress</span></span>
<span class="line">kubectl apply <span class="token parameter variable">-f</span> ingress.yaml</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_10-éªŒè¯éƒ¨ç½²" tabindex="-1"><a class="header-anchor" href="#_10-éªŒè¯éƒ¨ç½²">#</a> 10. éªŒè¯éƒ¨ç½²</h3>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># æ£€æŸ¥PodçŠ¶æ€</span></span>
<span class="line">kubectl get pods <span class="token parameter variable">-n</span> vgo-system</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥æœåŠ¡çŠ¶æ€</span></span>
<span class="line">kubectl get svc <span class="token parameter variable">-n</span> vgo-system</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æ£€æŸ¥IngressçŠ¶æ€</span></span>
<span class="line">kubectl get ingress <span class="token parameter variable">-n</span> vgo-system</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹åº”ç”¨æ—¥å¿—</span></span>
<span class="line">kubectl logs <span class="token parameter variable">-f</span> deployment/vgo-iam <span class="token parameter variable">-n</span> vgo-system</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æµ‹è¯•å¥åº·æ£€æŸ¥</span></span>
<span class="line">kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> deployment/vgo-iam <span class="token parameter variable">-n</span> vgo-system -- <span class="token function">curl</span> http://localhost:8081/health</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æµ‹è¯•gRPC API</span></span>
<span class="line">kubectl port-forward svc/vgo-iam <span class="token number">50051</span>:50051 <span class="token parameter variable">-n</span> vgo-system <span class="token operator">&amp;</span></span>
<span class="line">grpcurl <span class="token parameter variable">-plaintext</span> localhost:50051 list</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”§-é«˜çº§é…ç½®" tabindex="-1"><a class="header-anchor" href="#ğŸ”§-é«˜çº§é…ç½®">#</a> ğŸ”§ é«˜çº§é…ç½®</h2>
<h3 id="æ°´å¹³podè‡ªåŠ¨æ‰©ç¼©å®¹-hpa" tabindex="-1"><a class="header-anchor" href="#æ°´å¹³podè‡ªåŠ¨æ‰©ç¼©å®¹-hpa">#</a> æ°´å¹³Podè‡ªåŠ¨æ‰©ç¼©å®¹(HPA)</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># hpa.yaml</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v2</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam<span class="token punctuation">-</span>hpa</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</span>
<span class="line">    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">10</span></span>
<span class="line">  <span class="token key atrule">metrics</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Resource</span>
<span class="line">    <span class="token key atrule">resource</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">name</span><span class="token punctuation">:</span> cpu</span>
<span class="line">      <span class="token key atrule">target</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">type</span><span class="token punctuation">:</span> Utilization</span>
<span class="line">        <span class="token key atrule">averageUtilization</span><span class="token punctuation">:</span> <span class="token number">70</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Resource</span>
<span class="line">    <span class="token key atrule">resource</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">name</span><span class="token punctuation">:</span> memory</span>
<span class="line">      <span class="token key atrule">target</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">type</span><span class="token punctuation">:</span> Utilization</span>
<span class="line">        <span class="token key atrule">averageUtilization</span><span class="token punctuation">:</span> <span class="token number">80</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Pods</span>
<span class="line">    <span class="token key atrule">pods</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">metric</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">name</span><span class="token punctuation">:</span> grpc_requests_per_second</span>
<span class="line">      <span class="token key atrule">target</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">type</span><span class="token punctuation">:</span> AverageValue</span>
<span class="line">        <span class="token key atrule">averageValue</span><span class="token punctuation">:</span> <span class="token string">"100"</span></span>
<span class="line">  <span class="token key atrule">behavior</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">scaleDown</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">stabilizationWindowSeconds</span><span class="token punctuation">:</span> <span class="token number">300</span></span>
<span class="line">      <span class="token key atrule">policies</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Percent</span>
<span class="line">        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">10</span></span>
<span class="line">        <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">60</span></span>
<span class="line">    <span class="token key atrule">scaleUp</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">stabilizationWindowSeconds</span><span class="token punctuation">:</span> <span class="token number">60</span></span>
<span class="line">      <span class="token key atrule">policies</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Percent</span>
<span class="line">        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">50</span></span>
<span class="line">        <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">60</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Pods</span>
<span class="line">        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">2</span></span>
<span class="line">        <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">60</span></span>
<span class="line">      <span class="token key atrule">selectPolicy</span><span class="token punctuation">:</span> Max</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å‚ç›´podè‡ªåŠ¨æ‰©ç¼©å®¹-vpa" tabindex="-1"><a class="header-anchor" href="#å‚ç›´podè‡ªåŠ¨æ‰©ç¼©å®¹-vpa">#</a> å‚ç›´Podè‡ªåŠ¨æ‰©ç¼©å®¹(VPA)</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># vpa.yaml</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling.k8s.io/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> VerticalPodAutoscaler</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam<span class="token punctuation">-</span>vpa</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">targetRef</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</span>
<span class="line">    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">  <span class="token key atrule">updatePolicy</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">updateMode</span><span class="token punctuation">:</span> <span class="token string">"Auto"</span></span>
<span class="line">  <span class="token key atrule">resourcePolicy</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">containerPolicies</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">containerName</span><span class="token punctuation">:</span> iam</span>
<span class="line">      <span class="token key atrule">minAllowed</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m</span>
<span class="line">        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 128Mi</span>
<span class="line">      <span class="token key atrule">maxAllowed</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 2000m</span>
<span class="line">        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 2Gi</span>
<span class="line">      <span class="token key atrule">controlledResources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"cpu"</span><span class="token punctuation">,</span> <span class="token string">"memory"</span><span class="token punctuation">]</span></span>
<span class="line">      <span class="token key atrule">controlledValues</span><span class="token punctuation">:</span> RequestsAndLimits</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="podä¸­æ–­é¢„ç®—-pdb" tabindex="-1"><a class="header-anchor" href="#podä¸­æ–­é¢„ç®—-pdb">#</a> Podä¸­æ–­é¢„ç®—(PDB)</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># pdb.yaml</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> policy/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> PodDisruptionBudget</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam<span class="token punctuation">-</span>pdb</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">minAvailable</span><span class="token punctuation">:</span> <span class="token number">2</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> policy/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> PodDisruptionBudget</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>postgres<span class="token punctuation">-</span>pdb</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">0</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>postgres</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ç½‘ç»œç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#ç½‘ç»œç­–ç•¥">#</a> ç½‘ç»œç­–ç•¥</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># network-policy.yaml</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> NetworkPolicy</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam<span class="token punctuation">-</span>netpol</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">podSelector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">  <span class="token key atrule">policyTypes</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> Ingress</span>
<span class="line">  <span class="token punctuation">-</span> Egress</span>
<span class="line">  <span class="token key atrule">ingress</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx</span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">podSelector</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">50051</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>monitoring</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8082</span></span>
<span class="line">  <span class="token key atrule">egress</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">podSelector</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>postgres</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5432</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">podSelector</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>redis</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">53</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> UDP</span>
<span class="line">      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">53</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span></span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> NetworkPolicy</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>postgres<span class="token punctuation">-</span>netpol</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">podSelector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>postgres</span>
<span class="line">  <span class="token key atrule">policyTypes</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> Ingress</span>
<span class="line">  <span class="token key atrule">ingress</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">podSelector</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">podSelector</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">app</span><span class="token punctuation">:</span> postgres<span class="token punctuation">-</span>exporter</span>
<span class="line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</span>
<span class="line">      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5432</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“Š-ç›‘æ§é…ç½®" tabindex="-1"><a class="header-anchor" href="#ğŸ“Š-ç›‘æ§é…ç½®">#</a> ğŸ“Š ç›‘æ§é…ç½®</h2>
<h3 id="prometheusé…ç½®" tabindex="-1"><a class="header-anchor" href="#prometheusé…ç½®">#</a> Prometheusé…ç½®</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># prometheus.yaml</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>config</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>monitoring</span>
<span class="line"><span class="token key atrule">data</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">prometheus.yml</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">    global:</span>
<span class="line">      scrape_interval: 15s</span>
<span class="line">      evaluation_interval: 15s</span>
<span class="line">      external_labels:</span>
<span class="line">        cluster: 'vgo-k8s-cluster'</span>
<span class="line">        environment: 'production'</span></span>
<span class="line">    </span>
<span class="line">    <span class="token key atrule">rule_files</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token string">"/etc/prometheus/rules/*.yml"</span></span>
<span class="line">    </span>
<span class="line">    <span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token comment"># Kubernetes API Server</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'kubernetes-apiservers'</span></span>
<span class="line">        <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> endpoints</span>
<span class="line">        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> https</span>
<span class="line">        <span class="token key atrule">tls_config</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">ca_file</span><span class="token punctuation">:</span> /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
<span class="line">        <span class="token key atrule">bearer_token_file</span><span class="token punctuation">:</span> /var/run/secrets/kubernetes.io/serviceaccount/token</span>
<span class="line">        <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_namespace<span class="token punctuation">,</span> __meta_kubernetes_service_name<span class="token punctuation">,</span> __meta_kubernetes_endpoint_port_name<span class="token punctuation">]</span></span>
<span class="line">          <span class="token key atrule">action</span><span class="token punctuation">:</span> keep</span>
<span class="line">          <span class="token key atrule">regex</span><span class="token punctuation">:</span> default;kubernetes;https</span>
<span class="line">      </span>
<span class="line">      <span class="token comment"># Kubernetes Nodes</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'kubernetes-nodes'</span></span>
<span class="line">        <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> node</span>
<span class="line">        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> https</span>
<span class="line">        <span class="token key atrule">tls_config</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">ca_file</span><span class="token punctuation">:</span> /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span>
<span class="line">        <span class="token key atrule">bearer_token_file</span><span class="token punctuation">:</span> /var/run/secrets/kubernetes.io/serviceaccount/token</span>
<span class="line">        <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> labelmap</span>
<span class="line">          <span class="token key atrule">regex</span><span class="token punctuation">:</span> __meta_kubernetes_node_label_(.+)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __address__</span>
<span class="line">          <span class="token key atrule">replacement</span><span class="token punctuation">:</span> kubernetes.default.svc<span class="token punctuation">:</span><span class="token number">443</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_node_name<span class="token punctuation">]</span></span>
<span class="line">          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (.+)</span>
<span class="line">          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __metrics_path__</span>
<span class="line">          <span class="token key atrule">replacement</span><span class="token punctuation">:</span> /api/v1/nodes/$<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span>/proxy/metrics</span>
<span class="line">      </span>
<span class="line">      <span class="token comment"># Kubernetes Pods</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'kubernetes-pods'</span></span>
<span class="line">        <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> pod</span>
<span class="line">        <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_pod_annotation_prometheus_io_scrape<span class="token punctuation">]</span></span>
<span class="line">          <span class="token key atrule">action</span><span class="token punctuation">:</span> keep</span>
<span class="line">          <span class="token key atrule">regex</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_pod_annotation_prometheus_io_path<span class="token punctuation">]</span></span>
<span class="line">          <span class="token key atrule">action</span><span class="token punctuation">:</span> replace</span>
<span class="line">          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __metrics_path__</span>
<span class="line">          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (.+)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__address__<span class="token punctuation">,</span> __meta_kubernetes_pod_annotation_prometheus_io_port<span class="token punctuation">]</span></span>
<span class="line">          <span class="token key atrule">action</span><span class="token punctuation">:</span> replace</span>
<span class="line">          <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">[</span>^<span class="token punctuation">:</span><span class="token punctuation">]</span>+)(<span class="token punctuation">?</span><span class="token punctuation">:</span><span class="token punctuation">:</span>\d+)<span class="token punctuation">?</span>;(\d+)</span>
<span class="line">          <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1<span class="token punctuation">:</span>$2</span>
<span class="line">          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __address__</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> labelmap</span>
<span class="line">          <span class="token key atrule">regex</span><span class="token punctuation">:</span> __meta_kubernetes_pod_label_(.+)</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_namespace<span class="token punctuation">]</span></span>
<span class="line">          <span class="token key atrule">action</span><span class="token punctuation">:</span> replace</span>
<span class="line">          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_namespace</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_pod_name<span class="token punctuation">]</span></span>
<span class="line">          <span class="token key atrule">action</span><span class="token punctuation">:</span> replace</span>
<span class="line">          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_pod_name</span>
<span class="line">      </span>
<span class="line">      <span class="token comment"># VGO IAM Service</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'vgo-iam'</span></span>
<span class="line">        <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> endpoints</span>
<span class="line">          <span class="token key atrule">namespaces</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">names</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line">        <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_name<span class="token punctuation">]</span></span>
<span class="line">          <span class="token key atrule">action</span><span class="token punctuation">:</span> keep</span>
<span class="line">          <span class="token key atrule">regex</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_endpoint_port_name<span class="token punctuation">]</span></span>
<span class="line">          <span class="token key atrule">action</span><span class="token punctuation">:</span> keep</span>
<span class="line">          <span class="token key atrule">regex</span><span class="token punctuation">:</span> metrics</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_namespace<span class="token punctuation">]</span></span>
<span class="line">          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> namespace</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_name<span class="token punctuation">]</span></span>
<span class="line">          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> service</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_pod_name<span class="token punctuation">]</span></span>
<span class="line">          <span class="token key atrule">target_label</span><span class="token punctuation">:</span> pod</span>
<span class="line">    </span>
<span class="line">    <span class="token key atrule">alerting</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">alertmanagers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> pod</span>
<span class="line">          <span class="token key atrule">namespaces</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">names</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> vgo<span class="token punctuation">-</span>monitoring</span>
<span class="line">        <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_pod_label_app<span class="token punctuation">]</span></span>
<span class="line">          <span class="token key atrule">action</span><span class="token punctuation">:</span> keep</span>
<span class="line">          <span class="token key atrule">regex</span><span class="token punctuation">:</span> alertmanager</span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>monitoring</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus</span>
<span class="line">  <span class="token key atrule">template</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus</span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> prometheus</span>
<span class="line">      <span class="token key atrule">containers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus</span>
<span class="line">        <span class="token key atrule">image</span><span class="token punctuation">:</span> prom/prometheus<span class="token punctuation">:</span>latest</span>
<span class="line">        <span class="token key atrule">args</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token string">'--config.file=/etc/prometheus/prometheus.yml'</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token string">'--storage.tsdb.path=/prometheus/'</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token string">'--web.console.libraries=/etc/prometheus/console_libraries'</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token string">'--web.console.templates=/etc/prometheus/consoles'</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token string">'--storage.tsdb.retention.time=200h'</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token string">'--web.enable-lifecycle'</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token string">'--web.enable-admin-api'</span></span>
<span class="line">        <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9090</span></span>
<span class="line">        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>config</span>
<span class="line">          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/prometheus</span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>storage</span>
<span class="line">          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /prometheus</span>
<span class="line">        <span class="token key atrule">resources</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">requests</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m</span>
<span class="line">            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi</span>
<span class="line">          <span class="token key atrule">limits</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 1000m</span>
<span class="line">            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 2Gi</span>
<span class="line">      <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>config</span>
<span class="line">        <span class="token key atrule">configMap</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>config</span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>storage</span>
<span class="line">        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>pvc</span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>monitoring</span>
<span class="line">  <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</span>
<span class="line">  <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9090</span></span>
<span class="line">    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9090</span></span>
<span class="line">    <span class="token key atrule">name</span><span class="token punctuation">:</span> web</span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> prometheus</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”„-å¤‡ä»½å’Œæ¢å¤" tabindex="-1"><a class="header-anchor" href="#ğŸ”„-å¤‡ä»½å’Œæ¢å¤">#</a> ğŸ”„ å¤‡ä»½å’Œæ¢å¤</h2>
<h3 id="æ•°æ®åº“å¤‡ä»½cronjob" tabindex="-1"><a class="header-anchor" href="#æ•°æ®åº“å¤‡ä»½cronjob">#</a> æ•°æ®åº“å¤‡ä»½CronJob</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># backup-cronjob.yaml</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> postgres<span class="token punctuation">-</span>backup</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">"0 2 * * *"</span>  <span class="token comment"># æ¯å¤©å‡Œæ™¨2ç‚¹</span></span>
<span class="line">  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">template</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">containers</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> postgres<span class="token punctuation">-</span>backup</span>
<span class="line">            <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span>15<span class="token punctuation">-</span>alpine</span>
<span class="line">            <span class="token key atrule">command</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> /bin/bash</span>
<span class="line">            <span class="token punctuation">-</span> <span class="token punctuation">-</span>c</span>
<span class="line">            <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">              set -e</span>
<span class="line">              BACKUP_FILE="/backup/postgres_$(date +%Y%m%d_%H%M%S).sql.gz"</span>
<span class="line">              echo "å¼€å§‹å¤‡ä»½åˆ° $BACKUP_FILE"</span>
<span class="line">              pg_dump -h vgo-postgres -U $POSTGRES_USER -d $POSTGRES_DB | gzip > $BACKUP_FILE</span>
<span class="line">              echo "å¤‡ä»½å®Œæˆ"</span></span>
<span class="line">              </span>
<span class="line">              <span class="token comment"># æ¸…ç†7å¤©å‰çš„å¤‡ä»½</span></span>
<span class="line">              find /backup <span class="token punctuation">-</span>name "postgres_<span class="token important">*.sql.gz"</span> <span class="token punctuation">-</span>mtime +7 <span class="token punctuation">-</span>delete</span>
<span class="line">              echo "æ¸…ç†å®Œæˆ"</span>
<span class="line">            <span class="token key atrule">env</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_USER</span>
<span class="line">              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span></span>
<span class="line">                  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>database<span class="token punctuation">-</span>secret</span>
<span class="line">                  <span class="token key atrule">key</span><span class="token punctuation">:</span> username</span>
<span class="line">            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_DB</span>
<span class="line">              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span></span>
<span class="line">                  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>database<span class="token punctuation">-</span>secret</span>
<span class="line">                  <span class="token key atrule">key</span><span class="token punctuation">:</span> database</span>
<span class="line">            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PGPASSWORD</span>
<span class="line">              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span></span>
<span class="line">                  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>database<span class="token punctuation">-</span>secret</span>
<span class="line">                  <span class="token key atrule">key</span><span class="token punctuation">:</span> password</span>
<span class="line">            <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> backup<span class="token punctuation">-</span>storage</span>
<span class="line">              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /backup</span>
<span class="line">          <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> backup<span class="token punctuation">-</span>storage</span>
<span class="line">            <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">claimName</span><span class="token punctuation">:</span> backup<span class="token punctuation">-</span>pvc</span>
<span class="line">          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure</span>
<span class="line">  <span class="token key atrule">successfulJobsHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">  <span class="token key atrule">failedJobsHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">1</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å¤‡ä»½å­˜å‚¨pvc" tabindex="-1"><a class="header-anchor" href="#å¤‡ä»½å­˜å‚¨pvc">#</a> å¤‡ä»½å­˜å‚¨PVC</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># backup-pvc.yaml</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> backup<span class="token punctuation">-</span>pvc</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> ReadWriteOnce</span>
<span class="line">  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>standard</span>
<span class="line">  <span class="token key atrule">resources</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">requests</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 100Gi</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”§-æ•…éšœæ’é™¤" tabindex="-1"><a class="header-anchor" href="#ğŸ”§-æ•…éšœæ’é™¤">#</a> ğŸ”§ æ•…éšœæ’é™¤</h2>
<h3 id="å¸¸è§é—®é¢˜è¯Šæ–­" tabindex="-1"><a class="header-anchor" href="#å¸¸è§é—®é¢˜è¯Šæ–­">#</a> å¸¸è§é—®é¢˜è¯Šæ–­</h3>
<h4 id="_1-podå¯åŠ¨å¤±è´¥" tabindex="-1"><a class="header-anchor" href="#_1-podå¯åŠ¨å¤±è´¥">#</a> 1. Podå¯åŠ¨å¤±è´¥</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># æŸ¥çœ‹PodçŠ¶æ€</span></span>
<span class="line">kubectl get pods <span class="token parameter variable">-n</span> vgo-system</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹Podè¯¦ç»†ä¿¡æ¯</span></span>
<span class="line">kubectl describe pod <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> <span class="token parameter variable">-n</span> vgo-system</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹Podæ—¥å¿—</span></span>
<span class="line">kubectl logs <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> <span class="token parameter variable">-n</span> vgo-system</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹å‰ä¸€ä¸ªå®¹å™¨çš„æ—¥å¿—</span></span>
<span class="line">kubectl logs <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> <span class="token parameter variable">-n</span> vgo-system <span class="token parameter variable">--previous</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># è¿›å…¥Podè°ƒè¯•</span></span>
<span class="line">kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token operator">&lt;</span>pod-name<span class="token operator">></span> <span class="token parameter variable">-n</span> vgo-system -- /bin/sh</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-æœåŠ¡è¿æ¥é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#_2-æœåŠ¡è¿æ¥é—®é¢˜">#</a> 2. æœåŠ¡è¿æ¥é—®é¢˜</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># æµ‹è¯•æœåŠ¡è¿é€šæ€§</span></span>
<span class="line">kubectl run test-pod <span class="token parameter variable">--image</span><span class="token operator">=</span>busybox <span class="token parameter variable">--rm</span> <span class="token parameter variable">-it</span> <span class="token parameter variable">--restart</span><span class="token operator">=</span>Never -- <span class="token function">nslookup</span> vgo-iam.vgo-system.svc.cluster.local</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æµ‹è¯•ç«¯å£è¿é€šæ€§</span></span>
<span class="line">kubectl run test-pod <span class="token parameter variable">--image</span><span class="token operator">=</span>busybox <span class="token parameter variable">--rm</span> <span class="token parameter variable">-it</span> <span class="token parameter variable">--restart</span><span class="token operator">=</span>Never -- telnet vgo-iam.vgo-system.svc.cluster.local <span class="token number">8080</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹æœåŠ¡ç«¯ç‚¹</span></span>
<span class="line">kubectl get endpoints <span class="token parameter variable">-n</span> vgo-system</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹æœåŠ¡è¯¦æƒ…</span></span>
<span class="line">kubectl describe svc vgo-iam <span class="token parameter variable">-n</span> vgo-system</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-å­˜å‚¨é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#_3-å­˜å‚¨é—®é¢˜">#</a> 3. å­˜å‚¨é—®é¢˜</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># æŸ¥çœ‹PVCçŠ¶æ€</span></span>
<span class="line">kubectl get pvc <span class="token parameter variable">-n</span> vgo-system</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹PVçŠ¶æ€</span></span>
<span class="line">kubectl get <span class="token function">pv</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹å­˜å‚¨ç±»</span></span>
<span class="line">kubectl get storageclass</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹PVCè¯¦æƒ…</span></span>
<span class="line">kubectl describe pvc postgres-data-vgo-postgres-0 <span class="token parameter variable">-n</span> vgo-system</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ€§èƒ½è°ƒä¼˜" tabindex="-1"><a class="header-anchor" href="#æ€§èƒ½è°ƒä¼˜">#</a> æ€§èƒ½è°ƒä¼˜</h3>
<h4 id="èµ„æºç›‘æ§" tabindex="-1"><a class="header-anchor" href="#èµ„æºç›‘æ§">#</a> èµ„æºç›‘æ§</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># æŸ¥çœ‹èŠ‚ç‚¹èµ„æºä½¿ç”¨</span></span>
<span class="line">kubectl <span class="token function">top</span> nodes</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹Podèµ„æºä½¿ç”¨</span></span>
<span class="line">kubectl <span class="token function">top</span> pods <span class="token parameter variable">-n</span> vgo-system</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨</span></span>
<span class="line">kubectl <span class="token function">top</span> pods <span class="token parameter variable">-n</span> vgo-system <span class="token parameter variable">--containers</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ€§èƒ½åˆ†æ" tabindex="-1"><a class="header-anchor" href="#æ€§èƒ½åˆ†æ">#</a> æ€§èƒ½åˆ†æ</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># å¯ç”¨æ€§èƒ½åˆ†æ</span></span>
<span class="line">kubectl port-forward svc/vgo-iam <span class="token number">8082</span>:8082 <span class="token parameter variable">-n</span> vgo-system <span class="token operator">&amp;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># CPUåˆ†æ</span></span>
<span class="line"><span class="token function">curl</span> http://localhost:8082/debug/pprof/profile?seconds<span class="token operator">=</span><span class="token number">30</span> <span class="token operator">></span> cpu.prof</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å†…å­˜åˆ†æ</span></span>
<span class="line"><span class="token function">curl</span> http://localhost:8082/debug/pprof/heap <span class="token operator">></span> heap.prof</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹goroutine</span></span>
<span class="line"><span class="token function">curl</span> http://localhost:8082/debug/pprof/goroutine?debug<span class="token operator">=</span><span class="token number">1</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“ˆ-æ‰©å±•å’Œå‡çº§" tabindex="-1"><a class="header-anchor" href="#ğŸ“ˆ-æ‰©å±•å’Œå‡çº§">#</a> ğŸ“ˆ æ‰©å±•å’Œå‡çº§</h2>
<h3 id="æ»šåŠ¨æ›´æ–°" tabindex="-1"><a class="header-anchor" href="#æ»šåŠ¨æ›´æ–°">#</a> æ»šåŠ¨æ›´æ–°</h3>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># æ›´æ–°é•œåƒ</span></span>
<span class="line">kubectl <span class="token builtin class-name">set</span> image deployment/vgo-iam <span class="token assign-left variable">iam</span><span class="token operator">=</span>vgo/iam:v1.1.0 <span class="token parameter variable">-n</span> vgo-system</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹æ›´æ–°çŠ¶æ€</span></span>
<span class="line">kubectl rollout status deployment/vgo-iam <span class="token parameter variable">-n</span> vgo-system</span>
<span class="line"></span>
<span class="line"><span class="token comment"># æŸ¥çœ‹æ›´æ–°å†å²</span></span>
<span class="line">kubectl rollout <span class="token function">history</span> deployment/vgo-iam <span class="token parameter variable">-n</span> vgo-system</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬</span></span>
<span class="line">kubectl rollout undo deployment/vgo-iam <span class="token parameter variable">-n</span> vgo-system</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬</span></span>
<span class="line">kubectl rollout undo deployment/vgo-iam --to-revision<span class="token operator">=</span><span class="token number">2</span> <span class="token parameter variable">-n</span> vgo-system</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è“ç»¿éƒ¨ç½²" tabindex="-1"><a class="header-anchor" href="#è“ç»¿éƒ¨ç½²">#</a> è“ç»¿éƒ¨ç½²</h3>
<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre v-pre><code class="language-yaml"><span class="line"><span class="token comment"># blue-green-deployment.yaml</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Rollout</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam<span class="token punctuation">-</span>rollout</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>system</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span></span>
<span class="line">  <span class="token key atrule">strategy</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">blueGreen</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">activeService</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam<span class="token punctuation">-</span>active</span>
<span class="line">      <span class="token key atrule">previewService</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam<span class="token punctuation">-</span>preview</span>
<span class="line">      <span class="token key atrule">autoPromotionEnabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></span>
<span class="line">      <span class="token key atrule">scaleDownDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span></span>
<span class="line">      <span class="token key atrule">prePromotionAnalysis</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">templates</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">templateName</span><span class="token punctuation">:</span> success<span class="token punctuation">-</span>rate</span>
<span class="line">        <span class="token key atrule">args</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>name</span>
<span class="line">          <span class="token key atrule">value</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam<span class="token punctuation">-</span>preview.vgo<span class="token punctuation">-</span>system.svc.cluster.local</span>
<span class="line">      <span class="token key atrule">postPromotionAnalysis</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">templates</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">templateName</span><span class="token punctuation">:</span> success<span class="token punctuation">-</span>rate</span>
<span class="line">        <span class="token key atrule">args</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>name</span>
<span class="line">          <span class="token key atrule">value</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam<span class="token punctuation">-</span>active.vgo<span class="token punctuation">-</span>system.svc.cluster.local</span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">  <span class="token key atrule">template</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">app</span><span class="token punctuation">:</span> vgo<span class="token punctuation">-</span>iam</span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">containers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> iam</span>
<span class="line">        <span class="token key atrule">image</span><span class="token punctuation">:</span> vgo/iam<span class="token punctuation">:</span>v1.1.0</span>
<span class="line">        <span class="token comment"># ... å…¶ä»–é…ç½®</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ“š-ç›¸å…³æ–‡æ¡£" tabindex="-1"><a class="header-anchor" href="#ğŸ“š-ç›¸å…³æ–‡æ¡£">#</a> ğŸ“š ç›¸å…³æ–‡æ¡£</h2>
<ul>
<li><RouteLink to="/deployment/docker-compose.html">Docker Composeéƒ¨ç½²</RouteLink> - ç®€å•éƒ¨ç½²æ–¹æ¡ˆ</li>
<li><RouteLink to="/deployment/monitoring.html">ç›‘æ§é…ç½®</RouteLink> - å®Œæ•´ç›‘æ§è§£å†³æ–¹æ¡ˆ</li>
<li><RouteLink to="/deployment/security.html">å®‰å…¨é…ç½®</RouteLink> - ç”Ÿäº§ç¯å¢ƒå®‰å…¨</li>
<li><RouteLink to="/deployment/troubleshooting.html">æ•…éšœæ’é™¤</RouteLink> - é—®é¢˜è¯Šæ–­æŒ‡å—</li>
<li><RouteLink to="/deployment/performance.html">æ€§èƒ½è°ƒä¼˜</RouteLink> - æ€§èƒ½ä¼˜åŒ–å»ºè®®</li>
</ul>
<hr>
<div class="hint-container tip">
<p class="hint-container-title">æç¤º</p>
<p>Kuberneteséƒ¨ç½²é€‚åˆå¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒï¼Œå»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯é…ç½®ã€‚</p>
</div>
<div class="hint-container warning">
<p class="hint-container-title">æ³¨æ„</p>
<p>ç”Ÿäº§ç¯å¢ƒè¯·åŠ¡å¿…é…ç½®é€‚å½“çš„èµ„æºé™åˆ¶ã€ç½‘ç»œç­–ç•¥å’Œå®‰å…¨ç­–ç•¥ã€‚</p>
</div>
</div></template>


