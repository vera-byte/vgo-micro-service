<template><div><h1 id="æƒé™éªŒè¯-api" tabindex="-1"><a class="header-anchor" href="#æƒé™éªŒè¯-api">#</a> æƒé™éªŒè¯ API</h1>
<p>æƒé™éªŒè¯APIæ˜¯VGOå¾®æœåŠ¡çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œæä¾›äº†çµæ´»å¼ºå¤§çš„æƒé™éªŒè¯æœºåˆ¶ã€‚æ”¯æŒåŸºäºç­–ç•¥çš„è®¿é—®æ§åˆ¶ï¼ˆPBACï¼‰ï¼Œå¯ä»¥éªŒè¯ç”¨æˆ·å¯¹ç‰¹å®šèµ„æºçš„æ“ä½œæƒé™ã€‚</p>
<h2 id="ğŸ“‹-api-æ¦‚è§ˆ" tabindex="-1"><a class="header-anchor" href="#ğŸ“‹-api-æ¦‚è§ˆ">#</a> ğŸ“‹ API æ¦‚è§ˆ</h2>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>æè¿°</th>
<th>æƒé™è¦æ±‚</th>
</tr>
</thead>
<tbody>
<tr>
<td><code v-pre>CheckPermission</code></td>
<td>æ£€æŸ¥å•ä¸ªæƒé™</td>
<td><code v-pre>iam:CheckPermission</code></td>
</tr>
<tr>
<td><code v-pre>CheckPermissions</code></td>
<td>æ‰¹é‡æ£€æŸ¥æƒé™</td>
<td><code v-pre>iam:CheckPermissions</code></td>
</tr>
<tr>
<td><code v-pre>GetEffectivePermissions</code></td>
<td>è·å–æœ‰æ•ˆæƒé™</td>
<td><code v-pre>iam:GetEffectivePermissions</code></td>
</tr>
<tr>
<td><code v-pre>SimulatePermission</code></td>
<td>æ¨¡æ‹Ÿæƒé™æ£€æŸ¥</td>
<td><code v-pre>iam:SimulatePermission</code></td>
</tr>
</tbody>
</table>
<h2 id="ğŸ”§-api-è¯¦æƒ…" tabindex="-1"><a class="header-anchor" href="#ğŸ”§-api-è¯¦æƒ…">#</a> ğŸ”§ API è¯¦æƒ…</h2>
<h3 id="checkpermission-æ£€æŸ¥å•ä¸ªæƒé™" tabindex="-1"><a class="header-anchor" href="#checkpermission-æ£€æŸ¥å•ä¸ªæƒé™">#</a> CheckPermission - æ£€æŸ¥å•ä¸ªæƒé™</h3>
<p>æ£€æŸ¥æŒ‡å®šç”¨æˆ·æ˜¯å¦æœ‰æƒé™æ‰§è¡Œç‰¹å®šæ“ä½œã€‚</p>
<h4 id="è¯·æ±‚" tabindex="-1"><a class="header-anchor" href="#è¯·æ±‚">#</a> è¯·æ±‚</h4>
<div class="language-protobuf line-numbers-mode" data-highlighter="prismjs" data-ext="protobuf"><pre v-pre><code class="language-protobuf"><span class="line"><span class="token keyword">message</span> <span class="token class-name">CheckPermissionRequest</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">string</span> user_name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment">// ç”¨æˆ·åï¼ˆå¿…éœ€ï¼‰</span></span>
<span class="line">  <span class="token builtin">string</span> action <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>            <span class="token comment">// æ“ä½œåŠ¨ä½œï¼ˆå¿…éœ€ï¼‰</span></span>
<span class="line">  <span class="token builtin">string</span> resource <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>          <span class="token comment">// èµ„æºARNï¼ˆå¿…éœ€ï¼‰</span></span>
<span class="line">  <span class="token map class-name">map<span class="token punctuation">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">></span></span> context <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å“åº”" tabindex="-1"><a class="header-anchor" href="#å“åº”">#</a> å“åº”</h4>
<div class="language-protobuf line-numbers-mode" data-highlighter="prismjs" data-ext="protobuf"><pre v-pre><code class="language-protobuf"><span class="line"><span class="token keyword">message</span> <span class="token class-name">CheckPermissionResponse</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">bool</span> allowed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>             <span class="token comment">// æ˜¯å¦å…è®¸</span></span>
<span class="line">  <span class="token builtin">string</span> decision <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>          <span class="token comment">// å†³ç­–ç»“æœï¼ˆAllow/Deny/NotApplicableï¼‰</span></span>
<span class="line">  <span class="token keyword">repeated</span> <span class="token builtin">string</span> matched_policies <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token comment">// åŒ¹é…çš„ç­–ç•¥åˆ—è¡¨</span></span>
<span class="line">  <span class="token builtin">string</span> reason <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>            <span class="token comment">// å†³ç­–åŸå› </span></span>
<span class="line">  <span class="token map class-name">map<span class="token punctuation">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">></span></span> context <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>      <span class="token comment">// è¯„ä¼°ä¸Šä¸‹æ–‡</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹">#</a> ç¤ºä¾‹</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># æ£€æŸ¥ç”¨æˆ·è¯»å–æ–‡ä»¶æƒé™</span></span>
<span class="line">grpcurl <span class="token parameter variable">-plaintext</span> <span class="token parameter variable">-d</span> <span class="token string">'{</span>
<span class="line">  "user_name": "john_doe",</span>
<span class="line">  "action": "s3:GetObject",</span>
<span class="line">  "resource": "arn:aws:s3:::my-bucket/documents/file.txt"</span>
<span class="line">}'</span> localhost:50051 iam.v1.IAM/CheckPermission</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># å¸¦ä¸Šä¸‹æ–‡çš„æƒé™æ£€æŸ¥</span></span>
<span class="line">grpcurl <span class="token parameter variable">-plaintext</span> <span class="token parameter variable">-d</span> <span class="token string">'{</span>
<span class="line">  "user_name": "john_doe",</span>
<span class="line">  "action": "iam:UpdateUser",</span>
<span class="line">  "resource": "arn:iam::user/jane_doe",</span>
<span class="line">  "context": {</span>
<span class="line">    "aws:RequestedRegion": "us-east-1",</span>
<span class="line">    "aws:CurrentTime": "2024-01-15T10:30:00Z",</span>
<span class="line">    "aws:SourceIp": "192.168.1.100"</span>
<span class="line">  }</span>
<span class="line">}'</span> localhost:50051 iam.v1.IAM/CheckPermission</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å“åº”ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#å“åº”ç¤ºä¾‹">#</a> å“åº”ç¤ºä¾‹</h4>
<div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre v-pre><code class="language-json"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">"allowed"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"decision"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"matched_policies"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">"S3ReadOnlyPolicy"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">"DocumentAccessPolicy"</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"reason"</span><span class="token operator">:</span> <span class="token string">"ç”¨æˆ·å…·æœ‰S3è¯»å–æƒé™ï¼Œä¸”èµ„æºåŒ¹é…ç­–ç•¥æ¡ä»¶"</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"context"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">"evaluated_at"</span><span class="token operator">:</span> <span class="token string">"2024-01-15T10:30:00Z"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">"policy_version"</span><span class="token operator">:</span> <span class="token string">"2025-01-01"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">"evaluation_time_ms"</span><span class="token operator">:</span> <span class="token string">"15"</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="é”™è¯¯æƒ…å†µ" tabindex="-1"><a class="header-anchor" href="#é”™è¯¯æƒ…å†µ">#</a> é”™è¯¯æƒ…å†µ</h4>
<table>
<thead>
<tr>
<th>é”™è¯¯ç </th>
<th>è¯´æ˜</th>
<th>è§£å†³æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code v-pre>NOT_FOUND</code></td>
<td>ç”¨æˆ·ä¸å­˜åœ¨</td>
<td>ç¡®è®¤ç”¨æˆ·åæ­£ç¡®</td>
</tr>
<tr>
<td><code v-pre>INVALID_ARGUMENT</code></td>
<td>æ— æ•ˆçš„èµ„æºARN</td>
<td>æ£€æŸ¥ARNæ ¼å¼</td>
</tr>
<tr>
<td><code v-pre>INVALID_ARGUMENT</code></td>
<td>æ— æ•ˆçš„æ“ä½œåŠ¨ä½œ</td>
<td>ä½¿ç”¨æœ‰æ•ˆçš„æ“ä½œåç§°</td>
</tr>
<tr>
<td><code v-pre>PERMISSION_DENIED</code></td>
<td>æ— æƒé™éªŒè¯æƒé™</td>
<td>ç¡®ä¿æœ‰<code v-pre>iam:CheckPermission</code>æƒé™</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="checkpermissions-æ‰¹é‡æ£€æŸ¥æƒé™" tabindex="-1"><a class="header-anchor" href="#checkpermissions-æ‰¹é‡æ£€æŸ¥æƒé™">#</a> CheckPermissions - æ‰¹é‡æ£€æŸ¥æƒé™</h3>
<p>ä¸€æ¬¡æ€§æ£€æŸ¥å¤šä¸ªæƒé™ï¼Œæé«˜æ•ˆç‡ã€‚</p>
<h4 id="è¯·æ±‚-1" tabindex="-1"><a class="header-anchor" href="#è¯·æ±‚-1">#</a> è¯·æ±‚</h4>
<div class="language-protobuf line-numbers-mode" data-highlighter="prismjs" data-ext="protobuf"><pre v-pre><code class="language-protobuf"><span class="line"><span class="token keyword">message</span> <span class="token class-name">CheckPermissionsRequest</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">string</span> user_name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment">// ç”¨æˆ·åï¼ˆå¿…éœ€ï¼‰</span></span>
<span class="line">  <span class="token keyword">repeated</span> <span class="token positional-class-name class-name">PermissionCheck</span> checks <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// æƒé™æ£€æŸ¥åˆ—è¡¨</span></span>
<span class="line">  <span class="token map class-name">map<span class="token punctuation">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">></span></span> context <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>      <span class="token comment">// å…¨å±€ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">message</span> <span class="token class-name">PermissionCheck</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">string</span> action <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token comment">// æ“ä½œåŠ¨ä½œ</span></span>
<span class="line">  <span class="token builtin">string</span> resource <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>          <span class="token comment">// èµ„æºARN</span></span>
<span class="line">  <span class="token map class-name">map<span class="token punctuation">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">></span></span> context <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>      <span class="token comment">// ç‰¹å®šä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼‰</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å“åº”-1" tabindex="-1"><a class="header-anchor" href="#å“åº”-1">#</a> å“åº”</h4>
<div class="language-protobuf line-numbers-mode" data-highlighter="prismjs" data-ext="protobuf"><pre v-pre><code class="language-protobuf"><span class="line"><span class="token keyword">message</span> <span class="token class-name">CheckPermissionsResponse</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">repeated</span> <span class="token positional-class-name class-name">PermissionResult</span> results <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// æƒé™æ£€æŸ¥ç»“æœåˆ—è¡¨</span></span>
<span class="line">  <span class="token map class-name">map<span class="token punctuation">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">></span></span> context <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token comment">// è¯„ä¼°ä¸Šä¸‹æ–‡</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">message</span> <span class="token class-name">PermissionResult</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">string</span> action <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token comment">// æ“ä½œåŠ¨ä½œ</span></span>
<span class="line">  <span class="token builtin">string</span> resource <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>          <span class="token comment">// èµ„æºARN</span></span>
<span class="line">  <span class="token builtin">bool</span> allowed <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>             <span class="token comment">// æ˜¯å¦å…è®¸</span></span>
<span class="line">  <span class="token builtin">string</span> decision <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>          <span class="token comment">// å†³ç­–ç»“æœ</span></span>
<span class="line">  <span class="token keyword">repeated</span> <span class="token builtin">string</span> matched_policies <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>  <span class="token comment">// åŒ¹é…çš„ç­–ç•¥</span></span>
<span class="line">  <span class="token builtin">string</span> reason <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>            <span class="token comment">// å†³ç­–åŸå› </span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç¤ºä¾‹-1" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-1">#</a> ç¤ºä¾‹</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># æ‰¹é‡æ£€æŸ¥å¤šä¸ªæƒé™</span></span>
<span class="line">grpcurl <span class="token parameter variable">-plaintext</span> <span class="token parameter variable">-d</span> <span class="token string">'{</span>
<span class="line">  "user_name": "john_doe",</span>
<span class="line">  "checks": [</span>
<span class="line">    {</span>
<span class="line">      "action": "s3:GetObject",</span>
<span class="line">      "resource": "arn:aws:s3:::my-bucket/file1.txt"</span>
<span class="line">    },</span>
<span class="line">    {</span>
<span class="line">      "action": "s3:PutObject",</span>
<span class="line">      "resource": "arn:aws:s3:::my-bucket/file2.txt"</span>
<span class="line">    },</span>
<span class="line">    {</span>
<span class="line">      "action": "iam:ListUsers",</span>
<span class="line">      "resource": "arn:iam::user/*"</span>
<span class="line">    }</span>
<span class="line">  ],</span>
<span class="line">  "context": {</span>
<span class="line">    "aws:RequestedRegion": "us-east-1",</span>
<span class="line">    "aws:SourceIp": "192.168.1.100"</span>
<span class="line">  }</span>
<span class="line">}'</span> localhost:50051 iam.v1.IAM/CheckPermissions</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å“åº”ç¤ºä¾‹-1" tabindex="-1"><a class="header-anchor" href="#å“åº”ç¤ºä¾‹-1">#</a> å“åº”ç¤ºä¾‹</h4>
<div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre v-pre><code class="language-json"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">"results"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"arn:aws:s3:::my-bucket/file1.txt"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"allowed"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"decision"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"matched_policies"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"S3ReadOnlyPolicy"</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"reason"</span><span class="token operator">:</span> <span class="token string">"ç”¨æˆ·å…·æœ‰S3è¯»å–æƒé™"</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"s3:PutObject"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"arn:aws:s3:::my-bucket/file2.txt"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"allowed"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"decision"</span><span class="token operator">:</span> <span class="token string">"Deny"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"matched_policies"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"reason"</span><span class="token operator">:</span> <span class="token string">"ç”¨æˆ·æ²¡æœ‰S3å†™å…¥æƒé™"</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"iam:ListUsers"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"arn:iam::user/*"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"allowed"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"decision"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"matched_policies"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"IAMReadOnlyPolicy"</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"reason"</span><span class="token operator">:</span> <span class="token string">"ç”¨æˆ·å…·æœ‰IAMåªè¯»æƒé™"</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"context"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">"evaluated_at"</span><span class="token operator">:</span> <span class="token string">"2024-01-15T10:30:00Z"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">"total_checks"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">"evaluation_time_ms"</span><span class="token operator">:</span> <span class="token string">"25"</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="é”™è¯¯æƒ…å†µ-1" tabindex="-1"><a class="header-anchor" href="#é”™è¯¯æƒ…å†µ-1">#</a> é”™è¯¯æƒ…å†µ</h4>
<table>
<thead>
<tr>
<th>é”™è¯¯ç </th>
<th>è¯´æ˜</th>
<th>è§£å†³æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code v-pre>NOT_FOUND</code></td>
<td>ç”¨æˆ·ä¸å­˜åœ¨</td>
<td>ç¡®è®¤ç”¨æˆ·åæ­£ç¡®</td>
</tr>
<tr>
<td><code v-pre>INVALID_ARGUMENT</code></td>
<td>æ£€æŸ¥åˆ—è¡¨ä¸ºç©º</td>
<td>æä¾›è‡³å°‘ä¸€ä¸ªæƒé™æ£€æŸ¥</td>
</tr>
<tr>
<td><code v-pre>INVALID_ARGUMENT</code></td>
<td>æ£€æŸ¥æ•°é‡è¶…é™</td>
<td>å‡å°‘å•æ¬¡æ£€æŸ¥çš„æ•°é‡ï¼ˆæœ€å¤§100ä¸ªï¼‰</td>
</tr>
<tr>
<td><code v-pre>PERMISSION_DENIED</code></td>
<td>æ— æƒé™éªŒè¯æƒé™</td>
<td>ç¡®ä¿æœ‰<code v-pre>iam:CheckPermissions</code>æƒé™</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="geteffectivepermissions-è·å–æœ‰æ•ˆæƒé™" tabindex="-1"><a class="header-anchor" href="#geteffectivepermissions-è·å–æœ‰æ•ˆæƒé™">#</a> GetEffectivePermissions - è·å–æœ‰æ•ˆæƒé™</h3>
<p>è·å–ç”¨æˆ·å¯¹ç‰¹å®šèµ„æºçš„æ‰€æœ‰æœ‰æ•ˆæƒé™ã€‚</p>
<h4 id="è¯·æ±‚-2" tabindex="-1"><a class="header-anchor" href="#è¯·æ±‚-2">#</a> è¯·æ±‚</h4>
<div class="language-protobuf line-numbers-mode" data-highlighter="prismjs" data-ext="protobuf"><pre v-pre><code class="language-protobuf"><span class="line"><span class="token keyword">message</span> <span class="token class-name">GetEffectivePermissionsRequest</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">string</span> user_name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment">// ç”¨æˆ·åï¼ˆå¿…éœ€ï¼‰</span></span>
<span class="line">  <span class="token builtin">string</span> resource_prefix <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>   <span class="token comment">// èµ„æºå‰ç¼€ï¼ˆå¯é€‰ï¼‰</span></span>
<span class="line">  <span class="token keyword">repeated</span> <span class="token builtin">string</span> actions <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token comment">// æ“ä½œè¿‡æ»¤ï¼ˆå¯é€‰ï¼‰</span></span>
<span class="line">  <span class="token map class-name">map<span class="token punctuation">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">></span></span> context <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å“åº”-2" tabindex="-1"><a class="header-anchor" href="#å“åº”-2">#</a> å“åº”</h4>
<div class="language-protobuf line-numbers-mode" data-highlighter="prismjs" data-ext="protobuf"><pre v-pre><code class="language-protobuf"><span class="line"><span class="token keyword">message</span> <span class="token class-name">GetEffectivePermissionsResponse</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">repeated</span> <span class="token positional-class-name class-name">EffectivePermission</span> permissions <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// æœ‰æ•ˆæƒé™åˆ—è¡¨</span></span>
<span class="line">  <span class="token keyword">repeated</span> <span class="token builtin">string</span> policies <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                  <span class="token comment">// ç›¸å…³ç­–ç•¥åˆ—è¡¨</span></span>
<span class="line">  <span class="token map class-name">map<span class="token punctuation">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">></span></span> context <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>               <span class="token comment">// è¯„ä¼°ä¸Šä¸‹æ–‡</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">message</span> <span class="token class-name">EffectivePermission</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">string</span> action <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token comment">// æ“ä½œåŠ¨ä½œ</span></span>
<span class="line">  <span class="token builtin">string</span> resource <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>          <span class="token comment">// èµ„æºARN</span></span>
<span class="line">  <span class="token builtin">string</span> effect <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>            <span class="token comment">// æ•ˆæœï¼ˆAllow/Denyï¼‰</span></span>
<span class="line">  <span class="token builtin">string</span> source_policy <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>     <span class="token comment">// æ¥æºç­–ç•¥</span></span>
<span class="line">  <span class="token keyword">repeated</span> <span class="token builtin">string</span> conditions <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>  <span class="token comment">// æ¡ä»¶åˆ—è¡¨</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç¤ºä¾‹-2" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-2">#</a> ç¤ºä¾‹</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># è·å–ç”¨æˆ·å¯¹S3çš„æ‰€æœ‰æƒé™</span></span>
<span class="line">grpcurl <span class="token parameter variable">-plaintext</span> <span class="token parameter variable">-d</span> <span class="token string">'{</span>
<span class="line">  "user_name": "john_doe",</span>
<span class="line">  "resource_prefix": "arn:aws:s3:::",</span>
<span class="line">  "actions": ["s3:GetObject", "s3:PutObject", "s3:DeleteObject"]</span>
<span class="line">}'</span> localhost:50051 iam.v1.IAM/GetEffectivePermissions</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># è·å–ç”¨æˆ·çš„æ‰€æœ‰IAMæƒé™</span></span>
<span class="line">grpcurl <span class="token parameter variable">-plaintext</span> <span class="token parameter variable">-d</span> <span class="token string">'{</span>
<span class="line">  "user_name": "admin_user",</span>
<span class="line">  "resource_prefix": "arn:iam::"</span>
<span class="line">}'</span> localhost:50051 iam.v1.IAM/GetEffectivePermissions</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å“åº”ç¤ºä¾‹-2" tabindex="-1"><a class="header-anchor" href="#å“åº”ç¤ºä¾‹-2">#</a> å“åº”ç¤ºä¾‹</h4>
<div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre v-pre><code class="language-json"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">"permissions"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"arn:aws:s3:::my-bucket/*"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"source_policy"</span><span class="token operator">:</span> <span class="token string">"S3ReadOnlyPolicy"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"conditions"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">"StringEquals: aws:RequestedRegion = us-east-1"</span></span>
<span class="line">      <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"s3:PutObject"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"arn:aws:s3:::my-bucket/uploads/*"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"source_policy"</span><span class="token operator">:</span> <span class="token string">"S3UploadPolicy"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"conditions"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">"StringLike: aws:userid = john_doe"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"DateGreaterThan: aws:CurrentTime = 2024-01-01T00:00:00Z"</span></span>
<span class="line">      <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"s3:DeleteObject"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"arn:aws:s3:::my-bucket/sensitive/*"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"effect"</span><span class="token operator">:</span> <span class="token string">"Deny"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"source_policy"</span><span class="token operator">:</span> <span class="token string">"S3ProtectionPolicy"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"conditions"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"policies"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">"S3ReadOnlyPolicy"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">"S3UploadPolicy"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">"S3ProtectionPolicy"</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"context"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">"evaluated_at"</span><span class="token operator">:</span> <span class="token string">"2024-01-15T10:30:00Z"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">"total_permissions"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">"evaluation_time_ms"</span><span class="token operator">:</span> <span class="token string">"45"</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="é”™è¯¯æƒ…å†µ-2" tabindex="-1"><a class="header-anchor" href="#é”™è¯¯æƒ…å†µ-2">#</a> é”™è¯¯æƒ…å†µ</h4>
<table>
<thead>
<tr>
<th>é”™è¯¯ç </th>
<th>è¯´æ˜</th>
<th>è§£å†³æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code v-pre>NOT_FOUND</code></td>
<td>ç”¨æˆ·ä¸å­˜åœ¨</td>
<td>ç¡®è®¤ç”¨æˆ·åæ­£ç¡®</td>
</tr>
<tr>
<td><code v-pre>INVALID_ARGUMENT</code></td>
<td>æ— æ•ˆçš„èµ„æºå‰ç¼€</td>
<td>æ£€æŸ¥ARNå‰ç¼€æ ¼å¼</td>
</tr>
<tr>
<td><code v-pre>PERMISSION_DENIED</code></td>
<td>æ— è·å–æƒé™æƒé™</td>
<td>ç¡®ä¿æœ‰<code v-pre>iam:GetEffectivePermissions</code>æƒé™</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="simulatepermission-æ¨¡æ‹Ÿæƒé™æ£€æŸ¥" tabindex="-1"><a class="header-anchor" href="#simulatepermission-æ¨¡æ‹Ÿæƒé™æ£€æŸ¥">#</a> SimulatePermission - æ¨¡æ‹Ÿæƒé™æ£€æŸ¥</h3>
<p>æ¨¡æ‹Ÿæƒé™æ£€æŸ¥ï¼Œç”¨äºæµ‹è¯•å’Œè°ƒè¯•ç­–ç•¥ã€‚</p>
<h4 id="è¯·æ±‚-3" tabindex="-1"><a class="header-anchor" href="#è¯·æ±‚-3">#</a> è¯·æ±‚</h4>
<div class="language-protobuf line-numbers-mode" data-highlighter="prismjs" data-ext="protobuf"><pre v-pre><code class="language-protobuf"><span class="line"><span class="token keyword">message</span> <span class="token class-name">SimulatePermissionRequest</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">string</span> user_name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment">// ç”¨æˆ·åï¼ˆå¿…éœ€ï¼‰</span></span>
<span class="line">  <span class="token keyword">repeated</span> <span class="token builtin">string</span> policy_arns <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>      <span class="token comment">// ç­–ç•¥ARNåˆ—è¡¨ï¼ˆå¯é€‰ï¼‰</span></span>
<span class="line">  <span class="token keyword">repeated</span> <span class="token positional-class-name class-name">PermissionCheck</span> checks <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>  <span class="token comment">// æƒé™æ£€æŸ¥åˆ—è¡¨</span></span>
<span class="line">  <span class="token map class-name">map<span class="token punctuation">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">></span></span> context <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>      <span class="token comment">// ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</span></span>
<span class="line">  <span class="token builtin">bool</span> detailed_evaluation <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>         <span class="token comment">// è¯¦ç»†è¯„ä¼°ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å“åº”-3" tabindex="-1"><a class="header-anchor" href="#å“åº”-3">#</a> å“åº”</h4>
<div class="language-protobuf line-numbers-mode" data-highlighter="prismjs" data-ext="protobuf"><pre v-pre><code class="language-protobuf"><span class="line"><span class="token keyword">message</span> <span class="token class-name">SimulatePermissionResponse</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">repeated</span> <span class="token positional-class-name class-name">SimulationResult</span> results <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// æ¨¡æ‹Ÿç»“æœåˆ—è¡¨</span></span>
<span class="line">  <span class="token keyword">repeated</span> <span class="token builtin">string</span> evaluated_policies <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// è¯„ä¼°çš„ç­–ç•¥åˆ—è¡¨</span></span>
<span class="line">  <span class="token map class-name">map<span class="token punctuation">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">></span></span> context <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>        <span class="token comment">// è¯„ä¼°ä¸Šä¸‹æ–‡</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">message</span> <span class="token class-name">SimulationResult</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">string</span> action <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token comment">// æ“ä½œåŠ¨ä½œ</span></span>
<span class="line">  <span class="token builtin">string</span> resource <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>          <span class="token comment">// èµ„æºARN</span></span>
<span class="line">  <span class="token builtin">bool</span> allowed <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>             <span class="token comment">// æ˜¯å¦å…è®¸</span></span>
<span class="line">  <span class="token builtin">string</span> decision <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>          <span class="token comment">// å†³ç­–ç»“æœ</span></span>
<span class="line">  <span class="token keyword">repeated</span> <span class="token positional-class-name class-name">PolicyEvaluation</span> policy_evaluations <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>  <span class="token comment">// ç­–ç•¥è¯„ä¼°è¯¦æƒ…</span></span>
<span class="line">  <span class="token builtin">string</span> reason <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>            <span class="token comment">// å†³ç­–åŸå› </span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">message</span> <span class="token class-name">PolicyEvaluation</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token builtin">string</span> policy_name <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>       <span class="token comment">// ç­–ç•¥åç§°</span></span>
<span class="line">  <span class="token builtin">string</span> effect <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>            <span class="token comment">// æ•ˆæœï¼ˆAllow/Deny/NotApplicableï¼‰</span></span>
<span class="line">  <span class="token builtin">bool</span> matched <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>             <span class="token comment">// æ˜¯å¦åŒ¹é…</span></span>
<span class="line">  <span class="token keyword">repeated</span> <span class="token builtin">string</span> matched_statements <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>  <span class="token comment">// åŒ¹é…çš„è¯­å¥</span></span>
<span class="line">  <span class="token keyword">repeated</span> <span class="token builtin">string</span> condition_results <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>   <span class="token comment">// æ¡ä»¶è¯„ä¼°ç»“æœ</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç¤ºä¾‹-3" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-3">#</a> ç¤ºä¾‹</h4>
<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre v-pre><code class="language-bash"><span class="line"><span class="token comment"># æ¨¡æ‹Ÿæƒé™æ£€æŸ¥</span></span>
<span class="line">grpcurl <span class="token parameter variable">-plaintext</span> <span class="token parameter variable">-d</span> <span class="token string">'{</span>
<span class="line">  "user_name": "john_doe",</span>
<span class="line">  "policy_arns": [</span>
<span class="line">    "arn:iam::policy/S3ReadOnlyPolicy",</span>
<span class="line">    "arn:iam::policy/S3WritePolicy"</span>
<span class="line">  ],</span>
<span class="line">  "checks": [</span>
<span class="line">    {</span>
<span class="line">      "action": "s3:GetObject",</span>
<span class="line">      "resource": "arn:aws:s3:::test-bucket/file.txt"</span>
<span class="line">    },</span>
<span class="line">    {</span>
<span class="line">      "action": "s3:PutObject",</span>
<span class="line">      "resource": "arn:aws:s3:::test-bucket/upload.txt"</span>
<span class="line">    }</span>
<span class="line">  ],</span>
<span class="line">  "detailed_evaluation": true</span>
<span class="line">}'</span> localhost:50051 iam.v1.IAM/SimulatePermission</span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å“åº”ç¤ºä¾‹-3" tabindex="-1"><a class="header-anchor" href="#å“åº”ç¤ºä¾‹-3">#</a> å“åº”ç¤ºä¾‹</h4>
<div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre v-pre><code class="language-json"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">"results"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"arn:aws:s3:::test-bucket/file.txt"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"allowed"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"decision"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"policy_evaluations"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">"policy_name"</span><span class="token operator">:</span> <span class="token string">"S3ReadOnlyPolicy"</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">"effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">"matched"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">"matched_statements"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Statement1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">"condition_results"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token string">"StringEquals: s3:prefix = test-bucket/* -> true"</span></span>
<span class="line">          <span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">"policy_name"</span><span class="token operator">:</span> <span class="token string">"S3WritePolicy"</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">"effect"</span><span class="token operator">:</span> <span class="token string">"NotApplicable"</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">"matched"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">"matched_statements"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">"condition_results"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"reason"</span><span class="token operator">:</span> <span class="token string">"S3ReadOnlyPolicyå…è®¸è¯»å–æ“ä½œ"</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">"action"</span><span class="token operator">:</span> <span class="token string">"s3:PutObject"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"arn:aws:s3:::test-bucket/upload.txt"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"allowed"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"decision"</span><span class="token operator">:</span> <span class="token string">"Deny"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"policy_evaluations"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">"policy_name"</span><span class="token operator">:</span> <span class="token string">"S3ReadOnlyPolicy"</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">"effect"</span><span class="token operator">:</span> <span class="token string">"NotApplicable"</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">"matched"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">"matched_statements"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">"condition_results"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">"policy_name"</span><span class="token operator">:</span> <span class="token string">"S3WritePolicy"</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">"effect"</span><span class="token operator">:</span> <span class="token string">"Deny"</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">"matched"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">"matched_statements"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Statement2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token property">"condition_results"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token string">"StringNotEquals: s3:prefix = uploads/* -> false"</span></span>
<span class="line">          <span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"reason"</span><span class="token operator">:</span> <span class="token string">"S3WritePolicyæ‹’ç»å†™å…¥åˆ°éuploadsç›®å½•"</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"evaluated_policies"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">"S3ReadOnlyPolicy"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">"S3WritePolicy"</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"context"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">"simulation_time"</span><span class="token operator">:</span> <span class="token string">"2024-01-15T10:30:00Z"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">"total_checks"</span><span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">"evaluation_time_ms"</span><span class="token operator">:</span> <span class="token string">"35"</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="é”™è¯¯æƒ…å†µ-3" tabindex="-1"><a class="header-anchor" href="#é”™è¯¯æƒ…å†µ-3">#</a> é”™è¯¯æƒ…å†µ</h4>
<table>
<thead>
<tr>
<th>é”™è¯¯ç </th>
<th>è¯´æ˜</th>
<th>è§£å†³æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code v-pre>NOT_FOUND</code></td>
<td>ç”¨æˆ·æˆ–ç­–ç•¥ä¸å­˜åœ¨</td>
<td>ç¡®è®¤ç”¨æˆ·åå’Œç­–ç•¥ARNæ­£ç¡®</td>
</tr>
<tr>
<td><code v-pre>INVALID_ARGUMENT</code></td>
<td>æ£€æŸ¥åˆ—è¡¨ä¸ºç©º</td>
<td>æä¾›è‡³å°‘ä¸€ä¸ªæƒé™æ£€æŸ¥</td>
</tr>
<tr>
<td><code v-pre>PERMISSION_DENIED</code></td>
<td>æ— æ¨¡æ‹Ÿæƒé™æƒé™</td>
<td>ç¡®ä¿æœ‰<code v-pre>iam:SimulatePermission</code>æƒé™</td>
</tr>
</tbody>
</table>
<h2 id="ğŸ“Š-æƒé™å†³ç­–é€»è¾‘" tabindex="-1"><a class="header-anchor" href="#ğŸ“Š-æƒé™å†³ç­–é€»è¾‘">#</a> ğŸ“Š æƒé™å†³ç­–é€»è¾‘</h2>
<h3 id="å†³ç­–æµç¨‹" tabindex="-1"><a class="header-anchor" href="#å†³ç­–æµç¨‹">#</a> å†³ç­–æµç¨‹</h3>
<div class="language-mermaid line-numbers-mode" data-highlighter="prismjs" data-ext="mermaid"><pre v-pre><code class="language-mermaid"><span class="line"><span class="token keyword">flowchart</span> TD</span>
<span class="line">    A<span class="token text string">[å¼€å§‹æƒé™æ£€æŸ¥]</span> <span class="token arrow operator">--></span> B<span class="token text string">[è·å–ç”¨æˆ·ç­–ç•¥]</span></span>
<span class="line">    B <span class="token arrow operator">--></span> C<span class="token text string">[éå†ç­–ç•¥è¯­å¥]</span></span>
<span class="line">    C <span class="token arrow operator">--></span> D<span class="token text string">{è¯­å¥åŒ¹é…?}</span></span>
<span class="line">    D <span class="token arrow operator">--></span><span class="token label property">|å¦|</span> E<span class="token text string">[ä¸‹ä¸€ä¸ªè¯­å¥]</span></span>
<span class="line">    D <span class="token arrow operator">--></span><span class="token label property">|æ˜¯|</span> F<span class="token text string">{æ¡ä»¶æ»¡è¶³?}</span></span>
<span class="line">    F <span class="token arrow operator">--></span><span class="token label property">|å¦|</span> E</span>
<span class="line">    F <span class="token arrow operator">--></span><span class="token label property">|æ˜¯|</span> G<span class="token text string">{æ•ˆæœç±»å‹?}</span></span>
<span class="line">    G <span class="token arrow operator">--></span><span class="token label property">|Allow|</span> H<span class="token text string">[è®°å½•Allow]</span></span>
<span class="line">    G <span class="token arrow operator">--></span><span class="token label property">|Deny|</span> I<span class="token text string">[è®°å½•Deny]</span></span>
<span class="line">    H <span class="token arrow operator">--></span> E</span>
<span class="line">    I <span class="token arrow operator">--></span> E</span>
<span class="line">    E <span class="token arrow operator">--></span> J<span class="token text string">{è¿˜æœ‰è¯­å¥?}</span></span>
<span class="line">    J <span class="token arrow operator">--></span><span class="token label property">|æ˜¯|</span> C</span>
<span class="line">    J <span class="token arrow operator">--></span><span class="token label property">|å¦|</span> K<span class="token text string">{æœ‰Deny?}</span></span>
<span class="line">    K <span class="token arrow operator">--></span><span class="token label property">|æ˜¯|</span> L<span class="token text string">[è¿”å›Deny]</span></span>
<span class="line">    K <span class="token arrow operator">--></span><span class="token label property">|å¦|</span> M<span class="token text string">{æœ‰Allow?}</span></span>
<span class="line">    M <span class="token arrow operator">--></span><span class="token label property">|æ˜¯|</span> N<span class="token text string">[è¿”å›Allow]</span></span>
<span class="line">    M <span class="token arrow operator">--></span><span class="token label property">|å¦|</span> O<span class="token text string">[è¿”å›Denyé»˜è®¤]</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å†³ç­–ä¼˜å…ˆçº§" tabindex="-1"><a class="header-anchor" href="#å†³ç­–ä¼˜å…ˆçº§">#</a> å†³ç­–ä¼˜å…ˆçº§</h3>
<ol>
<li><strong>æ˜¾å¼æ‹’ç»ï¼ˆExplicit Denyï¼‰</strong>ï¼šæœ€é«˜ä¼˜å…ˆçº§</li>
<li><strong>æ˜¾å¼å…è®¸ï¼ˆExplicit Allowï¼‰</strong>ï¼šä¸­ç­‰ä¼˜å…ˆçº§</li>
<li><strong>éšå¼æ‹’ç»ï¼ˆImplicit Denyï¼‰</strong>ï¼šé»˜è®¤è¡Œä¸º</li>
</ol>
<h3 id="ç­–ç•¥è¯„ä¼°é¡ºåº" tabindex="-1"><a class="header-anchor" href="#ç­–ç•¥è¯„ä¼°é¡ºåº">#</a> ç­–ç•¥è¯„ä¼°é¡ºåº</h3>
<ol>
<li><strong>ç”¨æˆ·ç›´æ¥ç»‘å®šçš„ç­–ç•¥</strong></li>
<li><strong>ç”¨æˆ·ç»„ç­–ç•¥</strong>ï¼ˆå¦‚æœæ”¯æŒï¼‰</li>
<li><strong>è§’è‰²ç­–ç•¥</strong>ï¼ˆå¦‚æœæ”¯æŒï¼‰</li>
<li><strong>èµ„æºç­–ç•¥</strong>ï¼ˆå¦‚æœæ”¯æŒï¼‰</li>
</ol>
<h2 id="ğŸ”-æƒé™è¦æ±‚" tabindex="-1"><a class="header-anchor" href="#ğŸ”-æƒé™è¦æ±‚">#</a> ğŸ” æƒé™è¦æ±‚</h2>
<h3 id="æ‰€éœ€æƒé™" tabindex="-1"><a class="header-anchor" href="#æ‰€éœ€æƒé™">#</a> æ‰€éœ€æƒé™</h3>
<table>
<thead>
<tr>
<th>æ“ä½œ</th>
<th>æƒé™</th>
<th>èµ„æº</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ£€æŸ¥æƒé™</td>
<td><code v-pre>iam:CheckPermission</code></td>
<td><code v-pre>arn:iam::user/*</code></td>
</tr>
<tr>
<td>æ‰¹é‡æ£€æŸ¥æƒé™</td>
<td><code v-pre>iam:CheckPermissions</code></td>
<td><code v-pre>arn:iam::user/*</code></td>
</tr>
<tr>
<td>è·å–æœ‰æ•ˆæƒé™</td>
<td><code v-pre>iam:GetEffectivePermissions</code></td>
<td><code v-pre>arn:iam::user/*</code></td>
</tr>
<tr>
<td>æ¨¡æ‹Ÿæƒé™</td>
<td><code v-pre>iam:SimulatePermission</code></td>
<td><code v-pre>arn:iam::user/*</code> å’Œ <code v-pre>arn:iam::policy/*</code></td>
</tr>
</tbody>
</table>
<h3 id="ç­–ç•¥ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ç­–ç•¥ç¤ºä¾‹">#</a> ç­–ç•¥ç¤ºä¾‹</h3>
<h4 id="æƒé™éªŒè¯æœåŠ¡ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#æƒé™éªŒè¯æœåŠ¡ç­–ç•¥">#</a> æƒé™éªŒè¯æœåŠ¡ç­–ç•¥</h4>
<div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre v-pre><code class="language-json"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2025-01-01"</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">"iam:CheckPermission"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"iam:CheckPermissions"</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"*"</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æƒé™ç®¡ç†å‘˜ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#æƒé™ç®¡ç†å‘˜ç­–ç•¥">#</a> æƒé™ç®¡ç†å‘˜ç­–ç•¥</h4>
<div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre v-pre><code class="language-json"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2025-01-01"</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">"iam:CheckPermission"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"iam:CheckPermissions"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"iam:GetEffectivePermissions"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"iam:SimulatePermission"</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"*"</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ› ï¸-ä½¿ç”¨ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ğŸ› ï¸-ä½¿ç”¨ç¤ºä¾‹">#</a> ğŸ› ï¸ ä½¿ç”¨ç¤ºä¾‹</h2>
<h3 id="go-å®¢æˆ·ç«¯ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#go-å®¢æˆ·ç«¯ç¤ºä¾‹">#</a> Go å®¢æˆ·ç«¯ç¤ºä¾‹</h3>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"context"</span></span>
<span class="line">    <span class="token string">"fmt"</span></span>
<span class="line">    <span class="token string">"log"</span></span>
<span class="line">    </span>
<span class="line">    <span class="token string">"google.golang.org/grpc"</span></span>
<span class="line">    <span class="token string">"google.golang.org/grpc/credentials/insecure"</span></span>
<span class="line">    </span>
<span class="line">    iamv1 <span class="token string">"github.com/your-org/vgo/api/iam/v1"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æƒé™æ£€æŸ¥å™¨</span></span>
<span class="line"><span class="token keyword">type</span> PermissionChecker <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    client iamv1<span class="token punctuation">.</span>IAMClient</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">NewPermissionChecker</span><span class="token punctuation">(</span>client iamv1<span class="token punctuation">.</span>IAMClient<span class="token punctuation">)</span> <span class="token operator">*</span>PermissionChecker <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>PermissionChecker<span class="token punctuation">{</span>client<span class="token punctuation">:</span> client<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ£€æŸ¥å•ä¸ªæƒé™</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>pc <span class="token operator">*</span>PermissionChecker<span class="token punctuation">)</span> <span class="token function">CheckPermission</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> action<span class="token punctuation">,</span> resource <span class="token builtin">string</span><span class="token punctuation">,</span> context <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> pc<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">CheckPermission</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>iamv1<span class="token punctuation">.</span>CheckPermissionRequest<span class="token punctuation">{</span></span>
<span class="line">        UserName<span class="token punctuation">:</span> userName<span class="token punctuation">,</span></span>
<span class="line">        Action<span class="token punctuation">:</span>   action<span class="token punctuation">,</span></span>
<span class="line">        Resource<span class="token punctuation">:</span> resource<span class="token punctuation">,</span></span>
<span class="line">        Context<span class="token punctuation">:</span>  context<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"æƒé™æ£€æŸ¥å¤±è´¥: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> resp<span class="token punctuation">.</span>Allowed<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ‰¹é‡æ£€æŸ¥æƒé™</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>pc <span class="token operator">*</span>PermissionChecker<span class="token punctuation">)</span> <span class="token function">CheckPermissions</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> userName <span class="token builtin">string</span><span class="token punctuation">,</span> checks <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>iamv1<span class="token punctuation">.</span>PermissionCheck<span class="token punctuation">,</span> context <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>iamv1<span class="token punctuation">.</span>PermissionResult<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> pc<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">CheckPermissions</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>iamv1<span class="token punctuation">.</span>CheckPermissionsRequest<span class="token punctuation">{</span></span>
<span class="line">        UserName<span class="token punctuation">:</span> userName<span class="token punctuation">,</span></span>
<span class="line">        Checks<span class="token punctuation">:</span>   checks<span class="token punctuation">,</span></span>
<span class="line">        Context<span class="token punctuation">:</span>  context<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"æ‰¹é‡æƒé™æ£€æŸ¥å¤±è´¥: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> resp<span class="token punctuation">.</span>Results<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æƒé™è£…é¥°å™¨</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">RequirePermission</span><span class="token punctuation">(</span>checker <span class="token operator">*</span>PermissionChecker<span class="token punctuation">,</span> action<span class="token punctuation">,</span> resource <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>HandlerFunc<span class="token punctuation">)</span> http<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next http<span class="token punctuation">.</span>HandlerFunc<span class="token punctuation">)</span> http<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// ä»è¯·æ±‚ä¸­è·å–ç”¨æˆ·ä¿¡æ¯</span></span>
<span class="line">            userName <span class="token operator">:=</span> <span class="token function">getUserFromRequest</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> userName <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span></span>
<span class="line">                http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"æœªè®¤è¯"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">return</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// æ„é€ ä¸Šä¸‹æ–‡</span></span>
<span class="line">            context <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">"aws:SourceIp"</span><span class="token punctuation">:</span>        <span class="token function">getClientIP</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">"aws:RequestedRegion"</span><span class="token punctuation">:</span> <span class="token string">"us-east-1"</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">"aws:CurrentTime"</span><span class="token punctuation">:</span>     time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>RFC3339<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// æ£€æŸ¥æƒé™</span></span>
<span class="line">            allowed<span class="token punctuation">,</span> err <span class="token operator">:=</span> checker<span class="token punctuation">.</span><span class="token function">CheckPermission</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userName<span class="token punctuation">,</span> action<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> context<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"æƒé™æ£€æŸ¥é”™è¯¯: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">                http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"æƒé™æ£€æŸ¥å¤±è´¥"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">return</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">if</span> <span class="token operator">!</span>allowed <span class="token punctuation">{</span></span>
<span class="line">                http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"æƒé™ä¸è¶³"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusForbidden<span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">return</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// æƒé™æ£€æŸ¥é€šè¿‡ï¼Œç»§ç»­å¤„ç†è¯·æ±‚</span></span>
<span class="line">            <span class="token function">next</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// è¿æ¥åˆ°æœåŠ¡</span></span>
<span class="line">    conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span><span class="token string">"localhost:50051"</span><span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithTransportCredentials</span><span class="token punctuation">(</span>insecure<span class="token punctuation">.</span><span class="token function">NewCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"è¿æ¥å¤±è´¥: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">defer</span> conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    client <span class="token operator">:=</span> iamv1<span class="token punctuation">.</span><span class="token function">NewIAMClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span></span>
<span class="line">    checker <span class="token operator">:=</span> <span class="token function">NewPermissionChecker</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span></span>
<span class="line">    ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1. å•ä¸ªæƒé™æ£€æŸ¥</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"1. æ£€æŸ¥å•ä¸ªæƒé™..."</span><span class="token punctuation">)</span></span>
<span class="line">    allowed<span class="token punctuation">,</span> err <span class="token operator">:=</span> checker<span class="token punctuation">.</span><span class="token function">CheckPermission</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"john_doe"</span><span class="token punctuation">,</span> <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span> <span class="token string">"arn:aws:s3:::my-bucket/file.txt"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"æƒé™æ£€æŸ¥å¤±è´¥: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"æƒé™æ£€æŸ¥ç»“æœ: %t\n"</span><span class="token punctuation">,</span> allowed<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 2. æ‰¹é‡æƒé™æ£€æŸ¥</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"\n2. æ‰¹é‡æƒé™æ£€æŸ¥..."</span><span class="token punctuation">)</span></span>
<span class="line">    checks <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>iamv1<span class="token punctuation">.</span>PermissionCheck<span class="token punctuation">{</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            Action<span class="token punctuation">:</span>   <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span></span>
<span class="line">            Resource<span class="token punctuation">:</span> <span class="token string">"arn:aws:s3:::my-bucket/file1.txt"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            Action<span class="token punctuation">:</span>   <span class="token string">"s3:PutObject"</span><span class="token punctuation">,</span></span>
<span class="line">            Resource<span class="token punctuation">:</span> <span class="token string">"arn:aws:s3:::my-bucket/file2.txt"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            Action<span class="token punctuation">:</span>   <span class="token string">"iam:ListUsers"</span><span class="token punctuation">,</span></span>
<span class="line">            Resource<span class="token punctuation">:</span> <span class="token string">"arn:iam::user/*"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    results<span class="token punctuation">,</span> err <span class="token operator">:=</span> checker<span class="token punctuation">.</span><span class="token function">CheckPermissions</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"john_doe"</span><span class="token punctuation">,</span> checks<span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">"aws:RequestedRegion"</span><span class="token punctuation">:</span> <span class="token string">"us-east-1"</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"æ‰¹é‡æƒé™æ£€æŸ¥å¤±è´¥: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"æ‰¹é‡æ£€æŸ¥ç»“æœ:\n"</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> i<span class="token punctuation">,</span> result <span class="token operator">:=</span> <span class="token keyword">range</span> results <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"  %d. %s on %s: %t (%s)\n"</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>Action<span class="token punctuation">,</span> result<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> result<span class="token punctuation">.</span>Allowed<span class="token punctuation">,</span> result<span class="token punctuation">.</span>Decision<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 3. è·å–æœ‰æ•ˆæƒé™</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"\n3. è·å–æœ‰æ•ˆæƒé™..."</span><span class="token punctuation">)</span></span>
<span class="line">    effectiveResp<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">GetEffectivePermissions</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>iamv1<span class="token punctuation">.</span>GetEffectivePermissionsRequest<span class="token punctuation">{</span></span>
<span class="line">        UserName<span class="token punctuation">:</span>       <span class="token string">"john_doe"</span><span class="token punctuation">,</span></span>
<span class="line">        ResourcePrefix<span class="token punctuation">:</span> <span class="token string">"arn:aws:s3:::"</span><span class="token punctuation">,</span></span>
<span class="line">        Actions<span class="token punctuation">:</span>        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span> <span class="token string">"s3:PutObject"</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"è·å–æœ‰æ•ˆæƒé™å¤±è´¥: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"æœ‰æ•ˆæƒé™ (%d ä¸ª):\n"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>effectiveResp<span class="token punctuation">.</span>Permissions<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> i<span class="token punctuation">,</span> perm <span class="token operator">:=</span> <span class="token keyword">range</span> effectiveResp<span class="token punctuation">.</span>Permissions <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"  %d. %s on %s: %s (æ¥æº: %s)\n"</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> perm<span class="token punctuation">.</span>Action<span class="token punctuation">,</span> perm<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> perm<span class="token punctuation">.</span>Effect<span class="token punctuation">,</span> perm<span class="token punctuation">.</span>SourcePolicy<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 4. æ¨¡æ‹Ÿæƒé™æ£€æŸ¥</span></span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"\n4. æ¨¡æ‹Ÿæƒé™æ£€æŸ¥..."</span><span class="token punctuation">)</span></span>
<span class="line">    simulateResp<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">SimulatePermission</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>iamv1<span class="token punctuation">.</span>SimulatePermissionRequest<span class="token punctuation">{</span></span>
<span class="line">        UserName<span class="token punctuation">:</span> <span class="token string">"john_doe"</span><span class="token punctuation">,</span></span>
<span class="line">        PolicyArns<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">"arn:iam::policy/S3ReadOnlyPolicy"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        Checks<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>iamv1<span class="token punctuation">.</span>PermissionCheck<span class="token punctuation">{</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                Action<span class="token punctuation">:</span>   <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span></span>
<span class="line">                Resource<span class="token punctuation">:</span> <span class="token string">"arn:aws:s3:::test-bucket/file.txt"</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        DetailedEvaluation<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"æ¨¡æ‹Ÿæƒé™æ£€æŸ¥å¤±è´¥: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"æ¨¡æ‹Ÿç»“æœ:\n"</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">for</span> i<span class="token punctuation">,</span> result <span class="token operator">:=</span> <span class="token keyword">range</span> simulateResp<span class="token punctuation">.</span>Results <span class="token punctuation">{</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"  %d. %s on %s: %t\n"</span><span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>Action<span class="token punctuation">,</span> result<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span> result<span class="token punctuation">.</span>Allowed<span class="token punctuation">)</span></span>
<span class="line">        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"     åŸå› : %s\n"</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>Reason<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">for</span> j<span class="token punctuation">,</span> eval <span class="token operator">:=</span> <span class="token keyword">range</span> result<span class="token punctuation">.</span>PolicyEvaluations <span class="token punctuation">{</span></span>
<span class="line">            fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"     ç­–ç•¥%d: %s - %s (åŒ¹é…: %t)\n"</span><span class="token punctuation">,</span> j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> eval<span class="token punctuation">.</span>PolicyName<span class="token punctuation">,</span> eval<span class="token punctuation">.</span>Effect<span class="token punctuation">,</span> eval<span class="token punctuation">.</span>Matched<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è¾…åŠ©å‡½æ•°</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">getUserFromRequest</span><span class="token punctuation">(</span>r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ä»JWT tokenã€sessionæˆ–å…¶ä»–æ–¹å¼è·å–ç”¨æˆ·å</span></span>
<span class="line">    <span class="token keyword">return</span> r<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"X-User-Name"</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">getClientIP</span><span class="token punctuation">(</span>r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// è·å–å®¢æˆ·ç«¯IP</span></span>
<span class="line">    forwarded <span class="token operator">:=</span> r<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> forwarded <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>forwarded<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> r<span class="token punctuation">.</span>RemoteAddr</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æƒé™ä¸­é—´ä»¶ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#æƒé™ä¸­é—´ä»¶ç¤ºä¾‹">#</a> æƒé™ä¸­é—´ä»¶ç¤ºä¾‹</h3>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">package</span> middleware</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">"context"</span></span>
<span class="line">    <span class="token string">"encoding/json"</span></span>
<span class="line">    <span class="token string">"net/http"</span></span>
<span class="line">    <span class="token string">"strings"</span></span>
<span class="line">    <span class="token string">"time"</span></span>
<span class="line">    </span>
<span class="line">    iamv1 <span class="token string">"github.com/your-org/vgo/api/iam/v1"</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æƒé™ä¸­é—´ä»¶é…ç½®</span></span>
<span class="line"><span class="token keyword">type</span> PermissionMiddlewareConfig <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    IAMClient    iamv1<span class="token punctuation">.</span>IAMClient</span>
<span class="line">    SkipPaths    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span></span>
<span class="line">    ErrorHandler <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æƒé™ä¸­é—´ä»¶</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">PermissionMiddleware</span><span class="token punctuation">(</span>config PermissionMiddlewareConfig<span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>next http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// æ£€æŸ¥æ˜¯å¦è·³è¿‡æƒé™éªŒè¯</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> path <span class="token operator">:=</span> <span class="token keyword">range</span> config<span class="token punctuation">.</span>SkipPaths <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">,</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    next<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span></span>
<span class="line">                    <span class="token keyword">return</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// è·å–ç”¨æˆ·ä¿¡æ¯</span></span>
<span class="line">            userName <span class="token operator">:=</span> <span class="token function">getUserFromContext</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> userName <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span></span>
<span class="line">                http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"æœªè®¤è¯"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusUnauthorized<span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">return</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// æ„é€ æƒé™æ£€æŸ¥å‚æ•°</span></span>
<span class="line">            action <span class="token operator">:=</span> <span class="token function">getActionFromRequest</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span></span>
<span class="line">            resource <span class="token operator">:=</span> <span class="token function">getResourceFromRequest</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span></span>
<span class="line">            context <span class="token operator">:=</span> <span class="token function">getContextFromRequest</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// æ£€æŸ¥æƒé™</span></span>
<span class="line">            resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> config<span class="token punctuation">.</span>IAMClient<span class="token punctuation">.</span><span class="token function">CheckPermission</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>iamv1<span class="token punctuation">.</span>CheckPermissionRequest<span class="token punctuation">{</span></span>
<span class="line">                UserName<span class="token punctuation">:</span> userName<span class="token punctuation">,</span></span>
<span class="line">                Action<span class="token punctuation">:</span>   action<span class="token punctuation">,</span></span>
<span class="line">                Resource<span class="token punctuation">:</span> resource<span class="token punctuation">,</span></span>
<span class="line">                Context<span class="token punctuation">:</span>  context<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> config<span class="token punctuation">.</span>ErrorHandler <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">                    config<span class="token punctuation">.</span><span class="token function">ErrorHandler</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                    http<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"æƒé™æ£€æŸ¥å¤±è´¥"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">return</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">if</span> <span class="token operator">!</span>resp<span class="token punctuation">.</span>Allowed <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// è®°å½•æƒé™æ‹’ç»æ—¥å¿—</span></span>
<span class="line">                <span class="token function">logPermissionDenied</span><span class="token punctuation">(</span>userName<span class="token punctuation">,</span> action<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Reason<span class="token punctuation">)</span></span>
<span class="line">                </span>
<span class="line">                w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"application/json"</span><span class="token punctuation">)</span></span>
<span class="line">                w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusForbidden<span class="token punctuation">)</span></span>
<span class="line">                json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token string">"error"</span><span class="token punctuation">:</span>   <span class="token string">"æƒé™ä¸è¶³"</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">"action"</span><span class="token punctuation">:</span>  action<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">"resource"</span><span class="token punctuation">:</span> resource<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">"reason"</span><span class="token punctuation">:</span>  resp<span class="token punctuation">.</span>Reason<span class="token punctuation">,</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">return</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment">// æƒé™æ£€æŸ¥é€šè¿‡ï¼Œæ·»åŠ æƒé™ä¿¡æ¯åˆ°ä¸Šä¸‹æ–‡</span></span>
<span class="line">            ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"permission_check"</span><span class="token punctuation">,</span> resp<span class="token punctuation">)</span></span>
<span class="line">            next<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ä»è¯·æ±‚æ„é€ æ“ä½œåŠ¨ä½œ</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">getActionFromRequest</span><span class="token punctuation">(</span>r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    method <span class="token operator">:=</span> r<span class="token punctuation">.</span>Method</span>
<span class="line">    path <span class="token operator">:=</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path</span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ ¹æ®HTTPæ–¹æ³•å’Œè·¯å¾„æ„é€ æ“ä½œ</span></span>
<span class="line">    <span class="token keyword">switch</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> method <span class="token operator">==</span> <span class="token string">"GET"</span> <span class="token operator">&amp;&amp;</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/api/users"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"iam:ListUsers"</span></span>
<span class="line">    <span class="token keyword">case</span> method <span class="token operator">==</span> <span class="token string">"GET"</span> <span class="token operator">&amp;&amp;</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/api/users/"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"iam:GetUser"</span></span>
<span class="line">    <span class="token keyword">case</span> method <span class="token operator">==</span> <span class="token string">"POST"</span> <span class="token operator">&amp;&amp;</span> path <span class="token operator">==</span> <span class="token string">"/api/users"</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"iam:CreateUser"</span></span>
<span class="line">    <span class="token keyword">case</span> method <span class="token operator">==</span> <span class="token string">"PUT"</span> <span class="token operator">&amp;&amp;</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/api/users/"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"iam:UpdateUser"</span></span>
<span class="line">    <span class="token keyword">case</span> method <span class="token operator">==</span> <span class="token string">"DELETE"</span> <span class="token operator">&amp;&amp;</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/api/users/"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"iam:DeleteUser"</span></span>
<span class="line">    <span class="token keyword">case</span> method <span class="token operator">==</span> <span class="token string">"GET"</span> <span class="token operator">&amp;&amp;</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/api/files"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"s3:GetObject"</span></span>
<span class="line">    <span class="token keyword">case</span> method <span class="token operator">==</span> <span class="token string">"POST"</span> <span class="token operator">&amp;&amp;</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/api/files"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"s3:PutObject"</span></span>
<span class="line">    <span class="token keyword">case</span> method <span class="token operator">==</span> <span class="token string">"DELETE"</span> <span class="token operator">&amp;&amp;</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/api/files"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"s3:DeleteObject"</span></span>
<span class="line">    <span class="token keyword">default</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"unknown:Action"</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ä»è¯·æ±‚æ„é€ èµ„æºARN</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">getResourceFromRequest</span><span class="token punctuation">(</span>r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    path <span class="token operator">:=</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">switch</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/api/users"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/api/users/"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// æå–ç”¨æˆ·å</span></span>
<span class="line">            parts <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">4</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token string">"arn:iam::user/"</span> <span class="token operator">+</span> parts<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"arn:iam::user/*"</span></span>
<span class="line">    <span class="token keyword">case</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/api/files"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">// æå–æ–‡ä»¶è·¯å¾„</span></span>
<span class="line">        filePath <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">TrimPrefix</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"/api/files/"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"arn:aws:s3:::my-bucket/"</span> <span class="token operator">+</span> filePath</span>
<span class="line">    <span class="token keyword">default</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">"arn:unknown::resource/*"</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ä»è¯·æ±‚æ„é€ ä¸Šä¸‹æ–‡</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">getContextFromRequest</span><span class="token punctuation">(</span>r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">"aws:SourceIp"</span><span class="token punctuation">:</span>        <span class="token function">getClientIP</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"aws:RequestedRegion"</span><span class="token punctuation">:</span> <span class="token string">"us-east-1"</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"aws:CurrentTime"</span><span class="token punctuation">:</span>     time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>RFC3339<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"http:Method"</span><span class="token punctuation">:</span>         r<span class="token punctuation">.</span>Method<span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">"http:UserAgent"</span><span class="token punctuation">:</span>      r<span class="token punctuation">.</span><span class="token function">UserAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// è®°å½•æƒé™æ‹’ç»æ—¥å¿—</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">logPermissionDenied</span><span class="token punctuation">(</span>userName<span class="token punctuation">,</span> action<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> reason <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"æƒé™æ‹’ç»: ç”¨æˆ·=%s, æ“ä½œ=%s, èµ„æº=%s, åŸå› =%s"</span><span class="token punctuation">,</span> userName<span class="token punctuation">,</span> action<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> reason<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="python-å®¢æˆ·ç«¯ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#python-å®¢æˆ·ç«¯ç¤ºä¾‹">#</a> Python å®¢æˆ·ç«¯ç¤ºä¾‹</h3>
<div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre v-pre><code class="language-python"><span class="line"><span class="token keyword">import</span> grpc</span>
<span class="line"><span class="token keyword">import</span> asyncio</span>
<span class="line"><span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> Optional<span class="token punctuation">,</span> Tuple</span>
<span class="line"><span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass</span>
<span class="line"></span>
<span class="line"><span class="token comment"># å‡è®¾å·²ç”Ÿæˆçš„Python gRPCå®¢æˆ·ç«¯</span></span>
<span class="line"><span class="token keyword">from</span> iam<span class="token punctuation">.</span>v1 <span class="token keyword">import</span> iam_pb2<span class="token punctuation">,</span> iam_pb2_grpc</span>
<span class="line"></span>
<span class="line"><span class="token decorator annotation punctuation">@dataclass</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">PermissionCheck</span><span class="token punctuation">:</span></span>
<span class="line">    action<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    resource<span class="token punctuation">:</span> <span class="token builtin">str</span></span>
<span class="line">    context<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">PermissionChecker</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>client <span class="token operator">=</span> iam_pb2_grpc<span class="token punctuation">.</span>IAMStub<span class="token punctuation">(</span>channel<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">check_permission</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> action<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> resource<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> </span>
<span class="line">                             context<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Tuple<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">"""æ£€æŸ¥å•ä¸ªæƒé™"""</span></span>
<span class="line">        request <span class="token operator">=</span> iam_pb2<span class="token punctuation">.</span>CheckPermissionRequest<span class="token punctuation">(</span></span>
<span class="line">            user_name<span class="token operator">=</span>user_name<span class="token punctuation">,</span></span>
<span class="line">            action<span class="token operator">=</span>action<span class="token punctuation">,</span></span>
<span class="line">            resource<span class="token operator">=</span>resource<span class="token punctuation">,</span></span>
<span class="line">            context<span class="token operator">=</span>context <span class="token keyword">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">            response <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>CheckPermission<span class="token punctuation">(</span>request<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> response<span class="token punctuation">.</span>allowed<span class="token punctuation">,</span> response<span class="token punctuation">.</span>reason</span>
<span class="line">        <span class="token keyword">except</span> grpc<span class="token punctuation">.</span>RpcError <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"æƒé™æ£€æŸ¥å¤±è´¥: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">.</span>details<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">check_permissions</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> checks<span class="token punctuation">:</span> List<span class="token punctuation">[</span>PermissionCheck<span class="token punctuation">]</span><span class="token punctuation">,</span> </span>
<span class="line">                              context<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">"""æ‰¹é‡æ£€æŸ¥æƒé™"""</span></span>
<span class="line">        grpc_checks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">for</span> check <span class="token keyword">in</span> checks<span class="token punctuation">:</span></span>
<span class="line">            grpc_check <span class="token operator">=</span> iam_pb2<span class="token punctuation">.</span>PermissionCheck<span class="token punctuation">(</span></span>
<span class="line">                action<span class="token operator">=</span>check<span class="token punctuation">.</span>action<span class="token punctuation">,</span></span>
<span class="line">                resource<span class="token operator">=</span>check<span class="token punctuation">.</span>resource<span class="token punctuation">,</span></span>
<span class="line">                context<span class="token operator">=</span>check<span class="token punctuation">.</span>context <span class="token keyword">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">)</span></span>
<span class="line">            grpc_checks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>grpc_check<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        request <span class="token operator">=</span> iam_pb2<span class="token punctuation">.</span>CheckPermissionsRequest<span class="token punctuation">(</span></span>
<span class="line">            user_name<span class="token operator">=</span>user_name<span class="token punctuation">,</span></span>
<span class="line">            checks<span class="token operator">=</span>grpc_checks<span class="token punctuation">,</span></span>
<span class="line">            context<span class="token operator">=</span>context <span class="token keyword">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">            response <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>CheckPermissions<span class="token punctuation">(</span>request<span class="token punctuation">)</span></span>
<span class="line">            results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token keyword">for</span> result <span class="token keyword">in</span> response<span class="token punctuation">.</span>results<span class="token punctuation">:</span></span>
<span class="line">                results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token string">'action'</span><span class="token punctuation">:</span> result<span class="token punctuation">.</span>action<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">'resource'</span><span class="token punctuation">:</span> result<span class="token punctuation">.</span>resource<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">'allowed'</span><span class="token punctuation">:</span> result<span class="token punctuation">.</span>allowed<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">'decision'</span><span class="token punctuation">:</span> result<span class="token punctuation">.</span>decision<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">'reason'</span><span class="token punctuation">:</span> result<span class="token punctuation">.</span>reason<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">'matched_policies'</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>matched_policies<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> results</span>
<span class="line">        <span class="token keyword">except</span> grpc<span class="token punctuation">.</span>RpcError <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"æ‰¹é‡æƒé™æ£€æŸ¥å¤±è´¥: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">.</span>details<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_effective_permissions</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> </span>
<span class="line">                                      resource_prefix<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span></span>
<span class="line">                                      actions<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">"""è·å–æœ‰æ•ˆæƒé™"""</span></span>
<span class="line">        request <span class="token operator">=</span> iam_pb2<span class="token punctuation">.</span>GetEffectivePermissionsRequest<span class="token punctuation">(</span></span>
<span class="line">            user_name<span class="token operator">=</span>user_name<span class="token punctuation">,</span></span>
<span class="line">            resource_prefix<span class="token operator">=</span>resource_prefix <span class="token keyword">or</span> <span class="token string">""</span><span class="token punctuation">,</span></span>
<span class="line">            actions<span class="token operator">=</span>actions <span class="token keyword">or</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">            response <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>GetEffectivePermissions<span class="token punctuation">(</span>request<span class="token punctuation">)</span></span>
<span class="line">            permissions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token keyword">for</span> perm <span class="token keyword">in</span> response<span class="token punctuation">.</span>permissions<span class="token punctuation">:</span></span>
<span class="line">                permissions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token string">'action'</span><span class="token punctuation">:</span> perm<span class="token punctuation">.</span>action<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">'resource'</span><span class="token punctuation">:</span> perm<span class="token punctuation">.</span>resource<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">'effect'</span><span class="token punctuation">:</span> perm<span class="token punctuation">.</span>effect<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">'source_policy'</span><span class="token punctuation">:</span> perm<span class="token punctuation">.</span>source_policy<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token string">'conditions'</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>perm<span class="token punctuation">.</span>conditions<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> permissions</span>
<span class="line">        <span class="token keyword">except</span> grpc<span class="token punctuation">.</span>RpcError <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"è·å–æœ‰æ•ˆæƒé™å¤±è´¥: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">.</span>details<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># æƒé™è£…é¥°å™¨</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">require_permission</span><span class="token punctuation">(</span>action<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> resource<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">"""æƒé™æ£€æŸ¥è£…é¥°å™¨"""</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># å‡è®¾ä»æŸå¤„è·å–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™æ£€æŸ¥å™¨</span></span>
<span class="line">            user_name <span class="token operator">=</span> get_current_user<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            checker <span class="token operator">=</span> get_permission_checker<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token keyword">if</span> <span class="token keyword">not</span> user_name<span class="token punctuation">:</span></span>
<span class="line">                <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"æœªè®¤è¯"</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># æ£€æŸ¥æƒé™</span></span>
<span class="line">            allowed<span class="token punctuation">,</span> reason <span class="token operator">=</span> <span class="token keyword">await</span> checker<span class="token punctuation">.</span>check_permission<span class="token punctuation">(</span>user_name<span class="token punctuation">,</span> action<span class="token punctuation">,</span> resource<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token keyword">not</span> allowed<span class="token punctuation">:</span></span>
<span class="line">                <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"æƒé™ä¸è¶³: </span><span class="token interpolation"><span class="token punctuation">{</span>reason<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">            <span class="token comment"># æƒé™æ£€æŸ¥é€šè¿‡ï¼Œæ‰§è¡ŒåŸå‡½æ•°</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">await</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> wrapper</span>
<span class="line">    <span class="token keyword">return</span> decorator</span>
<span class="line"></span>
<span class="line"><span class="token comment"># ä½¿ç”¨ç¤ºä¾‹</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">UserService</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> permission_checker<span class="token punctuation">:</span> PermissionChecker<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        self<span class="token punctuation">.</span>permission_checker <span class="token operator">=</span> permission_checker</span>
<span class="line">    </span>
<span class="line">    <span class="token decorator annotation punctuation">@require_permission</span><span class="token punctuation">(</span><span class="token string">"iam:GetUser"</span><span class="token punctuation">,</span> <span class="token string">"arn:iam::user/*"</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get_user</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">"""è·å–ç”¨æˆ·ä¿¡æ¯"""</span></span>
<span class="line">        <span class="token comment"># å®é™…çš„ç”¨æˆ·è·å–é€»è¾‘</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"John Doe"</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token decorator annotation punctuation">@require_permission</span><span class="token punctuation">(</span><span class="token string">"iam:CreateUser"</span><span class="token punctuation">,</span> <span class="token string">"arn:iam::user/*"</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_user</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_data<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">"""åˆ›å»ºç”¨æˆ·"""</span></span>
<span class="line">        <span class="token comment"># å®é™…çš„ç”¨æˆ·åˆ›å»ºé€»è¾‘</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string">"new_user_id"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">:</span> user_data<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">check_user_permissions</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Dict<span class="token punctuation">:</span></span>
<span class="line">        <span class="token triple-quoted-string string">"""æ£€æŸ¥ç”¨æˆ·çš„å¤šä¸ªæƒé™"""</span></span>
<span class="line">        checks <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">            PermissionCheck<span class="token punctuation">(</span><span class="token string">"iam:GetUser"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"arn:iam::user/</span><span class="token interpolation"><span class="token punctuation">{</span>user_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            PermissionCheck<span class="token punctuation">(</span><span class="token string">"iam:UpdateUser"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"arn:iam::user/</span><span class="token interpolation"><span class="token punctuation">{</span>user_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            PermissionCheck<span class="token punctuation">(</span><span class="token string">"iam:DeleteUser"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"arn:iam::user/</span><span class="token interpolation"><span class="token punctuation">{</span>user_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            PermissionCheck<span class="token punctuation">(</span><span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span> <span class="token string">"arn:aws:s3:::my-bucket/*"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            PermissionCheck<span class="token punctuation">(</span><span class="token string">"s3:PutObject"</span><span class="token punctuation">,</span> <span class="token string">"arn:aws:s3:::my-bucket/*"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        results <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>permission_checker<span class="token punctuation">.</span>check_permissions<span class="token punctuation">(</span>user_name<span class="token punctuation">,</span> checks<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># æ•´ç†ç»“æœ</span></span>
<span class="line">        permissions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">:</span></span>
<span class="line">            permissions<span class="token punctuation">[</span>result<span class="token punctuation">[</span><span class="token string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string">'allowed'</span><span class="token punctuation">:</span> result<span class="token punctuation">[</span><span class="token string">'allowed'</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">'reason'</span><span class="token punctuation">:</span> result<span class="token punctuation">[</span><span class="token string">'reason'</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">return</span> permissions</span>
<span class="line"></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># è¿æ¥åˆ°æœåŠ¡</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token keyword">with</span> grpc<span class="token punctuation">.</span>aio<span class="token punctuation">.</span>insecure_channel<span class="token punctuation">(</span><span class="token string">'localhost:50051'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> channel<span class="token punctuation">:</span></span>
<span class="line">        checker <span class="token operator">=</span> PermissionChecker<span class="token punctuation">(</span>channel<span class="token punctuation">)</span></span>
<span class="line">        user_service <span class="token operator">=</span> UserService<span class="token punctuation">(</span>checker<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 1. æ£€æŸ¥å•ä¸ªæƒé™</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"1. æ£€æŸ¥å•ä¸ªæƒé™..."</span><span class="token punctuation">)</span></span>
<span class="line">        allowed<span class="token punctuation">,</span> reason <span class="token operator">=</span> <span class="token keyword">await</span> checker<span class="token punctuation">.</span>check_permission<span class="token punctuation">(</span></span>
<span class="line">            <span class="token string">"john_doe"</span><span class="token punctuation">,</span> <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span> <span class="token string">"arn:aws:s3:::my-bucket/file.txt"</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"æƒé™æ£€æŸ¥ç»“æœ: </span><span class="token interpolation"><span class="token punctuation">{</span>allowed<span class="token punctuation">}</span></span><span class="token string">, åŸå› : </span><span class="token interpolation"><span class="token punctuation">{</span>reason<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 2. æ‰¹é‡æ£€æŸ¥æƒé™</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n2. æ‰¹é‡æ£€æŸ¥æƒé™..."</span><span class="token punctuation">)</span></span>
<span class="line">        checks <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">            PermissionCheck<span class="token punctuation">(</span><span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span> <span class="token string">"arn:aws:s3:::my-bucket/file1.txt"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            PermissionCheck<span class="token punctuation">(</span><span class="token string">"s3:PutObject"</span><span class="token punctuation">,</span> <span class="token string">"arn:aws:s3:::my-bucket/file2.txt"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            PermissionCheck<span class="token punctuation">(</span><span class="token string">"iam:ListUsers"</span><span class="token punctuation">,</span> <span class="token string">"arn:iam::user/*"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        results <span class="token operator">=</span> <span class="token keyword">await</span> checker<span class="token punctuation">.</span>check_permissions<span class="token punctuation">(</span><span class="token string">"john_doe"</span><span class="token punctuation">,</span> checks<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"æ‰¹é‡æ£€æŸ¥ç»“æœ:"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">for</span> i<span class="token punctuation">,</span> result <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>results<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  </span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">. </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">[</span><span class="token string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> on </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">[</span><span class="token string">'resource'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">[</span><span class="token string">'allowed'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 3. è·å–æœ‰æ•ˆæƒé™</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n3. è·å–æœ‰æ•ˆæƒé™..."</span><span class="token punctuation">)</span></span>
<span class="line">        permissions <span class="token operator">=</span> <span class="token keyword">await</span> checker<span class="token punctuation">.</span>get_effective_permissions<span class="token punctuation">(</span></span>
<span class="line">            <span class="token string">"john_doe"</span><span class="token punctuation">,</span> <span class="token string">"arn:aws:s3:::"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span> <span class="token string">"s3:PutObject"</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"æœ‰æ•ˆæƒé™ (</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>permissions<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> ä¸ª):"</span></span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">for</span> i<span class="token punctuation">,</span> perm <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>permissions<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  </span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">. </span><span class="token interpolation"><span class="token punctuation">{</span>perm<span class="token punctuation">[</span><span class="token string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> on </span><span class="token interpolation"><span class="token punctuation">{</span>perm<span class="token punctuation">[</span><span class="token string">'resource'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>perm<span class="token punctuation">[</span><span class="token string">'effect'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 4. ä½¿ç”¨æœåŠ¡æ–¹æ³•</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n4. ä½¿ç”¨æœåŠ¡æ–¹æ³•..."</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">            user <span class="token operator">=</span> <span class="token keyword">await</span> user_service<span class="token punctuation">.</span>get_user<span class="token punctuation">(</span><span class="token string">"john_doe"</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"è·å–ç”¨æˆ·æˆåŠŸ: </span><span class="token interpolation"><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"è·å–ç”¨æˆ·å¤±è´¥: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment"># 5. æ£€æŸ¥ç”¨æˆ·çš„å¤šä¸ªæƒé™</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n5. æ£€æŸ¥ç”¨æˆ·çš„å¤šä¸ªæƒé™..."</span><span class="token punctuation">)</span></span>
<span class="line">        user_permissions <span class="token operator">=</span> <span class="token keyword">await</span> user_service<span class="token punctuation">.</span>check_user_permissions<span class="token punctuation">(</span><span class="token string">"john_doe"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"ç”¨æˆ·æƒé™:"</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">for</span> action<span class="token punctuation">,</span> perm <span class="token keyword">in</span> user_permissions<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  </span><span class="token interpolation"><span class="token punctuation">{</span>action<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>perm<span class="token punctuation">[</span><span class="token string">'allowed'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token punctuation">{</span>perm<span class="token punctuation">[</span><span class="token string">'reason'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">)"</span></span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span></span>
<span class="line">    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸ”-æœ€ä½³å®è·µ" tabindex="-1"><a class="header-anchor" href="#ğŸ”-æœ€ä½³å®è·µ">#</a> ğŸ” æœ€ä½³å®è·µ</h2>
<h3 id="_1-æƒé™æ£€æŸ¥ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_1-æƒé™æ£€æŸ¥ä¼˜åŒ–">#</a> 1. æƒé™æ£€æŸ¥ä¼˜åŒ–</h3>
<h4 id="ç¼“å­˜æƒé™ç»“æœ" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜æƒé™ç»“æœ">#</a> ç¼“å­˜æƒé™ç»“æœ</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token keyword">type</span> PermissionCache <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    cache <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>CacheEntry</span>
<span class="line">    mutex sync<span class="token punctuation">.</span>RWMutex</span>
<span class="line">    ttl   time<span class="token punctuation">.</span>Duration</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> CacheEntry <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    allowed   <span class="token builtin">bool</span></span>
<span class="line">    timestamp time<span class="token punctuation">.</span>Time</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>pc <span class="token operator">*</span>PermissionCache<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    pc<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> pc<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    entry<span class="token punctuation">,</span> exists <span class="token operator">:=</span> pc<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token operator">!</span>exists <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span> <span class="token operator">></span> pc<span class="token punctuation">.</span>ttl <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">delete</span><span class="token punctuation">(</span>pc<span class="token punctuation">.</span>cache<span class="token punctuation">,</span> key<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> entry<span class="token punctuation">.</span>allowed<span class="token punctuation">,</span> <span class="token boolean">true</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>pc <span class="token operator">*</span>PermissionCache<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>key <span class="token builtin">string</span><span class="token punctuation">,</span> allowed <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    pc<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> pc<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    pc<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>CacheEntry<span class="token punctuation">{</span></span>
<span class="line">        allowed<span class="token punctuation">:</span>   allowed<span class="token punctuation">,</span></span>
<span class="line">        timestamp<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// å¸¦ç¼“å­˜çš„æƒé™æ£€æŸ¥</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>pc <span class="token operator">*</span>PermissionChecker<span class="token punctuation">)</span> <span class="token function">CheckPermissionWithCache</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> action<span class="token punctuation">,</span> resource <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æ„é€ ç¼“å­˜é”®</span></span>
<span class="line">    cacheKey <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s:%s:%s"</span><span class="token punctuation">,</span> userName<span class="token punctuation">,</span> action<span class="token punctuation">,</span> resource<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ£€æŸ¥ç¼“å­˜</span></span>
<span class="line">    <span class="token keyword">if</span> allowed<span class="token punctuation">,</span> found <span class="token operator">:=</span> pc<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span> found <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> allowed<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç¼“å­˜æœªå‘½ä¸­ï¼Œè°ƒç”¨API</span></span>
<span class="line">    allowed<span class="token punctuation">,</span> err <span class="token operator">:=</span> pc<span class="token punctuation">.</span><span class="token function">CheckPermission</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> action<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// ç¼“å­˜ç»“æœ</span></span>
<span class="line">    pc<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> allowed<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> allowed<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ‰¹é‡æƒé™æ£€æŸ¥" tabindex="-1"><a class="header-anchor" href="#æ‰¹é‡æƒé™æ£€æŸ¥">#</a> æ‰¹é‡æƒé™æ£€æŸ¥</h4>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// æ™ºèƒ½æ‰¹é‡æƒé™æ£€æŸ¥</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>pc <span class="token operator">*</span>PermissionChecker<span class="token punctuation">)</span> <span class="token function">SmartCheckPermissions</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> userName <span class="token builtin">string</span><span class="token punctuation">,</span> checks <span class="token punctuation">[</span><span class="token punctuation">]</span>PermissionCheck<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    results <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">bool</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">var</span> uncachedChecks <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>iamv1<span class="token punctuation">.</span>PermissionCheck</span>
<span class="line">    <span class="token keyword">var</span> uncachedKeys <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ£€æŸ¥ç¼“å­˜</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> check <span class="token operator">:=</span> <span class="token keyword">range</span> checks <span class="token punctuation">{</span></span>
<span class="line">        key <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s:%s:%s"</span><span class="token punctuation">,</span> userName<span class="token punctuation">,</span> check<span class="token punctuation">.</span>Action<span class="token punctuation">,</span> check<span class="token punctuation">.</span>Resource<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> allowed<span class="token punctuation">,</span> found <span class="token operator">:=</span> pc<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> found <span class="token punctuation">{</span></span>
<span class="line">            results<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> allowed</span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            uncachedChecks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>uncachedChecks<span class="token punctuation">,</span> <span class="token operator">&amp;</span>iamv1<span class="token punctuation">.</span>PermissionCheck<span class="token punctuation">{</span></span>
<span class="line">                Action<span class="token punctuation">:</span>   check<span class="token punctuation">.</span>Action<span class="token punctuation">,</span></span>
<span class="line">                Resource<span class="token punctuation">:</span> check<span class="token punctuation">.</span>Resource<span class="token punctuation">,</span></span>
<span class="line">                Context<span class="token punctuation">:</span>  check<span class="token punctuation">.</span>Context<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            uncachedKeys <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>uncachedKeys<span class="token punctuation">,</span> key<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ‰¹é‡æ£€æŸ¥æœªç¼“å­˜çš„æƒé™</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>uncachedChecks<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        batchResults<span class="token punctuation">,</span> err <span class="token operator">:=</span> pc<span class="token punctuation">.</span><span class="token function">CheckPermissions</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> uncachedChecks<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">        <span class="token comment">// ç¼“å­˜ç»“æœ</span></span>
<span class="line">        <span class="token keyword">for</span> i<span class="token punctuation">,</span> result <span class="token operator">:=</span> <span class="token keyword">range</span> batchResults <span class="token punctuation">{</span></span>
<span class="line">            key <span class="token operator">:=</span> uncachedKeys<span class="token punctuation">[</span>i<span class="token punctuation">]</span></span>
<span class="line">            results<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">.</span>Allowed</span>
<span class="line">            pc<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> result<span class="token punctuation">.</span>Allowed<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> results<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-æƒé™ç­–ç•¥è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#_2-æƒé™ç­–ç•¥è®¾è®¡">#</a> 2. æƒé™ç­–ç•¥è®¾è®¡</h3>
<h4 id="æœ€å°æƒé™åŸåˆ™" tabindex="-1"><a class="header-anchor" href="#æœ€å°æƒé™åŸåˆ™">#</a> æœ€å°æƒé™åŸåˆ™</h4>
<div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre v-pre><code class="language-json"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2025-01-01"</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">"s3:GetObject"</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">"arn:aws:s3:::my-bucket/users/${aws:username}/*"</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"Condition"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">"StringEquals"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">"s3:ExistingObjectTag/Owner"</span><span class="token operator">:</span> <span class="token string">"${aws:username}"</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ—¶é—´é™åˆ¶ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#æ—¶é—´é™åˆ¶ç­–ç•¥">#</a> æ—¶é—´é™åˆ¶ç­–ç•¥</h4>
<div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre v-pre><code class="language-json"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2025-01-01"</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">"iam:*"</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">"Condition"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">"DateGreaterThan"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">"aws:CurrentTime"</span><span class="token operator">:</span> <span class="token string">"2024-01-01T00:00:00Z"</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"DateLessThan"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">"aws:CurrentTime"</span><span class="token operator">:</span> <span class="token string">"2024-12-31T23:59:59Z"</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">"IpAddress"</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">"aws:SourceIp"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"192.168.1.0/24"</span><span class="token punctuation">,</span> <span class="token string">"10.0.0.0/8"</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-é”™è¯¯å¤„ç†å’Œç›‘æ§" tabindex="-1"><a class="header-anchor" href="#_3-é”™è¯¯å¤„ç†å’Œç›‘æ§">#</a> 3. é”™è¯¯å¤„ç†å’Œç›‘æ§</h3>
<div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre v-pre><code class="language-go"><span class="line"><span class="token comment">// æƒé™æ£€æŸ¥ç›‘æ§</span></span>
<span class="line"><span class="token keyword">type</span> PermissionMetrics <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    totalChecks    <span class="token builtin">int64</span></span>
<span class="line">    allowedChecks  <span class="token builtin">int64</span></span>
<span class="line">    deniedChecks   <span class="token builtin">int64</span></span>
<span class="line">    errorChecks    <span class="token builtin">int64</span></span>
<span class="line">    cacheHits      <span class="token builtin">int64</span></span>
<span class="line">    cacheMisses    <span class="token builtin">int64</span></span>
<span class="line">    avgLatency     time<span class="token punctuation">.</span>Duration</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>pc <span class="token operator">*</span>PermissionChecker<span class="token punctuation">)</span> <span class="token function">CheckPermissionWithMetrics</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> action<span class="token punctuation">,</span> resource <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        pc<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>avgLatency <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span></span>
<span class="line">        atomic<span class="token punctuation">.</span><span class="token function">AddInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pc<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>totalChecks<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// æ£€æŸ¥æƒé™</span></span>
<span class="line">    allowed<span class="token punctuation">,</span> err <span class="token operator">:=</span> pc<span class="token punctuation">.</span><span class="token function">CheckPermission</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> action<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        atomic<span class="token punctuation">.</span><span class="token function">AddInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pc<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>errorChecks<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// è®°å½•é”™è¯¯æ—¥å¿—</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"æƒé™æ£€æŸ¥é”™è¯¯: ç”¨æˆ·=%s, æ“ä½œ=%s, èµ„æº=%s, é”™è¯¯=%v"</span><span class="token punctuation">,</span> userName<span class="token punctuation">,</span> action<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span> allowed <span class="token punctuation">{</span></span>
<span class="line">        atomic<span class="token punctuation">.</span><span class="token function">AddInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pc<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>allowedChecks<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        atomic<span class="token punctuation">.</span><span class="token function">AddInt64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pc<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>deniedChecks<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// è®°å½•æƒé™æ‹’ç»æ—¥å¿—</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"æƒé™æ‹’ç»: ç”¨æˆ·=%s, æ“ä½œ=%s, èµ„æº=%s"</span><span class="token punctuation">,</span> userName<span class="token punctuation">,</span> action<span class="token punctuation">,</span> resource<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> allowed<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æƒé™å®¡è®¡æ—¥å¿—</span></span>
<span class="line"><span class="token keyword">type</span> PermissionAuditLog <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">    Timestamp    time<span class="token punctuation">.</span>Time <span class="token string">`json:"timestamp"`</span></span>
<span class="line">    UserName     <span class="token builtin">string</span>    <span class="token string">`json:"user_name"`</span></span>
<span class="line">    Action       <span class="token builtin">string</span>    <span class="token string">`json:"action"`</span></span>
<span class="line">    Resource     <span class="token builtin">string</span>    <span class="token string">`json:"resource"`</span></span>
<span class="line">    Allowed      <span class="token builtin">bool</span>      <span class="token string">`json:"allowed"`</span></span>
<span class="line">    Decision     <span class="token builtin">string</span>    <span class="token string">`json:"decision"`</span></span>
<span class="line">    Policies     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>  <span class="token string">`json:"policies"`</span></span>
<span class="line">    Reason       <span class="token builtin">string</span>    <span class="token string">`json:"reason"`</span></span>
<span class="line">    Context      <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token string">`json:"context"`</span></span>
<span class="line">    SourceIP     <span class="token builtin">string</span>    <span class="token string">`json:"source_ip"`</span></span>
<span class="line">    UserAgent    <span class="token builtin">string</span>    <span class="token string">`json:"user_agent"`</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>pc <span class="token operator">*</span>PermissionChecker<span class="token punctuation">)</span> <span class="token function">AuditPermissionCheck</span><span class="token punctuation">(</span>userName<span class="token punctuation">,</span> action<span class="token punctuation">,</span> resource <span class="token builtin">string</span><span class="token punctuation">,</span> result <span class="token operator">*</span>iamv1<span class="token punctuation">.</span>CheckPermissionResponse<span class="token punctuation">,</span> context <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    auditLog <span class="token operator">:=</span> PermissionAuditLog<span class="token punctuation">{</span></span>
<span class="line">        Timestamp<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        UserName<span class="token punctuation">:</span>  userName<span class="token punctuation">,</span></span>
<span class="line">        Action<span class="token punctuation">:</span>    action<span class="token punctuation">,</span></span>
<span class="line">        Resource<span class="token punctuation">:</span>  resource<span class="token punctuation">,</span></span>
<span class="line">        Allowed<span class="token punctuation">:</span>   result<span class="token punctuation">.</span>Allowed<span class="token punctuation">,</span></span>
<span class="line">        Decision<span class="token punctuation">:</span>  result<span class="token punctuation">.</span>Decision<span class="token punctuation">,</span></span>
<span class="line">        Policies<span class="token punctuation">:</span>  result<span class="token punctuation">.</span>MatchedPolicies<span class="token punctuation">,</span></span>
<span class="line">        Reason<span class="token punctuation">:</span>    result<span class="token punctuation">.</span>Reason<span class="token punctuation">,</span></span>
<span class="line">        Context<span class="token punctuation">:</span>   context<span class="token punctuation">,</span></span>
<span class="line">        SourceIP<span class="token punctuation">:</span>  context<span class="token punctuation">[</span><span class="token string">"aws:SourceIp"</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        UserAgent<span class="token punctuation">:</span> context<span class="token punctuation">[</span><span class="token string">"http:UserAgent"</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// å‘é€åˆ°å®¡è®¡æ—¥å¿—ç³»ç»Ÿ</span></span>
<span class="line">    pc<span class="token punctuation">.</span>auditLogger<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>auditLog<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre>
<div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ğŸš¨-æ³¨æ„äº‹é¡¹" tabindex="-1"><a class="header-anchor" href="#ğŸš¨-æ³¨æ„äº‹é¡¹">#</a> ğŸš¨ æ³¨æ„äº‹é¡¹</h2>
<h3 id="å®‰å…¨è€ƒè™‘" tabindex="-1"><a class="header-anchor" href="#å®‰å…¨è€ƒè™‘">#</a> å®‰å…¨è€ƒè™‘</h3>
<ol>
<li>
<p><strong>æƒé™æ£€æŸ¥ä¸èƒ½ç»•è¿‡</strong>ï¼š</p>
<ul>
<li>åœ¨æ‰€æœ‰å…³é”®æ“ä½œå‰è¿›è¡Œæƒé™æ£€æŸ¥</li>
<li>ä¸è¦ä¾èµ–å®¢æˆ·ç«¯çš„æƒé™éªŒè¯</li>
<li>ä½¿ç”¨ç™½åå•è€Œéé»‘åå•</li>
</ul>
</li>
<li>
<p><strong>ä¸Šä¸‹æ–‡ä¿¡æ¯éªŒè¯</strong>ï¼š</p>
<ul>
<li>éªŒè¯IPåœ°å€ã€æ—¶é—´ç­‰ä¸Šä¸‹æ–‡ä¿¡æ¯</li>
<li>é˜²æ­¢ä¸Šä¸‹æ–‡ä¿¡æ¯è¢«ä¼ªé€ </li>
<li>è®°å½•è¯¦ç»†çš„å®¡è®¡æ—¥å¿—</li>
</ul>
</li>
<li>
<p><strong>æƒé™æå‡é˜²æŠ¤</strong>ï¼š</p>
<ul>
<li>é˜²æ­¢æƒé™æå‡æ”»å‡»</li>
<li>å®šæœŸå®¡æŸ¥æƒé™åˆ†é…</li>
<li>ç›‘æ§å¼‚å¸¸æƒé™ä½¿ç”¨</li>
</ul>
</li>
</ol>
<h3 id="æ€§èƒ½ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#æ€§èƒ½ä¼˜åŒ–">#</a> æ€§èƒ½ä¼˜åŒ–</h3>
<ol>
<li>
<p><strong>ç¼“å­˜ç­–ç•¥</strong>ï¼š</p>
<ul>
<li>åˆç†è®¾ç½®ç¼“å­˜TTL</li>
<li>ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡</li>
<li>åŠæ—¶æ¸…ç†è¿‡æœŸç¼“å­˜</li>
</ul>
</li>
<li>
<p><strong>æ‰¹é‡æ“ä½œ</strong>ï¼š</p>
<ul>
<li>å°½é‡ä½¿ç”¨æ‰¹é‡æƒé™æ£€æŸ¥</li>
<li>é¿å…å¾ªç¯è°ƒç”¨å•ä¸ªæƒé™æ£€æŸ¥</li>
<li>åˆç†æ§åˆ¶æ‰¹é‡å¤§å°</li>
</ul>
</li>
<li>
<p><strong>å¼‚æ­¥å¤„ç†</strong>ï¼š</p>
<ul>
<li>å¯¹äºéå…³é”®è·¯å¾„ï¼Œè€ƒè™‘å¼‚æ­¥æƒé™æ£€æŸ¥</li>
<li>ä½¿ç”¨æƒé™é¢„æ£€æŸ¥æœºåˆ¶</li>
<li>å®ç°æƒé™æ£€æŸ¥çš„é™çº§ç­–ç•¥</li>
</ul>
</li>
</ol>
<h3 id="ç›‘æ§å’Œè¿ç»´" tabindex="-1"><a class="header-anchor" href="#ç›‘æ§å’Œè¿ç»´">#</a> ç›‘æ§å’Œè¿ç»´</h3>
<ol>
<li>
<p><strong>æŒ‡æ ‡ç›‘æ§</strong>ï¼š</p>
<ul>
<li>ç›‘æ§æƒé™æ£€æŸ¥æˆåŠŸç‡</li>
<li>ç›‘æ§æƒé™æ£€æŸ¥å»¶è¿Ÿ</li>
<li>ç›‘æ§æƒé™æ‹’ç»ç‡</li>
</ul>
</li>
<li>
<p><strong>å‘Šè­¦è®¾ç½®</strong>ï¼š</p>
<ul>
<li>è®¾ç½®æƒé™æ£€æŸ¥å¤±è´¥å‘Šè­¦</li>
<li>è®¾ç½®å¼‚å¸¸æƒé™ä½¿ç”¨å‘Šè­¦</li>
<li>è®¾ç½®æƒé™ç­–ç•¥å˜æ›´å‘Šè­¦</li>
</ul>
</li>
<li>
<p><strong>å®¡è®¡åˆè§„</strong>ï¼š</p>
<ul>
<li>ä¿ç•™å®Œæ•´çš„æƒé™å®¡è®¡æ—¥å¿—</li>
<li>å®šæœŸè¿›è¡Œæƒé™å®¡è®¡</li>
<li>æ»¡è¶³åˆè§„è¦æ±‚</li>
</ul>
</li>
</ol>
<hr>
<div class="hint-container tip">
<p class="hint-container-title">æç¤º</p>
<p>æƒé™æ£€æŸ¥æ˜¯å®‰å…¨çš„æœ€åä¸€é“é˜²çº¿ï¼Œå»ºè®®åœ¨åº”ç”¨çš„å¤šä¸ªå±‚æ¬¡éƒ½è¿›è¡Œæƒé™éªŒè¯ã€‚</p>
</div>
<h2 id="ğŸ“š-ç›¸å…³æ–‡æ¡£" tabindex="-1"><a class="header-anchor" href="#ğŸ“š-ç›¸å…³æ–‡æ¡£">#</a> ğŸ“š ç›¸å…³æ–‡æ¡£</h2>
<ul>
<li><RouteLink to="/api/policy-management.html">ç­–ç•¥ç®¡ç† API</RouteLink> - äº†è§£å¦‚ä½•åˆ›å»ºå’Œç®¡ç†æƒé™ç­–ç•¥</li>
<li><RouteLink to="/api/user-management.html">ç”¨æˆ·ç®¡ç† API</RouteLink> - äº†è§£å¦‚ä½•ç®¡ç†ç”¨æˆ·å’Œç»‘å®šç­–ç•¥</li>
<li><RouteLink to="/api/access-keys.html">è®¿é—®å¯†é’¥ API</RouteLink> - äº†è§£å¦‚ä½•ç®¡ç†APIè®¿é—®å¯†é’¥</li>
<li><RouteLink to="/guide/">å¿«é€Ÿå¼€å§‹æŒ‡å—</RouteLink> - å¿«é€Ÿä¸Šæ‰‹VGOå¾®æœåŠ¡</li>
<li><RouteLink to="/guide/configuration.html">é…ç½®æŒ‡å—</RouteLink> - äº†è§£ç³»ç»Ÿé…ç½®é€‰é¡¹</li>
</ul>
</div></template>


