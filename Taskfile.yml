# VGOå¾®æœåŠ¡ - Taskfile
# ç»Ÿä¸€ç®¡ç†submoduleå’Œæ„å»ºä»»åŠ¡
# ä½¿ç”¨ Task æ›¿ä»£ Make: https://taskfile.dev/

version: '3'

vars:
  PROJECT_NAME: vgo-microservices
  GO_VERSION: 1.24.1

tasks:
  default:
    desc: æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨ä»»åŠ¡
    cmds:
      - task --list

  # Submoduleç®¡ç†ä»»åŠ¡
  init:
    desc: åˆå§‹åŒ–æ‰€æœ‰submodule
    cmds:
      - echo "ğŸš€ åˆå§‹åŒ–submodules..."
      - ./scripts/submodule-init.sh
    sources:
      - .gitmodules
    generates:
      - vgo-kit/**/*
      - vgo-iam/**/*
      - vgo-gateway/**/*

  update:
    desc: æ›´æ–°æ‰€æœ‰submoduleåˆ°æœ€æ–°ç‰ˆæœ¬
    cmds:
      - echo "ğŸ”„ æ›´æ–°submodules..."
      - ./scripts/submodule-update.sh
    deps:
      - init

  sync:
    desc: åŒæ­¥æ‰€æœ‰submoduleæ›´æ”¹
    cmds:
      - echo "ğŸ”„ åŒæ­¥submodules..."
      - ./scripts/submodule-sync.sh
    deps:
      - init

  # æ„å»ºå’Œæµ‹è¯•ä»»åŠ¡
  build:
    desc: æ„å»ºæ‰€æœ‰æœåŠ¡
    cmds:
      - echo "ğŸ”¨ æ„å»ºæ‰€æœ‰æœåŠ¡..."
      - go work sync
      - go build ./...
      - echo "âœ… æ„å»ºå®Œæˆ"
    sources:
      - "**/*.go"
      - "**/go.mod"
      - "**/go.sum"
      - go.work
    deps:
      - init

  test:
    desc: è¿è¡Œæ‰€æœ‰æµ‹è¯•
    cmds:
      - echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
      - go work sync
      - go test ./...
      - echo "âœ… æµ‹è¯•å®Œæˆ"
    sources:
      - "**/*.go"
      - "**/go.mod"
      - "**/go.sum"
    deps:
      - init

  test:verbose:
    desc: è¿è¡Œè¯¦ç»†æµ‹è¯•
    cmds:
      - echo "ğŸ§ª è¿è¡Œè¯¦ç»†æµ‹è¯•..."
      - go work sync
      - go test -v ./...
      - echo "âœ… è¯¦ç»†æµ‹è¯•å®Œæˆ"
    deps:
      - init

  clean:
    desc: æ¸…ç†æ„å»ºæ–‡ä»¶
    cmds:
      - echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
      - rm -rf bin/
      - rm -rf */bin/
      - go clean -cache
      - echo "âœ… æ¸…ç†å®Œæˆ"

  # Dockerç®¡ç†ä»»åŠ¡
  docker:build:
    desc: æ„å»ºDockeré•œåƒ
    cmds:
      - echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
      - docker-compose build
      - echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ"
    sources:
      - docker-compose.yml
      - "**/Dockerfile"
      - "**/*.go"

  docker:up:
    desc: å¯åŠ¨Docker ComposeæœåŠ¡
    cmds:
      - echo "ğŸš€ å¯åŠ¨Docker ComposeæœåŠ¡..."
      - docker-compose up -d
      - echo "âœ… æœåŠ¡å¯åŠ¨å®Œæˆ"
    deps:
      - docker:build

  docker:down:
    desc: åœæ­¢Docker ComposeæœåŠ¡
    cmds:
      - echo "ğŸ›‘ åœæ­¢Docker ComposeæœåŠ¡..."
      - docker-compose down
      - echo "âœ… æœåŠ¡åœæ­¢å®Œæˆ"

  docker:logs:
    desc: æŸ¥çœ‹Docker Composeæ—¥å¿—
    cmds:
      - docker-compose logs -f

  docker:ps:
    desc: æŸ¥çœ‹Docker ComposeæœåŠ¡çŠ¶æ€
    cmds:
      - docker-compose ps

  # å¼€å‘å·¥å…·ä»»åŠ¡
  fmt:
    desc: æ ¼å¼åŒ–ä»£ç 
    cmds:
      - echo "ğŸ“ æ ¼å¼åŒ–ä»£ç ..."
      - go fmt ./...
      - echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"
    sources:
      - "**/*.go"

  lint:
    desc: ä»£ç æ£€æŸ¥
    cmds:
      - echo "ğŸ” ä»£ç æ£€æŸ¥..."
      - |
        if command -v golangci-lint >/dev/null 2>&1; then
          golangci-lint run ./...
        else
          echo "âš ï¸  golangci-lintæœªå®‰è£…ï¼Œè·³è¿‡ä»£ç æ£€æŸ¥"
          echo "ğŸ’¡ å®‰è£…å‘½ä»¤ï¼šgo install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"
        fi
    sources:
      - "**/*.go"
      - .golangci.yml

  deps:
    desc: æ›´æ–°ä¾èµ–
    cmds:
      - echo "ğŸ“¦ æ›´æ–°ä¾èµ–..."
      - go work sync
      - go mod tidy -C vgo-kit
      - go mod tidy -C vgo-iam
      - go mod tidy -C vgo-gateway
      - echo "âœ… ä¾èµ–æ›´æ–°å®Œæˆ"
    deps:
      - init

  # Kubernetesä»»åŠ¡
  k8s:apply:
    desc: åº”ç”¨Kubernetesé…ç½®
    cmds:
      - echo "â˜¸ï¸  åº”ç”¨Kubernetesé…ç½®..."
      - kubectl apply -f k8s/
      - echo "âœ… Kubernetesé…ç½®åº”ç”¨å®Œæˆ"
    sources:
      - k8s/**/*.yaml

  k8s:delete:
    desc: åˆ é™¤Kubernetesèµ„æº
    cmds:
      - echo "ğŸ—‘ï¸  åˆ é™¤Kubernetesèµ„æº..."
      - kubectl delete -f k8s/
      - echo "âœ… Kubernetesèµ„æºåˆ é™¤å®Œæˆ"

  k8s:status:
    desc: æŸ¥çœ‹KubernetesæœåŠ¡çŠ¶æ€
    cmds:
      - kubectl get pods,svc,ingress -n vgo-microservices

  # ç›‘æ§ä»»åŠ¡
  monitoring:up:
    desc: å¯åŠ¨ç›‘æ§æœåŠ¡
    cmds:
      - echo "ğŸ“Š å¯åŠ¨ç›‘æ§æœåŠ¡..."
      - kubectl apply -f k8s/monitoring/
      - echo "âœ… ç›‘æ§æœåŠ¡å¯åŠ¨å®Œæˆ"

  monitoring:down:
    desc: åœæ­¢ç›‘æ§æœåŠ¡
    cmds:
      - echo "ğŸ“Š åœæ­¢ç›‘æ§æœåŠ¡..."
      - kubectl delete -f k8s/monitoring/
      - echo "âœ… ç›‘æ§æœåŠ¡åœæ­¢å®Œæˆ"

  # å¼€å‘ç¯å¢ƒä»»åŠ¡
  dev:
    desc: åˆå§‹åŒ–å¼€å‘ç¯å¢ƒ
    cmds:
      - task: init
      - task: deps
      - task: build
      - echo "ğŸ‰ å¼€å‘ç¯å¢ƒå‡†å¤‡å®Œæˆï¼"

  dev:watch:
    desc: ç›‘å¬æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨æ„å»º
    cmds:
      - echo "ğŸ‘€ ç›‘å¬æ–‡ä»¶å˜åŒ–..."
      - |
        if command -v watchexec >/dev/null 2>&1; then
          watchexec -e go -r "task build"
        else
          echo "âš ï¸  watchexecæœªå®‰è£…ï¼Œæ— æ³•ç›‘å¬æ–‡ä»¶å˜åŒ–"
          echo "ğŸ’¡ å®‰è£…å‘½ä»¤ï¼šbrew install watchexec"
        fi

  # å·¥å…·å®‰è£…ä»»åŠ¡
  install:tools:
    desc: å®‰è£…å¼€å‘å·¥å…·
    cmds:
      - echo "ğŸ”§ å®‰è£…å¼€å‘å·¥å…·..."
      - go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
      - |
        if [[ "$OSTYPE" == "darwin"* ]]; then
          if ! command -v watchexec >/dev/null 2>&1; then
            echo "å®‰è£… watchexec..."
            brew install watchexec
          fi
        fi
      - echo "âœ… å¼€å‘å·¥å…·å®‰è£…å®Œæˆ"

  # ç‰ˆæœ¬ç®¡ç†ä»»åŠ¡
  version:
    desc: æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
    cmds:
      - echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯ï¼š"
      - echo "Goç‰ˆæœ¬ï¼š$(go version)"
      - echo "Taskç‰ˆæœ¬ï¼š$(task --version)"
      - echo "Dockerç‰ˆæœ¬ï¼š$(docker --version)"
      - echo "Kubernetesç‰ˆæœ¬ï¼š$(kubectl version --client --short 2>/dev/null || echo 'kubectlæœªå®‰è£…')"

  # å¸®åŠ©ä»»åŠ¡
  help:
    desc: æ˜¾ç¤ºè¯¦ç»†å¸®åŠ©ä¿¡æ¯
    cmds:
      - echo "VGOå¾®æœåŠ¡ - Taskå‘½ä»¤å¸®åŠ©"
      - echo ""
      - echo "ğŸš€ å¿«é€Ÿå¼€å§‹ï¼š"
      - echo "  task dev          - åˆå§‹åŒ–å¼€å‘ç¯å¢ƒ"
      - echo "  task build        - æ„å»ºæ‰€æœ‰æœåŠ¡"
      - echo "  task docker:up    - å¯åŠ¨DockeræœåŠ¡"
      - echo ""
      - echo "ğŸ“¦ Submoduleç®¡ç†ï¼š"
      - echo "  task init         - åˆå§‹åŒ–submodule"
      - echo "  task update       - æ›´æ–°submodule"
      - echo "  task sync         - åŒæ­¥submodule"
      - echo ""
      - echo "ğŸ”§ å¼€å‘å·¥å…·ï¼š"
      - echo "  task fmt          - æ ¼å¼åŒ–ä»£ç "
      - echo "  task lint         - ä»£ç æ£€æŸ¥"
      - echo "  task test         - è¿è¡Œæµ‹è¯•"
      - echo ""
      - echo "ğŸ³ Dockerç®¡ç†ï¼š"
      - echo "  task docker:build - æ„å»ºé•œåƒ"
      - echo "  task docker:up    - å¯åŠ¨æœåŠ¡"
      - echo "  task docker:down  - åœæ­¢æœåŠ¡"
      - echo ""
      - echo "â˜¸ï¸  Kubernetesï¼š"
      - echo "  task k8s:apply    - åº”ç”¨é…ç½®"
      - echo "  task k8s:status   - æŸ¥çœ‹çŠ¶æ€"
      - echo ""
      - echo "ğŸ’¡ æç¤ºï¼šä½¿ç”¨ 'task --list' æŸ¥çœ‹æ‰€æœ‰å¯ç”¨ä»»åŠ¡"